<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (ART SHOP)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons CDN for modern icons -->
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Cairo', 'sans-serif'],
                    },
                },
            }
        }   
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Enhanced Invoice Section Animations */
        .invoice-row {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .invoice-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .status-badge {
            transition: all 0.2s ease-in-out;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
        }
        
        .action-button {
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }
        
        .action-button:hover::before {
            left: 100%;
        }
        
        .priority-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            animation: slideInFromLeft 0.6s ease-out;
        }
        
        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Enhanced table styling */
        .invoice-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .invoice-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        
        .invoice-table tbody tr:last-child {
            border-bottom: none;
        }
        
        /* Channel Filter Buttons Styling */
        .channel-filter-btn {
            position: relative;
            overflow: hidden;
        }
        
        .channel-filter-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .channel-filter-btn:not(.active):hover {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        
        .channel-filter-btn:not(.active):active {
            transform: translateY(0);
        }
        
        .channel-filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .channel-filter-btn:hover::before {
            left: 100%;
        }
        
        /* Loading animation for status changes */
        .status-changing {
            animation: statusChange 0.8s ease-in-out;
        }
        
        @keyframes statusChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #fbbf24; }
            100% { transform: scale(1); }
        }
        .sidebar-link {
            transition: all 0.2s ease-in-out;
        }
        .sidebar-link.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: white;
            
        }
        .sidebar-link:hover {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
            }
            body * {
                visibility: hidden;
            }
            /* Allow invoice, stock-out, expense, and purchase details print modals to render during printing */
            #printable-invoice-modal, #printable-invoice-modal *,
            #printable-stock-out-modal, #printable-stock-out-modal *,
            #printable-expense-modal, #printable-expense-modal *,
            #printable-purchase-details-modal, #printable-purchase-details-modal * {
                visibility: visible;
            }
            #printable-invoice-modal, #printable-stock-out-modal, #printable-expense-modal, #printable-purchase-details-modal {
                position: static !important;
                box-shadow: none !important;
                border: none !important;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center h-screen bg-gray-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">ğŸ¨ ART SHOP ERP</h1>
                <p class="mt-2 text-gray-600">Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            </div>
            
            <div id="auth-error" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                <!-- Error message will be shown here -->
            </div>

            <form id="email-password-form" class="space-y-4">
                <input id="email-input" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full px-4 py-2 text-gray-700 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <input id="password-input" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full px-4 py-2 text-gray-700 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <div class="flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:space-x-2 sm:space-x-reverse">
                    <button id="login-btn" type="button" class="w-full px-4 py-2 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                    <button id="signup-btn" type="button" class="w-full px-4 py-2 font-semibold text-gray-800 bg-gray-200 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                </div>
            </form>

            <div class="flex items-center justify-between">
                <span class="w-1/5 border-b"></span>
                <span class="text-xs text-center text-gray-500 uppercase">Ø£Ùˆ</span>
                <span class="w-1/5 border-b"></span>
            </div>

            <button id="google-login-btn" class="w-full flex items-center justify-center px-4 py-2 space-x-2 space-x-reverse transition-colors duration-300 border border-gray-300 rounded-lg group hover:bg-red-500 focus:outline-none">
                <span>
                    <svg class="w-5 h-5 text-red-500 fill-current group-hover:text-white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.0001 10.2112L11.9721 10.2282C10.8111 10.8542 9.91211 11.7582 9.32411 12.8252C8.72411 13.9112 8.43111 15.1112 8.46811 16.3202C8.48711 16.9462 8.60111 17.5662 8.80611 18.1582C9.01111 18.7502 9.30511 19.3072 9.67511 19.8112C10.0451 20.3152 10.4861 20.7582 10.9821 21.1242C11.4781 21.4902 12.0211 21.7742 12.5911 21.9642C13.1611 22.1542 13.7531 22.2472 14.3491 22.2402C15.5411 22.2402 16.6511 21.9192 17.6131 21.3032C18.5751 20.6872 19.3621 19.8082 19.9111 18.7382C20.4601 17.6682 20.7581 16.4482 20.7821 15.1982C20.7931 14.4382 20.6971 13.6842 20.4991 12.9582C20.3011 12.2322 20.0061 11.5472 19.6241 10.9242C19.2421 10.3012 18.7781 9.75218 18.2511 9.29218C17.7241 8.83218 17.1411 8.46918 16.5211 8.21718C15.4311 7.78118 14.2511 7.60018 13.0781 7.69718C12.5531 7.73818 12.0351 7.87318 11.5411 8.09718C11.0471 8.32118 10.5841 8.63018 10.1681 9.01318C9.75211 9.39618 9.39111 9.84818 9.09811 10.3542L12.0001 13.0542V10.2112Z" fill="#FFC107"/><path d="M21.9981 12.0002C21.9981 11.2332 21.9181 10.4782 21.7581 9.75018H12.0001V13.8442H17.7251C17.5311 14.9772 16.9151 15.9612 16.0331 16.6382L16.0151 16.6512L18.8481 18.9602L18.9601 18.9482C20.8351 17.2022 21.9981 14.7822 21.9981 12.0002Z" fill="#FF3D00"/><path d="M9.09809 10.3542C9.39109 9.84818 9.75209 9.39618 10.1681 9.01318C10.5841 8.63018 11.0471 8.32118 11.5411 8.09718C12.0351 7.87318 12.5531 7.73818 13.0781 7.69718C14.2511 7.60018 15.4311 7.78118 16.5211 8.21718L19.2601 5.67918C17.7001 4.49218 15.7951 3.86418 13.8011 3.87518C11.6091 3.86918 9.53109 4.65018 7.89809 5.99918C6.26509 7.34818 5.17609 9.18818 4.82809 11.2502C4.48009 13.3122 4.89609 15.4292 6.00009 17.1992L8.98209 14.8212C8.57409 13.6842 8.57409 12.4282 8.98209 11.2912L9.09809 10.3542Z" fill="#4CAF50"/><path d="M21.7581 9.75018L18.9881 7.20518C17.2881 5.80518 15.1111 5.00018 12.8621 5.00018C10.8381 5.00518 8.88809 5.76518 7.38809 7.12518L4.35209 4.35218C6.54109 2.53018 9.24309 1.50018 12.0001 1.50018C15.3111 1.50018 18.2931 2.82218 20.4881 4.96218C20.9411 5.39318 21.3481 5.86518 21.7051 6.37518C22.2101 7.10818 22.5851 7.92518 22.8131 8.79018C22.9511 9.28818 23.0001 9.79918 23.0001 10.3132C23.0001 10.8872 22.9211 11.4582 22.7681 12.0132H12.0001V9.75018H21.7581Z" fill="#1565C0"/></svg>
                </span> 
                <span class="text-sm font-medium text-gray-800 group-hover:text-white">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</span>
            </button>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="main-app" class="hidden flex h-screen bg-gray-200 no-print">
        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-gray-800 text-white flex flex-col" id="sidebar">
            <div class="h-16 flex items-center justify-center text-2xl font-bold border-b border-gray-700">
                ğŸ¨ ART SHOP
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" class="sidebar-link active flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                    <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="sales">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M16 8h-6a2 2 0 1 0 0 4h6"/><path d="M12 17.5v-11"/></svg>
                    <span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</span>
                </a>
                 <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="inventory">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-boxes"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    <span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="purchases">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg>
                    <span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="stock-out">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-x"><path d="M21 10H7l-2 3H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2Z"/><path d="m17 15 2 2 4-4"/></svg>
                    <span>ØµØ±Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                </a>
                 <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="expenses">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-banknote"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                    <span>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span>
                </a>
                <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="hr">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span>
                </a>
                 <a href="#" class="sidebar-link flex items-center space-x-2 space-x-reverse py-2 px-4 rounded-md" data-page="reports">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart-big"><path d="M3 3v18h18"/><path d="M7 12h4v6"/><path d="M12 7h4v11"/><path d="M17 14h4v4"/></svg>
                    <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6">
                 <button id="menu-button" class="md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                 </button>
                 <div class="flex items-center">
                    <h1 id="page-title" class="text-xl font-semibold text-gray-700">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                 </div>
                 <div class="flex items-center space-x-4 space-x-reverse">
                     <span id="user-email" class="text-sm text-gray-600 hidden"></span>
                     <button id="logout-btn" class="hidden p-2 rounded-full hover:bg-gray-100" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out text-red-500"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                     </button>
                 </div>
            </header>

            <div class="flex-1 p-6 overflow-y-auto">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Total Revenue - Money Coming In -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between relative group">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
                                    <div class="tooltip-container relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        <div class="tooltip absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØµØ§Ø¯Ø±Ø© (Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„)
                                        </div>
                                    </div>
                                </div>
                                <p id="total-revenue" class="text-3xl font-bold text-green-600">-- Ø¬.Ù…</p>
                            </div>
                            <div class="bg-green-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up text-green-500"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                            </div>
                        </div>

                        <!-- Amount Due - Money Owed to Us -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between relative group">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø¹Ù„ÙŠÙ†Ø§</p>
                                    <div class="tooltip-container relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        <div class="tooltip absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                            Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ù„Ù… ÙŠØ¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¨Ø¹Ø¯ (Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
                                        </div>
                                    </div>
                                </div>
                                <p id="amount-due" class="text-3xl font-bold text-orange-600">-- Ø¬.Ù…</p>
                            </div>
                            <div class="bg-orange-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock text-orange-500"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
                            </div>
                        </div>

                        <!-- Today's Sales - Money Coming In Today -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between relative group">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                                    <div class="tooltip-container relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        <div class="tooltip absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
                                        </div>
                                    </div>
                                </div>
                                <p id="today-sales" class="text-3xl font-bold text-blue-600">-- Ø¬.Ù…</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar text-blue-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            </div>
                        </div>

                        <!-- Active Petty Cash - Money Available -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between relative group">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500">Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù†Ø´Ø·Ø©</p>
                                    <div class="tooltip-container relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        <div class="tooltip absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                            Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù†Ø´Ø·Ø©
                                        </div>
                                    </div>
                                </div>
                                <p id="active-petty-cash-balance" class="text-3xl font-bold text-purple-600">-- Ø¬.Ù…</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet text-purple-500"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="showAddModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                            <button onclick="showAddProductModal()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27,6.96 12,12.01 20.73,6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                            </button>
                            <button onclick="showAddPurchaseModal()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Additional Analytics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                        <!-- Unpaid Invoices Count -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between relative group">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</p>
                                    <div class="tooltip-container relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        <div class="tooltip absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                            Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ø¨Ø¹Ø¯
                                        </div>
                                    </div>
                                </div>
                                <p id="unpaid-invoices" class="text-3xl font-bold text-red-600">--</p>
                            </div>
                            <div class="bg-red-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle text-red-500"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                            </div>
                        </div>
                        
                        <!-- Total Customers -->
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between relative group">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                                    <div class="tooltip-container relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-help-circle text-gray-400 cursor-help"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                                        <div class="tooltip absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap z-10">
                                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ù…
                                        </div>
                                    </div>
                                </div>
                                <p id="total-customers" class="text-3xl font-bold text-yellow-600">--</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users text-yellow-500"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</p>
                                <p id="average-invoice" class="text-3xl font-bold text-purple-600">-- Ø¬.Ù…</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bar-chart text-purple-500"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p>
                                <p id="total-invoices" class="text-3xl font-bold text-indigo-600">--</p>
                            </div>
                            <div class="bg-indigo-100 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text text-indigo-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/></svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-4">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</h2>
                            <canvas id="salesChart"></canvas>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-4">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h2>
                            <canvas id="paymentStatusChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Sales Channel Analytics -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-6">ØªØ­Ù„ÙŠÙ„ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø¨ÙŠØ¹</h2>
                        
                        <!-- Channel Performance Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-blue-600 font-medium">Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ</p>
                                        <p id="store-revenue" class="text-2xl font-bold text-blue-800">-- Ø¬.Ù…</p>
                                        <p id="store-invoices" class="text-sm text-blue-600">-- ÙØ§ØªÙˆØ±Ø©</p>
                                    </div>
                                    <div class="bg-blue-100 p-2 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-store text-blue-600"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-green-600 font-medium">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</p>
                                        <p id="website-revenue" class="text-2xl font-bold text-green-800">-- Ø¬.Ù…</p>
                                        <p id="website-invoices" class="text-sm text-green-600">-- ÙØ§ØªÙˆØ±Ø©</p>
                                    </div>
                                    <div class="bg-green-100 p-2 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe text-green-600"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="2" y2="22"/><path d="M6.35 6.35L17.65 17.65"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-orange-600 font-medium">Ø£Ù…Ø§Ø²ÙˆÙ†</p>
                                        <p id="amazon-revenue" class="text-2xl font-bold text-orange-800">-- Ø¬.Ù…</p>
                                        <p id="amazon-invoices" class="text-sm text-orange-600">-- ÙØ§ØªÙˆØ±Ø©</p>
                                    </div>
                                    <div class="bg-orange-100 p-2 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart text-orange-600"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-purple-600 font-medium">Ù‚Ù†ÙˆØ§Øª Ø£Ø®Ø±Ù‰</p>
                                        <p id="other-revenue" class="text-2xl font-bold text-purple-800">-- Ø¬.Ù…</p>
                                        <p id="other-invoices" class="text-sm text-purple-600">-- ÙØ§ØªÙˆØ±Ø©</p>
                                    </div>
                                    <div class="bg-purple-100 p-2 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-more-horizontal text-purple-600"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Channel Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ù†Ø§Ø©</h3>
                                <canvas id="channelRevenueChart"></canvas>
                            </div>
                            
                            <div class="bg-gray-50 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù‚Ù†Ø§Ø©</h3>
                                <canvas id="channelInvoicesChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Channel Performance Table -->
                        <div class="mt-8">
                            <h3 class="text-lg font-semibold mb-4">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-3 text-right">Ø§Ù„Ù‚Ù†Ø§Ø©</th>
                                            <th class="p-3 text-center">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                                            <th class="p-3 text-center">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                            <th class="p-3 text-center">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                            <th class="p-3 text-center">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                                        </tr>
                                    </thead>
                                    <tbody id="channel-performance-table">
                                        <!-- Channel performance data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Customers and Products -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-4">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                            <div id="top-customers-list" class="space-y-3">
                                <!-- Top customers will be populated here -->
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-lg font-semibold mb-4">Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                            <div id="top-products-list" class="space-y-3">
                                <!-- Top products will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Page -->
                <div id="sales-page" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
                        <div class="flex items-center space-x-4 space-x-reverse">
                            <button id="add-invoice-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                        </div>
                    </div>
                    
                    <!-- Channel Filter Buttons -->
                    <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                        <div class="flex items-center justify-center space-x-2 space-x-reverse">
                            <span class="text-sm font-medium text-gray-700 mr-4">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ù†Ø§Ø©:</span>
                            <button id="filter-all-channels" class="channel-filter-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-blue-500 text-white hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                                Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
                            </button>
                            <button id="filter-amazon" class="channel-filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300" data-channel="Amazon">
                                Amazon
                            </button>
                            <button id="filter-website" class="channel-filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300" data-channel="Website">
                                Website
                            </button>
                            <button id="filter-showroom" class="channel-filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300" data-channel="Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ">
                                Showroom
                            </button>
                        </div>
                    </div>
                    <!-- Search and Filter Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Search Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø«</label>
                                <input type="text" id="invoice-search" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŒ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ù…Ù†ØªØ¬..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Date Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="date-from" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" id="date-to" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Amount Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù†</label>
                                <input type="number" id="amount-from" placeholder="0" step="0.01" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰</label>
                                <input type="number" id="amount-to" placeholder="999999" step="0.01" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Payment Status Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                                <select id="payment-status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                    <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                                    <option value="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                                    <option value="Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
                                    <option value="voided">Ù…Ù„ØºØ§Ø©</option>
                                </select>
                            </div>
                            
                            <!-- Payment Method Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                                <select id="payment-method-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ø±Ù‚</option>
                                    <option value="Ù†Ù‚Ø¯">Ù†Ù‚Ø¯</option>
                                    <option value="Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                                    <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                    <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                                </select>
                            </div>
                            
                            <!-- Sort Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
                                <select id="sort-by" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="createdAt-desc">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
                                    <option value="createdAt-asc">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø§Ù„Ø£Ù‚Ø¯Ù…)</option>
                                    <option value="date-desc">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
                                    <option value="date-asc">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ø£Ù‚Ø¯Ù…)</option>
                                    <option value="total-desc">Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø£ÙƒØ¨Ø±)</option>
                                    <option value="total-asc">Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ù„Ø£ØµØºØ±)</option>
                                    <option value="customer-asc">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£-ÙŠ)</option>
                                    <option value="customer-desc">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (ÙŠ-Ø£)</option>
                                    <option value="manualInvoiceNumber-asc">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø£-ÙŠ)</option>
                                    <option value="manualInvoiceNumber-desc">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠ (ÙŠ-Ø£)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Quick Filter Buttons -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button id="quick-filter-today" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200">Ø§Ù„ÙŠÙˆÙ…</button>
                            <button id="quick-filter-week" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                            <button id="quick-filter-month" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
                            <button id="quick-filter-unpaid" class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm hover:bg-red-200">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</button>
                            <button id="quick-filter-overdue" class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm hover:bg-orange-200">Ù…ØªØ£Ø®Ø±Ø©</button>
                            <button id="quick-filter-high-value" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200">Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù‚ÙŠÙ…Ø©</button>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex justify-between items-center">
                            <div class="flex gap-2">
                                <button id="search-invoices" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Ø¨Ø­Ø«</button>
                                <button id="clear-filters" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
                                <button id="export-invoices" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">ØªØµØ¯ÙŠØ±</button>
                            </div>
                            <div class="text-sm text-gray-600">
                                <span id="search-results-count">0</span> Ù†ØªÙŠØ¬Ø©
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto" id="sales-groups-container">
                        <!-- Grouped invoices will be rendered here -->
                    </div>
                </div>

                <!-- Inventory Page -->
                <div id="inventory-page" class="page hidden">
                   <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
                        <div class="flex gap-2">
                            <button id="add-product-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
                            <button id="delete-all-inventory-btn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Search Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¨Ø­Ø«</label>
                                <input type="text" id="product-search" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ØŒ SKU..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Quantity Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                <input type="number" id="quantity-from" min="0" placeholder="0" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                <input type="number" id="quantity-to" min="0" placeholder="100" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Status Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                                <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                    <option value="in-stock">Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ</option>
                                    <option value="low-stock">Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶</option>
                                    <option value="out-of-stock">Ù†Ø§ÙØ¯</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Price Range -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† Ø§Ù„Ø³Ø¹Ø±</label>
                                <input type="number" id="price-from" step="0.01" min="0" placeholder="0.00" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±</label>
                                <input type="number" id="price-to" step="0.01" min="0" placeholder="1000.00" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <!-- Sort Options -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
                                <select id="product-sort" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="createdAt-desc">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø§Ù„Ø£Ø­Ø¯Ø«)</option>
                                    <option value="createdAt-asc">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ (Ø§Ù„Ø£Ù‚Ø¯Ù…)</option>
                                    <option value="name-asc">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (Ø£-ÙŠ)</option>
                                    <option value="name-desc">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ (ÙŠ-Ø£)</option>
                                    <option value="quantity-desc">Ø§Ù„ÙƒÙ…ÙŠØ© (Ø§Ù„Ø£ÙƒØ«Ø±)</option>
                                    <option value="quantity-asc">Ø§Ù„ÙƒÙ…ÙŠØ© (Ø§Ù„Ø£Ù‚Ù„)</option>
                                    <option value="price-desc">Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ø¹Ù„Ù‰)</option>
                                    <option value="price-asc">Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ù‚Ù„)</option>
                                </select>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex items-end gap-2">
                                <button id="search-products-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 flex-1">Ø¨Ø­Ø«</button>
                                <button id="clear-product-filters-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 flex-1">Ù…Ø³Ø­</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inline Product Creation Form -->
                    <div id="inline-product-form" class="bg-blue-50 p-4 rounded-lg mb-6 hidden">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                        <form id="quick-add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <input id="inline-product-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="px-3 py-2 border rounded-lg focus:outline-none" required>
                            <input id="inline-product-sku" type="text" placeholder="SKU (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ)" class="px-3 py-2 border rounded-lg focus:outline-none" required>
                            <input id="inline-product-quantity" type="number" min="0" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©" class="px-3 py-2 border rounded-lg focus:outline-none" required>
                            <input id="inline-product-website-price" type="number" step="0.01" min="0" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶" class="px-3 py-2 border rounded-lg focus:outline-none" required>
                            <input id="inline-product-amazon-price" type="number" step="0.01" min="0" placeholder="Ø³Ø¹Ø± Ø£Ù…Ø§Ø²ÙˆÙ†" class="px-3 py-2 border rounded-lg focus:outline-none" required>
                            <div class="flex gap-2">
                                <button type="submit" id="save-inline-product-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Ø­ÙØ¸</button>
                                <button type="button" id="cancel-inline-product-btn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="p-3">SKU</th>
                                    <th class="p-3">Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶</th>
                                    <th class="p-3">Ø³Ø¹Ø± Ø£Ù…Ø§Ø²ÙˆÙ†</th>
                                    <th class="p-3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th class="p-3">Ø§Ù„Ù…Ø®Ø²Ù†</th>
                                    <th class="p-3">Ø§Ù„Ù…Ø¹Ø±Ø¶</th>
                                    <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body">
                                <!-- Products will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>


                    <!-- Deleted Items Section -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h3>
                            <button id="refresh-deleted-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded hover:bg-gray-300">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                        <div id="deleted-products-container" class="text-sm text-gray-700">
                            <!-- Deleted products will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Purchases Page -->
                <div id="purchases-page" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
                        <button id="add-purchase-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="p-3">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</th>
                                    <th class="p-3">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</th>
                                    <th class="p-3">Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                                    <th class="p-3">Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                                    <th class="p-3">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th class="p-3">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th class="p-3">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th class="p-3">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                    <th class="p-3">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                                    <th class="p-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="purchases-table-body"></tbody>
                        </table>
                    </div>

                    <!-- Deleted Purchases Section -->
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h3>
                            <button id="refresh-deleted-purchases-btn" class="bg-gray-200 text-gray-800 px-3 py-1 rounded hover:bg-gray-300">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                        <div id="deleted-purchases-list" class="text-sm text-gray-700"></div>
                    </div>
                </div>

                <!-- Stock Out Page -->
                <div id="stock-out-page" class="page hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold">ØµØ±Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
                        <button id="add-stock-out-btn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Ø¥Ø¶Ø§ÙØ© ØµØ±Ù Ø¬Ø¯ÙŠØ¯</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø±Ù‚Ù… Ø§Ù„ØµØ±Ù</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØºØ±Ø¶</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="stock-out-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ±Ù...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Expenses Page -->
                <div id="expenses-page" class="page hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</h2>
                        
                        <!-- Petty Cash Boxes Section -->
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</h3>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button id="create-missing-records-btn" class="bg-green-500 text-white px-3 py-2 rounded-md hover:bg-green-600 text-sm">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</button>
                                    <button id="add-petty-cash-box-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø¬Ø¯ÙŠØ¯</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-50 border-b">
                                        <tr>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="petty-cash-boxes-table-body" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="7" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Employee Petty Cash Management Section -->
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                                <button id="add-employee-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-50 border-b">
                                        <tr>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-table-body" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- All Expenses Section -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                                <button id="add-expense-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-gray-50 border-b">
                                        <tr>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ÙØ¦Ø©</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„ÙˆØµÙ</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ù…ØµØ¯Ø±</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</th>
                                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenses-table-body" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="9" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reports-page" class="page hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold mb-4">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h2>
                        
                        <!-- Report Filters -->
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-lg font-semibold mb-4">ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
                                    <select id="report-type" class="w-full px-3 py-2 border rounded-md focus:outline-none">
                                        <option value="sales">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                                        <option value="inventory">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</option>
                                        <option value="financial">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</option>
                                        <option value="expenses">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„</option>
                                        <option value="customers">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                                        <option value="products">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" id="report-start-date" class="w-full px-3 py-2 border rounded-md focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" id="report-end-date" class="w-full px-3 py-2 border rounded-md focus:outline-none">
                                </div>
                                <div class="flex items-end">
                                    <button id="generate-report-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                        ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Report Content Area -->
                        <div id="report-content" class="bg-white p-6 rounded-lg shadow-md">
                            <div class="text-center text-gray-500 py-8">
                                <svg xmlns="http://www.wwww.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-400">
                                    <path d="M3 3v18h18"/>
                                    <path d="M7 12h4v6"/>
                                    <path d="M12 7h4v11"/>
                                    <path d="M17 14h4v4"/>
                                </svg>
                                <p>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ­Ø¯Ø¯ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other pages remain the same -->

            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <!-- Add New Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="add-product-form" class="mt-4 px-4 py-3 text-right space-y-4">
                    <input id="product-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                    <input id="product-sku" type="text" placeholder="SKU (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ)" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                    <textarea id="product-description" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" rows="3"></textarea>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input id="product-website-price" type="number" step="0.01" min="0" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                        <input id="product-amazon-price" type="number" step="0.01" min="0" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø£Ù…Ø§Ø²ÙˆÙ†" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                    </div>
                    <!-- Quantity Distribution Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</h4>
                        
                        <!-- Total Quantity Field -->
                        <div class="mb-4">
                            <label class="block text-sm text-gray-600 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</label>
                            <input id="product-total-qty" type="number" placeholder="0" min="0" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            <p class="text-xs text-gray-500 mt-1">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ ØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù…Ø¹Ø±Ø¶</p>
                        </div>
                        
                        <!-- Distribution Fields -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†</label>
                                <input id="product-warehouse-qty" type="number" placeholder="0" min="0" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø±Ø¶</label>
                                <input id="product-showroom-qty" type="number" placeholder="0" min="0" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            </div>
                        </div>
                        
                        <!-- Auto-calculation Display -->
                        <div id="quantity-summary" class="mt-3 p-2 bg-blue-50 rounded text-sm text-center hidden">
                            <span class="text-gray-600">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: </span>
                            <span id="calculated-total" class="font-semibold text-blue-600">0</span>
                        </div>
                    </div>
                    
                    <!-- Current Stock Display (only shown when editing existing product) -->
                    <div id="current-stock-display" class="hidden bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Ø§Ù„Ù…Ø®Ø²Ù†:</span>
                                <span id="current-warehouse-qty" class="font-semibold text-blue-600">0</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Ø§Ù„Ù…Ø¹Ø±Ø¶:</span>
                                <span id="current-showroom-qty" class="font-semibold text-green-600">0</span>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="save-product-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬
                    </button>
                     <button id="cancel-product-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add New Purchase Modal -->
    <div id="purchase-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</h3>
                <form id="add-purchase-form" class="mt-4 px-4 py-3 text-right space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="purchase-supplier" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                        <div class="flex flex-col space-y-1">
                            <label for="purchase-date" class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                            <input id="purchase-date" type="date" placeholder="Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex flex-col space-y-1">
                            <label for="purchase-internal-number" class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
                            <input id="purchase-internal-number" type="text" readonly class="w-full px-3 py-2 text-gray-500 bg-gray-100 border rounded-lg focus:outline-none" placeholder="Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <div class="flex flex-col space-y-1">
                            <label for="purchase-supplier-invoice" class="text-sm text-gray-600">Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input id="purchase-supplier-invoice" type="text" placeholder="Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        </div>
                    </div>

                    <hr class="my-2">
                    <h4 class="font-semibold text-gray-800">Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙØ¹</h4>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="flex flex-col space-y-3">
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input id="payment-source-external" type="radio" name="payment-source" value="external" class="w-4 h-4" checked>
                                    <span class="text-sm text-gray-700">Ø¯ÙØ¹ Ø®Ø§Ø±Ø¬ÙŠ</span>
                                </label>
                                <label class="flex items-center space-x-2 space-x-reverse">
                                    <input id="payment-source-petty-cash" type="radio" name="payment-source" value="petty-cash" class="w-4 h-4">
                                    <span class="text-sm text-gray-700">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</span>
                                </label>
                            </div>
                            <div id="petty-cash-selection" class="hidden">
                                <div class="flex items-center justify-between mb-1">
                                    <label for="purchase-petty-cash-box" class="block text-sm text-gray-600">Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</label>
                                    <button type="button" id="refresh-petty-cash-boxes" class="text-xs text-blue-600 hover:text-blue-800 underline">ØªØ­Ø¯ÙŠØ«</button>
                                </div>
                                <select id="purchase-petty-cash-box" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                                    <option value="">Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©...</option>
                                </select>
                                <div id="petty-cash-balance-display" class="mt-2 text-sm text-gray-600 hidden">
                                    <span class="font-semibold">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: </span>
                                    <span id="petty-cash-current-balance">0.00 Ø¬.Ù…</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-2">
                    <h4 class="font-semibold text-gray-800">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex flex-col space-y-1">
                            <label for="purchase-payment-status" class="text-sm text-gray-600">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select id="purchase-payment-status" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                                <option value="" disabled selected>Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</option>
                                <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                                <option value="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                                <option value="Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
                            </select>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <label for="purchase-initial-payment" class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                            <input id="purchase-initial-payment" type="number" step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        </div>
                        <div class="flex flex-col space-y-1">
                            <label for="purchase-payment-method" class="text-sm text-gray-600">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select id="purchase-payment-method" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                                <option value="">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</option>
                                <option value="Ù†Ù‚Ø¯">Ù†Ù‚Ø¯</option>
                                <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                                <option value="Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                                <option value="Ø¢Ø¬Ù„">Ø¢Ø¬Ù„</option>
                            </select>
                        </div>
                    </div>

                    <hr class="my-2">
                    <h4 class="font-semibold text-gray-800">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="flex items-center space-x-2 space-x-reverse">
                            <input id="purchase-vat-enabled" type="checkbox" class="w-4 h-4" checked>
                            <span class="text-sm text-gray-700">ØªØ·Ø¨ÙŠÙ‚ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</span>
                        </label>
                        <div class="flex flex-col space-y-1 md:col-span-2">
                            <label for="purchase-vat-rate" class="text-sm text-gray-600">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
                            <input id="purchase-vat-rate" type="number" step="0.01" min="0" placeholder="14.00" value="14" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        </div>
                    </div>

                    <hr class="my-2">
                    <h4 class="font-semibold text-gray-800">Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡</h4>
                    <div class="text-sm text-gray-600 mb-2">Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ù„ÙƒÙ…ÙŠØ© | Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„ÙˆØ­Ø¯Ø©</div>
                    <div id="purchase-items-container" class="space-y-3 max-h-48 overflow-y-auto pr-2"></div>
                    <button type="button" id="add-purchase-line-btn" class="w-full mt-2 px-4 py-2 text-sm text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>

                    <div class="mt-4 pt-4 border-t space-y-2">
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                            <span id="purchase-subtotal">0.00 Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (VAT):</span>
                            <span id="purchase-vat-amount">0.00 Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between items-center font-bold text-lg">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©):</span>
                            <span id="purchase-calculated-total">0.00 Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                            <span id="purchase-payment-display">0.00 Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                            <span id="purchase-remaining-display">0.00 Ø¬.Ù…</span>
                        </div>
                    </div>
                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md">
                    <button id="save-purchase-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
                    <button id="cancel-purchase-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Allocate Purchase Modal -->
    <div id="allocate-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª: Ù…Ø®Ø²Ù† / Ø¹Ø±Ø¶</h3>
                <div id="allocate-items-container" class="mt-4 px-4 py-3 text-right space-y-3 max-h-72 overflow-y-auto"></div>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4">
                    <button id="confirm-allocation-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
                    <button id="cancel-allocation-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Quick Add Product (from Purchases) Modal -->
    <div id="quick-product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                <form id="quick-product-form" class="mt-4 px-4 py-3 text-right space-y-4">
                    
                    <!-- Product Information Section -->
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-blue-800 mb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="space-y-3">
                    <input id="qp-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                    <input id="qp-sku" type="text" placeholder="SKU (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ)" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                    <textarea id="qp-description" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" rows="2"></textarea>
                            <input id="qp-website-price" type="number" step="0.01" min="0" placeholder="Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                            <input id="qp-amazon-price" type="number" step="0.01" min="0" placeholder="Ø³Ø¹Ø± Ø£Ù…Ø§Ø²ÙˆÙ†" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        </div>
                    </div>

                    <!-- Purchase Details Section -->
                    <div class="bg-green-50 p-3 rounded-lg">
                        <h4 class="text-sm font-semibold text-green-800 mb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©</label>
                                <input id="qp-quantity" type="number" min="0" step="1" placeholder="0" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                    </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                <input id="qp-unit-cost" type="number" step="0.01" min="0" placeholder="0.00" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            </div>
                        </div>
                        <div class="mt-2 p-2 bg-white rounded border">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø·Ø±:</span>
                                <span id="qp-line-total" class="font-semibold text-green-700">0.00 Ø¬.Ù…</span>
                            </div>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡.</p>
                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md">
                    <button id="qp-save-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>
                    <button id="qp-cancel-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribute Stock Modal -->
    <div id="distribute-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                <div class="mt-4 px-4 py-3 text-right space-y-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 id="distribute-product-name" class="font-semibold text-gray-800"></h4>
                        <p class="text-sm text-gray-600">SKU: <span id="distribute-product-sku"></span></p>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†:</span>
                            <span id="distribute-warehouse-available" class="font-semibold text-blue-600"></span>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶:</label>
                            <input id="distribute-to-showroom" type="number" min="0" max="0" value="0" 
                                   class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" 
                                   placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ù‚Ù„Ù‡Ø§">
                            <p class="text-xs text-gray-500 mt-1">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: <span id="distribute-max-qty">0</span></p>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="flex justify-between text-sm">
                                <span>Ø³ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†:</span>
                                <span id="distribute-remaining-warehouse" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span>Ø³ÙŠÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ø¶:</span>
                                <span id="distribute-moving-showroom" class="font-semibold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md">
                    <button id="distribute-save-btn" class="px-4 py-2 bg-purple-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-300">ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
                    <button id="distribute-cancel-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Add New Invoice Modal -->
    <div id="invoice-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-start justify-center py-8 hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white my-4">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <form id="add-invoice-form" class="mt-4 px-4 py-3 text-right space-y-4 max-h-[75vh] overflow-y-auto pr-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input id="customer-name" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                        <div class="flex flex-col space-y-1">
                            <label for="invoice-date" class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                            <input id="invoice-date" type="date" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                        </div>
                        <div class="flex flex-col space-y-1">
                            <label for="manual-invoice-number" class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯)</label>
                            <input id="manual-invoice-number" type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ÙŠØ¯ÙˆÙŠ)" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        </div>
                        <div class="flex flex-col space-y-1">
                            <label for="internal-invoice-number" class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</label>
                            <input id="internal-invoice-number" type="text" readonly class="w-full px-3 py-2 text-gray-500 bg-gray-100 border rounded-lg focus:outline-none" placeholder="Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <select id="sales-channel" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            <option value="" disabled selected>Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ¹</option>
                            <option value="Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ">Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ</option>
                            <option value="Website">Website</option>
                            <option value="Amazon">Amazon</option>
                            <option value="Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡)</option>
                        </select>
                        <select id="payment-method" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            <option value="" disabled selected>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</option>
                            <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
                            <option value="ÙÙŠØ²Ø§">ÙÙŠØ²Ø§</option>
                            <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        </select>
                        <select id="payment-status" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" required>
                            <option value="Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
                            <option value="Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                            <option value="ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                        </select>
                        <input id="paid-amount" type="number" min="0" step="0.01" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        <div class="flex flex-col space-y-1">
                            <label for="paid-at" class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
                            <input id="paid-at" type="date" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                        </div>
                    </div>

                    <textarea id="invoice-description" placeholder="ÙˆØµÙ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." class="w-full mt-2 px-3 py-2 text-gray-700 border rounded-lg focus:outline-none" rows="2"></textarea>

                    <hr class="my-4">
                    <h4 class="font-semibold text-gray-800">Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h4>
                    
                    <div id="invoice-items-container" class="space-y-3 max-h-40 overflow-y-auto pr-2">
                        <!-- Invoice items will be added here dynamically -->
                    </div>

                    <button type="button" id="add-item-btn" class="w-full mt-2 px-4 py-2 text-sm text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200">
                        + Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯
                    </button>
                    
                    <!-- Discount Section -->
                    <div class="mt-4 pt-4 border-t">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex flex-col space-y-2">
                                <label for="invoice-discount" class="text-sm text-gray-600">Ø§Ù„Ø®ØµÙ… (Ø¬.Ù…)</label>
                                <input id="invoice-discount" type="number" min="0" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label for="invoice-discount-percent" class="text-sm text-gray-600">Ø§Ù„Ø®ØµÙ… (%)</label>
                                <input id="invoice-discount-percent" type="number" min="0" max="100" step="0.01" placeholder="0.00" class="w-full px-3 py-2 text-gray-700 border rounded-lg focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t flex justify-between items-center font-bold text-lg">
                        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                        <span id="invoice-calculated-total">0.00 Ø¬.Ù…</span>
                    </div>

                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md sticky bottom-0 border-t">
                    <button id="save-invoice-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    </button>
                     <button id="cancel-invoice-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Invoice Details Modal -->
    <div id="view-invoice-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center border-b pb-3">
                 <h3 class="text-lg leading-6 font-medium text-gray-900">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                 <button id="close-view-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                 </button>
            </div>
            <div id="view-invoice-content" class="mt-4 px-4 py-3 text-right space-y-4">
                <!-- Invoice details will be populated here -->
            </div>
             <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4">
                <button id="print-invoice-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                </button>
            </div>
        </div>
    </div>

    <!-- Print Type Selection Modal -->
    <div id="print-type-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center mb-4">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</h3>
                <div class="space-y-3">
                    <button id="print-customer-btn" class="w-full px-4 py-3 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„
                    </button>
                    <button id="print-company-btn" class="w-full px-4 py-3 bg-green-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø´Ø±ÙƒØ©
                    </button>
                    <button id="cancel-print-type-btn" class="w-full px-4 py-3 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Printable Invoice Modal -->
    <div id="printable-invoice-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div id="invoice-to-print" class="p-8">
                <!-- Invoice Header -->
                <div class="text-center mb-6">
                    <h1 id="print-invoice-title" class="text-2xl font-bold">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
                    <p id="print-invoice-id" class="text-gray-600 mt-2"></p>
                    <p id="print-invoice-date" class="text-gray-600"></p>
                </div>
                
                <!-- Order Source (for company print only) -->
                <div id="order-source-info" class="mt-4 hidden">
                    <h3 class="font-semibold mb-2">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ù„Ø¨:</h3>
                    <p id="print-order-source" class="text-gray-700"></p>
                </div>
                
                <!-- Customer Info -->
                <div class="mt-6">
                    <h3 class="font-semibold mb-2">Ø§Ù„Ø¹Ù…ÙŠÙ„:</h3>
                    <p id="print-customer-name" class="text-gray-700"></p>
                </div>
                
                
                <!-- Invoice Table -->
                <div class="mt-6">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Product/Service</th>
                                <th class="p-2 text-center">Quantity</th>
                                <th class="p-2 text-center">Unit Price</th>
                                <th class="p-2 text-center company-column hidden">Cost Price</th>
                                <th class="p-2 text-center company-column hidden">Profit</th>
                                <th class="p-2 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="print-invoice-items">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Invoice Total -->
                <div class="mt-6 flex justify-end">
                    <div class="w-1/2 sm:w-1/3 space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="print-invoice-subtotal"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Discount:</span>
                            <span id="print-invoice-discount"></span>
                        </div>
                        <div class="flex justify-between border-t-2 pt-2">
                            <span class="font-bold">Total Amount:</span>
                            <span id="print-invoice-total" class="font-bold"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Company Totals (for company print only) -->
                <div id="company-totals" class="mt-6 hidden">
                    <div class="flex justify-end">
                        <div class="w-1/2 sm:w-1/3 space-y-2">
                            <div class="flex justify-between">
                                <span>Total Cost:</span>
                                <span id="print-total-cost"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total Profit:</span>
                                <span id="print-total-profit"></span>
                            </div>
                            <div class="flex justify-between border-t pt-2 font-bold">
                                <span>Net Amount:</span>
                                <span id="print-net-amount"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Action Buttons -->
             <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse no-print">
                <button id="execute-print-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Ø·Ø¨Ø§Ø¹Ø©
                </button>
                 <button id="close-print-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- View Purchase Modal -->
    <div id="view-purchase-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Ø¹Ø±Ø¶ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
                <button id="close-view-purchase-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="view-purchase-content" class="mt-4 px-4 py-3 text-right space-y-4 overflow-y-auto max-h-[70vh]">
                <!-- Purchase details will be populated here -->
            </div>
             <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4">
                <button id="print-purchase-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡
                </button>
            </div>
        </div>
    </div>

    <!-- Printable Purchase Invoice Modal -->
    <div id="printable-purchase-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div id="purchase-to-print" class="p-8 overflow-y-auto max-h-[70vh]">
                <!-- Purchase Invoice Header -->
                <div class="flex justify-end text-right border-b pb-4">
                    <div>
                        <h2 class="text-2xl font-bold">ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</h2>
                        <p id="print-purchase-id" class="text-gray-600"></p>
                        <p id="print-purchase-date" class="text-gray-600"></p>
                        <p id="print-purchase-supplier-invoice" class="text-gray-600"></p>
                    </div>
                </div>
                <!-- Supplier Info -->
                <div class="mt-6">
                    <h3 class="font-semibold">Ø§Ù„Ù…ÙˆØ±Ø¯:</h3>
                    <p id="print-supplier-name" class="text-gray-700"></p>
                </div>
                <!-- Payment Info -->
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</h4>
                        <p id="print-payment-status" class="text-gray-700"></p>
                    </div>
                    <div>
                        <h4 class="font-semibold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</h4>
                        <p id="print-payment-method" class="text-gray-700"></p>
                    </div>
                </div>
                <!-- Purchase Items Table -->
                <div class="mt-6">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-right">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th class="p-2 text-center">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th class="p-2 text-left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody id="print-purchase-items">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
                <!-- Purchase Totals -->
                <div class="mt-6 flex justify-end">
                    <div class="w-1/2 sm:w-1/3 space-y-2">
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                            <span id="print-purchase-subtotal"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                            <span id="print-purchase-vat"></span>
                        </div>
                        <div class="flex justify-between border-t-2 pt-2">
                            <span class="font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                            <span id="print-purchase-total" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                            <span id="print-purchase-paid"></span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="font-bold">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                            <span id="print-purchase-remaining" class="font-bold"></span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Action Buttons -->
             <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse no-print">
                <button id="execute-purchase-print-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    Ø·Ø¨Ø§Ø¹Ø©
                </button>
                 <button id="close-purchase-print-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Stock Out Modal -->
    <div id="stock-out-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© ØµØ±Ù Ù…Ø®Ø²ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3>
                <form id="add-stock-out-form" class="mt-4 px-4 py-3 text-right space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„ØµØ±Ù</label>
                            <input type="text" id="stock-out-number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 bg-gray-50 font-semibold text-gray-800" readonly placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù‚Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="stock-out-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
                            <input type="text" id="stock-out-employee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø§Ù„Ø´Ø®Øµ" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</label>
                            <input type="text" id="stock-out-approved-by" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹ØªÙ…Ø¯" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØºØ±Ø¶ / Ø§Ù„Ø³Ø¨Ø¨</label>
                        <textarea id="stock-out-reason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø´Ø±ÙˆØ¹ØŒ ØµÙŠØ§Ù†Ø©ØŒ ØªØ³Ù„ÙŠÙ…ØŒ Ø¥Ù„Ø®" required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØµØ±ÙÙ‡Ø§</label>
                        <div id="stock-out-items-container" class="space-y-3">
                            <!-- Items will be added here dynamically -->
                        </div>
                        <button type="button" id="add-stock-out-item-btn" class="mt-2 bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                    </div>
                    
                    <div class="flex justify-end space-x-3 space-x-reverse pt-4">
                        <button type="button" id="cancel-stock-out-btn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Ø¥Ù„ØºØ§Ø¡</button>
                        <button type="submit" id="save-stock-out-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Ø­ÙØ¸ Ø§Ù„ØµØ±Ù</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Stock Out Modal -->
    <div id="view-stock-out-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">ØªÙØ§ØµÙŠÙ„ ØµØ±Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                    <div class="flex space-x-2 space-x-reverse">
                        <button id="void-stock-out-btn" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                        <button id="print-stock-out-btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button id="close-view-stock-out-btn" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
                <div id="view-stock-out-content" class="mt-4">
                    <!-- Content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Printable Stock Out Modal -->
    <div id="printable-stock-out-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Ø·Ø¨Ø§Ø¹Ø© ØµØ±Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                <div class="flex space-x-2 space-x-reverse no-print">
                    <button id="execute-stock-out-print-btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button id="close-stock-out-print-modal-btn" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
            <div id="stock-out-to-print" class="p-8 bg-white">
                <!-- Printable content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Petty Cash Box Modal (Create New Box) -->
    <div id="petty-cash-box-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯</h3>
                <form id="add-petty-cash-box-form" class="mt-4 px-4 py-3 text-right space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
                        <input type="text" id="box-name" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù‡Ø¯Ø© Ø£ÙƒØªÙˆØ¨Ø± 2025" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Ø¬.Ù…)</label>
                        <input type="number" id="box-initial-amount" placeholder="2000" step="0.01" min="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div id="add-money-div" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº (Ø¬.Ù…)</label>
                        <input type="number" id="box-additional-amount" placeholder="500" step="0.01" min="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <p class="text-sm text-gray-600 mt-1">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                        <input type="date" id="box-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="save-petty-cash-box-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        ÙØªØ­ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                    </button>
                    <button id="cancel-petty-cash-box-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Petty Cash Box Modal -->
    <div id="view-petty-cash-box-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">ØªÙØ§ØµÙŠÙ„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</h3>
                    <button id="close-view-box-modal-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Box Information -->
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚:</label>
                            <p id="view-box-name" class="font-semibold text-gray-800"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ:</label>
                            <p id="view-box-initial-amount" class="font-semibold text-gray-800"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                            <p id="view-box-current-balance" class="font-semibold text-green-600"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                            <p id="view-box-start-date" class="font-semibold text-gray-800"></p>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                            <p id="view-box-status" class="font-semibold"></p>
                        </div>
                        <div id="view-box-end-date-container" class="hidden">
                            <label class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØºÙ„Ø§Ù‚:</label>
                            <p id="view-box-end-date" class="font-semibold text-gray-800"></p>
                        </div>
                    </div>
                </div>

                <!-- Transactions List (Expenses + Deposits) -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-md font-semibold text-gray-800">Ø­Ø±ÙƒØ§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</h4>
                        <button id="add-expense-to-box-btn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                            Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-2 text-right">Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th class="p-2 text-right">Ø§Ù„ÙØ¦Ø©</th>
                                    <th class="p-2 text-right">Ø§Ù„ÙˆØµÙ</th>
                                    <th class="p-2 text-left">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th class="p-2 text-right">Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ø¹Ø¯</th>
                                    <th class="p-2 text-right">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="view-box-expenses-list">
                                <!-- Expenses will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="view-box-no-expenses" class="text-center text-gray-500 py-4 hidden">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-2 space-x-reverse mt-4">
                    <button id="close-box-btn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="expense-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="add-expense-form" class="mt-4 px-4 py-3 text-right space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙØ¦Ø©</label>
                        <select id="expense-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©...</option>
                            <option value="advance">Ø³Ù„ÙØ©</option>
                            <option value="financial-aid">Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø§Ù„ÙŠØ©</option>
                            <option value="office-supplies">Ù„ÙˆØ§Ø²Ù… Ù…ÙƒØªØ¨ÙŠØ©</option>
                            <option value="transportation">Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                            <option value="meals">ÙˆØ¬Ø¨Ø§Øª</option>
                            <option value="maintenance">ØµÙŠØ§Ù†Ø©</option>
                            <option value="utilities">Ù…Ø±Ø§ÙÙ‚</option>
                            <option value="cleaning">Ù†Ø¸Ø§ÙØ©</option>
                            <option value="communication">Ø§ØªØµØ§Ù„Ø§Øª</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                            <option value="add-new-category">+ Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
                        </select>
                    </div>
                    <div id="custom-category-div" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="text" id="custom-category-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³Ø§Ø¹Ø¯Ø© Ø·Ø¨ÙŠØ©ØŒ Ø¥ØµÙ„Ø§Ø­Ø§ØªØŒ Ø¥Ù„Ø®...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙØ¹</label>
                        <select id="expense-source" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                            <option value="">Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙØ¹...</option>
                            <option value="petty-cash">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</option>
                            <option value="company-paid">Ø¯ÙØ¹ Ø§Ù„Ø´Ø±ÙƒØ©</option>
                        </select>
                    </div>
                    <div id="box-selection-div" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</label>
                        <select id="expense-box-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©...</option>
                        </select>
                    </div>
                    <div id="employee-selection-div" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…ÙˆØ¸Ù</label>
                        <select id="expense-employee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ÙˆØµÙ</label>
                        <textarea id="expense-description" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" rows="3" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)</label>
                        <input type="number" id="expense-amount" placeholder="150.00" step="0.01" min="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" id="expense-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div id="expense-balance-info" class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-blue-800">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                            <span id="current-balance-display" class="text-sm font-semibold text-blue-900">0.00 Ø¬.Ù…</span>
                        </div>
                        <div id="remaining-balance-display" class="hidden mt-2 flex justify-between items-center">
                            <span class="text-sm text-green-800">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                            <span id="remaining-balance-amount" class="text-sm font-semibold text-green-900">0.00 Ø¬.Ù…</span>
                        </div>
                    </div>
                    <div id="employee-balance-info" class="hidden p-3 bg-green-50 border border-green-200 rounded-md">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-green-800">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                            <span id="employee-weekly-limit-display" class="text-sm font-semibold text-green-900">500.00 Ø¬.Ù…</span>
                        </div>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-sm text-orange-800">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span>
                            <span id="requested-amount-display" class="text-sm font-semibold text-orange-900">0.00 Ø¬.Ù…</span>
                        </div>
                        <div id="employee-remaining-after" class="hidden mt-2 flex justify-between items-center">
                            <span class="text-sm text-blue-800">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ:</span>
                            <span id="employee-remaining-amount" class="text-sm font-semibold text-blue-900">0.00 Ø¬.Ù…</span>
                        </div>
                    </div>
                    <div id="expense-balance-warning" class="hidden p-3 bg-red-50 border border-red-200 rounded-md">
                        <p class="text-sm text-red-800">âš ï¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</p>
                    </div>
                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="save-expense-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ
                    </button>
                    <button id="cancel-expense-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="employee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
                <form id="add-employee-form" class="mt-4 px-4 py-3 text-right space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
                        <input type="text" id="employee-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø¬.Ù…)</label>
                        <input type="number" id="employee-weekly-limit" placeholder="500.00" step="0.01" min="0" value="500" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ù…Ù†ØµØ¨</label>
                        <input type="text" id="employee-position" placeholder="Ø§Ù„Ù…Ù†ØµØ¨..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="employee-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                </form>
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="save-employee-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù
                    </button>
                    <button id="cancel-employee-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product View Modal -->
    <div id="product-view-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>
                
                <!-- Product Information Section -->
                <div class="mt-4 px-4 py-3">
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-blue-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
                                <p id="view-product-name" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">SKU:</label>
                                <p id="view-product-sku" class="font-semibold text-gray-800"></p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm text-gray-600">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬:</label>
                                <p id="view-product-description" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹/Ø§Ù„Ù…Ø¹Ø±Ø¶:</label>
                                <p id="view-product-website-price" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø³Ø¹Ø± Ø£Ù…Ø§Ø²ÙˆÙ†:</label>
                                <p id="view-product-amazon-price" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Current Stock Section -->
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-green-800 mb-3">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
                                <p id="view-product-total-qty" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…Ø®Ø²Ù†:</label>
                                <p id="view-product-warehouse-qty" class="font-semibold text-blue-600"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…Ø¹Ø±Ø¶:</label>
                                <p id="view-product-showroom-qty" class="font-semibold text-green-600"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Purchase History Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-md font-semibold text-gray-800">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h4>
                            <div class="flex space-x-2 space-x-reverse">
                                <select id="history-sort-select" class="text-sm border rounded px-2 py-1">
                                    <option value="date-desc">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                                    <option value="date-asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                                    <option value="supplier">Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯</option>
                                    <option value="price-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±</option>
                                    <option value="price-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø±</option>
                                </select>
                                <input type="text" id="history-filter-input" placeholder="ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ±Ø¯..." class="text-sm border rounded px-2 py-1 w-32">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-right cursor-pointer hover:bg-gray-200" data-sort="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th class="p-2 text-right cursor-pointer hover:bg-gray-200" data-sort="supplier">Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                                        <th class="p-2 text-center cursor-pointer hover:bg-gray-200" data-sort="invoice">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                        <th class="p-2 text-center cursor-pointer hover:bg-gray-200" data-sort="quantity">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th class="p-2 text-center cursor-pointer hover:bg-gray-200" data-sort="price">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                        <th class="p-2 text-left cursor-pointer hover:bg-gray-200" data-sort="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th class="p-2 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="view-product-purchase-history">
                                    <!-- Purchase history will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="view-product-no-history" class="text-center text-gray-500 py-4 hidden">
                            Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬
                        </div>
                        <div id="view-product-filtered-empty" class="text-center text-gray-500 py-4 hidden">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="close-product-view-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Details Modal -->
    <div id="expense-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
                
                <!-- Expense Information Section -->
                <div class="mt-4 px-4 py-3">
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-blue-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„ÙØ¦Ø©:</label>
                                <p id="print-expense-category" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
                                <p id="print-expense-amount" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                                <p id="print-expense-date" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙØ¹:</label>
                                <p id="print-expense-source" class="font-semibold text-gray-800"></p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="text-sm text-gray-600">Ø§Ù„ÙˆØµÙ:</label>
                                <p id="print-expense-description" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Employee and Box Information Section -->
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-green-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ØµÙ†Ø¯ÙˆÙ‚</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                                <p id="print-expense-employee" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©:</label>
                                <p id="print-expense-box" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Accounting Information Section -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</label>
                                <p id="print-expense-created" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</label>
                                <p id="print-expense-updated" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="print-expense-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button id="close-expense-details-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Printable Expense Modal -->
    <div id="printable-expense-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h3>
                    <div class="flex space-x-2 space-x-reverse no-print">
                        <button id="execute-expense-print-btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button id="close-expense-print-modal-btn" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
                <div id="expense-to-print" class="p-8 bg-white overflow-y-auto max-h-[70vh]">
                    <!-- Expense details will be populated here for printing -->
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Details Modal -->
    <div id="purchase-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 no-print">
        <div class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
                
                <!-- Purchase Information Section -->
                <div class="mt-4 px-4 py-3">
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-blue-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</label>
                                <p id="print-purchase-internal-number" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                                <p id="print-purchase-invoice-number" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                                <p id="print-purchase-details-date" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                                <p id="print-purchase-supplier" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                                <p id="print-purchase-payment-method" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                                <p id="print-purchase-payment-status" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                                <p id="print-purchase-receive-status" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <p id="print-purchase-status" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Information Section -->
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-green-800 mb-3">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label>
                                <p id="print-purchase-total" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</label>
                                <p id="print-purchase-paid" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
                                <p id="print-purchase-remaining" class="font-semibold text-gray-800"></p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</label>
                                <p id="print-purchase-tax" class="font-semibold text-gray-800"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-gray-800 mb-3">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
                        <div id="print-purchase-items" class="overflow-x-auto">
                            <!-- Items will be populated here -->
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="text-md font-semibold text-yellow-800 mb-3">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h4>
                        <div>
                            <label class="text-sm text-gray-600">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                            <p id="print-purchase-notes" class="font-semibold text-gray-800"></p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="items-center px-4 py-3 bg-gray-50 rounded-b-md mt-4 flex space-x-2 space-x-reverse">
                    <button id="print-purchase-details-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button id="close-purchase-details-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Ø¥ØºÙ„Ø§Ù‚
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Printable Purchase Details Modal -->
    <div id="printable-purchase-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡</h3>
                    <div class="flex space-x-2 space-x-reverse no-print">
                        <button id="execute-purchase-details-print-btn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button id="close-purchase-details-print-modal-btn" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600 text-sm">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
                <div id="purchase-details-to-print" class="p-8 bg-white overflow-y-auto max-h-[70vh]">
                    <!-- Purchase details will be populated here for printing -->
                </div>
            </div>
        </div>
    </div>


<script type="module">
    // --- Firebase SDKs and Initialization ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, doc, setDoc, getDoc, runTransaction, where, increment, serverTimestamp, updateDoc, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    
    document.addEventListener('DOMContentLoaded', function () {
        let db, auth;
        let firebaseInitialized = false;

        try {
            // Fallback for development/testing if environment variable is missing
            const fallbackConfig = {
                apiKey: "AIzaSyBFOjq_liHPg2qNrCoGj-RGa3pzDWPEeho",
                authDomain: "art-shop-76a17.firebaseapp.com",
                projectId: "art-shop-76a17",
                storageBucket: "art-shop-76a17.firebasestorage.app", // Corrected this line
                messagingSenderId: "17746176869",
                appId: "1:17746176869:web:c1df07adbdfba0721dcf8c",
                measurementId: "G-LRNYSQM223"
            };

            let firebaseConfig;
            const configFromEnv = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

            if (typeof configFromEnv === 'string' && configFromEnv.trim().startsWith('{')) {
                firebaseConfig = JSON.parse(configFromEnv);
            } else if (typeof configFromEnv === 'object' && configFromEnv !== null && configFromEnv.projectId) {
                firebaseConfig = configFromEnv;
            } else {
                console.warn("Canvas environment variable '__firebase_config' not found or invalid. Using fallback config.");
                firebaseConfig = fallbackConfig;
            }
            
            if (!firebaseConfig.projectId) {
               throw new Error("Firebase config is not loaded or projectId is missing.");
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            const body = document.querySelector('body');
            const errorDiv = document.createElement('div');
            errorDiv.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.';
            errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; background-color: #ef4444; color: white; text-align: center; padding: 10px; z-index: 9999;';
            body.prepend(errorDiv);
        }

        // --- GLOBAL STATE ---
        let invoiceData = {};
        let productsCache = []; // To store products for dropdowns
        
        // PDF Generation State
        let pdfSerialCounter = 0;
        let pdfSerialCounterKey = 'pdfSerialCounter';
        
        // Initialize PDF serial counter from localStorage
        function initializePdfSerialCounter() {
            const saved = localStorage.getItem(pdfSerialCounterKey);
            pdfSerialCounter = saved ? parseInt(saved) : 0;
        }
        
        // Increment and save PDF serial counter
        function getNextPdfSerial() {
            pdfSerialCounter++;
            localStorage.setItem(pdfSerialCounterKey, pdfSerialCounter.toString());
            console.log('PDF Serial Counter:', pdfSerialCounter);
            return pdfSerialCounter;
        }
        
        // Generate PDF from HTML element
        async function generatePDF(elementId, filename) {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.error('Element not found:', elementId);
                    return;
                }
                
                // Use html2canvas to capture the element
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });
                
                // Create PDF
                if (!window.jspdf) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                console.log('Creating PDF with filename:', filename);
                
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                // Add image to PDF
                pdf.addImage(canvas, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add new pages if content is longer than one page
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(canvas, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Validate filename
                if (!filename || filename.trim() === '') {
                    throw new Error('Invalid filename provided');
                }
                
                // Save the PDF with the custom filename
                pdf.save(filename);
                
                console.log('PDF generated successfully:', filename);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF: ' + error.message);
            }
        }
        
        // Initialize PDF counter on page load
        initializePdfSerialCounter();

        // --- UI Elements ---
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailEl = document.getElementById('user-email');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const authErrorDiv = document.getElementById('auth-error');
        const salesGroupsContainer = document.getElementById('sales-groups-container');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        
        // Search and Filter Elements
        const invoiceSearch = document.getElementById('invoice-search');
        const dateFrom = document.getElementById('date-from');
        const dateTo = document.getElementById('date-to');
        const amountFrom = document.getElementById('amount-from');
        const amountTo = document.getElementById('amount-to');
        const paymentStatusFilter = document.getElementById('payment-status-filter');
        const paymentMethodFilter = document.getElementById('payment-method-filter');
        const sortBy = document.getElementById('sort-by');
        const searchInvoicesBtn = document.getElementById('search-invoices');
        const clearFiltersBtn = document.getElementById('clear-filters');
        const exportInvoicesBtn = document.getElementById('export-invoices');
        const searchResultsCount = document.getElementById('search-results-count');
        
        // Inventory Search and Filter Elements
        const productSearch = document.getElementById('product-search');
        const quantityFrom = document.getElementById('quantity-from');
        const quantityTo = document.getElementById('quantity-to');
        const statusFilter = document.getElementById('status-filter');
        const priceFrom = document.getElementById('price-from');
        const priceTo = document.getElementById('price-to');
        const productSort = document.getElementById('product-sort');
        const searchProductsBtn = document.getElementById('search-products-btn');
        const clearProductFiltersBtn = document.getElementById('clear-product-filters-btn');
        
        // Quick Filter Buttons
        const quickFilterToday = document.getElementById('quick-filter-today');
        const quickFilterWeek = document.getElementById('quick-filter-week');
        const quickFilterMonth = document.getElementById('quick-filter-month');
        const quickFilterUnpaid = document.getElementById('quick-filter-unpaid');
        const quickFilterOverdue = document.getElementById('quick-filter-overdue');
        const quickFilterHighValue = document.getElementById('quick-filter-high-value');
        
        // --- AUTH FUNCTIONS ---
        const createUserProfileDocument = async (user) => {
            if (!db || !user) return;
            const userRef = doc(db, "users", user.uid);
            try {
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    const { email, uid } = user;
                    const createdAt = new Date();
                    await setDoc(userRef, { uid, email, createdAt, role: 'user' });
                    console.log(`Created user profile for ${email}`);
                }
            } catch (error) {
                console.error("Error creating user profile:", error);
            }
        };

        // --- SEARCH AND FILTER FUNCTIONS ---
        const applySearchFilters = (invoices) => {
            let filtered = [...invoices];
            
            // Text search
            if (currentSearchFilters.searchText) {
                const searchText = currentSearchFilters.searchText.toLowerCase();
                filtered = filtered.filter(invoice => {
                    const invoiceData = invoice.invoice;
                    const searchableText = [
                        invoiceData.manualInvoiceNumber || '',
                        invoiceData.customer || '',
                        invoiceData.description || '',
                        invoiceData.invoiceNumber || '',
                        ...(invoiceData.items || []).map(item => item.productName || '')
                    ].join(' ').toLowerCase();
                    return searchableText.includes(searchText);
                });
            }
            
            // Date range filter
            if (currentSearchFilters.dateFrom) {
                filtered = filtered.filter(invoice => {
                    const invoiceDate = new Date(invoice.invoice.date);
                    const fromDate = new Date(currentSearchFilters.dateFrom);
                    return invoiceDate >= fromDate;
                });
            }
            
            if (currentSearchFilters.dateTo) {
                filtered = filtered.filter(invoice => {
                    const invoiceDate = new Date(invoice.invoice.date);
                    const toDate = new Date(currentSearchFilters.dateTo);
                    toDate.setHours(23, 59, 59, 999); // Include the entire day
                    return invoiceDate <= toDate;
                });
            }
            
            // Amount range filter
            if (currentSearchFilters.amountFrom) {
                filtered = filtered.filter(invoice => {
                    const total = Number(invoice.invoice.total || 0);
                    return total >= Number(currentSearchFilters.amountFrom);
                });
            }
            
            if (currentSearchFilters.amountTo) {
                filtered = filtered.filter(invoice => {
                    const total = Number(invoice.invoice.total || 0);
                    return total <= Number(currentSearchFilters.amountTo);
                });
            }
            
            // Payment status filter
            if (currentSearchFilters.paymentStatus) {
                // Always exclude voided invoices from search results
                filtered = filtered.filter(invoice => 
                    !invoice.invoice.voided && 
                    (invoice.invoice.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') === currentSearchFilters.paymentStatus
                );
            } else {
                // If no payment status filter, still exclude voided invoices
                filtered = filtered.filter(invoice => !invoice.invoice.voided);
            }
            
            // Payment method filter
            if (currentSearchFilters.paymentMethod) {
                filtered = filtered.filter(invoice => 
                    invoice.invoice.paymentMethod === currentSearchFilters.paymentMethod
                );
            }
            
            // Channel filter
            if (currentSearchFilters.channel) {
                filtered = filtered.filter(invoice => 
                    invoice.invoice.channel === currentSearchFilters.channel
                );
            }
            
            // Sort
            filtered.sort((a, b) => {
                const [field, direction] = currentSearchFilters.sortBy.split('-');
                let aValue, bValue;
                
                switch (field) {
                    case 'createdAt':
                        aValue = a.invoice.createdAt?.toDate ? a.invoice.createdAt.toDate() : new Date(a.invoice.createdAt);
                        bValue = b.invoice.createdAt?.toDate ? b.invoice.createdAt.toDate() : new Date(b.invoice.createdAt);
                        break;
                    case 'date':
                        aValue = new Date(a.invoice.date);
                        bValue = new Date(b.invoice.date);
                        break;
                    case 'total':
                        aValue = Number(a.invoice.total || 0);
                        bValue = Number(b.invoice.total || 0);
                        break;
                    case 'customer':
                        aValue = (a.invoice.customer || '').toLowerCase();
                        bValue = (b.invoice.customer || '').toLowerCase();
                        break;
                    case 'manualInvoiceNumber':
                        // Handle manual invoice number sorting (alphanumeric)
                        aValue = (a.invoice.manualInvoiceNumber || '').toLowerCase();
                        bValue = (b.invoice.manualInvoiceNumber || '').toLowerCase();
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                } else {
                    return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                }
            });
            
            return filtered;
        };
        
        // Pagination state
        let currentInvoicePage = {};
        const INVOICES_PER_PAGE = 25; // Show 25 invoices per group initially
        
        const displayFilteredInvoices = (invoices, page = {}) => {
            if (!salesGroupsContainer) return;
            
            salesGroupsContainer.innerHTML = '';
            invoiceData = {};
            
            if (invoices.length === 0) {
                salesGroupsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</div>';
                if (searchResultsCount) searchResultsCount.textContent = '0';
                return;
            }
            
            // Store invoice data
            invoices.forEach(({ id, invoice }) => {
                invoiceData[id] = invoice;
            });
            
            // Group invoices
            const groups = [
                { key: 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹', title: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©' },
                { key: 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹', title: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹' },
                { key: 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', title: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' },
            ];
            const grouped = { 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹': [], 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹': [], 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„': [] };
            
            invoices.forEach(({ id: invoiceId, invoice }) => {
                // Additional safety check: skip voided invoices
                if (invoice.voided) {
                    return; // Skip voided invoices completely
                }
                grouped[invoice.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'].push({ id: invoiceId, invoice });
            });
            
            // Display grouped invoices with pagination
            groups.forEach(group => {
                const list = grouped[group.key] || [];
                if (list.length === 0) return;
                
                // Get current page for this group
                const groupPage = page[group.key] || currentInvoicePage[group.key] || 1;
                const startIndex = (groupPage - 1) * INVOICES_PER_PAGE;
                const endIndex = startIndex + INVOICES_PER_PAGE;
                const displayedList = list.slice(startIndex, endIndex);
                const totalPages = Math.ceil(list.length / INVOICES_PER_PAGE);
                
                const section = document.createElement('div');
                section.className = 'mb-8';
                section.innerHTML = `
                    <div class="section-header flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                            <span class="w-1 h-6 bg-gradient-to-b from-blue-500 to-indigo-600 rounded-full"></span>
                            ${group.title}
                        </h3>
                        <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">${list.length} ÙØ§ØªÙˆØ±Ø© (Ø¹Ø±Ø¶ ${startIndex + 1}-${Math.min(endIndex, list.length)} Ù…Ù† ${list.length})</span>
                    </div>
                    <div class="border-t border-gray-200 mb-4"></div>
                    <div class="overflow-x-auto">
                        <table class="invoice-table w-full text-right shadow-sm rounded-lg overflow-hidden">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b-2 border-gray-200">
                                <tr>
                                    <th class="p-4 w-12 text-center font-semibold text-gray-700">#</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø§Ù„ÙˆØµÙ</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="p-4 font-semibold text-gray-700">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody class="group-body bg-white"></tbody>
                        </table>
                    </div>
                    ${totalPages > 1 ? `
                        <div class="mt-4 flex justify-center items-center gap-2 pagination-controls" data-group="${group.key}">
                            <button class="px-3 py-1 border rounded-md ${groupPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}" 
                                    ${groupPage === 1 ? 'disabled' : ''} 
                                    onclick="loadInvoicePage('${group.key}', ${groupPage - 1})">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                            <span class="px-4 py-1 text-gray-700">ØµÙØ­Ø© ${groupPage} Ù…Ù† ${totalPages}</span>
                            <button class="px-3 py-1 border rounded-md ${groupPage >= totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'}" 
                                    ${groupPage >= totalPages ? 'disabled' : ''} 
                                    onclick="loadInvoicePage('${group.key}', ${groupPage + 1})">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                        </div>
                    ` : ''}
                `;
                const tbody = section.querySelector('.group-body');
                displayedList.forEach(({ id: invoiceId, invoice }, index) => {
                    if (!invoice) {
                        console.warn('Invoice data is undefined for ID:', invoiceId);
                        return;
                    }
                    
                    const tr = document.createElement('tr');
                    tr.className = 'invoice-row border-b transition-all duration-300 ease-in-out hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 hover:shadow-md hover:scale-[1.01] hover:border-blue-200 fade-in';
                    
                    const shortId = invoiceId ? invoiceId.substring(0, 8).toUpperCase() : 'UNKNOWN';
                    const truncatedDescription = invoice.description && invoice.description.length > 30 ? invoice.description.substring(0, 30) + '...' : invoice.description;
                    
                    // Enhanced status labels with better contrast and icons
                    let statusLabel, statusIcon, statusBgColor, statusTextColor;
                    if (invoice.paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„') {
                        statusLabel = 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                        statusIcon = 'âœ“';
                        statusBgColor = 'bg-emerald-100';
                        statusTextColor = 'text-emerald-800';
                    } else if (invoice.paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') {
                        statusLabel = 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
                        statusIcon = 'âš ';
                        statusBgColor = 'bg-amber-100';
                        statusTextColor = 'text-amber-800';
                    } else {
                        statusLabel = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                        statusIcon = 'â°';
                        statusBgColor = 'bg-red-100';
                        statusTextColor = 'text-red-800';
                    }
                    
                    const statusBadge = `<span class="status-badge ${statusBgColor} ${statusTextColor} px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 w-fit">${statusIcon} ${statusLabel}</span>`;
                    
                    // Voided invoices are now deleted, so no need for voided display logic
                    const amountDue = (invoice.amountDue != null ? Number(invoice.amountDue) : Math.max(0, Number(invoice.total||0) - Number(invoice.paidAmount||0))).toFixed(2);
                    const displayNumber = invoice.manualInvoiceNumber || shortId;
                    
                    // Check if invoice is overdue (more than 30 days old and unpaid)
                    const invoiceDate = new Date(invoice.date);
                    const daysDiff = Math.floor((new Date() - invoiceDate) / (1000 * 60 * 60 * 24));
                    const isOverdue = daysDiff > 30 && invoice.paymentStatus !== 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                    const overdueClass = isOverdue ? 'bg-red-50 border-l-4 border-red-400' : '';
                    const priorityIcon = isOverdue ? '<span class="priority-indicator text-red-500 text-sm" title="ÙØ§ØªÙˆØ±Ø© Ù…ØªØ£Ø®Ø±Ø©">ğŸš¨</span>' : '';
                    
                    tr.innerHTML = `
                        <td class="p-4 text-center font-semibold text-gray-600 transition-colors duration-200">${startIndex + index + 1}</td>
                        <td class="p-4 font-medium transition-colors duration-200">
                            <div class="flex items-center gap-2">
                                ${priorityIcon}
                                <span class="text-gray-900">${displayNumber}</span>
                            </div>
                            ${invoice.manualInvoiceNumber ? `<small class="text-gray-500 text-xs">Ø¯Ø§Ø®Ù„ÙŠ: ${shortId}</small>` : ''}
                        </td>
                        <td class="p-4 font-medium text-gray-900 transition-colors duration-200">${invoice.customer}</td>
                        <td class="p-4 text-sm text-gray-600 transition-colors duration-200">${truncatedDescription || '-'}</td>
                        <td class="p-4 text-gray-700 transition-colors duration-200">${invoice.date}</td>
                        <td class="p-4 font-semibold text-gray-900 transition-colors duration-200">${invoice.total || '-'}</td>
                        <td class="p-4 font-semibold transition-colors duration-200 ${Number(amountDue) > 0 ? 'text-red-600' : 'text-green-600'}">${amountDue}</td>
                        <td class="p-4">${statusBadge}</td>
                        <td class="p-4 space-x-2 space-x-reverse">
                            <button class="action-button text-blue-600 hover:text-blue-800 hover:bg-blue-100 px-2 py-1 rounded-md transition-all duration-200 font-medium view-invoice-btn" data-invoice-id="${invoiceId}">Ø¹Ø±Ø¶</button>
                            <button class="action-button text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 px-2 py-1 rounded-md transition-all duration-200 font-medium edit-invoice-btn" data-invoice-id="${invoiceId}">ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="action-button text-red-600 hover:text-red-800 hover:bg-red-100 px-2 py-1 rounded-md transition-all duration-200 font-medium void-invoice-btn" data-invoice-id="${invoiceId}">Ø¥Ù„ØºØ§Ø¡</button>
                        </td>
                    `;
                    
                    // Add overdue styling if applicable
                    if (isOverdue) {
                        tr.className += ` ${overdueClass}`;
                    }
                    tbody.appendChild(tr);
                });
                salesGroupsContainer.appendChild(section);
            });
            
            // Update results count
            if (searchResultsCount) {
                searchResultsCount.textContent = invoices.length.toString();
            }
            
            // Store current page state
            Object.keys(currentInvoicePage).forEach(key => {
                if (!page[key]) delete currentInvoicePage[key];
            });
            Object.assign(currentInvoicePage, page);
        };
        
        // Function to load a specific page for a group
        window.loadInvoicePage = function(groupKey, pageNum) {
            currentInvoicePage[groupKey] = pageNum;
            displayFilteredInvoices(filteredInvoices, currentInvoicePage);
            // Scroll to top of the section
            const section = document.querySelector(`[data-group="${groupKey}"]`)?.closest('.mb-8');
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        };
        
        const performSearch = () => {
            // Update current filters from UI
            currentSearchFilters.searchText = invoiceSearch ? invoiceSearch.value : '';
            currentSearchFilters.dateFrom = dateFrom ? dateFrom.value : '';
            currentSearchFilters.dateTo = dateTo ? dateTo.value : '';
            currentSearchFilters.amountFrom = amountFrom ? amountFrom.value : '';
            currentSearchFilters.amountTo = amountTo ? amountTo.value : '';
            currentSearchFilters.paymentStatus = paymentStatusFilter ? paymentStatusFilter.value : '';
            currentSearchFilters.paymentMethod = paymentMethodFilter ? paymentMethodFilter.value : '';
            currentSearchFilters.sortBy = sortBy ? sortBy.value : 'createdAt-desc';
            currentSearchFilters.channel = currentChannelFilter; // Include channel filter
            
            // Apply filters to all invoices
            filteredInvoices = applySearchFilters(allInvoices);
            
            // Reset pagination when filters change
            currentInvoicePage = {};
            
            // Display filtered results (starting from page 1)
            displayFilteredInvoices(filteredInvoices, {});
        };
        
        const clearAllFilters = () => {
            if (invoiceSearch) invoiceSearch.value = '';
            if (dateFrom) dateFrom.value = '';
            if (dateTo) dateTo.value = '';
            if (amountFrom) amountFrom.value = '';
            if (amountTo) amountTo.value = '';
            if (paymentStatusFilter) paymentStatusFilter.value = '';
            if (paymentMethodFilter) paymentMethodFilter.value = '';
            if (sortBy) sortBy.value = 'createdAt-desc';
            
            // Reset channel filter buttons
            const channelFilterButtons = document.querySelectorAll('.channel-filter-btn');
            channelFilterButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-all-channels').classList.add('active');
            currentChannelFilter = '';
            
            currentSearchFilters = {
                searchText: '',
                dateFrom: '',
                dateTo: '',
                amountFrom: '',
                amountTo: '',
                paymentStatus: '',
                paymentMethod: '',
                sortBy: 'createdAt-desc',
                channel: ''
            };
            
            // Reset to show all invoices
            filteredInvoices = [...allInvoices];
            
            // Reset pagination
            currentInvoicePage = {};
            
            displayFilteredInvoices(filteredInvoices, {});
        };
        
        // --- INVENTORY SEARCH AND FILTER FUNCTIONS ---
        const applyProductSearchFilters = (products) => {
            let filtered = [...products];
            
            // Text search
            if (currentProductSearchFilters.searchText) {
                const searchText = currentProductSearchFilters.searchText.toLowerCase();
                filtered = filtered.filter(product => {
                    const searchableText = [
                        product.name || '',
                        product.sku || '',
                        product.description || ''
                    ].join(' ').toLowerCase();
                    return searchableText.includes(searchText);
                });
            }
            
            // Quantity range filter
            if (currentProductSearchFilters.quantityFrom) {
                filtered = filtered.filter(product => {
                    const totalQuantity = product.warehouseQty + product.showroomQty;
                    return totalQuantity >= Number(currentProductSearchFilters.quantityFrom);
                });
            }
            
            if (currentProductSearchFilters.quantityTo) {
                filtered = filtered.filter(product => {
                    const totalQuantity = product.warehouseQty + product.showroomQty;
                    return totalQuantity <= Number(currentProductSearchFilters.quantityTo);
                });
            }
            
            // Status filter
            if (currentProductSearchFilters.status) {
                filtered = filtered.filter(product => {
                    const totalQuantity = product.warehouseQty + product.showroomQty;
                    switch (currentProductSearchFilters.status) {
                        case 'out-of-stock':
                            return totalQuantity === 0;
                        case 'low-stock':
                            return totalQuantity > 0 && totalQuantity < 10;
                        case 'in-stock':
                            return totalQuantity >= 10;
                        default:
                            return true;
                    }
                });
            }
            
            // Price range filter
            if (currentProductSearchFilters.priceFrom) {
                filtered = filtered.filter(product => {
                    const price = Number(product.websitePrice || 0);
                    return price >= Number(currentProductSearchFilters.priceFrom);
                });
            }
            
            if (currentProductSearchFilters.priceTo) {
                filtered = filtered.filter(product => {
                    const price = Number(product.websitePrice || 0);
                    return price <= Number(currentProductSearchFilters.priceTo);
                });
            }
            
            // Sort
            const [field, direction] = currentProductSearchFilters.sortBy.split('-');
            filtered.sort((a, b) => {
                let aValue, bValue;
                
                switch (field) {
                    case 'createdAt':
                        aValue = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                        bValue = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                        break;
                    case 'name':
                        aValue = (a.name || '').toLowerCase();
                        bValue = (b.name || '').toLowerCase();
                        break;
                    case 'quantity':
                        aValue = (a.warehouseQty || 0) + (a.showroomQty || 0);
                        bValue = (b.warehouseQty || 0) + (b.showroomQty || 0);
                        break;
                    case 'price':
                        aValue = Number(a.websitePrice || 0);
                        bValue = Number(b.websitePrice || 0);
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                } else {
                    return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                }
            });
            
            return filtered;
        };
        
        const displayFilteredProducts = async (products) => {
            if (!inventoryTableBody) return;
            
            inventoryTableBody.innerHTML = '';
            
            if (products.length === 0) {
                inventoryTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</td></tr>';
                return;
            }
            
            // Process products with location quantities
            const productPromises = [];
            products.forEach((product) => {
                productPromises.push(calculateLocationQuantities(product.id).then(locations => ({ 
                    id: product.id, 
                    product, 
                    locations 
                })));
            });
            
            const productsWithLocations = await Promise.all(productPromises);
            
            productsWithLocations.forEach(({ id, product, locations }) => {
                const totalQuantity = locations.warehouse + locations.showroom;
                let status = 'Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ';
                let statusClass = 'bg-green-100 text-green-800';
                
                if (totalQuantity === 0) {
                    status = 'Ù†Ø§ÙØ¯';
                    statusClass = 'bg-red-100 text-red-800';
                } else if (totalQuantity < 10) {
                    status = 'Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶';
                    statusClass = 'bg-yellow-100 text-yellow-800';
                }
                
                const statusSpan = `<span class="px-2 py-1 text-xs rounded-full ${statusClass}">${status}</span>`;
                
                const row = document.createElement('tr');
                row.classList.add('border-b', 'hover:bg-gray-50');
                row.innerHTML = `
                    <td class="p-3">${product.name}</td>
                    <td class="p-3">${product.sku}</td>
                    <td class="p-3">${Number(product.websitePrice || 0).toFixed(2)}</td>
                    <td class="p-3">${Number(product.amazonPrice || 0).toFixed(2)}</td>
                    <td class="p-3 font-semibold">${totalQuantity}</td>
                    <td class="p-3 text-blue-600">${locations.warehouse}</td>
                    <td class="p-3 text-green-600">${locations.showroom}</td>
                    <td class="p-3">${statusSpan}</td>
                    <td class="p-3 space-x-2 space-x-reverse">
                        <span class="text-green-600 cursor-pointer view-product-btn" data-product-id="${id}">Ø¹Ø±Ø¶</span>
                        <span class="text-blue-500 cursor-pointer edit-product-btn" data-product-id="${id}">ØªØ¹Ø¯ÙŠÙ„</span>
                        <span class="text-gray-600 cursor-pointer delete-product-btn" data-product-id="${id}">Ø­Ø°Ù</span>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });
        };
        
        const performProductSearch = () => {
            // Update current filters from UI
            currentProductSearchFilters.searchText = productSearch ? productSearch.value : '';
            currentProductSearchFilters.quantityFrom = quantityFrom ? quantityFrom.value : '';
            currentProductSearchFilters.quantityTo = quantityTo ? quantityTo.value : '';
            currentProductSearchFilters.status = statusFilter ? statusFilter.value : '';
            currentProductSearchFilters.priceFrom = priceFrom ? priceFrom.value : '';
            currentProductSearchFilters.priceTo = priceTo ? priceTo.value : '';
            currentProductSearchFilters.sortBy = productSort ? productSort.value : 'createdAt-desc';
            
            // Apply filters to all products
            filteredProducts = applyProductSearchFilters(allProducts);
            
            // Display filtered results
            displayFilteredProducts(filteredProducts);
        };
        
        const clearAllProductFilters = () => {
            if (productSearch) productSearch.value = '';
            if (quantityFrom) quantityFrom.value = '';
            if (quantityTo) quantityTo.value = '';
            if (statusFilter) statusFilter.value = '';
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            if (productSort) productSort.value = 'createdAt-desc';
            
            currentProductSearchFilters = {
                searchText: '',
                quantityFrom: '',
                quantityTo: '',
                status: '',
                priceFrom: '',
                priceTo: '',
                sortBy: 'createdAt-desc'
            };
            
            // Reset to show all products
            filteredProducts = [...allProducts];
            displayFilteredProducts(filteredProducts);
        };
        
        // --- DASHBOARD ANALYTICS FUNCTIONS ---
        const calculateSalesAnalytics = async () => {
            if (!db) return;
            
            try {
                // OPTIMIZATION: Use cached invoice data instead of querying Firestore
                // This saves hundreds of reads per analytics calculation
                if (invoiceData && Object.keys(invoiceData).length > 0) {
                    console.log('[Quota Usage] Using cached invoices for analytics (0 reads)');
                    // Use cached data
                    const cachedInvoices = Object.entries(invoiceData).map(([id, invoice]) => ({
                        id,
                        data: () => invoice
                    }));
                    
                    // Process cached invoices
                    let totalRevenue = 0;
                    let totalPaid = 0;
                    let totalAmountDue = 0;
                    let unpaidCount = 0;
                    let totalInvoices = 0;
                    let todaySales = 0;
                    let customers = new Set();
                    let monthlyData = {};
                    let paymentStatusData = { 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹': 0, 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹': 0, 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„': 0 };
                    let customerTotals = {};
                    let productTotals = {};
                    let channelData = {
                        'Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ': { revenue: 0, invoices: 0, total: 0 },
                        'Website': { revenue: 0, invoices: 0, total: 0 },
                        'Amazon': { revenue: 0, invoices: 0, total: 0 },
                        'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª': { revenue: 0, invoices: 0, total: 0 },
                        'Other': { revenue: 0, invoices: 0, total: 0 }
                    };
                    
                    // Get today's date for filtering
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    
                    cachedInvoices.forEach((docSnap) => {
                        const invoice = docSnap.data();
                        if (invoice.voided) return; // Skip voided invoices
                        
                        const total = Number(invoice.total || 0);
                        const paidAmount = Number(invoice.paidAmount || 0);
                        const amountDue = Number(invoice.amountDue || 0);
                        
                        totalRevenue += total;
                        totalPaid += paidAmount;
                        totalAmountDue += amountDue;
                        totalInvoices++;
                        
                        if (invoice.paymentStatus === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') unpaidCount++;
                        paymentStatusData[invoice.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'] = (paymentStatusData[invoice.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'] || 0) + 1;
                        
                        if (invoice.customer) customers.add(invoice.customer);
                        if (invoice.customer) {
                            customerTotals[invoice.customer] = (customerTotals[invoice.customer] || 0) + total;
                        }
                        
                        if (invoice.date && invoice.date.startsWith(todayStr)) {
                            todaySales += total;
                        }
                        
                        const invoiceDate = new Date(invoice.date || invoice.createdAt);
                        const monthKey = `${invoiceDate.getFullYear()}-${String(invoiceDate.getMonth() + 1).padStart(2, '0')}`;
                        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + total;
                        
                        const channel = invoice.channel || 'Other';
                        if (channelData[channel]) {
                            channelData[channel].revenue += total;
                            channelData[channel].invoices++;
                            channelData[channel].total += total;
                        } else {
                            channelData['Other'].revenue += total;
                            channelData['Other'].invoices++;
                            channelData['Other'].total += total;
                        }
                        
                        if (invoice.items && Array.isArray(invoice.items)) {
                            invoice.items.forEach(item => {
                                const productName = item.productName || 'Unknown';
                                productTotals[productName] = (productTotals[productName] || 0) + (Number(item.quantity || 0) * Number(item.price || 0));
                            });
                        }
                    });
                    
                    // Update UI with analytics using same functions as Firestore path
                    updateDashboardElements({
                        totalRevenue,
                        totalPaid,
                        totalAmountDue,
                        unpaidCount,
                        totalInvoices,
                        totalCustomers: customers.size,
                        averageInvoice: totalInvoices > 0 ? totalRevenue / totalInvoices : 0,
                        todaySales
                    });
                    
                    // Update charts
                    updateSalesChart(monthlyData);
                    updatePaymentStatusChart(paymentStatusData);
                    
                    // Update top customers and products
                    updateTopCustomers(customerTotals);
                    updateTopProducts(productTotals);
                    
                    // Update channel analytics
                    updateChannelAnalytics(channelData);
                    
                    return; // Exit early, don't query Firestore
                }
                
                // Fallback: Only query if cache is empty (should rarely happen)
                console.log('[Quota Usage] Cache empty, querying Firestore for analytics (WARNING: This uses many reads!)');
                // OPTIMIZATION: Use limit to prevent excessive reads
                const INVOICES_FOR_ANALYTICS = 200; // Limit to recent 200 invoices for analytics
                const q = query(collection(db, "invoices"), orderBy("createdAt", "desc"), limit(INVOICES_FOR_ANALYTICS));
                const querySnapshot = await getDocs(q);
                console.log(`[Quota Usage] Loaded ${querySnapshot.size} invoices for analytics (${querySnapshot.size} reads)`);
                
                let totalRevenue = 0;
                let totalPaid = 0;
                let totalAmountDue = 0;
                let unpaidCount = 0;
                let totalInvoices = 0;
                let todaySales = 0;
                let customers = new Set();
                let monthlyData = {};
                let paymentStatusData = { 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹': 0, 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹': 0, 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„': 0 };
                let customerTotals = {};
                let productTotals = {};
                let channelData = {
                    'Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ': { revenue: 0, invoices: 0, total: 0 },
                    'Website': { revenue: 0, invoices: 0, total: 0 },
                    'Amazon': { revenue: 0, invoices: 0, total: 0 },
                    'Other': { revenue: 0, invoices: 0, total: 0 }
                };
                
                // Get today's date for filtering
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                querySnapshot.forEach((docSnap) => {
                    const invoice = docSnap.data();
                    
                    // Skip voided invoices completely - they should not be counted in analytics
                    if (invoice.voided) {
                        return; // Skip voided invoices completely
                    }
                    
                    totalInvoices++;
                    const total = Number(invoice.total || 0);
                    const paidAmount = Number(invoice.paidAmount || 0);
                    const amountDue = Number(invoice.amountDue || 0);
                    
                    totalRevenue += total;
                    totalPaid += paidAmount;
                    totalAmountDue += amountDue;
                    
                    // Calculate today's sales
                    const invoiceDate = invoice.date || invoice.createdAt?.toDate?.()?.toISOString()?.split('T')[0];
                    if (invoiceDate === todayStr) {
                        todaySales += total;
                    }
                    
                    // Count unpaid invoices
                    if (amountDue > 0) {
                        unpaidCount++;
                    }
                    
                    // Track customers
                    if (invoice.customer) {
                        customers.add(invoice.customer);
                        if (!customerTotals[invoice.customer]) {
                            customerTotals[invoice.customer] = 0;
                        }
                        customerTotals[invoice.customer] += total;
                    }
                    
                    // Track products
                    if (invoice.items && Array.isArray(invoice.items)) {
                        invoice.items.forEach(item => {
                            if (item.productName) {
                                if (!productTotals[item.productName]) {
                                    productTotals[item.productName] = { quantity: 0, revenue: 0 };
                                }
                                productTotals[item.productName].quantity += Number(item.quantity || 0);
                                productTotals[item.productName].revenue += (Number(item.quantity || 0) * Number(item.price || 0));
                            }
                        });
                    }
                    
                    // Monthly data for chart
                    const invoiceDateForChart = new Date(invoice.date);
                    const monthKey = `${invoiceDateForChart.getFullYear()}-${String(invoiceDateForChart.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = 0;
                    }
                    monthlyData[monthKey] += total;
                    
                    // Payment status
                    const status = invoice.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                    if (paymentStatusData.hasOwnProperty(status)) {
                        paymentStatusData[status]++;
                    }
                    
                    // Channel data
                    const channel = invoice.channel || 'Other';
                    let channelKey = 'Other';
                    if (channel === 'Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ') channelKey = 'Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ';
                    else if (channel === 'Website') channelKey = 'Website';
                    else if (channel === 'Amazon') channelKey = 'Amazon';
                    
                    if (channelData[channelKey]) {
                        channelData[channelKey].revenue += total;
                        channelData[channelKey].invoices += 1;
                        channelData[channelKey].total += total;
                    }
                });
                
                // Update dashboard elements
                updateDashboardElements({
                    totalRevenue,
                    totalPaid,
                    totalAmountDue,
                    unpaidCount,
                    totalInvoices,
                    totalCustomers: customers.size,
                    averageInvoice: totalInvoices > 0 ? totalRevenue / totalInvoices : 0,
                    todaySales
                });
                
                // Update charts
                updateSalesChart(monthlyData);
                updatePaymentStatusChart(paymentStatusData);
                
                // Update top customers and products
                updateTopCustomers(customerTotals);
                updateTopProducts(productTotals);
                
                // Update channel analytics
                updateChannelAnalytics(channelData);
                
            } catch (error) {
                console.error("Error calculating sales analytics:", error);
            }
        };
        
        const updateDashboardElements = (data) => {
            const elements = {
                'total-revenue': data.totalRevenue.toFixed(2),
                'total-customers': data.totalCustomers,
                'unpaid-invoices': data.unpaidCount,
                'amount-due': data.totalAmountDue.toFixed(2),
                'average-invoice': data.averageInvoice.toFixed(2),
                'total-invoices': data.totalInvoices,
                'today-sales': data.todaySales ? data.todaySales.toFixed(2) : '0.00'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        };
        
        const updateSalesChart = (monthlyData) => {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;
            
            // Get last 12 months
            const months = [];
            const values = [];
            const now = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                // Use English month names to avoid Islamic calendar issues
                const monthNames = [
                    'ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ',
                    'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
                ];
                const monthName = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                
                months.push(monthName);
                values.push(monthlyData[monthKey] || 0);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¬.Ù…)',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' Ø¬.Ù…';
                                }
                            }
                        }
                    }
                }
            });
        };
        
        const updatePaymentStatusChart = (paymentStatusData) => {
            const ctx = document.getElementById('paymentStatusChart');
            if (!ctx) return;
            
            const labels = Object.keys(paymentStatusData);
            const values = Object.values(paymentStatusData);
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#6b7280'];
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        };
        
        const updateTopCustomers = (customerTotals) => {
            const container = document.getElementById('top-customers-list');
            if (!container) return;
            
            const sortedCustomers = Object.entries(customerTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            container.innerHTML = sortedCustomers.map(([customer, total], index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                        <span class="font-medium">${customer}</span>
                    </div>
                    <span class="text-green-600 font-bold">${total.toFixed(2)} Ø¬.Ù…</span>
                </div>
            `).join('');
        };
        
        const updateTopProducts = (productTotals) => {
            const container = document.getElementById('top-products-list');
            if (!container) return;
            
            const sortedProducts = Object.entries(productTotals)
                .sort(([,a], [,b]) => b.revenue - a.revenue)
                .slice(0, 5);
            
            container.innerHTML = sortedProducts.map(([product, data], index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">${index + 1}</span>
                        <div>
                            <span class="font-medium">${product}</span>
                            <div class="text-sm text-gray-500">${data.quantity} ÙˆØ­Ø¯Ø©</div>
                        </div>
                    </div>
                    <span class="text-green-600 font-bold">${data.revenue.toFixed(2)} Ø¬.Ù…</span>
                </div>
            `).join('');
        };
        
        const updateChannelAnalytics = (channelData) => {
            // Update channel cards
            updateChannelCards(channelData);
            
            // Update channel charts
            updateChannelCharts(channelData);
            
            // Update channel performance table
            updateChannelPerformanceTable(channelData);
        };
        
        const updateChannelCards = (channelData) => {
            const elements = {
                'store-revenue': channelData['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ'].revenue.toFixed(2),
                'store-invoices': channelData['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ'].invoices,
                'website-revenue': channelData['Website'].revenue.toFixed(2),
                'website-invoices': channelData['Website'].invoices,
                'amazon-revenue': channelData['Amazon'].revenue.toFixed(2),
                'amazon-invoices': channelData['Amazon'].invoices,
                'other-revenue': channelData['Other'].revenue.toFixed(2),
                'other-invoices': channelData['Other'].invoices
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
        };
        
        const updateChannelCharts = (channelData) => {
            // Revenue chart
            const revenueCtx = document.getElementById('channelRevenueChart');
            if (revenueCtx) {
                const labels = ['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ', 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø£Ù…Ø§Ø²ÙˆÙ†', 'Ù‚Ù†ÙˆØ§Øª Ø£Ø®Ø±Ù‰'];
                const values = [
                    channelData['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ'].revenue,
                    channelData['Website'].revenue,
                    channelData['Amazon'].revenue,
                    channelData['Other'].revenue
                ];
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
                
                new Chart(revenueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Invoices chart
            const invoicesCtx = document.getElementById('channelInvoicesChart');
            if (invoicesCtx) {
                const labels = ['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ', 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø£Ù…Ø§Ø²ÙˆÙ†', 'Ù‚Ù†ÙˆØ§Øª Ø£Ø®Ø±Ù‰'];
                const values = [
                    channelData['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ'].invoices,
                    channelData['Website'].invoices,
                    channelData['Amazon'].invoices,
                    channelData['Other'].invoices
                ];
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
                
                new Chart(invoicesCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±',
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        };
        
        const updateChannelPerformanceTable = (channelData) => {
            const container = document.getElementById('channel-performance-table');
            if (!container) return;
            
            const totalRevenue = Object.values(channelData).reduce((sum, channel) => sum + channel.revenue, 0);
            
            const tableData = [
                { name: 'Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ', data: channelData['Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ÙØ¹Ù„ÙŠ'] },
                { name: 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', data: channelData['Website'] },
                { name: 'Ø£Ù…Ø§Ø²ÙˆÙ†', data: channelData['Amazon'] },
                { name: 'Ù‚Ù†ÙˆØ§Øª Ø£Ø®Ø±Ù‰', data: channelData['Other'] }
            ];
            
            container.innerHTML = tableData.map(({ name, data }) => {
                const percentage = totalRevenue > 0 ? ((data.revenue / totalRevenue) * 100).toFixed(1) : 0;
                const averageInvoice = data.invoices > 0 ? (data.revenue / data.invoices).toFixed(2) : 0;
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">${name}</td>
                        <td class="p-3 text-center">${data.revenue.toFixed(2)} Ø¬.Ù…</td>
                        <td class="p-3 text-center">${data.invoices}</td>
                        <td class="p-3 text-center">${averageInvoice} Ø¬.Ù…</td>
                        <td class="p-3 text-center">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">${percentage}%</span>
                        </td>
                    </tr>
                `;
            }).join('');
        };
        
        // --- DATA FETCHING FUNCTIONS ---
        // Track if invoices are already loaded to prevent unnecessary reloads
        let invoicesLastLoaded = null;
        const INVOICES_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
        
        const fetchAndDisplayInvoices = async (channelFilter = '', forceReload = false) => {
             if (!db || !salesGroupsContainer) return;
            
            // OPTIMIZATION: Check cache - don't reload if data is fresh and no filter change
            const now = Date.now();
            if (!forceReload && invoicesLastLoaded && (now - invoicesLastLoaded) < INVOICES_CACHE_DURATION && 
                invoiceData && Object.keys(invoiceData).length > 0 && !channelFilter) {
                console.log('[Quota Usage] Using cached invoices (0 reads)');
                // Re-apply filters if needed
                if (channelFilter) {
                    filteredInvoices = allInvoices.filter(inv => inv.invoice.channel === channelFilter);
                } else {
                    filteredInvoices = [...allInvoices];
                }
                displayFilteredInvoices(filteredInvoices);
                return;
            }
            
            salesGroupsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...</div>';
            try {
                // OPTIMIZATION: Use limit for initial load (pagination)
                const INVOICES_PER_PAGE = 100; // Load first 100, can expand later if needed
                const q = query(collection(db, "invoices"), orderBy("createdAt", "desc"), limit(INVOICES_PER_PAGE));
                const querySnapshot = await getDocs(q);
                console.log(`[Quota Usage] Loaded ${querySnapshot.size} invoices (${querySnapshot.size} reads)`);
                
                // Store all invoices for search functionality
                if (forceReload || !invoiceData) {
                    allInvoices = [];
                    invoiceData = {};
                }
                
                querySnapshot.forEach((docSnap) => {
                    const invoice = docSnap.data();
                    const invoiceId = docSnap.id;
                    
                    // Skip voided invoices - they should not appear in the UI
                    if (invoice.voided) {
                        return; // Skip voided invoices completely
                    }
                    
                    invoiceData[invoiceId] = invoice;
                    
                    // Apply channel filter
                    if (channelFilter && invoice.channel !== channelFilter) {
                        return; // Skip this invoice if it doesn't match the filter
                    }
                    
                    // Only add if not already in allInvoices
                    if (!allInvoices.find(inv => inv.id === invoiceId)) {
                        allInvoices.push({ id: invoiceId, invoice });
                    }
                });
                
                // Initialize filtered invoices with all invoices
                filteredInvoices = [...allInvoices];
                
                // Update cache timestamp
                invoicesLastLoaded = now;
                
                // Display all invoices initially (page 1)
                currentInvoicePage = {};
                displayFilteredInvoices(filteredInvoices, {});
                
            } catch (error) {
                console.error("Error fetching invoices: ", error);
                salesGroupsContainer.innerHTML = '<div class="p-4 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±.</div>';
            }
        };
        
        // Track if products are already loaded to prevent unnecessary reloads
        let productsLastLoaded = null;
        let productsLoading = false;
        const PRODUCTS_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache
        
        const fetchAndDisplayProducts = async (loadLocationQuantities = false, forceReload = false) => {
            if (!db || !inventoryTableBody) return;
            
            // OPTIMIZATION: Prevent concurrent loads
            if (productsLoading) {
                console.log('[Quota Usage] Products already loading, skipping...');
                return;
            }
            
            // OPTIMIZATION: Check cache - don't reload if data is fresh
            const now = Date.now();
            if (!forceReload && productsLastLoaded && (now - productsLastLoaded) < PRODUCTS_CACHE_DURATION && 
                productsCache && productsCache.length > 0) {
                console.log('[Quota Usage] Using cached products (0 reads)');
                // Only reload location quantities if requested
                if (loadLocationQuantities) {
                    // Load location quantities for cached products
                    const productPromises = [];
                    productsCache.forEach(product => {
                        productPromises.push(calculateLocationQuantities(product.id).then(locations => ({ 
                            id: product.id, 
                            locations 
                        })).catch(err => {
                            console.warn(`Failed to load location quantities for product ${product.id}:`, err);
                            return { id: product.id, locations: { warehouse: 0, showroom: 0, total: 0 } };
                        }));
                    });
                    const productsWithLocations = await Promise.all(productPromises);
                    allProducts = allProducts.map(product => {
                        const productWithLocations = productsWithLocations.find(p => p.id === product.id);
                        return {
                            ...product,
                            warehouseQty: productWithLocations ? productWithLocations.locations.warehouse : 0,
                            showroomQty: productWithLocations ? productWithLocations.locations.showroom : 0
                        };
                    });
                    displayFilteredProducts(filteredProducts || allProducts);
                } else {
                    displayFilteredProducts(filteredProducts || allProducts);
                }
                return;
            }
            
            productsLoading = true;
            inventoryTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</td></tr>';
            try {
                if (forceReload || !productsCache || productsCache.length === 0) {
                    productsCache = []; // Clear cache before fetching
                    allProducts = []; // Clear all products array
                }
                // NOTE: We load ALL products because they're needed for:
                // 1. Invoice creation (autocomplete dropdown)
                // 2. Purchase creation (autocomplete dropdown)
                // 3. Inventory management
                // The 5-minute cache prevents reloads, so this only happens once per session
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                console.log(`[Quota Usage] Loaded ${querySnapshot.size} products (${querySnapshot.size} reads) - all products needed for invoice/purchase creation`);
                inventoryTableBody.innerHTML = '';
                if (querySnapshot.empty) {
                    inventoryTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„Ù…Ø®Ø²Ù†.</td></tr>';
                    return;
                }
                
                // Process products - skip location quantities by default to save quota
                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    if (product && product.deleted === true) { return; }
                    const productWithId = { 
                        id: doc.id, 
                        ...product,
                        warehouseQty: 0, // Default values, will be calculated on demand if needed
                        showroomQty: 0
                    };
                    productsCache.push(productWithId); // Add to cache
                    allProducts.push(productWithId); // Add to all products for search
                });
                
                // Only load location quantities if explicitly requested (to save quota)
                if (loadLocationQuantities) {
                    const productPromises = [];
                    allProducts.forEach(product => {
                        productPromises.push(calculateLocationQuantities(product.id).then(locations => ({ 
                            id: product.id, 
                            locations 
                        })).catch(err => {
                            console.warn(`Failed to load location quantities for product ${product.id}:`, err);
                            return { id: product.id, locations: { warehouse: 0, showroom: 0, total: 0 } };
                        }));
                    });
                    
                    const productsWithLocations = await Promise.all(productPromises);
                    
                    // Update products with location quantities
                    allProducts = allProducts.map(product => {
                        const productWithLocations = productsWithLocations.find(p => p.id === product.id);
                        return {
                            ...product,
                            warehouseQty: productWithLocations ? productWithLocations.locations.warehouse : 0,
                            showroomQty: productWithLocations ? productWithLocations.locations.showroom : 0
                        };
                    });
                }
                
                // Initialize filtered products with all products
                filteredProducts = [...allProducts];
                
                // Update cache timestamp
                productsLastLoaded = now;
                
                // Display all products initially
                displayFilteredProducts(filteredProducts);
            } catch (error) {
                console.error("Error fetching products:", error);
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.';
                if (error.code === 'resource-exhausted' || error.message.includes('Quota exceeded')) {
                    errorMessage = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø£Ùˆ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø®Ø·Ø©.';
                }
                inventoryTableBody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-red-500">${errorMessage}</td></tr>`;
            } finally {
                productsLoading = false;
            }
        };


        // --- AUTH STATE MANAGEMENT ---
        if (firebaseInitialized) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await createUserProfileDocument(user);
                    const userRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userRef);
                    if (docSnap.exists() && docSnap.data().role === 'admin') {
                        loginPage.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        userEmailEl.textContent = user.email || 'Admin';
                        userEmailEl.classList.remove('hidden');
                        logoutBtn.classList.remove('hidden');
                        fetchAndDisplayInvoices();
                        fetchAndDisplayProducts(); 
                    } else {
                        showAuthError("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù….");
                        await signOut(auth);
                    }
                } else {
                    mainApp.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                    userEmailEl.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                    if(salesGroupsContainer) salesGroupsContainer.innerHTML = '';
                    if(inventoryTableBody) inventoryTableBody.innerHTML = '';
                    invoiceData = {};
                }
            });
        }

        function showAuthError(message) {
            authErrorDiv.textContent = message;
            authErrorDiv.classList.remove('hidden');
        }

        const authErrorMessage = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';

        if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', async () => {
                if (!firebaseInitialized) { showAuthError(authErrorMessage); return; }
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    authErrorDiv.classList.add('hidden');
                } catch (error) {
                    console.error("Google sign-in error", error);
                    showAuthError("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„.");
                }
            });
        }
        
        if (loginBtn) {
            loginBtn.addEventListener('click', async () => {
                if (!firebaseInitialized) { showAuthError(authErrorMessage); return; }
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                if (!email || !password) { showAuthError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."); return; }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    authErrorDiv.classList.add('hidden');
                } catch (error) {
                    console.error("Email login error", error);
                    showAuthError("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
                }
            });
        }
        
        if (signupBtn) {
            signupBtn.addEventListener('click', async () => {
                if (!firebaseInitialized) { showAuthError(authErrorMessage); return; }
                const email = emailInput.value.trim();
                const password = passwordInput.value.trim();
                if (!email || !password) { showAuthError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."); return; }
                if (password.length < 6) { showAuthError("ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„."); return; }
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    authErrorDiv.classList.add('hidden');
                } catch (error) {
                    console.error("Email signup error", error);
                    if (error.code === 'auth/email-already-in-use') { showAuthError("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„."); } 
                    else if (error.code === 'auth/invalid-email') { showAuthError("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ§Ù„Ø­."); }
                    else { showAuthError("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ØªØ£ÙƒØ¯ Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©."); }
                }
            });
        }
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try { await signOut(auth); } catch (error) { console.error("Sign out error", error); }
            });
        }

        // --- UI Navigation & Setup ---
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const pages = document.querySelectorAll('.page');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const menuButton = document.getElementById('menu-button');

        function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) targetPage.classList.remove('hidden');
            if (pageId === 'dashboard') {
                if (typeof updateDashboardPettyCashBalance === 'function') updateDashboardPettyCashBalance();
                if (typeof calculateSalesAnalytics === 'function') calculateSalesAnalytics();
            } else if (pageId === 'purchases') {
                if (typeof fetchAndDisplayPurchases === 'function') fetchAndDisplayPurchases();
            } else if (pageId === 'stock-out') {
                if (typeof fetchAndDisplayStockOuts === 'function') fetchAndDisplayStockOuts();
            } else if (pageId === 'inventory') {
                if (typeof fetchAndDisplayProducts === 'function') fetchAndDisplayProducts();
                if (typeof loadDeletedLists === 'function') loadDeletedLists();
            } else if (pageId === 'expenses') {
                if (typeof fetchAndDisplayPettyCashBoxes === 'function') fetchAndDisplayPettyCashBoxes();
                if (typeof fetchAndDisplayAllExpenses === 'function') fetchAndDisplayAllExpenses();
                if (typeof fetchAndDisplayEmployees === 'function') fetchAndDisplayEmployees();
            }
        }

        sidebarLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                sidebarLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                const pageId = this.dataset.page;
                showPage(pageId);
                pageTitle.textContent = this.querySelector('span').textContent;
                if(window.innerWidth < 768) sidebar.classList.add('hidden');
            });
        });

        if (menuButton) {
            menuButton.addEventListener('click', () => sidebar.classList.toggle('hidden'));
        }

        // Charts will be initialized by the analytics functions

        // --- DYNAMIC SECTIONS ---

        // Sales Section
        const invoiceModal = document.getElementById('invoice-modal');
        const invoiceModalTitle = invoiceModal ? invoiceModal.querySelector('h3') : null;
        const addInvoiceBtn = document.getElementById('add-invoice-btn');
        const cancelInvoiceBtn = document.getElementById('cancel-invoice-btn');
        const saveInvoiceBtn = document.getElementById('save-invoice-btn');
        const addInvoiceForm = document.getElementById('add-invoice-form');
        const invoiceItemsContainer = document.getElementById('invoice-items-container');
        const addItemBtn = document.getElementById('add-item-btn');
        const calculatedTotalEl = document.getElementById('invoice-calculated-total');
        const invoiceDiscountEl = document.getElementById('invoice-discount');
        const invoiceDiscountPercentEl = document.getElementById('invoice-discount-percent');
        const viewInvoiceModal = document.getElementById('view-invoice-modal');
        const closeViewModalBtn = document.getElementById('close-view-modal-btn');
        const viewInvoiceContent = document.getElementById('view-invoice-content');
        const printInvoiceBtn = document.getElementById('print-invoice-btn');
        const printTypeModal = document.getElementById('print-type-modal');
        const printCustomerBtn = document.getElementById('print-customer-btn');
        const printCompanyBtn = document.getElementById('print-company-btn');
        const cancelPrintTypeBtn = document.getElementById('cancel-print-type-btn');
        const printableInvoiceModal = document.getElementById('printable-invoice-modal');
        const closePrintModalBtn = document.getElementById('close-print-modal-btn');
        const executePrintBtn = document.getElementById('execute-print-btn');
        const printCustomerName = document.getElementById('print-customer-name');
        const printInvoiceItems = document.getElementById('print-invoice-items');
        const printInvoiceTotal = document.getElementById('print-invoice-total');
        const printInvoiceSubtotal = document.getElementById('print-invoice-subtotal');
        const printInvoiceDiscount = document.getElementById('print-invoice-discount');
        const printInvoiceId = document.getElementById('print-invoice-id');
        const printInvoiceDate = document.getElementById('print-invoice-date');
        const printInvoiceTitle = document.getElementById('print-invoice-title');
        const orderSourceInfo = document.getElementById('order-source-info');
        const printOrderSource = document.getElementById('print-order-source');
        const companyTotals = document.getElementById('company-totals');
        const printTotalCost = document.getElementById('print-total-cost');
        const printTotalProfit = document.getElementById('print-total-profit');
        const printNetAmount = document.getElementById('print-net-amount');
        let currentOpenInvoiceId = null;
        let currentEditingInvoiceId = null;
        let currentPrintType = 'customer'; // 'customer' or 'company'
        
        // Search and Filter State
        let allInvoices = [];
        let filteredInvoices = [];
        let currentSearchFilters = {
            searchText: '',
            dateFrom: '',
            dateTo: '',
            amountFrom: '',
            amountTo: '',
            paymentStatus: '',
            paymentMethod: '',
            sortBy: 'createdAt-desc'
        };
        
        // Inventory Search and Filter State
        let allProducts = [];
        let filteredProducts = [];
        let currentProductSearchFilters = {
            searchText: '',
            quantityFrom: '',
            quantityTo: '',
            status: '',
            priceFrom: '',
            priceTo: '',
            sortBy: 'createdAt-desc'
        };
        
        // Purchase modals
        const viewPurchaseModal = document.getElementById('view-purchase-modal');
        const viewPurchaseContent = document.getElementById('view-purchase-content');
        const printPurchaseBtn = document.getElementById('print-purchase-btn');
        const printablePurchaseModal = document.getElementById('printable-purchase-modal');
        
        // Product view modal
        const productViewModal = document.getElementById('product-view-modal');
        const closeProductViewBtn = document.getElementById('close-product-view-btn');
        const viewProductName = document.getElementById('view-product-name');
        const viewProductSku = document.getElementById('view-product-sku');
        const viewProductDescription = document.getElementById('view-product-description');
        const viewProductWebsitePrice = document.getElementById('view-product-website-price');
        const viewProductAmazonPrice = document.getElementById('view-product-amazon-price');
        const viewProductTotalQty = document.getElementById('view-product-total-qty');
        const viewProductWarehouseQty = document.getElementById('view-product-warehouse-qty');
        const viewProductShowroomQty = document.getElementById('view-product-showroom-qty');
        const viewProductPurchaseHistory = document.getElementById('view-product-purchase-history');
        const viewProductNoHistory = document.getElementById('view-product-no-history');
        const historySortSelect = document.getElementById('history-sort-select');
        const historyFilterInput = document.getElementById('history-filter-input');
        const viewProductFilteredEmpty = document.getElementById('view-product-filtered-empty');
        const closePurchasePrintModalBtn = document.getElementById('close-purchase-print-modal-btn');

        // Stock Out Modal Elements
        const stockOutModal = document.getElementById('stock-out-modal');
        const addStockOutBtn = document.getElementById('add-stock-out-btn');
        const cancelStockOutBtn = document.getElementById('cancel-stock-out-btn');
        const saveStockOutBtn = document.getElementById('save-stock-out-btn');
        const addStockOutForm = document.getElementById('add-stock-out-form');
        const stockOutNumber = document.getElementById('stock-out-number');
        const stockOutDate = document.getElementById('stock-out-date');
        const stockOutEmployee = document.getElementById('stock-out-employee');
        const stockOutApprovedBy = document.getElementById('stock-out-approved-by');
        const stockOutReason = document.getElementById('stock-out-reason');
        const stockOutItemsContainer = document.getElementById('stock-out-items-container');
        const addStockOutItemBtn = document.getElementById('add-stock-out-item-btn');
        const stockOutTableBody = document.getElementById('stock-out-table-body');
        
        // View Stock Out Modal Elements
        const viewStockOutModal = document.getElementById('view-stock-out-modal');
        const closeViewStockOutBtn = document.getElementById('close-view-stock-out-btn');
        const printStockOutBtn = document.getElementById('print-stock-out-btn');
        const viewStockOutContent = document.getElementById('view-stock-out-content');
        
        // Printable Stock Out Modal Elements
        const printableStockOutModal = document.getElementById('printable-stock-out-modal');
        const executeStockOutPrintBtn = document.getElementById('execute-stock-out-print-btn');
        const closeStockOutPrintModalBtn = document.getElementById('close-stock-out-print-modal-btn');
        const stockOutToPrint = document.getElementById('stock-out-to-print');
        
        // Stock Out Data
        let stockOutsCache = [];
        let currentViewingStockOutId = null;
        let currentPrintingPurchase = null; // Store current purchase data for printing
        const executePurchasePrintBtn = document.getElementById('execute-purchase-print-btn');
        const printPurchaseId = document.getElementById('print-purchase-id');
        const printPurchaseDate = document.getElementById('print-purchase-date');
        const printPurchaseSupplierInvoice = document.getElementById('print-purchase-supplier-invoice');
        const printSupplierName = document.getElementById('print-supplier-name');
        const printPaymentStatus = document.getElementById('print-payment-status');
        const printPaymentMethod = document.getElementById('print-payment-method');
        const printPurchaseItems = document.getElementById('print-purchase-items');
        const printPurchaseSubtotal = document.getElementById('print-purchase-subtotal');
        const printPurchaseVat = document.getElementById('print-purchase-vat');
        const printPurchaseTotal = document.getElementById('print-purchase-total');
        const printPurchasePaid = document.getElementById('print-purchase-paid');
        const printPurchaseRemaining = document.getElementById('print-purchase-remaining');
        let currentOpenPurchaseId = null;
        
        // Purchases refs
        const purchasesTableBody = document.getElementById('purchases-table-body');
        const addPurchaseBtn = document.getElementById('add-purchase-btn');
        let purchasesCache = [];
        

        function calculateTotal() {
            if (!invoiceItemsContainer || !calculatedTotalEl) return;
            let sum = 0;
            const items = invoiceItemsContainer.querySelectorAll('.invoice-item');
            items.forEach(row => {
                const q = Number((row.querySelector('.item-qty') || {}).value || 0);
                const p = Number((row.querySelector('.item-price') || {}).value || 0);
                if (!isNaN(q) && !isNaN(p)) sum += q * p;
            });
            
            // Apply discount (either fixed amount or percentage)
            let discount = 0;
            const fixedDiscount = Number(invoiceDiscountEl ? invoiceDiscountEl.value || 0 : 0);
            const percentDiscount = Number(invoiceDiscountPercentEl ? invoiceDiscountPercentEl.value || 0 : 0);
            
            if (percentDiscount > 0) {
                // Calculate discount as percentage of subtotal
                discount = sum * (percentDiscount / 100);
            } else {
                // Use fixed discount amount
                discount = fixedDiscount;
            }
            
            const totalAfterDiscount = Math.max(0, sum - discount);
            
            calculatedTotalEl.textContent = `${totalAfterDiscount.toFixed(2)} Ø¬.Ù…`;
            return totalAfterDiscount;
        }

        async function getNextInvoiceNumber() {
            if (!db) return null;
            const counterRef = doc(db, 'counters', 'invoices');
            let nextNumber = null;
            await runTransaction(db, async (transaction) => {
                const snap = await transaction.get(counterRef);
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const prefix = `INV-${y}${m}-`;
                let last = 0;
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.prefix === prefix) last = Number(data.last || 0);
                }
                const updated = last + 1;
                nextNumber = `${prefix}${String(updated).padStart(6, '0')}`;
                transaction.set(counterRef, { prefix, last: updated }, { merge: true });
            });
            return nextNumber;
        }

        // Function to check if manual invoice number already exists
        async function checkManualInvoiceNumberExists(manualNumber, excludeInvoiceId = null) {
            if (!db || !manualNumber || manualNumber.trim() === '') return false;
            
            try {
                // OPTIMIZATION: Check local cache first (saves Firestore reads)
                if (invoiceData && Object.keys(invoiceData).length > 0) {
                    for (const [invoiceId, invoice] of Object.entries(invoiceData)) {
                        if (excludeInvoiceId && invoiceId === excludeInvoiceId) {
                            continue; // Skip the current invoice being edited
                        }
                        if (invoice.manualInvoiceNumber && invoice.manualInvoiceNumber.trim() === manualNumber.trim()) {
                            console.log('[Quota Usage] Duplicate found in cache (0 reads)');
                            return true; // Found a duplicate in cache
                        }
                    }
                    // If we have a good cache, trust it (no need to query Firestore)
                    console.log('[Quota Usage] No duplicate in cache (0 reads)');
                    return false;
                }
                
                // Fallback to Firestore query only if cache is empty
                console.log('[Quota Usage] Cache empty, querying Firestore...');
                const invoicesRef = collection(db, 'invoices');
                const q = query(invoicesRef, where('manualInvoiceNumber', '==', manualNumber.trim()));
                const querySnapshot = await getDocs(q);
                console.log(`[Quota Usage] Duplicate check query returned ${querySnapshot.size} results (${querySnapshot.size} reads)`);
                
                // Check if any invoice has this manual number (excluding the current one if editing)
                for (const docSnapshot of querySnapshot.docs) {
                    if (excludeInvoiceId && docSnapshot.id === excludeInvoiceId) {
                        continue; // Skip the current invoice being edited
                    }
                    return true; // Found a duplicate
                }
                return false; // No duplicates found
            } catch (error) {
                console.error('Error checking manual invoice number:', error);
                return false; // Allow creation if check fails (fail-safe)
            }
        }

        // CRITICAL: Check for duplicate invoice content (same customer, date, total, items)
        async function checkInvoiceContentDuplicate(customer, date, total, items) {
            try {
                // Get invoices from the same date and customer
                const invoicesQuery = query(
                    collection(db, 'invoices'),
                    where('customer', '==', customer),
                    where('date', '==', date)
                );
                const snapshot = await getDocs(invoicesQuery);
                
                for (const doc of snapshot.docs) {
                    const invoiceData = doc.data();
                    
                    // Check if total matches (within 0.01 tolerance for floating point)
                    if (Math.abs(invoiceData.total - total) < 0.01) {
                        // Check if items match (same products and quantities)
                        const invoiceItems = invoiceData.items || [];
                        if (invoiceItems.length === items.length) {
                            let itemsMatch = true;
                            for (let i = 0; i < items.length; i++) {
                                const currentItem = items[i];
                                const existingItem = invoiceItems[i];
                                
                                if (currentItem.productId !== existingItem.productId ||
                                    currentItem.quantity !== existingItem.quantity ||
                                    Math.abs(currentItem.price - existingItem.price) > 0.01) {
                                    itemsMatch = false;
                                    break;
                                }
                            }
                            
                            if (itemsMatch) {
                                console.log('Duplicate invoice content detected:', {
                                    customer,
                                    date,
                                    total,
                                    invoiceId: doc.id
                                });
                                return true; // Duplicate found
                            }
                        }
                    }
                }
                return false; // No duplicate
            } catch (error) {
                console.error('Error checking invoice content duplicate:', error);
                return false; // Allow save on error to prevent blocking
            }
        }

        // Function to validate manual invoice number in real-time
        let validationTimeout = null;
        async function validateManualInvoiceNumber() {
            const manualInput = document.getElementById('manual-invoice-number');
            if (!manualInput) return;
            
            // CRITICAL: Only validate for new invoices, not when editing existing ones
            if (currentEditingInvoiceId) {
                // Clear any existing validation styling for editing mode
                manualInput.classList.remove('border-red-500', 'border-green-500');
                const existingMessage = manualInput.parentNode.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                return;
            }
            
            const manualNumber = manualInput.value.trim();
            
            // Clear previous timeout
            if (validationTimeout) {
                clearTimeout(validationTimeout);
            }
            
            // Remove previous validation styling
            manualInput.classList.remove('border-red-500', 'border-green-500');
            
            if (!manualNumber) {
                // Clear any existing validation message
                const existingMessage = manualInput.parentNode.querySelector('.validation-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                return;
            }
            
            // Debounce the validation to avoid too many API calls
            validationTimeout = setTimeout(async () => {
                try {
                    const isDuplicate = await checkManualInvoiceNumberExists(manualNumber, currentEditingInvoiceId);
                    
                    // Remove existing validation message
                    const existingMessage = manualInput.parentNode.querySelector('.validation-message');
                    if (existingMessage) {
                        existingMessage.remove();
                    }
                    
                    if (isDuplicate) {
                        // Show error styling and message
                        manualInput.classList.add('border-red-500');
                        manualInput.classList.remove('border-green-500');
                        
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'validation-message text-red-600 text-sm mt-1';
                        errorMessage.textContent = `Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© "${manualNumber}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„`;
                        manualInput.parentNode.appendChild(errorMessage);
                    } else {
                        // Show success styling
                        manualInput.classList.add('border-green-500');
                        manualInput.classList.remove('border-red-500');
                        
                        const successMessage = document.createElement('div');
                        successMessage.className = 'validation-message text-green-600 text-sm mt-1';
                        successMessage.textContent = 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ØªØ§Ø­';
                        manualInput.parentNode.appendChild(successMessage);
                    }
                } catch (error) {
                    console.error('Error validating manual invoice number:', error);
                }
            }, 500); // 500ms debounce
        }

        function addItemRow() {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'grid grid-cols-12 gap-2 items-center invoice-item';
            
            // Create a text input with datalist for autocomplete
            const productInput = document.createElement('input');
            productInput.type = 'text';
            productInput.className = 'col-span-5 px-2 py-1 border rounded-md item-desc';
            productInput.placeholder = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...';
            productInput.setAttribute('list', 'product-suggestions');
            
            // Create datalist for autocomplete
            const datalist = document.createElement('datalist');
            datalist.id = 'product-suggestions';
            
            productsCache.forEach(p => {
                const option = document.createElement('option');
                option.value = `${p.name} (${p.sku})`;
                option.dataset.productId = p.id;
                option.dataset.price = (p && p.websitePrice != null) ? p.websitePrice : 0;
                datalist.appendChild(option);
            });

            itemDiv.innerHTML = `
                ${productInput.outerHTML}
                <input type="number" placeholder="ÙƒÙ…ÙŠØ©" value="1" min="1" class="col-span-2 px-2 py-1 border rounded-md item-qty">
                <input type="number" placeholder="Ø³Ø¹Ø±" value="0" min="0" class="col-span-2 px-2 py-1 border rounded-md item-price">
                <span class="col-span-2 text-sm text-gray-600 item-total text-center">0.00 Ø¬.Ù…</span>
                <button type="button" class="col-span-1 text-red-500 hover:text-red-700 remove-item-btn">&times;</button>
            `;
            
            // Add the datalist to the document
            document.body.appendChild(datalist);
            invoiceItemsContainer.appendChild(itemDiv);

            const selectEl = itemDiv.querySelector('.item-desc');
            const priceEl = itemDiv.querySelector('.item-price');
            const qtyEl = itemDiv.querySelector('.item-qty');
            const totalEl = itemDiv.querySelector('.item-total');
            const removeBtn = itemDiv.querySelector('.remove-item-btn');

            const updateLine = () => {
                const q = Number(qtyEl.value || 0);
                const p = Number(priceEl.value || 0);
                totalEl.textContent = `${(q * p).toFixed(2)} Ø¬.Ù…`;
                calculateTotal();
            };

            if (selectEl) {
                selectEl.addEventListener('input', () => {
                    const inputValue = selectEl.value;
                    // Check if the input matches an existing product
                    const matchingOption = datalist.querySelector(`option[value="${inputValue}"]`);
                    if (matchingOption) {
                        // It's an existing product
                        const salePrice = matchingOption.dataset.price ? Number(matchingOption.dataset.price) : 0;
                        priceEl.value = isNaN(salePrice) ? 0 : salePrice;
                        updateLine();
                    } else {
                        // It's a new product - just update the line total
                        updateLine();
                    }
                });
            }
            if (qtyEl) qtyEl.addEventListener('input', updateLine);
            if (priceEl) priceEl.addEventListener('input', updateLine);
            if (removeBtn) removeBtn.addEventListener('click', () => { itemDiv.remove(); calculateTotal(); });
        }

        if (invoiceItemsContainer) { /* ... event listeners ... */ }
        if (addItemBtn) addItemBtn.addEventListener('click', addItemRow);
        
        // Add event listener for discount field
        if (invoiceDiscountEl) invoiceDiscountEl.addEventListener('input', calculateTotal);
        if (invoiceDiscountPercentEl) {
            invoiceDiscountPercentEl.addEventListener('input', () => {
                calculateTotal();
                // Clear fixed discount when percentage is entered
                if (invoiceDiscountPercentEl.value > 0 && invoiceDiscountEl) {
                    invoiceDiscountEl.value = '';
                }
            });
        }
        // Add event listener to clear percentage when fixed amount is entered
        if (invoiceDiscountEl) {
            invoiceDiscountEl.addEventListener('input', () => {
                calculateTotal();
                // Clear percentage discount when fixed amount is entered
                if (invoiceDiscountEl.value > 0 && invoiceDiscountPercentEl) {
                    invoiceDiscountPercentEl.value = '';
                }
            });
        }
        
        // Helper function to create new product from text input
        async function createNewProductFromText(productName, price) {
            if (!db) return null;
            
            try {
                // Generate a simple SKU from the product name
                const sku = productName.replace(/\s+/g, '').substring(0, 10).toUpperCase() + Date.now().toString().slice(-4);
                
                const newProduct = {
                    name: productName,
                    sku,
                    websitePrice: price,
                    amazonPrice: price,
                    quantity: 0, // New products start with 0 quantity
                    category: 'Ø¹Ø§Ù…',
                    createdAt: new Date(),
                    createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null
                };
                
                const productRef = await addDoc(collection(db, 'products'), newProduct);
                const newProductId = productRef.id;
                
                // Add to products cache
                productsCache.push({ id: newProductId, ...newProduct });
                
                return newProductId;
            } catch (error) {
                console.error('Error creating product:', error);
                return null;
            }
        }
        async function showAddModal() { 
            currentEditingInvoiceId = null; 
            if(invoiceModalTitle) invoiceModalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©'; 
            if(saveInvoiceBtn) saveInvoiceBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©'; 
            if(invoiceModal) invoiceModal.classList.remove('hidden'); 
            if (invoiceItemsContainer && invoiceItemsContainer.children.length === 0) addItemRow(); 
            
            // Generate and display the internal invoice number
            const internalInvoiceNumberEl = document.getElementById('internal-invoice-number');
            if (internalInvoiceNumberEl) {
                const nextNumber = await getNextInvoiceNumber();
                internalInvoiceNumberEl.value = nextNumber || '';
            }
        }
        function hideAddModal() { 
            if(addInvoiceForm) addInvoiceForm.reset(); 
            if(invoiceItemsContainer) invoiceItemsContainer.innerHTML = ''; 
            if(calculatedTotalEl) calculatedTotalEl.textContent = '0.00 Ø¬.Ù…'; 
            currentEditingInvoiceId = null; 
            if(invoiceModalTitle) invoiceModalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©'; 
            if(saveInvoiceBtn) saveInvoiceBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©'; 
            if(invoiceModal) invoiceModal.classList.add('hidden'); 
            
            // Clear the internal invoice number field
            const internalInvoiceNumberEl = document.getElementById('internal-invoice-number');
            if (internalInvoiceNumberEl) internalInvoiceNumberEl.value = '';
        }
        function openInvoiceInEditMode(invoiceId) {
            const inv = invoiceData[invoiceId];
            if (!inv) return;
            currentEditingInvoiceId = invoiceId;
            if(invoiceModalTitle) invoiceModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            if(saveInvoiceBtn) saveInvoiceBtn.textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
            const customerNameEl = document.getElementById('customer-name');
            const invoiceDateEl = document.getElementById('invoice-date');
            const salesChannelEl = document.getElementById('sales-channel');
            const paymentMethodEl = document.getElementById('payment-method');
            const paymentStatusEl = document.getElementById('payment-status');
            const paidAmountEl = document.getElementById('paid-amount');
            const paidAtEl = document.getElementById('paid-at');
            const invoiceDescEl = document.getElementById('invoice-description');
            const manualInvoiceNumberEl = document.getElementById('manual-invoice-number');
            const internalInvoiceNumberEl = document.getElementById('internal-invoice-number');
            if(customerNameEl) customerNameEl.value = inv.customer || '';
            if(invoiceDateEl) invoiceDateEl.value = inv.date || '';
            if(salesChannelEl) salesChannelEl.value = inv.channel || '';
            if(paymentMethodEl) paymentMethodEl.value = inv.paymentMethod || '';
            if(paymentStatusEl) paymentStatusEl.value = inv.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
            if(paidAmountEl) paidAmountEl.value = inv.paidAmount || 0;
            if(paidAtEl) paidAtEl.value = inv.paidAt || '';
            if(invoiceDescEl) invoiceDescEl.value = inv.description || '';
            if(manualInvoiceNumberEl) manualInvoiceNumberEl.value = inv.manualInvoiceNumber || '';
            if(internalInvoiceNumberEl) internalInvoiceNumberEl.value = inv.invoiceNumber || '';
            if(invoiceDiscountEl) invoiceDiscountEl.value = inv.discount || 0;
            const invoiceDiscountPercentInput = document.getElementById('invoice-discount-percent');
            if(invoiceDiscountPercentInput) invoiceDiscountPercentInput.value = inv.discountPercent || 0;
            if(invoiceItemsContainer) {
                invoiceItemsContainer.innerHTML = '';
                const items = Array.isArray(inv.items) ? inv.items : [];
                if(items.length === 0) { addItemRow(); }
                items.forEach((it) => {
                    addItemRow();
                    const row = invoiceItemsContainer.lastElementChild;
                    if (!row) return;
                    const inputEl = row.querySelector('.item-desc');
                    const qtyEl = row.querySelector('.item-qty');
                    const priceEl = row.querySelector('.item-price');
                    const totalEl = row.querySelector('.item-total');
                    if(inputEl) inputEl.value = it.productName || '';
                    if(qtyEl) qtyEl.value = it.quantity != null ? it.quantity : 1;
                    if(priceEl) priceEl.value = it.price != null ? it.price : 0;
                    if(totalEl) totalEl.textContent = `${(Number(qtyEl.value) * Number(priceEl.value)).toFixed(2)} Ø¬.Ù…`;
                });
            }
            if(typeof calculateTotal === 'function') {
                calculateTotal();
            }
            // Recalculate discount if percentage is set
            if(invoiceDiscountPercentInput && inv.discountPercent > 0) {
                setTimeout(calculateTotal, 100); // Delay to ensure form is fully loaded
            }
            if(invoiceModal) invoiceModal.classList.remove('hidden');
        }
        async function showViewModal(invoiceId) {
            const invoice = invoiceData[invoiceId];
            if (!invoice || !viewInvoiceModal || !viewInvoiceContent) return;
            currentOpenInvoiceId = invoiceId;
            // Build details
            const itemsHtml = (Array.isArray(invoice.items) ? invoice.items : []).map((it, idx) => {
                const qty = Number(it.quantity) || 0;
                const price = Number(it.price) || 0;
                const total = (qty * price).toFixed(2);
                return `
                    <tr class="border-b">
                        <td class="p-2">${it.productName || '-'}</td>
                        <td class="p-2 text-center">${qty}</td>
                        <td class="p-2 text-center">${price}</td>
                        <td class="p-2 text-left">${total}</td>
                    </tr>
                `;
            }).join('');

            const overallTotal = (invoice.total != null ? Number(invoice.total) : (Array.isArray(invoice.items) ? invoice.items : []).reduce((acc, it) => acc + (Number(it.quantity)||0) * (Number(it.price)||0), 0)).toFixed(2);

            // Load payments list
            let paymentsHtml = '';
            try {
                const pQ = query(collection(db, 'payments'), where('invoiceId', '==', invoiceId));
                const pSnap = await getDocs(pQ);
                if (pSnap.empty) {
                    paymentsHtml = '<div class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª.</div>';
                } else {
                    const rows = [];
                    pSnap.forEach(d => {
                        const p = d.data();
                        if (p && p.reversed === true) return;
                        const amt = Number(p.amount || 0).toFixed(2);
                        const method = p.method || '-';
                        const paidAt = p.paidAt || '-';
                        rows.push(`<tr class="border-b"><td class="p-2">${paidAt}</td><td class="p-2">${method}</td><td class="p-2 text-left">${amt}</td></tr>`);
                    });
                    paymentsHtml = `
                        <table class=\"w-full text-right\">
                            <thead class=\"bg-gray-100\"><tr><th class=\"p-2\">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class=\"p-2\">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th><th class=\"p-2 text-left\">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                            <tbody>${rows.join('')}</tbody>
                        </table>
                    `;
                }
            } catch (e) {
                paymentsHtml = '<div class="text-red-500">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª.</div>';
            }

            viewInvoiceContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div><span class="font-semibold">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (ÙŠØ¯ÙˆÙŠ):</span> ${invoice.manualInvoiceNumber || '-'}</div>
                    <div><span class="font-semibold">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</span> ${invoice.invoiceNumber || String(invoiceId).substring(0,8).toUpperCase()}</div>
                    <div><span class="font-semibold">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span> ${invoice.customer || '-'}</div>
                    <div><span class="font-semibold">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${invoice.date || '-'}</div>
                    <div><span class="font-semibold">Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ¹:</span> ${invoice.channel || '-'}</div>
                    <div><span class="font-semibold">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span> ${invoice.paymentMethod || '-'}</div>
                    <div><span class="font-semibold">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</span> ${invoice.paymentStatus || '-'}</div>
                    ${invoice.voided ? '<div class="col-span-2"><span class="bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-xs">ÙØ§ØªÙˆØ±Ø© Ù…Ù„ØºØ§Ø©</span></div>' : ''}
                </div>
                <div class="mt-3"><span class="font-semibold">Ø§Ù„ÙˆØµÙ:</span><div class="text-gray-700 mt-1">${invoice.description || '-'}</div></div>
                <div class="mt-4">
                    <table class="w-full text-right">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-right">Ø§Ù„Ù…Ù†ØªØ¬/Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                <th class="p-2 text-center">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th class="p-2 text-center">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                <th class="p-2 text-left">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml || '<tr><td colspan="4" class="p-3 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯.</td></tr>'}
                        </tbody>
                    </table>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2 font-bold text-lg">
                        <div class="flex justify-between"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span><span>${(Number(invoice.subtotal || 0) || (Array.isArray(invoice.items) ? invoice.items : []).reduce((acc, it) => acc + (Number(it.quantity)||0) * (Number(it.price)||0), 0)).toFixed(2)} Ø¬.Ù…</span></div>
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ø®ØµÙ…:${invoice.discountPercent > 0 ? ` (${invoice.discountPercent}%)` : ''}</span>
                            <span>${Number(invoice.discount || 0).toFixed(2)} Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span><span>${overallTotal} Ø¬.Ù…</span></div>
                        <div class="flex justify-between"><span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span><span>${Number(invoice.paidAmount || 0).toFixed(2)} Ø¬.Ù…</span></div>
                        <div class="flex justify-between"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span><span>${Number(invoice.amountDue != null ? invoice.amountDue : (overallTotal - Number(invoice.paidAmount || 0))).toFixed(2)} Ø¬.Ù…</span></div>
                    </div>
                </div>
                <div class=\"mt-6\">
                    <div class=\"flex items-center justify-between mb-2\">
                        <h4 class=\"font-semibold\">Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h4>
                        ${invoice.voided ? '' : '<button id="add-payment-btn" class="px-3 py-1 text-sm bg-blue-500 text-white rounded">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>'}
                    </div>
                    <div id=\"payments-list\">${paymentsHtml}</div>
                </div>
            `;
            viewInvoiceModal.classList.remove('hidden');

            const addPaymentBtn = document.getElementById('add-payment-btn');
            if (addPaymentBtn) {
                addPaymentBtn.addEventListener('click', async () => {
                    const amountStr = prompt('Ø§Ù„Ù…Ø¨Ù„Øº:');
                    if (amountStr == null) return;
                    const amount = Number(amountStr);
                    if (isNaN(amount) || amount <= 0) { alert('Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }
                    const method = prompt('Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (ÙƒØ§Ø´/ÙÙŠØ²Ø§/ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ):') || 'ÙƒØ§Ø´';
                    const paidAt = prompt('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ (YYYY-MM-DD):') || new Date().toISOString().slice(0,10);
                    try {
                        const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                        await addDoc(collection(db, 'payments'), { invoiceId, amount, method, paidAt, createdAt: new Date(), createdBy });
                        // Recalculate payment state and get updated data
                        const updatedInvoice = await recalcInvoicePaymentState(invoiceId);
                        // Update local cache instead of full reload
                        if (updatedInvoice && invoiceData) {
                            invoiceData[invoiceId] = { ...updatedInvoice, id: invoiceId };
                            const invoiceIndex = allInvoices.findIndex(inv => inv.id === invoiceId);
                            if (invoiceIndex >= 0) {
                                allInvoices[invoiceIndex].invoice = { ...updatedInvoice, id: invoiceId };
                            }
                            const filteredIndex = filteredInvoices.findIndex(inv => inv.id === invoiceId);
                            if (filteredIndex >= 0) {
                                filteredInvoices[filteredIndex].invoice = { ...updatedInvoice, id: invoiceId };
                            }
                            currentInvoicePage = {};
                            displayFilteredInvoices(filteredInvoices, {});
                        }
                        if (typeof calculateSalesAnalytics === 'function') calculateSalesAnalytics();
                        showViewModal(invoiceId);
                    } catch (e) {
                        alert('ØªØ¹Ø°Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©.');
                    }
                });
            }
        }
        function hideViewModal() {
            if (!viewInvoiceModal || !viewInvoiceContent) return;
            viewInvoiceContent.innerHTML = '';
            currentOpenInvoiceId = null;
            viewInvoiceModal.classList.add('hidden');
        }
        function showPrintableModal(invoiceId) {
            const invoice = invoiceData[invoiceId];
            if (!invoice || !printableInvoiceModal) return;
            
            // Set invoice header
            if (printInvoiceTitle) {
                if (currentPrintType === 'customer') {
                    printInvoiceTitle.style.display = 'none'; // Hide title for customer prints
                } else {
                    printInvoiceTitle.style.display = 'block'; // Show title for company prints
                }
            }
            if (printInvoiceId) {
                if (currentPrintType === 'customer') {
                    printInvoiceId.textContent = ''; // Hide invoice ID for customer prints
                } else {
                    printInvoiceId.textContent = `Invoice #${invoiceId}`;
                }
            }
            if (printInvoiceDate) {
                const invoiceDate = new Date(invoice.date.seconds ? invoice.date.seconds * 1000 : invoice.date);
                printInvoiceDate.textContent = invoiceDate.toLocaleDateString('en-US');
            }
            
            // Set customer name
            if (printCustomerName) printCustomerName.textContent = invoice.customer || 'N/A';
            
            // Show/hide order source based on print type
            if (orderSourceInfo) {
                if (currentPrintType === 'company') {
                    orderSourceInfo.classList.remove('hidden');
                    // Set order source (you can customize this logic based on your data structure)
                    if (printOrderSource) {
                        // For now, we'll use a placeholder. You can modify this to read from invoice data
                        printOrderSource.textContent = invoice.orderSource || 'Website';
                    }
                } else {
                    orderSourceInfo.classList.add('hidden');
                }
            }
            
            // Set invoice items
            if (printInvoiceItems) {
                printInvoiceItems.innerHTML = (Array.isArray(invoice.items) ? invoice.items : []).map((it) => {
                    const qty = Number(it.quantity) || 0;
                    const price = Number(it.price) || 0;
                    const costPrice = Number(it.costPrice) || 0;
                    const total = (qty * price).toFixed(2);
                    const profit = ((price - costPrice) * qty).toFixed(2);
                    
                    if (currentPrintType === 'company') {
                        return `
                            <tr class="border-b">
                                <td class="p-2">${it.productName || '-'}</td>
                                <td class="p-2 text-center">${qty}</td>
                                <td class="p-2 text-center">${price}</td>
                                <td class="p-2 text-center">${costPrice}</td>
                                <td class="p-2 text-center">${profit}</td>
                                <td class="p-2 text-right">${total}</td>
                            </tr>
                        `;
                    } else {
                        return `
                            <tr class="border-b">
                                <td class="p-2">${it.productName || '-'}</td>
                                <td class="p-2 text-center">${qty}</td>
                                <td class="p-2 text-center">${price}</td>
                                <td class="p-2 text-right">${total}</td>
                            </tr>
                        `;
                    }
                }).join('');
            }
            
            // Show/hide company columns
            const companyColumns = document.querySelectorAll('.company-column');
            companyColumns.forEach(col => {
                if (currentPrintType === 'company') {
                    col.classList.remove('hidden');
                } else {
                    col.classList.add('hidden');
                }
            });
            
            // Set invoice totals
            const subtotal = (Number(invoice.subtotal || 0) || (Array.isArray(invoice.items) ? invoice.items : []).reduce((acc, it) => acc + (Number(it.quantity)||0) * (Number(it.price)||0), 0)).toFixed(2);
            const discount = Number(invoice.discount || 0).toFixed(2);
            const total = Number(invoice.total || 0).toFixed(2);
            
            if (printInvoiceSubtotal) {
                if (currentPrintType === 'company') {
                    printInvoiceSubtotal.textContent = subtotal;
                } else {
                    printInvoiceSubtotal.textContent = subtotal;
                }
            }
            
            if (printInvoiceDiscount) {
                if (currentPrintType === 'company') {
                    printInvoiceDiscount.textContent = discount;
                } else {
                    printInvoiceDiscount.textContent = discount;
                }
            }
            
            if (printInvoiceTotal) {
                if (currentPrintType === 'company') {
                    printInvoiceTotal.textContent = total;
                } else {
                    printInvoiceTotal.textContent = total;
                }
            }
            
            // Show/hide company totals
            if (companyTotals) {
                if (currentPrintType === 'company') {
                    companyTotals.classList.remove('hidden');
                    
                    // Calculate company totals
                    const items = Array.isArray(invoice.items) ? invoice.items : [];
                    const totalCost = items.reduce((acc, it) => acc + (Number(it.quantity)||0) * (Number(it.costPrice)||0), 0).toFixed(2);
                    const totalProfit = items.reduce((acc, it) => {
                        const qty = Number(it.quantity) || 0;
                        const price = Number(it.price) || 0;
                        const costPrice = Number(it.costPrice) || 0;
                        return acc + (price - costPrice) * qty;
                    }, 0).toFixed(2);
                    const netAmount = (Number(totalCost) + Number(totalProfit)).toFixed(2);
                    
                    if (printTotalCost) printTotalCost.textContent = totalCost;
                    if (printTotalProfit) printTotalProfit.textContent = totalProfit;
                    if (printNetAmount) printNetAmount.textContent = netAmount;
                } else {
                    companyTotals.classList.add('hidden');
                }
            }
            
            printableInvoiceModal.classList.remove('hidden');
        }
        function hidePrintableModal() {
            if (!printableInvoiceModal) return;
            printableInvoiceModal.classList.add('hidden');
            if (printInvoiceItems) printInvoiceItems.innerHTML = '';
        }
        
        function showPrintTypeModal() {
            if (!printTypeModal) return;
            printTypeModal.classList.remove('hidden');
        }
        
        function hidePrintTypeModal() {
            if (!printTypeModal) return;
            printTypeModal.classList.add('hidden');
        }
        
        // Purchase viewing and printing functions
        function showPurchaseModal(purchaseId) {
            const purchase = purchasesCache.find(p => p.id === purchaseId);
            if (!purchase || !viewPurchaseModal || !viewPurchaseContent) return;
            
            currentOpenPurchaseId = purchaseId;
            
            // Calculate totals
            const items = Array.isArray(purchase.items) ? purchase.items : [];
            const subtotal = items.reduce((sum, item) => sum + (Number(item.quantity) || 0) * (Number(item.unitCost) || 0), 0);
            const vatEnabled = !!purchase.vatEnabled;
            const vatRate = Number(purchase.vatRate) || 0;
            const vatAmount = vatEnabled ? (subtotal * (vatRate / 100)) : 0;
            const total = subtotal + vatAmount;
            const paidAmount = Number(purchase.paidAmount) || 0;
            const remaining = total - paidAmount;
            
            // Populate view content
            viewPurchaseContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ:</label>
                            <p class="text-lg">${purchase.internalNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                            <p class="text-lg">${purchase.supplierInvoiceNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                            <p class="text-lg">${purchase.supplierName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                            <p class="text-lg">${purchase.date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                            <p class="text-lg">${purchase.paymentStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                            <p class="text-lg">${purchase.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                            <p class="text-lg">${purchase.purchaseStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</label>
                            <p class="text-lg">${paidAmount.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="border border-gray-300 p-2">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td class="border border-gray-300 p-2">${item.productName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td class="border border-gray-300 p-2 text-center">${Number(item.quantity) || 0}</td>
                                        <td class="border border-gray-300 p-2 text-center">${Number(item.unitCost || 0).toFixed(2)} Ø¬.Ù…</td>
                                        <td class="border border-gray-300 p-2 text-center">${((Number(item.quantity) || 0) * (Number(item.unitCost) || 0)).toFixed(2)} Ø¬.Ù…</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <div class="w-1/2 sm:w-1/3 space-y-2">
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                            <span>${subtotal.toFixed(2)} Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (${vatEnabled ? vatRate : 0}%):</span>
                            <span>${vatAmount.toFixed(2)} Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between border-t-2 pt-2">
                            <span class="font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                            <span class="font-bold">${total.toFixed(2)} Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                            <span>${paidAmount.toFixed(2)} Ø¬.Ù…</span>
                        </div>
                        <div class="flex justify-between border-t pt-2">
                            <span class="font-bold">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                            <span class="font-bold">${remaining.toFixed(2)} Ø¬.Ù…</span>
                        </div>
                    </div>
                </div>
            `;
            
            viewPurchaseModal.classList.remove('hidden');
        }
        
        function hidePurchaseModal() {
            if (!viewPurchaseModal) return;
            viewPurchaseModal.classList.add('hidden');
            currentOpenPurchaseId = null;
        }

        // Product view modal functions
        async function showProductViewModal(productId) {
            const product = productsCache.find(p => p.id === productId);
            if (!product || !productViewModal) return;
            
            // Populate basic product information
            if (viewProductName) viewProductName.textContent = product.name || '';
            if (viewProductSku) viewProductSku.textContent = product.sku || '';
            if (viewProductDescription) viewProductDescription.textContent = product.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
            if (viewProductWebsitePrice) viewProductWebsitePrice.textContent = `${Number(product.websitePrice || 0).toFixed(2)} Ø¬.Ù…`;
            if (viewProductAmazonPrice) viewProductAmazonPrice.textContent = `${Number(product.amazonPrice || 0).toFixed(2)} Ø¬.Ù…`;
            
            // Calculate and display current stock quantities
            try {
                const locations = await calculateLocationQuantities(productId);
                if (viewProductTotalQty) viewProductTotalQty.textContent = locations.total;
                if (viewProductWarehouseQty) viewProductWarehouseQty.textContent = locations.warehouse;
                if (viewProductShowroomQty) viewProductShowroomQty.textContent = locations.showroom;
            } catch (error) {
                console.error('Error calculating location quantities:', error);
                if (viewProductTotalQty) viewProductTotalQty.textContent = '0';
                if (viewProductWarehouseQty) viewProductWarehouseQty.textContent = '0';
                if (viewProductShowroomQty) viewProductShowroomQty.textContent = '0';
            }
            
            // Store original purchase history for filtering/sorting
            const originalPurchaseHistory = Array.isArray(product.purchaseHistory) ? product.purchaseHistory : [];
            
            // Function to render purchase history with current filter/sort
            function renderPurchaseHistory(history = originalPurchaseHistory) {
                if (history.length > 0) {
                    if (viewProductNoHistory) viewProductNoHistory.classList.add('hidden');
                    if (viewProductFilteredEmpty) viewProductFilteredEmpty.classList.add('hidden');
                    if (viewProductPurchaseHistory) {
                        const historyHtml = history.map(entry => {
                            const date = entry.purchaseDate && entry.purchaseDate.toDate ? 
                                entry.purchaseDate.toDate().toISOString().slice(0,10) : 
                                (entry.purchaseDate ? new Date(entry.purchaseDate.seconds ? entry.purchaseDate.seconds*1000 : entry.purchaseDate).toISOString().slice(0,10) : '');
                            const invoiceNumber = entry.internalNumber || entry.supplierInvoiceNumber || '-';
                            const statusBadge = entry.purchaseStatus === 'Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' ? 
                                '<span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs">Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</span>' :
                                '<span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs">Ù…Ø³ØªÙ„Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>';
                            
                            return `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-2">${date}</td>
                                    <td class="p-2">${entry.supplierName || '-'}</td>
                                    <td class="p-2 text-center">${invoiceNumber}</td>
                                    <td class="p-2 text-center">${entry.quantity || 0}</td>
                                    <td class="p-2 text-center">${Number(entry.unitPrice || 0).toFixed(2)}</td>
                                    <td class="p-2 text-left">${Number(entry.totalAmount || 0).toFixed(2)} Ø¬.Ù…</td>
                                    <td class="p-2 text-center">${statusBadge}</td>
                                </tr>
                            `;
                        }).join('');
                        viewProductPurchaseHistory.innerHTML = historyHtml;
                    }
                } else if (originalPurchaseHistory.length > 0) {
                    // Show filtered empty message
                    if (viewProductNoHistory) viewProductNoHistory.classList.add('hidden');
                    if (viewProductFilteredEmpty) viewProductFilteredEmpty.classList.remove('hidden');
                    if (viewProductPurchaseHistory) viewProductPurchaseHistory.innerHTML = '';
                } else {
                    // Show no history message
                    if (viewProductNoHistory) viewProductNoHistory.classList.remove('hidden');
                    if (viewProductFilteredEmpty) viewProductFilteredEmpty.classList.add('hidden');
                    if (viewProductPurchaseHistory) viewProductPurchaseHistory.innerHTML = '';
                }
            }
            
            // Function to sort and filter purchase history
            function sortAndFilterHistory() {
                let filteredHistory = [...originalPurchaseHistory];
                
                // Apply filter
                const filterText = historyFilterInput ? historyFilterInput.value.toLowerCase().trim() : '';
                if (filterText) {
                    filteredHistory = filteredHistory.filter(entry => 
                        (entry.supplierName || '').toLowerCase().includes(filterText)
                    );
                }
                
                // Apply sort
                const sortValue = historySortSelect ? historySortSelect.value : 'date-desc';
                filteredHistory.sort((a, b) => {
                    switch (sortValue) {
                        case 'date-desc':
                            const dateA = a.purchaseDate && a.purchaseDate.toDate ? a.purchaseDate.toDate() : 
                                (a.purchaseDate ? new Date(a.purchaseDate.seconds ? a.purchaseDate.seconds*1000 : a.purchaseDate) : new Date(0));
                            const dateB = b.purchaseDate && b.purchaseDate.toDate ? b.purchaseDate.toDate() : 
                                (b.purchaseDate ? new Date(b.purchaseDate.seconds ? b.purchaseDate.seconds*1000 : b.purchaseDate) : new Date(0));
                            return dateB - dateA;
                        case 'date-asc':
                            const dateA2 = a.purchaseDate && a.purchaseDate.toDate ? a.purchaseDate.toDate() : 
                                (a.purchaseDate ? new Date(a.purchaseDate.seconds ? a.purchaseDate.seconds*1000 : a.purchaseDate) : new Date(0));
                            const dateB2 = b.purchaseDate && b.purchaseDate.toDate ? b.purchaseDate.toDate() : 
                                (b.purchaseDate ? new Date(b.purchaseDate.seconds ? b.purchaseDate.seconds*1000 : b.purchaseDate) : new Date(0));
                            return dateA2 - dateB2;
                        case 'supplier':
                            return (a.supplierName || '').localeCompare(b.supplierName || '');
                        case 'price-desc':
                            return (Number(b.unitPrice || 0)) - (Number(a.unitPrice || 0));
                        case 'price-asc':
                            return (Number(a.unitPrice || 0)) - (Number(b.unitPrice || 0));
                        default:
                            return 0;
                    }
                });
                
                renderPurchaseHistory(filteredHistory);
            }
            
            // Set up event listeners for sorting and filtering
            if (historySortSelect) {
                historySortSelect.addEventListener('change', sortAndFilterHistory);
            }
            if (historyFilterInput) {
                historyFilterInput.addEventListener('input', sortAndFilterHistory);
            }
            
            // Initial render
            renderPurchaseHistory();
            
            productViewModal.classList.remove('hidden');
        }
        
        function hideProductViewModal() {
            if (!productViewModal) return;
            productViewModal.classList.add('hidden');
        }
        
        function showPrintablePurchaseModal(purchaseId) {
            const purchase = purchasesCache.find(p => p.id === purchaseId);
            if (!purchase || !printablePurchaseModal) return;
            
            // Calculate totals
            const items = Array.isArray(purchase.items) ? purchase.items : [];
            const subtotal = items.reduce((sum, item) => sum + (Number(item.quantity) || 0) * (Number(item.unitCost) || 0), 0);
            const vatEnabled = !!purchase.vatEnabled;
            const vatRate = Number(purchase.vatRate) || 0;
            const vatAmount = vatEnabled ? (subtotal * (vatRate / 100)) : 0;
            const total = subtotal + vatAmount;
            const paidAmount = Number(purchase.paidAmount) || 0;
            const remaining = total - paidAmount;
            
            // Populate print content
            if (printPurchaseId) printPurchaseId.textContent = `#${purchase.internalNumber || String(purchaseId).substring(0, 8).toUpperCase()}`;
            if (printPurchaseDate) {
                const dateValue = purchase.date || '';
                printPurchaseDate.textContent = dateValue ? `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateValue}` : 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                console.log('Purchase date set:', dateValue); // Debug log
            } else {
                console.error('printPurchaseDate element not found!'); // Debug log
            }
            if (printPurchaseSupplierInvoice) printPurchaseSupplierInvoice.textContent = purchase.supplierInvoiceNumber ? `ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ±Ø¯: ${purchase.supplierInvoiceNumber}` : '';
            if (printSupplierName) printSupplierName.textContent = purchase.supplierName || '';
            if (printPaymentStatus) printPaymentStatus.textContent = purchase.paymentStatus || '';
            if (printPaymentMethod) printPaymentMethod.textContent = purchase.paymentMethod || '';
            
            if (printPurchaseItems) {
                printPurchaseItems.innerHTML = items.map((item) => {
                    const qty = Number(item.quantity) || 0;
                    const price = Number(item.unitCost) || 0;
                    const total = (qty * price).toFixed(2);
                    return `
                        <tr>
                            <td class="p-2">${item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td class="p-2 text-center">${qty}</td>
                            <td class="p-2 text-center">${price.toFixed(2)} Ø¬.Ù…</td>
                            <td class="p-2 text-left">${total} Ø¬.Ù…</td>
                        </tr>
                    `;
                }).join('');
            }
            
            if (printPurchaseSubtotal) printPurchaseSubtotal.textContent = `${subtotal.toFixed(2)} Ø¬.Ù…`;
            if (printPurchaseVat) printPurchaseVat.textContent = `${vatAmount.toFixed(2)} Ø¬.Ù…`;
            if (printPurchaseTotal) printPurchaseTotal.textContent = `${total.toFixed(2)} Ø¬.Ù…`;
            if (printPurchasePaid) printPurchasePaid.textContent = `${paidAmount.toFixed(2)} Ø¬.Ù…`;
            if (printPurchaseRemaining) printPurchaseRemaining.textContent = `${remaining.toFixed(2)} Ø¬.Ù…`;
            
            printablePurchaseModal.classList.remove('hidden');
        }
        
        function hidePrintablePurchaseModal() {
            if (!printablePurchaseModal) return;
            printablePurchaseModal.classList.add('hidden');
            if (printPurchaseItems) printPurchaseItems.innerHTML = '';
        }

        // Stock Out Functions
        async function openStockOutModal() {
            if (!stockOutModal) return;
            
            // Show modal first
            stockOutModal.classList.remove('hidden');
            
            // Show loading state for stock out number
            if (stockOutNumber) {
                stockOutNumber.value = '';
                stockOutNumber.placeholder = 'Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù‚Ù…...';
            }
            
            // Set today's date
            if (stockOutDate) stockOutDate.value = new Date().toISOString().slice(0,10);
            
            // Clear form
            if (addStockOutForm) addStockOutForm.reset();
            if (stockOutItemsContainer) stockOutItemsContainer.innerHTML = '';
            
            // Generate stock out number
            const stockOutNum = await generateStockOutNumber();
            if (stockOutNumber) {
                stockOutNumber.value = stockOutNum;
                stockOutNumber.placeholder = stockOutNum;
            }
            
            // Add first item row
            addStockOutItem();
        }

        function closeStockOutModal() {
            if (stockOutModal) stockOutModal.classList.add('hidden');
        }

        function addStockOutItem() {
            if (!stockOutItemsContainer) return;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center space-x-2 space-x-reverse p-3 border border-gray-300 rounded-md';
            
            itemDiv.innerHTML = `
                <div class="flex-1">
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 stock-out-product-select" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>
                    </select>
                </div>
                <div class="w-32">
                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 stock-out-quantity" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©" min="1" required>
                </div>
                <button type="button" class="remove-stock-out-item-btn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-sm">Ø­Ø°Ù</button>
            `;
            
            stockOutItemsContainer.appendChild(itemDiv);
            
            // Populate product dropdown
            const productSelect = itemDiv.querySelector('.stock-out-product-select');
            if (productSelect && productsCache) {
                productsCache.forEach(product => {
                    if (!product.deleted) {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (${product.sku})`;
                        productSelect.appendChild(option);
                        // Fetch quantities asynchronously and update label when ready
                        calculateLocationQuantities(product.id).then(q => {
                            try {
                                const total = (q && typeof q.total === 'number') ? q.total : 0;
                                option.textContent = `${product.name} (${product.sku}) - Ù…ØªÙˆÙØ±: ${total}`;
                            } catch (_) { /* ignore */ }
                        }).catch(() => { /* ignore */ });
                    }
                });
            }
            
            // Add remove button event listener
            const removeBtn = itemDiv.querySelector('.remove-stock-out-item-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    itemDiv.remove();
                });
            }
        }

        async function generateStockOutNumber() {
            if (!db) return 'SO-001';
            try {
                // Preview-only: do NOT persist here to avoid gaps; final number is assigned in transaction on save
                const counterRef = doc(db, 'counters', 'stockOut');
                const counterSnap = await getDoc(counterRef);
                const current = (counterSnap.exists() && typeof counterSnap.data().count === 'number') ? counterSnap.data().count : 0;
                const nextNumber = current + 1;
                return `SO-${nextNumber.toString().padStart(3, '0')}`;
            } catch (error) {
                console.error('Error previewing stock out number:', error);
                return 'SO-001';
            }
        }

        async function saveStockOut() {
            if (!addStockOutForm || !db) return;
            if (!auth || !auth.currentUser) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); return; }
            const createdBy = auth.currentUser.uid;
            
            const items = [];
            // Collect items
            const itemRows = stockOutItemsContainer.querySelectorAll('.flex.items-center');
            itemRows.forEach(row => {
                const productSelect = row.querySelector('.stock-out-product-select');
                const quantityInput = row.querySelector('.stock-out-quantity');
                if (productSelect && quantityInput && productSelect.value && quantityInput.value) {
                    const product = productsCache.find(p => p.id === productSelect.value);
                    if (product) {
                        const quantity = parseInt(quantityInput.value);
                        if (!Number.isFinite(quantity) || quantity <= 0) return;
                        items.push({
                            productId: product.id,
                            productName: product.name,
                            productSku: product.sku,
                            quantity: quantity
                        });
                    }
                }
            });
            if (items.length === 0) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
            
            // Disable submit to prevent duplicates
            if (saveStockOutBtn) { saveStockOutBtn.disabled = true; saveStockOutBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...'; }
            
            // Idempotency: use deterministic doc id
            const requestId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ('so-' + Date.now() + '-' + Math.floor(Math.random()*1e6));
            const stockOutRef = doc(collection(db, 'stockOuts'), requestId);
            const counterRef = doc(db, 'counters', 'stockOut');
            
            try {
                const committedNumber = await runTransaction(db, async (transaction) => {
                    // Preview number from input may be stale; compute final sequential number here
                    const counterSnap = await transaction.get(counterRef);
                    const current = (counterSnap.exists() && typeof counterSnap.data().count === 'number') ? counterSnap.data().count : 0;
                    const next = current + 1;
                    const finalNumber = `SO-${next.toString().padStart(3, '0')}`;
                    
                    // Validate and prepare product updates
                    const productUpdates = [];
                    for (const it of items) {
                        const productRef = doc(db, 'products', it.productId);
                        const productSnap = await transaction.get(productRef);
                        if (!productSnap.exists()) throw new Error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ' + it.productId);
                        const pdata = productSnap.data();
                        // DISABLED: No stock validation or updates since inventory is not updated automatically
                        // Inventory should only be updated manually from the inventory section
                        // Stock movements are still recorded for tracking purposes but don't affect inventory quantities
                        // if (pdata && pdata.quantities && typeof pdata.quantities === 'object') {
                        //     const from = it.issueFrom || 'warehouse';
                        //     const currentQty = Number((pdata.quantities[from] ?? 0));
                        //     if (it.quantity > currentQty) throw new Error(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${it.quantity}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© (${currentQty}) Ù„Ù„Ù…Ù†ØªØ¬ ${it.productName}`);
                        //     const newQuantities = Object.assign({}, pdata.quantities);
                        //     newQuantities[from] = currentQty - it.quantity;
                        //     productUpdates.push({ ref: productRef, data: { quantities: newQuantities } });
                        // } else {
                        //     const currentQty = Number(pdata.quantity ?? 0);
                        //     if (it.quantity > currentQty) throw new Error(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (${it.quantity}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© (${currentQty}) Ù„Ù„Ù…Ù†ØªØ¬ ${it.productName}`);
                        //     productUpdates.push({ ref: productRef, data: { quantity: currentQty - it.quantity } });
                        // }
                    }
                    // Apply product updates
                    // DISABLED: Do NOT update product quantities automatically
                    // Inventory should only be updated manually from the inventory section
                    // for (const u of productUpdates) transaction.update(u.ref, u.data);
                    
                    // Persist counter
                    transaction.set(counterRef, { count: next }, { merge: true });
                    
                    // Create stockOut doc
                    const payload = {
                        stockOutNumber: finalNumber,
                        date: stockOutDate.value,
                        employee: stockOutEmployee.value,
                        approvedBy: stockOutApprovedBy.value,
                        reason: stockOutReason.value,
                        items: items,
                        status: 'active',
                        createdAt: serverTimestamp(),
                        createdBy: createdBy,
                        relatedType: (typeof stockOutRelatedType !== 'undefined' && stockOutRelatedType && stockOutRelatedType.value) ? stockOutRelatedType.value : null,
                        relatedId: (typeof stockOutRelatedId !== 'undefined' && stockOutRelatedId && stockOutRelatedId.value) ? stockOutRelatedId.value : null
                    };
                    transaction.set(stockOutRef, payload);
                    
                    // Create movement docs
                    for (const it of items) {
                        const movementRef = doc(collection(db, 'stockMovements'));
                        const movement = {
                            productId: it.productId,
                            productName: it.productName,
                            productSku: it.productSku,
                            type: 'OUT',
                            quantity: it.quantity,
                            source: 'Stock Out',
                            reference: finalNumber,
                            date: stockOutDate.value,
                            stockOutId: stockOutRef.id,
                            reason: stockOutReason.value,
                            fromLocation: it.issueFrom || null,
                            toLocation: null,
                            relatedType: (typeof payload.relatedType !== 'undefined') ? payload.relatedType : null,
                            relatedId: (typeof payload.relatedId !== 'undefined') ? payload.relatedId : null,
                            createdAt: serverTimestamp(),
                            createdBy: createdBy
                        };
                        transaction.set(movementRef, movement);
                    }
                    return finalNumber;
                });
                // Update UI with committed number
                if (stockOutNumber) stockOutNumber.value = committedNumber;
                alert('ØªÙ… Ø­ÙØ¸ ØµØ±Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­!');
                closeStockOutModal();
                await fetchAndDisplayStockOuts();
            } catch (error) {
                console.error('Error saving stock out:', error);
                alert('ÙØ´Ù„ Ø­ÙØ¸ ØµØ±Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ' + error.message);
            } finally {
                if (saveStockOutBtn) { saveStockOutBtn.disabled = false; saveStockOutBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØµØ±Ù'; }
            }
        }

        async function fetchAndDisplayStockOuts() {
            if (!db || !stockOutTableBody) return;
            
            stockOutTableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ±Ù...</td></tr>';
            
            try {
                const q = query(collection(db, 'stockOuts'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(q);
                stockOutTableBody.innerHTML = '';
                stockOutsCache = [];
                
                snap.forEach(doc => {
                    const data = doc.data();
                    stockOutsCache.push({ id: doc.id, ...data });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${data.stockOutNumber || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${data.date || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${data.employee || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${data.reason || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${data.items ? data.items.length : 0}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${data.approvedBy || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            <button class="view-stock-out-btn bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs" data-stock-out-id="${doc.id}">Ø¹Ø±Ø¶</button>
                        </td>
                    `;
                    stockOutTableBody.appendChild(row);
                });
                
                if (stockOutsCache.length === 0) {
                    stockOutTableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ±Ù</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading stock outs:', error);
                stockOutTableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ±Ù: ' + error.message + '</td></tr>';
            }
        }

        function showStockOutModal(stockOutId) {
            const stockOut = stockOutsCache.find(s => s.id === stockOutId);
            if (!stockOut || !viewStockOutModal || !viewStockOutContent) return;
            
            currentViewingStockOutId = stockOutId;
            
            viewStockOutContent.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø±Ù‚Ù… Ø§Ù„ØµØ±Ù:</label>
                            <p class="text-lg font-semibold">${stockOut.stockOutNumber || ''}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                            <p class="text-lg">${stockOut.date || ''}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                            <p class="text-lg">${stockOut.employee || ''}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Ø§Ù„Ù…Ø¹ØªÙ…Ø¯:</label>
                            <p class="text-lg">${stockOut.approvedBy || ''}</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Ø§Ù„ØºØ±Ø¶ / Ø§Ù„Ø³Ø¨Ø¨:</label>
                        <p class="text-lg">${stockOut.reason || ''}</p>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ©:</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stockOut.items ? stockOut.items.map(item => `
                                    <tr>
                                        <td class="border border-gray-300 p-2">${item.productName} (${item.productSku})</td>
                                        <td class="border border-gray-300 p-2">${item.quantity}</td>
                                    </tr>
                                `).join('') : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            viewStockOutModal.classList.remove('hidden');
        }

        function hideStockOutModal() {
            if (viewStockOutModal) viewStockOutModal.classList.add('hidden');
        }

        async function voidStockOut(stockOutId) {
            if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¢Ù†.'); return; }
            if (!stockOutId) return;
            const confirmVoid = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.');
            if (!confirmVoid) return;
            const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):') || '';
            const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
            const stockOutRef = doc(db, 'stockOuts', stockOutId);
            try {
                await runTransaction(db, async (transaction) => {
                    const soSnap = await transaction.get(stockOutRef);
                    if (!soSnap.exists()) throw new Error('Ø³Ø¬Ù„ Ø§Ù„ØµØ±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
                    const sod = soSnap.data();
                    if (sod.status === 'void') throw new Error('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
                    const items = Array.isArray(sod.items) ? sod.items : [];
                    // Read and compute product reversals
                    const updates = [];
                    for (const it of items) {
                        const productRef = doc(db, 'products', it.productId);
                        const pSnap = await transaction.get(productRef);
                        if (!pSnap.exists()) throw new Error('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ' + it.productId);
                        const pdata = pSnap.data();
                        if (pdata && pdata.quantities && typeof pdata.quantities === 'object') {
                            const from = it.issueFrom || 'warehouse';
                            const currentQty = Number(pdata.quantities[from] ?? 0);
                            const newQuantities = Object.assign({}, pdata.quantities);
                            newQuantities[from] = currentQty + Number(it.quantity || 0);
                            updates.push({ ref: productRef, data: { quantities: newQuantities } });
                        } else {
                            const currentQty = Number(pdata.quantity ?? 0);
                            updates.push({ ref: productRef, data: { quantity: currentQty + Number(it.quantity || 0) } });
                        }
                    }
                    // DISABLED: Do NOT update product quantities automatically
                    // Inventory should only be updated manually from the inventory section
                    // for (const u of updates) transaction.update(u.ref, u.data);
                    // Mark void
                    transaction.set(stockOutRef, { status: 'void', voidedAt: serverTimestamp(), voidedBy: createdBy, voidReason: reason }, { merge: true });
                    // Write reversal movements
                    for (const it of items) {
                        const movementRef = doc(collection(db, 'stockMovements'));
                        const movement = {
                            productId: it.productId,
                            productName: it.productName,
                            productSku: it.productSku,
                            type: 'REVERSAL',
                            quantity: it.quantity,
                            source: 'Stock Out',
                            reference: sod.stockOutNumber,
                            date: sod.date,
                            stockOutId: stockOutId,
                            reason: 'VOID: ' + reason,
                            fromLocation: null,
                            toLocation: it.issueFrom || null,
                            relatedType: sod.relatedType || null,
                            relatedId: sod.relatedId || null,
                            createdAt: serverTimestamp(),
                            createdBy: createdBy
                        };
                        transaction.set(movementRef, movement);
                    }
                });
                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­.');
                hideStockOutModal();
                await fetchAndDisplayStockOuts();
            } catch (err) {
                console.error(err);
                alert('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + err.message);
            }
        }

        function showPrintableStockOutModal(stockOutId) {
            const stockOut = stockOutsCache.find(s => s.id === stockOutId);
            if (!stockOut || !printableStockOutModal) return;
            
            stockOutToPrint.innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold mb-2">ØµØ±Ù Ù…Ø®Ø²ÙˆÙ†</h1>
                    <h2 class="text-xl">Stock Out</h2>
                </div>
                
                <div class="mb-6">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <strong>Ø±Ù‚Ù… Ø§Ù„ØµØ±Ù:</strong> ${stockOut.stockOutNumber || ''}
                        </div>
                        <div>
                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${stockOut.date || ''}
                        </div>
                        <div>
                            <strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${stockOut.employee || ''}
                        </div>
                        <div>
                            <strong>Ø§Ù„Ù…Ø¹ØªÙ…Ø¯:</strong> ${stockOut.approvedBy || ''}
                        </div>
                    </div>
                    <div class="mb-4">
                        <strong>Ø§Ù„ØºØ±Ø¶ / Ø§Ù„Ø³Ø¨Ø¨:</strong><br>
                        ${stockOut.reason || ''}
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ©:</h3>
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="border border-gray-300 p-2 text-right">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th class="border border-gray-300 p-2 text-right">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stockOut.items ? stockOut.items.map(item => `
                                <tr>
                                    <td class="border border-gray-300 p-2">${item.productName} (${item.productSku})</td>
                                    <td class="border border-gray-300 p-2">${item.quantity}</td>
                                </tr>
                            `).join('') : ''}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-8">
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <div class="border-t border-gray-300 pt-2">
                                <strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸Ù:</strong>
                            </div>
                        </div>
                        <div>
                            <div class="border-t border-gray-300 pt-2">
                                <strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯:</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            printableStockOutModal.classList.remove('hidden');
        }

        function hidePrintableStockOutModal() {
            if (printableStockOutModal) printableStockOutModal.classList.add('hidden');
        }
        async function recalcInvoicePaymentState(invoiceId, invoiceData = null) {
            if (!db) return null;
            const invoiceRef = doc(db, 'invoices', invoiceId);
            let inv = invoiceData;
            // Only read invoice if data not provided
            if (!inv) {
                const snap = await getDoc(invoiceRef);
                if (!snap.exists()) return null;
                inv = snap.data();
            }
            const paymentsQ = query(collection(db, 'payments'), where('invoiceId', '==', invoiceId));
            const paymentsSnap = await getDocs(paymentsQ);
            let paidSum = 0;
            paymentsSnap.forEach(d => { const pdata = d.data(); if (pdata && pdata.reversed !== true) { const a = Number(pdata.amount || 0); if (!isNaN(a)) paidSum += a; } });
            const total = Number(inv.total || 0);
            const amountDue = Math.max(0, total - paidSum);
            let paymentStatus = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
            if (paidSum >= total && total > 0) paymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
            else if (paidSum > 0) paymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
            await setDoc(invoiceRef, { paidAmount: paidSum, amountDue, paymentStatus, updatedAt: new Date() }, { merge: true });
            
            // Return updated invoice data with recalculated payment state
            return {
                ...inv,
                paidAmount: paidSum,
                amountDue,
                paymentStatus,
                updatedAt: new Date()
            };
        }
        async function voidInvoice(invoiceId) {
            if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¢Ù†.'); return; }
            const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.')) return;
            
            // Fetch invoice directly from database to ensure we have current data
            const invoiceRef = doc(db, 'invoices', invoiceId);
            const invoiceSnap = await getDoc(invoiceRef);
            if (!invoiceSnap.exists()) { 
                alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.'); 
                return; 
            }
            
            const inv = invoiceSnap.data();
            console.log('Invoice data for voiding:', { invoiceId, invoice: inv });
            
            if (inv.voided) { 
                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.'); 
                return; 
            }
            
            const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
            try {
                await runTransaction(db, async (transaction) => {
                    const invoiceRef = doc(db, 'invoices', invoiceId);
                    const invoiceSnap = await transaction.get(invoiceRef);
                    if (!invoiceSnap.exists()) throw 'Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.';
                    const data = invoiceSnap.data();
                    if (data.voided) throw 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.';
                    const items = Array.isArray(data.items) ? data.items : [];
                    // READ all products first and prepare new quantities
                    const updates = [];
                    for (const it of items) {
                        const productRef = doc(db, 'products', it.productId);
                        const productSnap = await transaction.get(productRef);
                        if (!productSnap.exists()) throw `Ø§Ù„Ù…Ù†ØªØ¬ ${it.productName} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!`;
                        const currentQty = Number(productSnap.data().quantity || 0);
                        const newQty = currentQty + Number(it.quantity || 0);
                        updates.push({ productRef, newQty, it });
                    }
                    // WRITE: delete invoice completely
                    transaction.delete(invoiceRef);
                    // Restore product quantities ONLY if it was a purchase invoice
                    const invoiceChannel = inv.channel;
                    if (invoiceChannel === 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª') {
                        updates.forEach(u => transaction.update(u.productRef, { quantity: u.newQty }));
                    }
                });
                // Side effects after transaction: stockMovements IN, delete payments
                // Use the invoice data we already fetched before deletion
                const items = Array.isArray(inv.items) ? inv.items : [];
                for (const it of items) {
                    await addDoc(collection(db, 'stockMovements'), {
                        productId: it.productId,
                        quantity: it.quantity,
                        type: 'IN',
                        source: 'Void',
                        refId: invoiceId,
                        date: inv.date || new Date(),
                        createdAt: new Date(),
                        createdBy
                    });
                }
                // Delete all related payments
                const revQ = query(collection(db, 'payments'), where('invoiceId', '==', invoiceId));
                const revSnap = await getDocs(revQ);
                for (const p of revSnap.docs) {
                    await deleteDoc(doc(db, 'payments', p.id));
                }
                        await fetchAndDisplayInvoices('', true); // Force reload on login
                        await fetchAndDisplayProducts(false, true); // Force reload on login
                if (typeof calculateSalesAnalytics === 'function') calculateSalesAnalytics();
                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.');
            } catch (err) {
                console.error('Void error:', err);
                console.error('Error details:', {
                    invoiceId,
                    error: err,
                    stack: err.stack
                });
                
                // Provide more specific error messages
                let errorMessage = 'ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ';
                if (err.message && err.message.includes('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©')) {
                    errorMessage += 'Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
                } else if (err.message && err.message.includes('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹')) {
                    errorMessage += 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹';
                } else if (err.message && err.message.includes('Ø§Ù„Ù…Ù†ØªØ¬')) {
                    errorMessage += err.message;
                } else {
                    errorMessage += err.toString();
                }
                
                alert(errorMessage);
            }
        }
        if(addInvoiceBtn) addInvoiceBtn.addEventListener('click', showAddModal);
        if(cancelInvoiceBtn) cancelInvoiceBtn.addEventListener('click', hideAddModal);
        if(closeViewModalBtn) closeViewModalBtn.addEventListener('click', hideViewModal);
        if(printInvoiceBtn) printInvoiceBtn.addEventListener('click', () => { if (currentOpenInvoiceId) showPrintTypeModal(); });
        if(printCustomerBtn) printCustomerBtn.addEventListener('click', () => { 
            currentPrintType = 'customer'; 
            hidePrintTypeModal(); 
            if (currentOpenInvoiceId) showPrintableModal(currentOpenInvoiceId); 
        });
        if(printCompanyBtn) printCompanyBtn.addEventListener('click', () => { 
            currentPrintType = 'company'; 
            hidePrintTypeModal(); 
            if (currentOpenInvoiceId) showPrintableModal(currentOpenInvoiceId); 
        });
        if(cancelPrintTypeBtn) cancelPrintTypeBtn.addEventListener('click', hidePrintTypeModal);
        if(executePrintBtn) executePrintBtn.addEventListener('click', () => {
            const oldTitle = document.title;
            try {
                const inv = currentOpenInvoiceId ? invoiceData[currentOpenInvoiceId] : null;
                if (inv) {
                    // Get customer name and sanitize it for filename
                    const customerName = inv.customer || 'Unknown';
                    const sanitizedCustomerName = customerName.trim().replace(/[^a-zA-Z0-9\u0600-\u06FF\s_-]/g, '').replace(/\s+/g, ' ');
                    
                    // Get invoice date and format as DD-MM-YYYY
                    let formattedDate = '';
                    if (inv.date) {
                        const invoiceDate = new Date(inv.date.seconds ? inv.date.seconds * 1000 : inv.date);
                        const day = String(invoiceDate.getDate()).padStart(2, '0');
                        const month = String(invoiceDate.getMonth() + 1).padStart(2, '0');
                        const year = invoiceDate.getFullYear();
                        formattedDate = `${day}-${month}-${year}`;
                    } else {
                        // Fallback to current date if no date available
                        const now = new Date();
                        const day = String(now.getDate()).padStart(2, '0');
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const year = now.getFullYear();
                        formattedDate = `${day}-${month}-${year}`;
                    }
                    
                    // Set document title for PDF filename
                    document.title = `${sanitizedCustomerName} - ${formattedDate}`;
                } else {
                    // Fallback to invoice number if no invoice data
                    const invoiceNumber = currentOpenInvoiceId ? String(currentOpenInvoiceId).substring(0, 8).toUpperCase() : 'INVOICE';
                    const safe = String(invoiceNumber).trim().replace(/[^a-zA-Z0-9 _.-]+/g, '-').replace(/\s+/g, ' ');
                    document.title = `Invoice-${safe}`;
                }
            } catch (_) { /* no-op */ }
            const restore = () => {
                document.title = oldTitle;
                window.removeEventListener('afterprint', restore);
                if (restore._t) clearTimeout(restore._t);
            };
            window.addEventListener('afterprint', restore);
            restore._t = setTimeout(restore, 3000);
            window.print();
        });
        if(closePrintModalBtn) closePrintModalBtn.addEventListener('click', hidePrintableModal);
        
        // Purchase modal event listeners
        const closeViewPurchaseModalBtn = document.getElementById('close-view-purchase-modal-btn');
        if(closeViewPurchaseModalBtn) closeViewPurchaseModalBtn.addEventListener('click', hidePurchaseModal);
        if(printPurchaseBtn) printPurchaseBtn.addEventListener('click', () => { if (currentOpenPurchaseId) showPrintablePurchaseModal(currentOpenPurchaseId); });
        if(executePurchasePrintBtn) executePurchasePrintBtn.addEventListener('click', () => {
            const oldTitle = document.title;
            try {
                document.title = 'ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡';
                const restore = () => {
                    document.title = oldTitle;
                    window.removeEventListener('afterprint', restore);
                };
                window.addEventListener('afterprint', restore);
                window.print();
            } catch (e) {
                console.error('Print error', e);
                document.title = oldTitle;
            }
        });
        if(closePurchasePrintModalBtn) closePurchasePrintModalBtn.addEventListener('click', hidePrintablePurchaseModal);
        
        if(closeProductViewBtn) closeProductViewBtn.addEventListener('click', hideProductViewModal);
        
        // Add real-time validation for manual invoice number
        const manualInvoiceNumberInput = document.getElementById('manual-invoice-number');
        if(manualInvoiceNumberInput) {
            manualInvoiceNumberInput.addEventListener('input', validateManualInvoiceNumber);
            manualInvoiceNumberInput.addEventListener('blur', validateManualInvoiceNumber);
        }
        
        if(saveInvoiceBtn) {
            saveInvoiceBtn.addEventListener('click', async () => {
                if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.'); return; }
                
                // CRITICAL: Prevent double-click and multiple submissions
                if (saveInvoiceBtn.disabled) {
                    console.log('Invoice save already in progress, ignoring duplicate click');
                    return;
                }
                
                // Basic validations
                const hasInvalid = Array.from(invoiceItemsContainer.querySelectorAll('.invoice-item')).some(row => {
                    const productId = (row.querySelector('.item-desc') || {}).value || '';
                    const qty = Number((row.querySelector('.item-qty') || {}).value || 0);
                    const price = Number((row.querySelector('.item-price') || {}).value || 0);
                    return !productId || qty <= 0 || price < 0;
                });
                if (hasInvalid) { alert('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†ÙˆØ¯: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù…Ø¹ ÙƒÙ…ÙŠØ© ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­ÙŠÙ†.'); return; }

                const itemsToSave = [];
                const itemsElements = invoiceItemsContainer.querySelectorAll('.invoice-item');
                
                for (const el of itemsElements) {
                    const productInput = el.querySelector('.item-desc');
                    const quantity = Number(el.querySelector('.item-qty').value);
                    const price = Number(el.querySelector('.item-price').value);
                    const productName = productInput.value.trim();
                    
                    if (!productName || quantity <= 0 || price < 0) continue;
                    
                    // Check if it's an existing product
                    const existingProduct = productsCache.find(p => `${p.name} (${p.sku})` === productName);
                    let productId;
                    
                    if (existingProduct) {
                        // Use existing product
                        productId = existingProduct.id;
                    } else {
                        // Create new product
                        productId = await createNewProductFromText(productName, price);
                        if (!productId) {
                            alert(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬: ${productName}`);
                            continue;
                        }
                    }
                    
                    // Use website price as unit cost for now (until FIFO)
                    const prod = productsCache.find(p => p.id === productId) || {};
                    const unitCost = Number(prod.websitePrice || price);
                    const lineCOGS = unitCost * quantity;
                    itemsToSave.push({ productId, productName, quantity, price, unitCost, lineCOGS });
                }

                if(itemsToSave.length === 0) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø©.'); return; }
                
                saveInvoiceBtn.disabled = true;
                saveInvoiceBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

                try {
                    const customer = document.getElementById('customer-name').value.trim();
                    const date = document.getElementById('invoice-date').value;
                    const channel = document.getElementById('sales-channel').value;
                    const paymentMethod = document.getElementById('payment-method').value;
                    const description = document.getElementById('invoice-description').value.trim();
                    const paymentStatus = document.getElementById('payment-status').value; // ignored; status is recalculated
                    const paidAmount = Number(document.getElementById('paid-amount').value || 0);
                    const paidAt = document.getElementById('paid-at').value || null;
                    const manualInvoiceNumber = document.getElementById('manual-invoice-number').value.trim();
                    const discount = Number(document.getElementById('invoice-discount').value || 0);
                    const discountPercent = Number(document.getElementById('invoice-discount-percent').value || 0);

                    // compute totals FIRST (before any validation checks)
                    const subtotal = itemsToSave.reduce((acc, it) => acc + (Number(it.quantity) * Number(it.price)), 0);
                    
                    // Apply discount (percentage takes precedence)
                    let finalDiscount = 0;
                    if (discountPercent > 0) {
                        finalDiscount = subtotal * (discountPercent / 100);
                    } else {
                        finalDiscount = discount;
                    }
                    
                    const invoiceTotal = Math.max(0, subtotal - finalDiscount);
                    
                    // CRITICAL: Check for duplicate manual invoice number (ONLY for new invoices)
                    if (manualInvoiceNumber && !currentEditingInvoiceId) {
                        console.log('[Quota Usage] Checking for duplicate manual invoice number...');
                        const isDuplicate = await checkManualInvoiceNumberExists(manualInvoiceNumber, currentEditingInvoiceId);
                        console.log('[Quota Usage] Duplicate check completed');
                        if (isDuplicate) {
                            alert(`Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠ "${manualInvoiceNumber}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ù…Ø®ØªÙ„Ù.`);
                            saveInvoiceBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
                            saveInvoiceBtn.disabled = false;
                            return;
                        }
                    }
                    
                    // CRITICAL: Check for duplicate invoice content (same customer, date, total, items)
                    if (!currentEditingInvoiceId) {
                        console.log('[Quota Usage] Checking for duplicate invoice content...');
                        const isContentDuplicate = await checkInvoiceContentDuplicate(customer, date, invoiceTotal, itemsToSave);
                        console.log('[Quota Usage] Content duplicate check completed');
                        if (isContentDuplicate) {
                            alert(`ØªØ­Ø°ÙŠØ±: ÙØ§ØªÙˆØ±Ø© Ù…Ù…Ø§Ø«Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ù…Ø®ØªÙ„ÙØ©.`);
                            saveInvoiceBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
                            saveInvoiceBtn.disabled = false;
                            return;
                        }
                    }
                    const amountDue = Math.max(0, invoiceTotal - paidAmount);

                    if (currentEditingInvoiceId) {
                        const prev = invoiceData[currentEditingInvoiceId] || {};
                        const prevItems = Array.isArray(prev.items) ? prev.items : [];
                        const mergedItems = itemsToSave.map(it => {
                            const old = prevItems.find(p => p.productId === it.productId);
                            const unitCost = (old && old.unitCost != null) ? old.unitCost : it.unitCost;
                            const lineCOGS = unitCost * Number(it.quantity || 0);
                            return { ...it, unitCost, lineCOGS };
                        });
                        const updatedInvoiceData = { customer, date, channel, paymentMethod, description, manualInvoiceNumber, discount: finalDiscount, discountPercent, subtotal, total: invoiceTotal, amountDue, items: mergedItems, updatedAt: new Date(), updatedBy: (auth && auth.currentUser) ? auth.currentUser.uid : null };
                        await setDoc(doc(db, 'invoices', currentEditingInvoiceId), updatedInvoiceData, { merge: true });
                        
                        // Record payment entry if provided
                        if (paidAmount > 0) {
                            const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                            await addDoc(collection(db, 'payments'), {
                                invoiceId: currentEditingInvoiceId,
                                amount: paidAmount,
                                method: paymentMethod,
                                paidAt: paidAt || date || null,
                                createdAt: new Date(),
                                createdBy
                            });
                        }
                        
                        // Recalc payment state using invoice data we already have (avoid re-reading)
                        // Get the updated invoice data with recalculated payment state
                        const recalculatedInvoiceData = await recalcInvoicePaymentState(currentEditingInvoiceId, updatedInvoiceData);
                        
                        // Use recalculated data if available, otherwise fall back to updatedInvoiceData
                        const finalInvoiceData = recalculatedInvoiceData || updatedInvoiceData;
                        
                        // Update local cache with recalculated payment state
                        if (invoiceData) {
                            invoiceData[currentEditingInvoiceId] = { ...finalInvoiceData, id: currentEditingInvoiceId };
                        }
                        const invoiceIndex = allInvoices.findIndex(inv => inv.id === currentEditingInvoiceId);
                        if (invoiceIndex >= 0) {
                            allInvoices[invoiceIndex].invoice = { ...finalInvoiceData, id: currentEditingInvoiceId };
                        }
                        const filteredIndex = filteredInvoices.findIndex(inv => inv.id === currentEditingInvoiceId);
                        if (filteredIndex >= 0) {
                            filteredInvoices[filteredIndex].invoice = { ...finalInvoiceData, id: currentEditingInvoiceId };
                        }
                        currentInvoicePage = {};
                        displayFilteredInvoices(filteredInvoices, {});
                    } else {
                        // Pre-create invoice ref to capture ID for stock movements
                        const invoiceRef = doc(collection(db, 'invoices'));
                        
                        // Safety check: Firestore transactions have a limit of 500 document reads
                        if (itemsToSave.length > 400) {
                            alert(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${itemsToSave.length}). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© Ù‡Ùˆ 400 Ù…Ù†ØªØ¬. ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ù‰ ÙÙˆØ§ØªÙŠØ± Ø£ØµØºØ±.`);
                            saveInvoiceBtn.disabled = false;
                            saveInvoiceBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
                            return;
                        }
                        
                        console.log('[Quota Usage] Getting invoice number...');
                        const invoiceNumber = await getNextInvoiceNumber();
                        console.log('[Quota Usage] Invoice number obtained');
                        const newInvoiceData = { customer, date, channel, paymentMethod, description, manualInvoiceNumber, invoiceNumber, discount: finalDiscount, discountPercent, subtotal, total: invoiceTotal, amountDue, items: itemsToSave, createdAt: new Date(), createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null };
                        
                        // Track which products had inventory (to avoid re-reading later)
                        const productsWithInventory = [];
                        
                        console.log(`[Quota Usage] Starting transaction with ${itemsToSave.length} items...`);
                        
                        // Check if this is a purchase invoice (channel = "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª")
                        const isPurchaseInvoice = channel === 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª';
                        
                        await runTransaction(db, async (transaction) => {
                            // 1) READ all required product docs first
                            const productUpdates = [];
                            for (const item of itemsToSave) {
                                const productRef = doc(db, 'products', item.productId);
                                const productDoc = await transaction.get(productRef);
                                if (!productDoc.exists()) { throw `Ø§Ù„Ù…Ù†ØªØ¬ ${item.productName} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!`; }
                                
                                // For purchase invoices: automatically decrease inventory
                                if (isPurchaseInvoice) {
                                    const currentQty = Number(productDoc.data().quantity || 0);
                                    const newQuantity = currentQty - Number(item.quantity || 0);
                                    
                                    // Check stock quantity for purchase invoices
                                    if (currentQty > 0 && newQuantity < 0) { 
                                        throw `Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬: ${item.productName}. Ø§Ù„Ù…ØªØ§Ø­: ${currentQty}, Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${item.quantity}`; 
                                    }
                                    
                                    // Only update inventory for existing products with positive quantities
                                    if (currentQty > 0) {
                                        productUpdates.push({ productRef, newQuantity });
                                        productsWithInventory.push(item.productId);
                                    }
                                } else {
                                    // For sales invoices: no automatic inventory updates
                                    // Track products for stock movement records (for tracking purposes only)
                                    productsWithInventory.push(item.productId);
                                }
                            }
                            // 2) WRITE: create invoice
                            transaction.set(invoiceRef, newInvoiceData);
                            // 3) WRITE: update product quantities ONLY for purchase invoices
                            if (isPurchaseInvoice) {
                                for (const upd of productUpdates) {
                                    transaction.update(upd.productRef, { quantity: upd.newQuantity });
                                }
                            }
                        });
                        
                        // 3. Create stock movement OUT entries after successful transaction (only for existing products)
                        // Use tracked productsWithInventory instead of re-reading
                        const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                        for (const item of itemsToSave) {
                            // Only create stock movements for products that had inventory (tracked during transaction)
                            if (productsWithInventory.includes(item.productId)) {
                                await addDoc(collection(db, 'stockMovements'), {
                                    productId: item.productId,
                                    quantity: item.quantity,
                                    type: 'OUT',
                                    source: 'Sale',
                                    refId: invoiceRef.id,
                                    date: date || new Date(),
                                    createdAt: new Date(),
                                    createdBy
                                });
                            }
                        }
                        
                        // 4. Record payment entry if provided
                        if (paidAmount > 0) {
                            await addDoc(collection(db, 'payments'), {
                                invoiceId: invoiceRef.id,
                                amount: paidAmount,
                                method: paymentMethod,
                                paidAt: paidAt || date || null,
                                createdAt: new Date(),
                                createdBy
                            });
                        }
                        
                        // Recalc payment state using invoice data we already have (avoid re-reading)
                        console.log('[Quota Usage] Recalculating payment state...');
                        // Get the updated invoice data with recalculated payment state
                        const recalculatedNewInvoiceData = await recalcInvoicePaymentState(invoiceRef.id, newInvoiceData);
                        console.log('[Quota Usage] Payment state recalculated');
                        
                        // Use recalculated data if available, otherwise fall back to newInvoiceData
                        const finalInvoiceData = recalculatedNewInvoiceData 
                            ? { ...recalculatedNewInvoiceData, id: invoiceRef.id }
                            : { ...newInvoiceData, id: invoiceRef.id };
                        
                        // Update local cache instead of full refetch to save quota
                        if (!invoiceData) invoiceData = {};
                        invoiceData[invoiceRef.id] = finalInvoiceData;
                        if (!allInvoices) allInvoices = [];
                        allInvoices.unshift({ id: invoiceRef.id, invoice: finalInvoiceData });
                        if (!filteredInvoices) filteredInvoices = [];
                        filteredInvoices.unshift({ id: invoiceRef.id, invoice: finalInvoiceData });
                        currentInvoicePage = {};
                        displayFilteredInvoices(filteredInvoices, {});
                        
                        // Update product quantities in local cache ONLY for purchase invoices
                        if (isPurchaseInvoice) {
                            for (const item of itemsToSave) {
                                if (productsWithInventory.includes(item.productId)) {
                                    const productIndex = productsCache.findIndex(p => p.id === item.productId);
                                    if (productIndex >= 0) {
                                        productsCache[productIndex].quantity = (productsCache[productIndex].quantity || 0) - Number(item.quantity || 0);
                                    }
                                    const allProductIndex = allProducts.findIndex(p => p.id === item.productId);
                                    if (allProductIndex >= 0) {
                                        allProducts[allProductIndex].quantity = (allProducts[allProductIndex].quantity || 0) - Number(item.quantity || 0);
                                    }
                                }
                            }
                            displayFilteredProducts(filteredProducts || allProducts);
                        }
                    }

                    console.log("Invoice and stock update successful!");
                    // Removed full refetch - using local cache updates instead to save quota
                    // OPTIMIZATION: Analytics now uses cached data (0 reads) instead of querying all invoices
                    // Only update if on dashboard page to avoid unnecessary calculations
                    const currentPage = document.querySelector('.page:not(.hidden)');
                    if (currentPage && currentPage.id === 'dashboard-page' && typeof calculateSalesAnalytics === 'function') {
                        // Use setTimeout to avoid blocking, analytics uses cache so it's fast
                        setTimeout(() => calculateSalesAnalytics(), 100);
                    }
                    hideAddModal();

                } catch (error) {
                    console.error("Transaction failed: ", error);
                    let errorMessage = "ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: " + error;
                    if (error.code === 'resource-exhausted' || error.message.includes('Quota exceeded')) {
                        errorMessage = "ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Quota exceeded).\n\n" +
                            "Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø­ØªÙ…Ù„:\n" +
                            "- ØªÙ… Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„ÙƒØªØ§Ø¨Ø©\n" +
                            "- Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø£Ùˆ Ø§Ù„ÙÙˆØ§ØªÙŠØ±\n\n" +
                            "Ø§Ù„Ø­Ù„ÙˆÙ„:\n" +
                            "1. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø¹Ø§Ø¯Ø© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„)\n" +
                            "2. ØªØ±Ù‚ÙŠØ© Ø®Ø·Ø© Firebase Ø¥Ù„Ù‰ Blaze (Pay as you go)\n" +
                            "3. ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©\n" +
                            "4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Console";
                    }
                    alert(errorMessage);
                } finally {
                    saveInvoiceBtn.disabled = false;
                    saveInvoiceBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
                }
            });
        }

        if (salesGroupsContainer) { salesGroupsContainer.addEventListener('click', e => {
            const viewEl = e.target.closest && e.target.closest('.view-invoice-btn');
            const editEl = e.target.closest && e.target.closest('.edit-invoice-btn');
            const voidEl = e.target.closest && e.target.closest('.void-invoice-btn');
            if (viewEl) { showViewModal(viewEl.dataset.invoiceId); return; }
            if (editEl) { openInvoiceInEditMode(editEl.dataset.invoiceId); return; }
            if (voidEl) { voidInvoice(voidEl.dataset.invoiceId); return; }
        }); }
        
        // Channel filter buttons event listeners
        const channelFilterButtons = document.querySelectorAll('.channel-filter-btn');
        let currentChannelFilter = ''; // Track current filter
        
        channelFilterButtons.forEach(button => {
            button.addEventListener('click', async () => {
                // Remove active class from all buttons
                channelFilterButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                button.classList.add('active');
                
                // Get the channel value
                const channel = button.dataset.channel || '';
                currentChannelFilter = channel;
                
                // Apply the filter and trigger search to work with other filters
                await fetchAndDisplayInvoices(channel);
                performSearch(); // This ensures other filters are also applied
            });
        });
        
        // Search and Filter Event Listeners
        if (searchInvoicesBtn) {
            searchInvoicesBtn.addEventListener('click', performSearch);
        }
        
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', clearAllFilters);
        }
        
        // Real-time search on input change
        if (invoiceSearch) {
            invoiceSearch.addEventListener('input', performSearch);
        }
        
        // Filter change events
        if (dateFrom) {
            dateFrom.addEventListener('change', performSearch);
        }
        
        if (dateTo) {
            dateTo.addEventListener('change', performSearch);
        }
        
        if (amountFrom) {
            amountFrom.addEventListener('input', performSearch);
        }
        
        if (amountTo) {
            amountTo.addEventListener('input', performSearch);
        }
        
        if (paymentStatusFilter) {
            paymentStatusFilter.addEventListener('change', performSearch);
        }
        
        if (paymentMethodFilter) {
            paymentMethodFilter.addEventListener('change', performSearch);
        }
        
        if (sortBy) {
            sortBy.addEventListener('change', performSearch);
        }
        
        // Quick Filter Buttons
        if (quickFilterToday) {
            quickFilterToday.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                if (dateFrom) dateFrom.value = today;
                if (dateTo) dateTo.value = today;
                performSearch();
            });
        }
        
        if (quickFilterWeek) {
            quickFilterWeek.addEventListener('click', () => {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                if (dateFrom) dateFrom.value = weekAgo.toISOString().split('T')[0];
                if (dateTo) dateTo.value = today.toISOString().split('T')[0];
                performSearch();
            });
        }
        
        if (quickFilterMonth) {
            quickFilterMonth.addEventListener('click', () => {
                const today = new Date();
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                if (dateFrom) dateFrom.value = monthAgo.toISOString().split('T')[0];
                if (dateTo) dateTo.value = today.toISOString().split('T')[0];
                performSearch();
            });
        }
        
        if (quickFilterUnpaid) {
            quickFilterUnpaid.addEventListener('click', () => {
                if (paymentStatusFilter) paymentStatusFilter.value = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                performSearch();
            });
        }
        
        if (quickFilterOverdue) {
            quickFilterOverdue.addEventListener('click', () => {
                // Filter for invoices older than 30 days and unpaid
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                if (dateTo) dateTo.value = thirtyDaysAgo.toISOString().split('T')[0];
                if (paymentStatusFilter) paymentStatusFilter.value = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                performSearch();
            });
        }
        
        if (quickFilterHighValue) {
            quickFilterHighValue.addEventListener('click', () => {
                if (amountFrom) amountFrom.value = '1000';
                performSearch();
            });
        }
        
        // Export functionality
        if (exportInvoicesBtn) {
            exportInvoicesBtn.addEventListener('click', () => {
                if (filteredInvoices.length === 0) {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„ØªØµØ¯ÙŠØ±');
                    return;
                }
                
                // Create CSV content
                let csvContent = 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©,Ø§Ù„Ø¹Ù…ÙŠÙ„,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ,Ø§Ù„Ø­Ø§Ù„Ø©\n';
                filteredInvoices.forEach(({ id, invoice }) => {
                    const amountDue = invoice.amountDue != null ? Number(invoice.amountDue) : Math.max(0, Number(invoice.total||0) - Number(invoice.paidAmount||0));
                    const status = invoice.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                    csvContent += `"${invoice.manualInvoiceNumber || id}","${invoice.customer}","${invoice.date}","${invoice.total || 0}","${amountDue.toFixed(2)}","${status}"\n`;
                });
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `invoices_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
        
        // Inventory Search and Filter Event Listeners
        if (searchProductsBtn) {
            searchProductsBtn.addEventListener('click', performProductSearch);
        }
        
        if (clearProductFiltersBtn) {
            clearProductFiltersBtn.addEventListener('click', clearAllProductFilters);
        }
        
        // Real-time search on input change
        if (productSearch) {
            productSearch.addEventListener('input', performProductSearch);
        }
        
        // Filter change events
        if (quantityFrom) {
            quantityFrom.addEventListener('input', performProductSearch);
        }
        
        if (quantityTo) {
            quantityTo.addEventListener('input', performProductSearch);
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', performProductSearch);
        }
        
        if (priceFrom) {
            priceFrom.addEventListener('input', performProductSearch);
        }
        
        if (priceTo) {
            priceTo.addEventListener('input', performProductSearch);
        }
        
        if (productSort) {
            productSort.addEventListener('change', performProductSearch);
        }
        
        
        // Inventory Section
        const productModal = document.getElementById('product-modal');
        const addProductBtn = document.getElementById('add-product-btn');
        const deleteAllInventoryBtn = document.getElementById('delete-all-inventory-btn');
        const cancelProductBtn = document.getElementById('cancel-product-btn');
        const saveProductBtn = document.getElementById('save-product-btn');
        const addProductForm = document.getElementById('add-product-form');
        const productNameInput = document.getElementById('product-name');
        const productSkuInput = document.getElementById('product-sku');
        const productTotalQtyInput = document.getElementById('product-total-qty');
        const productWarehouseQtyInput = document.getElementById('product-warehouse-qty');
        const productShowroomQtyInput = document.getElementById('product-showroom-qty');
        const quantitySummary = document.getElementById('quantity-summary');
        const calculatedTotal = document.getElementById('calculated-total');
        const productModalTitle = productModal ? productModal.querySelector('h3') : null;
        const productWebsitePriceInput = document.getElementById('product-website-price');
        const productAmazonPriceInput = document.getElementById('product-amazon-price');
        const productDescriptionInput = document.getElementById('product-description');
        const currentStockDisplay = document.getElementById('current-stock-display');
        const currentWarehouseQtyDisplay = document.getElementById('current-warehouse-qty');
        const currentShowroomQtyDisplay = document.getElementById('current-showroom-qty');
        let currentEditingProductId = null;
        
        if(addProductBtn) addProductBtn.addEventListener('click', () => { 
            const inlineForm = document.getElementById('inline-product-form');
            if (inlineForm) {
                inlineForm.classList.remove('hidden');
                document.getElementById('inline-product-name').focus();
            }
        });
        
        // Delete All Inventory Button
        if(deleteAllInventoryBtn) {
            deleteAllInventoryBtn.addEventListener('click', async () => {
                // Strong confirmation - this is a destructive operation
                const firstConfirm = confirm(
                    'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!\n\n' +
                    'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŸ\n\n' +
                    'Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!'
                );
                
                if (!firstConfirm) return;
                
                // Second confirmation for extra safety
                const secondConfirm = confirm(
                    'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ:\n\n' +
                    'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\n' +
                    'Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!\n\n' +
                    'Ø§Ø¶ØºØ· "Ù…ÙˆØ§ÙÙ‚" ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…ØªØ£ÙƒØ¯Ø§Ù‹ 100%'
                );
                
                if (!secondConfirm) return;
                
                // Final confirmation with product count
                try {
                    if (!db) {
                        alert('Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©.');
                        return;
                    }
                    
                    // Get product count
                    const productsQuery = query(collection(db, 'products'));
                    const productsSnapshot = await getDocs(productsQuery);
                    const productCount = productsSnapshot.size;
                    
                    if (productCount === 0) {
                        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø­Ø°Ù.');
                        return;
                    }
                    
                    const finalConfirm = confirm(
                        `âš ï¸ Ø§Ù„ØªØ­Ø°ÙŠØ± Ø§Ù„Ø£Ø®ÙŠØ±:\n\n` +
                        `Ø³ÙŠØªÙ… Ø­Ø°Ù ${productCount} Ù…Ù†ØªØ¬ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.\n\n` +
                        `Ø§Ø¶ØºØ· "Ù…ÙˆØ§ÙÙ‚" ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Øª Ù…ØªØ£ÙƒØ¯Ø§Ù‹ ØªÙ…Ø§Ù…Ø§Ù‹!`
                    );
                    
                    if (!finalConfirm) return;
                    
                    // Disable button and show loading
                    deleteAllInventoryBtn.disabled = true;
                    deleteAllInventoryBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
                    
                    // Delete all products
                    const deletePromises = [];
                    productsSnapshot.forEach((docSnap) => {
                        deletePromises.push(deleteDoc(doc(db, 'products', docSnap.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    
                    // Clear local cache
                    productsCache = [];
                    allProducts = [];
                    filteredProducts = [];
                    
                    // Refresh display
                    await fetchAndDisplayProducts(true, true); // Force reload
                    
                    // Reset button
                    deleteAllInventoryBtn.disabled = false;
                    deleteAllInventoryBtn.textContent = 'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª';
                    
                    alert(`âœ… ØªÙ… Ø­Ø°Ù ${productCount} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`);
                    
                } catch (error) {
                    console.error('Error deleting all products:', error);
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ' + error.message);
                    
                    // Reset button
                    deleteAllInventoryBtn.disabled = false;
                    deleteAllInventoryBtn.textContent = 'Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª';
                }
            });
        }
        function closeAndResetProductModal() { 
            productModal.classList.add('hidden'); 
            addProductForm.reset(); 
            currentEditingProductId = null; 
            if(productModalTitle) productModalTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯'; 
            if(saveProductBtn) saveProductBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬'; 
            if(currentStockDisplay) currentStockDisplay.classList.add('hidden');
            // Reset quantity fields to 0
            if(productTotalQtyInput) productTotalQtyInput.value = '0';
            if(productWarehouseQtyInput) productWarehouseQtyInput.value = '0';
            if(productShowroomQtyInput) productShowroomQtyInput.value = '0';
            // Hide quantity summary
            if(quantitySummary) quantitySummary.classList.add('hidden');
        }
        
        // Function to load current stock levels
        async function loadCurrentStockLevels(productId) {
            try {
                const locations = await calculateLocationQuantities(productId);
                if (currentWarehouseQtyDisplay) currentWarehouseQtyDisplay.textContent = locations.warehouse;
                if (currentShowroomQtyDisplay) currentShowroomQtyDisplay.textContent = locations.showroom;
            } catch (error) {
                console.error('Error loading stock levels:', error);
                if (currentWarehouseQtyDisplay) currentWarehouseQtyDisplay.textContent = '0';
                if (currentShowroomQtyDisplay) currentShowroomQtyDisplay.textContent = '0';
            }
        }
        if(cancelProductBtn) cancelProductBtn.addEventListener('click', closeAndResetProductModal);
        
        // Inline product creation logic
        const inlineProductForm = document.getElementById('inline-product-form');
        const quickAddProductForm = document.getElementById('quick-add-product-form');
        const saveInlineProductBtn = document.getElementById('save-inline-product-btn');
        const cancelInlineProductBtn = document.getElementById('cancel-inline-product-btn');
        
        function hideInlineProductForm() {
            if (inlineProductForm) {
                inlineProductForm.classList.add('hidden');
                quickAddProductForm.reset();
            }
        }
        
        if (cancelInlineProductBtn) {
            cancelInlineProductBtn.addEventListener('click', hideInlineProductForm);
        }
        
        if (quickAddProductForm) {
            quickAddProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†.'); return; }
                
                const name = document.getElementById('inline-product-name').value.trim();
                const sku = document.getElementById('inline-product-sku').value.trim();
                const quantity = Number(document.getElementById('inline-product-quantity').value || 0);
                const websitePrice = Number(document.getElementById('inline-product-website-price').value);
                const amazonPrice = Number(document.getElementById('inline-product-amazon-price').value);
                
                if (!name || !sku) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù… Ùˆ SKU).');
                    return;
                }
                
                if (isNaN(quantity) || quantity < 0) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© (0 Ø£Ùˆ Ø£ÙƒØ¨Ø±).');
                    return;
                }
                
                if (saveInlineProductBtn) {
                    saveInlineProductBtn.disabled = true;
                    saveInlineProductBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                }
                
                try {
                    // Check SKU uniqueness
                    const skuQ = query(collection(db, 'products'), where('sku', '==', sku));
                    const skuSnap = await getDocs(skuQ);
                    if (!skuSnap.empty) { 
                        alert('SKU Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… SKU ÙØ±ÙŠØ¯.'); 
                        return; 
                    }
                    
                    // Create the product with the entered quantity
                    const newProduct = {
                        name,
                        sku,
                        websitePrice: websitePrice || 0,
                        amazonPrice: amazonPrice || 0,
                        quantity: quantity, // Use the quantity entered by the user
                        category: 'Ø¹Ø§Ù…',
                        createdAt: new Date(),
                        createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null
                    };
                    
                    const docRef = await addDoc(collection(db, 'products'), newProduct);
                    const newProductId = docRef.id;
                    
                    // Add to products cache
                    productsCache.push({ id: newProductId, ...newProduct });
                    
                    // Refresh the products display
                    await fetchAndDisplayProducts();
                    
                    // Hide the form
                    hideInlineProductForm();
                    
                    alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
                    
                } catch (error) {
                    console.error('Error creating product:', error);
                    alert('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬: ' + (error.message || error));
                } finally {
                    if (saveInlineProductBtn) {
                        saveInlineProductBtn.disabled = false;
                        saveInlineProductBtn.textContent = 'Ø­ÙØ¸';
                    }
                }
            });
        }
        if(productModal) productModal.addEventListener('click', e => { if (e.target === productModal) { closeAndResetProductModal(); } });
        
        // Quantity field event listeners for auto-calculation and validation
        function updateQuantityCalculations() {
            const warehouseQty = Number(productWarehouseQtyInput?.value || 0);
            const showroomQty = Number(productShowroomQtyInput?.value || 0);
            const totalQty = Number(productTotalQtyInput?.value || 0);
            const calculatedSum = warehouseQty + showroomQty;
            
            // Update calculated total display
            if (calculatedTotal) {
                calculatedTotal.textContent = calculatedSum;
            }
            
            // Show/hide quantity summary
            if (quantitySummary) {
                if (warehouseQty > 0 || showroomQty > 0) {
                    quantitySummary.classList.remove('hidden');
                } else {
                    quantitySummary.classList.add('hidden');
                }
            }
            
            // Validate that warehouse + showroom = total (if total is provided)
            if (totalQty > 0 && calculatedSum !== totalQty) {
                if (productTotalQtyInput) {
                    productTotalQtyInput.style.borderColor = '#ef4444';
                }
            } else {
                if (productTotalQtyInput) {
                    productTotalQtyInput.style.borderColor = '';
                }
            }
        }
        
        // Add event listeners to quantity fields
        if (productWarehouseQtyInput) {
            productWarehouseQtyInput.addEventListener('input', updateQuantityCalculations);
        }
        if (productShowroomQtyInput) {
            productShowroomQtyInput.addEventListener('input', updateQuantityCalculations);
        }
        if (productTotalQtyInput) {
            productTotalQtyInput.addEventListener('input', updateQuantityCalculations);
        }


        if(inventoryTableBody) {
            inventoryTableBody.addEventListener('click', async (e) => {
                const target = e.target;
                if (target && target.classList && target.classList.contains('view-product-btn')) {
                    const productId = target.getAttribute('data-product-id');
                    const product = productsCache.find(p => p.id === productId);
                    if (!product) return;
                    showProductViewModal(productId);
                }
                if (target && target.classList && target.classList.contains('edit-product-btn')) {
                    const productId = target.getAttribute('data-product-id');
                    const product = productsCache.find(p => p.id === productId);
                    if (!product) return;
                    currentEditingProductId = productId;
                    if(productModalTitle) productModalTitle.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†';
                    if(saveProductBtn) saveProductBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                    if(productNameInput) productNameInput.value = product.name || '';
                    if(productSkuInput) productSkuInput.value = product.sku || '';
                    // Load current stock levels into the quantity fields when editing
                    try {
                        const locations = await calculateLocationQuantities(productId);
                        if(productWarehouseQtyInput) productWarehouseQtyInput.value = locations.warehouse;
                        if(productShowroomQtyInput) productShowroomQtyInput.value = locations.showroom;
                        if(productTotalQtyInput) productTotalQtyInput.value = locations.total;
                        // Trigger calculation update
                        updateQuantityCalculations();
                    } catch (error) {
                        console.error('Error loading stock levels:', error);
                        if(productWarehouseQtyInput) productWarehouseQtyInput.value = '0';
                        if(productShowroomQtyInput) productShowroomQtyInput.value = '0';
                        if(productTotalQtyInput) productTotalQtyInput.value = '0';
                    }
                    if(productWebsitePriceInput) productWebsitePriceInput.value = product.websitePrice != null ? product.websitePrice : '';
                    if(productAmazonPriceInput) productAmazonPriceInput.value = product.amazonPrice != null ? product.amazonPrice : '';
                    if(productDescriptionInput) productDescriptionInput.value = product.description || '';
                    
                    // Show current stock levels when editing
                    if(currentStockDisplay) {
                        currentStockDisplay.classList.remove('hidden');
                        // Load current stock quantities
                        loadCurrentStockLevels(productId);
                    }
                    
                    productModal.classList.remove('hidden');
                }
                if (target && target.classList && target.classList.contains('delete-product-btn')) {
                    const productId = target.getAttribute('data-product-id');
                    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©ØŸ')) return;
                    (async () => {
                        try {
                            await setDoc(doc(db, 'products', productId), {
                                deleted: true,
                                deletedAt: new Date(),
                                deletedBy: (auth && auth.currentUser) ? auth.currentUser.uid : null
                            }, { merge: true });
                            await fetchAndDisplayProducts();
                            await loadDeletedLists();
                        } catch (e) {
                            console.error('Soft delete product failed', e);
                            alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.');
                        }
                    })();
                }
            });
        }

        // Stock Out Table Event Listener
        if(stockOutTableBody) {
            stockOutTableBody.addEventListener('click', (e) => {
                const target = e.target;
                if (target && target.classList && target.classList.contains('view-stock-out-btn')) {
                    const stockOutId = target.getAttribute('data-stock-out-id');
                    showStockOutModal(stockOutId);
                }
            });
        }

        if(saveProductBtn) {
            saveProductBtn.addEventListener('click', async () => {
                if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬.'); return; }
                const name = productNameInput.value.trim();
                const sku = productSkuInput.value.trim();
                const description = productDescriptionInput.value.trim();
                const warehouseQty = Number(productWarehouseQtyInput.value || 0);
                const showroomQty = Number(productShowroomQtyInput.value || 0);
                const totalQty = Number(productTotalQtyInput.value || 0);
                const websitePrice = Number(productWebsitePriceInput.value || 0);
                const amazonPrice = Number(productAmazonPriceInput.value || 0);
                
                // Validation
                if (!name || !sku || isNaN(warehouseQty) || isNaN(showroomQty) || isNaN(websitePrice) || isNaN(amazonPrice)) { 
                    alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.'); 
                    return; 
                }
                
                // Validate quantity consistency
                const calculatedTotal = warehouseQty + showroomQty;
                if (totalQty > 0 && totalQty !== calculatedTotal) {
                    alert(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© (${totalQty}) Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù…Ø¹Ø±Ø¶ (${calculatedTotal}). ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒÙ…ÙŠØ§Øª.`);
                    return;
                }
                
                saveProductBtn.disabled = true;
                saveProductBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                
                const totalQuantity = warehouseQty + showroomQty;
                const newProductData = { name, sku, description, quantity: totalQuantity, websitePrice: websitePrice, amazonPrice: amazonPrice };
                
                try {
                    // Enforce SKU uniqueness
                    const skuQ = query(collection(db, 'products'), where('sku', '==', sku));
                    const skuSnap = await getDocs(skuQ);
                    const existsDifferent = skuSnap.docs.some(d => !currentEditingProductId || d.id !== currentEditingProductId);
                    if (existsDifferent) { throw new Error('SKU Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… SKU ÙØ±ÙŠØ¯.'); }
                    
                    const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                    
                    if (currentEditingProductId) {
                        // Editing existing product
                        const productRef = doc(db, 'products', currentEditingProductId);
                        const productSnap = await getDoc(productRef);
                        
                        if (productSnap.exists()) {
                            // Get current stock levels
                            const currentLocations = await calculateLocationQuantities(currentEditingProductId);
                            const currentWarehouseQty = currentLocations.warehouse;
                            const currentShowroomQty = currentLocations.showroom;
                            
                            // Calculate differences
                            const warehouseDiff = warehouseQty - currentWarehouseQty;
                            const showroomDiff = showroomQty - currentShowroomQty;
                            
                            // Update product data
                            await setDoc(productRef, newProductData, { merge: true });
                            
                            // Create stock movements for changes
                            if (warehouseDiff !== 0) {
                                await addDoc(collection(db, 'stockMovements'), {
                                    productId: currentEditingProductId,
                                    quantity: Math.abs(warehouseDiff),
                                    type: warehouseDiff > 0 ? 'IN' : 'OUT',
                                    source: 'Inventory Direct Edit',
                                    location: 'warehouse',
                                    date: new Date(),
                                    createdAt: new Date(),
                                    createdBy
                                });
                            }
                            
                            if (showroomDiff !== 0) {
                                await addDoc(collection(db, 'stockMovements'), {
                                    productId: currentEditingProductId,
                                    quantity: Math.abs(showroomDiff),
                                    type: showroomDiff > 0 ? 'IN' : 'OUT',
                                    source: 'Inventory Direct Edit',
                                    location: 'showroom',
                                    date: new Date(),
                                    createdAt: new Date(),
                                    createdBy
                                });
                            }
                            
                            // Ensure product quantity matches calculated total
                            const updatedLocations = await calculateLocationQuantities(currentEditingProductId);
                            await setDoc(productRef, { quantity: updatedLocations.total }, { merge: true });
                        }
                    } else {
                        // Creating new product
                        const docRef = await addDoc(collection(db, 'products'), { ...newProductData, createdAt: new Date() });
                        
                        // Create stock movements for initial quantities
                        if (warehouseQty > 0) {
                            await addDoc(collection(db, 'stockMovements'), {
                                productId: docRef.id,
                                quantity: warehouseQty,
                                type: 'IN',
                                source: 'Initial Product Creation',
                                location: 'warehouse',
                                date: new Date(),
                                createdAt: new Date(),
                                createdBy
                            });
                        }
                        
                        if (showroomQty > 0) {
                            await addDoc(collection(db, 'stockMovements'), {
                                productId: docRef.id,
                                quantity: showroomQty,
                                type: 'IN',
                                source: 'Initial Product Creation',
                                location: 'showroom',
                                date: new Date(),
                                createdAt: new Date(),
                                createdBy
                            });
                        }
                            
                        // Ensure product quantity matches calculated total
                        const updatedLocations = await calculateLocationQuantities(docRef.id);
                        await setDoc(docRef, { quantity: updatedLocations.total }, { merge: true });
                    }
                    
                    await fetchAndDisplayProducts();
                    closeAndResetProductModal();
                } catch (error) {
                    console.error("Error adding product:", error);
                    alert(error && error.message ? error.message : "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬.");
                } finally {
                    saveProductBtn.disabled = false;
                    saveProductBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬';
                }
            });
        }

        // --- Purchases Section ---
        async function getNextPurchaseNumber() {
            if (!db) return 'PUR-001';
            try {
                const counterRef = doc(db, 'counters', 'purchaseNumber');
                const counterSnap = await getDoc(counterRef);
                let currentNumber = 1;
                if (counterSnap.exists()) {
                    currentNumber = (counterSnap.data().value || 0) + 1;
                }
                await setDoc(counterRef, { value: currentNumber }, { merge: true });
                return `PUR-${currentNumber.toString().padStart(3, '0')}`;
            } catch (e) {
                console.error('Error getting purchase number', e);
                return `PUR-${Date.now().toString().slice(-3)}`;
            }
        }

        function getPurchaseStatusBadge(status) {
            const statusMap = {
                'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±': '<span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>',
                'Ù…Ø³ØªÙ„Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹': '<span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-xs">Ù…Ø³ØªÙ„Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>',
                'Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„': '<span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs">Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</span>',
                'Ù…Ù„ØºØ§Ø©': '<span class="bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs">Ù…Ù„ØºØ§Ø©</span>'
            };
            return statusMap[status] || `<span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs">${status}</span>`;
        }

        function getPurchasePaymentStatusBadge(status) {
            const statusMap = {
                'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹': '<span class="bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>',
                'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹': '<span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>',
                'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„': '<span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</span>'
            };
            return statusMap[status] || `<span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs">${status}</span>`;
        }

        async function fetchAndDisplayPurchases() {
            if (!db || !purchasesTableBody) return;
            purchasesTableBody.innerHTML = '<tr><td colspan="11" class="p-4 text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...</td></tr>';
            try {
                const qPurch = query(collection(db, 'purchases'), orderBy('createdAt', 'desc'));
                const snap = await getDocs(qPurch);
                purchasesTableBody.innerHTML = '';
                purchasesCache = [];
                
                // Variables for totals calculation
                let totalPurchasesAmount = 0;
                let totalPaidAmount = 0;
                let totalAmountDue = 0;
                let totalInvoices = 0;
                
                if (snap.empty) {
                    purchasesTableBody.innerHTML = '<tr><td colspan="11" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø±Ø§Ø¡.</td></tr>';
                    return;
                }
                let serialNumber = 1;
                snap.forEach(d => {
                    const p = d.data();
                    if (p && p.deleted === true) return;
                    purchasesCache.push({ id: d.id, ...p });
                    const subtotal = Array.isArray(p.items) ? p.items.reduce((s, it) => s + (Number(it.quantity)||0) * (Number(it.unitCost)||0), 0) : 0;
                    const vatEnabled = !!p.vatEnabled;
                    const vatRate = Number(p.vatRate || 0);
                    const vatAmount = vatEnabled ? (subtotal * (vatRate/100)) : 0;
                    const total = subtotal + vatAmount;
                    const paidAmount = Number(p.paidAmount || 0);
                    const amountDue = Math.max(0, total - paidAmount);
                    
                    // Add to totals (only for non-voided purchases)
                    if (!p.voided) {
                        totalPurchasesAmount += total;
                        totalPaidAmount += paidAmount;
                        totalAmountDue += amountDue;
                        totalInvoices++;
                    }
                    
                    const paymentStatus = p.voided ? 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' : (p.paymentStatus || (paidAmount === 0 ? 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' : (paidAmount >= total ? 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹')));
                    const receiveStatus = p.voided ? 'Ù…Ù„ØºØ§Ø©' : (p.purchaseStatus || 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                    const paymentStatusBadge = getPurchasePaymentStatusBadge(paymentStatus);
                    const receiveStatusBadge = getPurchaseStatusBadge(receiveStatus);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50' + (p.voided ? ' bg-gray-50' : '');
                    row.innerHTML = `
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${serialNumber}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${p.internalNumber || String(d.id).substring(0,8).toUpperCase()}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${p.supplierInvoiceNumber || '-'}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${p.supplierName || '-'}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${p.date || '-'}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${Number(total).toFixed(2)}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${paidAmount.toFixed(2)}</td>
                        <td class="p-3 ${p.voided ? 'text-gray-400 line-through' : ''}">${amountDue.toFixed(2)}</td>
                        <td class="p-3">${paymentStatusBadge}</td>
                        <td class="p-3">${receiveStatusBadge}</td>
                        <td class="p-3 space-x-2 space-x-reverse">
                            <span class="text-green-600 cursor-pointer view-purchase-btn" data-purchase-id="${d.id}">Ø¹Ø±Ø¶</span>
                            <span class="text-purple-600 cursor-pointer print-purchase-btn" data-purchase-id="${d.id}">Ø·Ø¨Ø§Ø¹Ø©</span>
                            ${p.voided ? '' : `<span class="text-blue-600 cursor-pointer edit-purchase-btn" data-purchase-id="${d.id}">ØªØ¹Ø¯ÙŠÙ„</span>`}
                            ${p.voided ? '' : `<span class="text-indigo-600 cursor-pointer edit-allocation-btn" data-purchase-id="${d.id}">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹</span>`}
                            ${p.voided ? '' : `<span class=\"text-red-600 cursor-pointer void-purchase-btn\" data-purchase-id=\"${d.id}\">Ø¥Ù„ØºØ§Ø¡</span>`}
                            ${p.deleted ? '' : `<span class=\"text-gray-600 cursor-pointer delete-purchase-btn\" data-purchase-id=\"${d.id}\">Ø­Ø°Ù</span>`}
                        </td>
                    `;
                    purchasesTableBody.appendChild(row);
                    serialNumber++; // Increment only for valid purchases
                });
                
                // Add total summary rows
                if (totalInvoices > 0) {
                    // Total row
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'bg-gray-100 font-bold';
                    totalRow.innerHTML = `
                        <td colspan="5" class="p-3 text-right">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</td>
                        <td class="p-3 font-bold text-lg">${totalPurchasesAmount.toFixed(2)} Ø¬.Ù…</td>
                        <td class="p-3 font-bold text-lg">${totalPaidAmount.toFixed(2)} Ø¬.Ù…</td>
                        <td class="p-3 font-bold text-lg">${totalAmountDue.toFixed(2)} Ø¬.Ù…</td>
                        <td colspan="3" class="p-3"></td>
                    `;
                    purchasesTableBody.appendChild(totalRow);
                    
                    // Summary info row
                    const summaryRow = document.createElement('tr');
                    summaryRow.className = 'bg-blue-50 text-sm';
                    summaryRow.innerHTML = `
                        <td colspan="11" class="p-2 text-center text-blue-800">
                            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${totalInvoices} ÙØ§ØªÙˆØ±Ø© | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: ${totalPurchasesAmount.toFixed(2)} Ø¬.Ù… | Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaidAmount.toFixed(2)} Ø¬.Ù… | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${totalAmountDue.toFixed(2)} Ø¬.Ù…
                        </td>
                    `;
                    purchasesTableBody.appendChild(summaryRow);
                }
            } catch (e) {
                console.error('Error loading purchases', e);
                purchasesTableBody.innerHTML = '<tr><td colspan="11" class="p-4 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª.</td></tr>';
            }
        }

        // Reverse previous allocations helper (net to zero)
        async function reversePurchaseAllocations(purchaseId) {
            // Find existing movements for this purchase and reverse quantities in products
            try {
                const qMov = query(collection(db, 'stockMovements'), where('refId', '==', purchaseId));
                const snap = await getDocs(qMov);
                for (const m of snap.docs) {
                    const mov = m.data();
                    // Decrease product quantity by movement qty
                    const pRef = doc(db, 'products', mov.productId);
                    const pSnap = await getDoc(pRef);
                    if (pSnap.exists()) {
                        const cur = Number(pSnap.data().quantity || 0);
                        await setDoc(pRef, { quantity: Math.max(0, cur - Number(mov.quantity || 0)) }, { merge: true });
                    }
                    // Remove movement document
                    // Note: We could mark reversed=true, but for simplicity we delete
                    await setDoc(doc(db, 'stockMovements', m.id), { reversed: true, reversedAt: new Date() }, { merge: true });
                }
            } catch (e) {
                console.error('reversePurchaseAllocations error', e);
                throw e;
            }
        }
        async function softDeletePurchase(purchaseId) {
            if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†.'); return; }
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©ØŸ')) return;
            try {
                await setDoc(doc(db, 'purchases', purchaseId), {
                    deleted: true,
                    deletedAt: new Date(),
                    deletedBy: (auth && auth.currentUser) ? auth.currentUser.uid : null
                }, { merge: true });
                await fetchAndDisplayPurchases();
                await loadDeletedLists();
            } catch (e) {
                console.error('Soft delete purchase failed', e);
                alert('ÙØ´Ù„ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡.');
            }
        }

        // Open purchase in edit mode
        function openPurchaseInEditMode(purchaseId) {
            const p = purchasesCache.find(x => x.id === purchaseId);
            if (!p) return;
            openPurchaseModal();
            purchaseSupplierInput.value = p.supplierName || '';
            purchaseDateInput.value = p.date || new Date().toISOString().slice(0,10);
            purchaseInternalNumberInput.value = p.internalNumber || '';
            purchaseSupplierInvoiceInput.value = p.supplierInvoiceNumber || '';
            
            // Set payment status and amount
            purchasePaymentStatusInput.value = p.paymentStatus || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
            purchaseInitialPaymentInput.value = p.paidAmount || 0;
            purchasePaymentMethodInput.value = ''; // Reset method for editing
            
            purchaseItemsContainer.innerHTML = '';
            const items = Array.isArray(p.items) ? p.items : [];
            items.forEach(it => {
                addPurchaseLine();
                const row = purchaseItemsContainer.lastElementChild;
                if (!row) return;
                const sel = row.querySelector('.pi-desc');
                const qty = row.querySelector('.pi-qty');
                const cost = row.querySelector('.pi-cost');
                if (sel) {
                    // Find the product name for the text input
                    const product = productsCache.find(p => p.id === it.productId);
                    if (product) {
                        sel.value = `${product.name} (${product.sku})`;
                    }
                }
                if (qty) qty.value = it.quantity != null ? it.quantity : 1;
                if (cost) cost.value = it.unitCost != null ? it.unitCost : 0;
            });
            calculatePurchaseTotal();
            // Overwrite save behavior to perform edit
            if (savePurchaseBtn) {
                const handler = async (e) => {
                    e && e.preventDefault && e.preventDefault();
                    if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†.'); return; }
                    const supplierName = purchaseSupplierInput.value.trim();
                    const date = purchaseDateInput.value || new Date().toISOString().slice(0,10);
                    const newItems = [];
                    const rows = purchaseItemsContainer.querySelectorAll('.purchase-item');
                    for (const row of rows) {
                        const productInput = row.querySelector('.pi-desc');
                        const qty = Number((row.querySelector('.pi-qty')||{}).value || 0);
                        const unitCost = Number((row.querySelector('.pi-cost')||{}).value || 0);
                        const productName = productInput ? productInput.value.trim() : '';
                        
                        if (!productName || qty <= 0 || unitCost < 0) continue;
                        
                        // Check if it's an existing product
                        const existingProduct = productsCache.find(p => `${p.name} (${p.sku})` === productName);
                        let productId;
                        
                        if (existingProduct) {
                            // Use existing product
                            productId = existingProduct.id;
                        } else {
                            // Create new product using the same logic as Sales section
                            productId = await createNewProductFromText(productName, unitCost);
                            if (!productId) {
                                alert(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬: ${productName}`);
                                continue;
                            }
                        }
                        
                        newItems.push({ productId, productName, quantity: qty, unitCost });
                    }
                    if (!supplierName || newItems.length === 0) { alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.'); return; }
                    try {
                        // Calculate payment info
                        const subtotal = newItems.reduce((s, it) => s + (Number(it.quantity)||0) * (Number(it.unitCost)||0), 0);
                        const vatEnabled = purchaseVatEnabledEl ? !!purchaseVatEnabledEl.checked : false;
                        const vatRate = purchaseVatRateEl ? Number(purchaseVatRateEl.value || 0) : 0;
                        const vatAmount = vatEnabled ? (subtotal * (vatRate/100)) : 0;
                        const total = subtotal + vatAmount;
                        const paymentStatus = purchasePaymentStatusInput.value || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                        const initialPayment = Number(purchaseInitialPaymentInput.value || 0);
                        const paymentMethod = purchasePaymentMethodInput.value.trim();
                        
                        let finalPaymentStatus = paymentStatus;
                        let finalPaidAmount = initialPayment;
                        
                        // Auto-calculate payment status and amount
                        if (paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„') {
                            finalPaidAmount = total;
                            finalPaymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                        } else if (paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') {
                            if (initialPayment >= total) {
                                finalPaidAmount = total;
                                finalPaymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                            } else if (initialPayment > 0) {
                                finalPaymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
                            } else {
                                finalPaymentStatus = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                                finalPaidAmount = 0;
                            }
                        } else {
                            finalPaidAmount = 0;
                            finalPaymentStatus = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                        }
                        
                        // Validate payment amount
                        if (finalPaidAmount > total) {
                            alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (${finalPaidAmount.toFixed(2)}) Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡ (${total.toFixed(2)}).`);
                            return;
                        }

                        // 1) Update purchase document
                        await setDoc(doc(db, 'purchases', purchaseId), { 
                            supplierName, 
                            date, 
                            internalNumber: purchaseInternalNumberInput.value.trim(),
                            supplierInvoiceNumber: purchaseSupplierInvoiceInput.value.trim(),
                            items: newItems, 
                            updatedAt: new Date(),
                            purchaseStatus: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', // Reset to pending when edited
                            paidAmount: finalPaidAmount,
                            paymentStatus: finalPaymentStatus
                        }, { merge: true });
                        // 2) Reverse previous allocations and quantities
                        await reversePurchaseAllocations(purchaseId);
                        closePurchaseModal();
                        // 3) Auto-allocate to warehouse (consistent with new purchases)
                        await autoAllocateToWarehouse(purchaseId, date, newItems);
                        // 4) Update product purchase history
                        await updateProductPurchaseHistory(purchaseId, supplierName, purchaseInternalNumberInput.value.trim(), purchaseSupplierInvoiceInput.value.trim(), date, newItems);
                        await fetchAndDisplayPurchases();
                        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­!');
                    } catch (e) {
                        console.error('Edit purchase error', e);
                        alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±Ø§Ø¡.');
                    } finally {
                        savePurchaseBtn.removeEventListener('click', handler);
                    }
                };
                // Ensure no duplicate handlers
                savePurchaseBtn.addEventListener('click', handler);
            }
        }

        if (purchasesTableBody) {
            purchasesTableBody.addEventListener('click', (e) => {
                const viewBtn = e.target && e.target.closest && e.target.closest('.view-purchase-btn');
                if (viewBtn) {
                    showPurchaseModal(viewBtn.getAttribute('data-purchase-id'));
                    return;
                }
                const printBtn = e.target && e.target.closest && e.target.closest('.print-purchase-btn');
                if (printBtn) {
                    printPurchase(printBtn.getAttribute('data-purchase-id'));
                    return;
                }
                const delBtn = e.target && e.target.closest && e.target.closest('.delete-purchase-btn');
                if (delBtn) {
                    const id = delBtn.getAttribute('data-purchase-id');
                    softDeletePurchase(id);
                    return;
                }
                const btn = e.target && e.target.closest && e.target.closest('.edit-purchase-btn');
                if (btn) {
                    openPurchaseInEditMode(btn.getAttribute('data-purchase-id'));
                    return;
                }
                const allocBtn = e.target && e.target.closest && e.target.closest('.edit-allocation-btn');
                if (allocBtn) {
                    const id = allocBtn.getAttribute('data-purchase-id');
                    const p = purchasesCache.find(x => x.id === id);
                    if (p) openAllocationModal(id, p.date || new Date().toISOString().slice(0,10), Array.isArray(p.items)?p.items:[]);
                }
                const voidBtn = e.target && e.target.closest && e.target.closest('.void-purchase-btn');
                if (voidBtn) {
                    const id = voidBtn.getAttribute('data-purchase-id');
                    voidPurchase(id);
                }
            });
        }

        // Purchases modal handlers
        const purchaseModal = document.getElementById('purchase-modal');
        const addPurchaseForm = document.getElementById('add-purchase-form');
        const purchaseItemsContainer = document.getElementById('purchase-items-container');
        const addPurchaseLineBtn = document.getElementById('add-purchase-line-btn');
        const savePurchaseBtn = document.getElementById('save-purchase-btn');
        const cancelPurchaseBtn = document.getElementById('cancel-purchase-btn');
        const purchaseSupplierInput = document.getElementById('purchase-supplier');
        const purchaseDateInput = document.getElementById('purchase-date');
        const purchaseInternalNumberInput = document.getElementById('purchase-internal-number');
        const purchaseSupplierInvoiceInput = document.getElementById('purchase-supplier-invoice');
        const purchaseTotalEl = document.getElementById('purchase-calculated-total');
        const purchaseSubtotalEl = document.getElementById('purchase-subtotal');
        const purchaseVatAmountEl = document.getElementById('purchase-vat-amount');
        const purchaseVatEnabledEl = document.getElementById('purchase-vat-enabled');
        const purchaseVatRateEl = document.getElementById('purchase-vat-rate');
        const purchasePaymentStatusInput = document.getElementById('purchase-payment-status');
        const purchaseInitialPaymentInput = document.getElementById('purchase-initial-payment');
        const purchasePaymentMethodInput = document.getElementById('purchase-payment-method');
        const purchasePaymentDisplay = document.getElementById('purchase-payment-display');
        const purchaseRemainingDisplay = document.getElementById('purchase-remaining-display');

        // Payment source elements
        const paymentSourceExternal = document.getElementById('payment-source-external');
        const paymentSourcePettyCash = document.getElementById('payment-source-petty-cash');
        const pettyCashSelection = document.getElementById('petty-cash-selection');
        const purchasePettyCashBox = document.getElementById('purchase-petty-cash-box');
        const pettyCashBalanceDisplay = document.getElementById('petty-cash-balance-display');
        const pettyCashCurrentBalance = document.getElementById('petty-cash-current-balance');

        async function openPurchaseModal() {
            if (!purchaseModal) return;
            addPurchaseForm.reset();
            purchaseItemsContainer.innerHTML = '';
            addPurchaseLine();
            purchaseModal.classList.remove('hidden');
            purchaseDateInput.value = new Date().toISOString().slice(0,10);
            
            // Set default payment status
            purchasePaymentStatusInput.value = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
            purchaseInitialPaymentInput.value = '0';
            purchasePaymentMethodInput.value = '';
            
            // Generate internal purchase number
            const internalNumber = await getNextPurchaseNumber();
            if (purchaseInternalNumberInput) purchaseInternalNumberInput.value = internalNumber;
            // Focus supplier field
            if (purchaseSupplierInput && purchaseSupplierInput.focus) purchaseSupplierInput.focus();
            
            // Load petty cash boxes for selection
            await loadPettyCashBoxesForPurchase();
            
            // Reset payment source to external
            if (paymentSourceExternal) paymentSourceExternal.checked = true;
            if (paymentSourcePettyCash) paymentSourcePettyCash.checked = false;
            if (pettyCashSelection) pettyCashSelection.classList.add('hidden');
        }

        // Handle payment status changes
        if (purchasePaymentStatusInput) {
            purchasePaymentStatusInput.addEventListener('change', function() {
                const status = this.value;
                if (status === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„') {
                    // When fully paid, set payment amount to total
                    purchaseInitialPaymentInput.placeholder = 'Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
                    purchaseInitialPaymentInput.disabled = true;
                    purchaseInitialPaymentInput.value = '';
                } else if (status === 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹') {
                    purchaseInitialPaymentInput.placeholder = '0.00';
                    purchaseInitialPaymentInput.disabled = false;
                    purchaseInitialPaymentInput.value = '0';
                } else {
                    purchaseInitialPaymentInput.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹';
                    purchaseInitialPaymentInput.disabled = false;
                    purchaseInitialPaymentInput.value = '';
                }
                // Update payment display
                calculatePurchaseTotal();
            });
        }

        // Handle payment amount changes
        if (purchaseInitialPaymentInput) {
            purchaseInitialPaymentInput.addEventListener('input', function() {
                calculatePurchaseTotal();
            });
        }

        // Handle payment source changes
        if (paymentSourceExternal) {
            paymentSourceExternal.addEventListener('change', function() {
                if (this.checked) {
                    pettyCashSelection.classList.add('hidden');
                    purchasePettyCashBox.value = '';
                    pettyCashBalanceDisplay.classList.add('hidden');
                }
            });
        }

        if (paymentSourcePettyCash) {
            paymentSourcePettyCash.addEventListener('change', async function() {
                if (this.checked) {
                    pettyCashSelection.classList.remove('hidden');
                    // Reload petty cash boxes when this option is selected
                    await loadPettyCashBoxesForPurchase();
                    // Auto-select first available box if only one exists
                    if (purchasePettyCashBox.options.length === 2) { // 1 option + placeholder
                        purchasePettyCashBox.selectedIndex = 1;
                        updatePettyCashBalance();
                    }
                }
            });
        }

        // Handle petty cash box selection
        if (purchasePettyCashBox) {
            purchasePettyCashBox.addEventListener('change', updatePettyCashBalance);
        }

        // Handle refresh petty cash boxes button
        const refreshPettyCashBoxesBtn = document.getElementById('refresh-petty-cash-boxes');
        if (refreshPettyCashBoxesBtn) {
            refreshPettyCashBoxesBtn.addEventListener('click', async () => {
                console.log('Manual refresh of petty cash boxes requested');
                await loadPettyCashBoxesForPurchase();
            });
        }
        // VAT controls listeners
        if (purchaseVatEnabledEl) purchaseVatEnabledEl.addEventListener('change', calculatePurchaseTotal);
        if (purchaseVatRateEl) purchaseVatRateEl.addEventListener('input', calculatePurchaseTotal);
        function closePurchaseModal() { if (purchaseModal) purchaseModal.classList.add('hidden'); }

        // Load petty cash boxes for purchase form
        async function loadPettyCashBoxesForPurchase() {
            console.log('Loading petty cash boxes for purchase...');
            console.log('Firebase initialized:', firebaseInitialized);
            console.log('Database:', db);
            console.log('Purchase petty cash box element:', purchasePettyCashBox);
            
            if (!firebaseInitialized || !db || !purchasePettyCashBox) {
                console.log('Missing required dependencies for loading petty cash boxes');
                return;
            }
            
            try {
                // Use simple query without orderBy to avoid index requirements
                const boxesQuery = query(
                    collection(db, 'pettyCashBoxes'),
                    where('status', '==', 'active')
                );
                console.log('Query created, fetching documents...');
                const boxesSnapshot = await getDocs(boxesQuery);
                console.log('Query result:', boxesSnapshot.empty ? 'No boxes found' : `${boxesSnapshot.size} boxes found`);
                
                // Clear existing options except placeholder
                purchasePettyCashBox.innerHTML = '<option value="">Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©...</option>';
                
                if (boxesSnapshot.empty) {
                    console.log('No active petty cash boxes found');
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¹Ù‡Ø¯Ø© Ù†Ø´Ø·Ø©';
                    option.disabled = true;
                    purchasePettyCashBox.appendChild(option);
                    return;
                }
                
                // Convert to array and sort by creation date (newest first)
                const boxesArray = [];
                boxesSnapshot.forEach(docSnap => {
                    const box = docSnap.data();
                    boxesArray.push({
                        id: docSnap.id,
                        ...box,
                        createdAt: box.createdAt?.toDate ? box.createdAt.toDate() : new Date(0)
                    });
                });
                
                // Sort by creation date (newest first)
                boxesArray.sort((a, b) => b.createdAt - a.createdAt);
                
                boxesArray.forEach(box => {
                    console.log('Adding box to dropdown:', box.name, 'Balance:', box.currentBalance);
                    const option = document.createElement('option');
                    option.value = box.id;
                    option.textContent = `${box.name} - Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${box.currentBalance.toFixed(2)} Ø¬.Ù…`;
                    option.dataset.balance = box.currentBalance;
                    purchasePettyCashBox.appendChild(option);
                });
                console.log('Petty cash boxes loaded successfully');
            } catch (error) {
                console.error('Error loading petty cash boxes for purchase:', error);
                // Show error in dropdown
                purchasePettyCashBox.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</option>';
            }
        }

        // Update petty cash balance display
        async function updatePettyCashBalance() {
            if (!purchasePettyCashBox || !pettyCashBalanceDisplay || !pettyCashCurrentBalance) return;
            
            const selectedBoxId = purchasePettyCashBox.value;
            if (!selectedBoxId) {
                pettyCashBalanceDisplay.classList.add('hidden');
                return;
            }
            
            try {
                const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', selectedBoxId));
                if (boxDoc.exists()) {
                    const boxData = boxDoc.data();
                    pettyCashCurrentBalance.textContent = boxData.currentBalance.toFixed(2) + ' Ø¬.Ù…';
                    pettyCashBalanceDisplay.classList.remove('hidden');
                } else {
                    pettyCashBalanceDisplay.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching petty cash balance:', error);
                pettyCashBalanceDisplay.classList.add('hidden');
            }
        }

        // Function to create missing balance change records for existing deposits
        async function createMissingDepositRecords() {
            if (!firebaseInitialized || !db) return;
            
            try {
                console.log('Checking for missing deposit records...');
                
                // Get all petty cash boxes
                const boxesQuery = query(collection(db, 'pettyCashBoxes'));
                const boxesSnapshot = await getDocs(boxesQuery);
                
                for (const boxDoc of boxesSnapshot.docs) {
                    const boxId = boxDoc.id;
                    const boxData = boxDoc.data();
                    
                    // Check if there are any balance changes for this box
                    const balanceChangesQuery = query(
                        collection(db, 'balanceChanges'),
                        where('boxId', '==', boxId)
                    );
                    const balanceChangesSnapshot = await getDocs(balanceChangesQuery);
                    
                    if (balanceChangesSnapshot.empty && boxData.currentBalance > 0) {
                        console.log(`Creating missing deposit record for box: ${boxData.name}`);
                        
                        // Create initial deposit record
                        const balanceChangeData = {
                            boxId: boxId,
                            type: 'deposit',
                            amount: boxData.initialAmount || boxData.currentBalance,
                            oldBalance: 0,
                            newBalance: boxData.currentBalance,
                            description: `Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø¨Ø¯Ø¦ÙŠ Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©`,
                            date: boxData.startDate || boxData.createdAt || serverTimestamp(),
                            createdBy: boxData.createdBy || null,
                            createdAt: serverTimestamp()
                        };
                        
                        await addDoc(collection(db, 'balanceChanges'), balanceChangeData);
                        console.log(`Created deposit record for box: ${boxData.name}`);
                    }
                }
                
                console.log('Finished checking for missing deposit records');
            } catch (error) {
                console.error('Error creating missing deposit records:', error);
            }
        }

        function addPurchaseLine() {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-2 items-center purchase-item';
            
            // Create a text input with datalist for autocomplete (like Sales section)
            const productInput = document.createElement('input');
            productInput.type = 'text';
            productInput.className = 'col-span-5 px-2 py-1 border rounded-md pi-desc';
            productInput.placeholder = 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...';
            productInput.setAttribute('list', 'purchase-product-suggestions');
            
            // Create datalist for autocomplete
            const datalist = document.createElement('datalist');
            datalist.id = 'purchase-product-suggestions';
            
            productsCache.forEach(p => {
                const option = document.createElement('option');
                option.value = `${p.name} (${p.sku})`;
                option.dataset.productId = p.id;
                
                // Get last purchase price from purchase history
                const purchaseHistory = Array.isArray(p.purchaseHistory) ? p.purchaseHistory : [];
                const lastPurchase = purchaseHistory.length > 0 ? purchaseHistory[0] : null;
                const lastPrice = lastPurchase ? Number(lastPurchase.unitPrice || 0) : Number(p.websitePrice || 0);
                const lastSupplier = lastPurchase ? lastPurchase.supplierName : '';
                
                option.dataset.lastPrice = lastPrice;
                option.dataset.lastSupplier = lastSupplier;
                datalist.appendChild(option);
            });

            row.innerHTML = `
                ${productInput.outerHTML}
                <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1" min="1" class="col-span-2 px-2 py-1 border rounded-md pi-qty">
                <input type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" value="0" min="0" step="0.01" class="col-span-3 px-2 py-1 border rounded-md pi-cost">
                <button type="button" class="col-span-2 text-red-500 hover:text-red-700 pi-remove" title="Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯">&times;</button>
            `;
            
            // Add the datalist to the document
            document.body.appendChild(datalist);
            purchaseItemsContainer.appendChild(row);
            
            const inputEl = row.querySelector('.pi-desc');
            const qtyEl = row.querySelector('.pi-qty');
            const costEl = row.querySelector('.pi-cost');
            const removeBtn = row.querySelector('.pi-remove');
            const recalc = () => calculatePurchaseTotal();
            
            if (qtyEl) qtyEl.addEventListener('input', recalc);
            if (costEl) costEl.addEventListener('input', recalc);
            if (removeBtn) removeBtn.addEventListener('click', () => { row.remove(); calculatePurchaseTotal(); });
            
            if (inputEl) {
                inputEl.addEventListener('input', () => {
                    const inputValue = inputEl.value;
                    // Check if the input matches an existing product
                    const matchingOption = datalist.querySelector(`option[value="${inputValue}"]`);
                    if (matchingOption) {
                        // It's an existing product - auto-fill unit cost
                        const lastPrice = matchingOption.dataset.lastPrice ? Number(matchingOption.dataset.lastPrice) : 0;
                        if (lastPrice > 0) {
                            costEl.value = lastPrice.toFixed(2);
                        } else {
                            // Fallback to product's website price
                            const productId = matchingOption.dataset.productId;
                            const selectedProduct = productsCache.find(p => p.id === productId);
                            if (selectedProduct && selectedProduct.websitePrice != null) {
                                costEl.value = Number(selectedProduct.websitePrice).toFixed(2);
                            }
                        }
                        calculatePurchaseTotal();
                    } else {
                        // It's a new product - just update the line total
                        calculatePurchaseTotal();
                    }
                });
            }
            calculatePurchaseTotal();
        }
        function round2(n) { return Math.round((Number(n)||0) * 100) / 100; }

        // Auto-allocate all purchase items to warehouse (for simplified business flow)
        async function autoAllocateToWarehouse(purchaseId, date, items) {
            const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
            let anyAllocated = false;
            const allocatedPerItem = new Array(items.length).fill(0);
            
            // Process each item in the purchase
            for (let idx = 0; idx < items.length; idx++) {
                const item = items[idx];
                const quantity = Number(item.quantity || 0);
                
                if (quantity > 0) {
                    anyAllocated = true;
                    
                    // Create stock movement for warehouse allocation
                    await addDoc(collection(db, 'stockMovements'), {
                        productId: item.productId,
                        quantity: quantity,
                        type: 'IN',
                        source: 'Purchase',
                        refId: purchaseId,
                        unitCost: item.unitCost,
                        location: 'warehouse', // Auto-allocate to warehouse
                        date: new Date(date),
                        createdAt: new Date(),
                        createdBy
                    });
                    
                    // DISABLED: Do NOT update product total quantity automatically
                    // Inventory should only be updated manually from the inventory section
                    // const productRef = doc(db, 'products', item.productId);
                    // const productSnap = await getDoc(productRef);
                    // if (productSnap.exists()) {
                    //     const currentQty = Number(productSnap.data().quantity || 0);
                    //     await setDoc(productRef, { 
                    //         quantity: currentQty + quantity 
                    //     }, { merge: true });
                    // }
                    
                    allocatedPerItem[idx] = quantity;
                }
            }
            
            // Update purchase status 
            const newPurchaseStatus = anyAllocated ? 'Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
            const itemsWithAllocated = items.map((item, i) => ({ 
                ...item, 
                allocatedQty: Number(allocatedPerItem[i] || 0) 
            }));
            
            await setDoc(doc(db, 'purchases', purchaseId), { 
                allocationStatus: anyAllocated ? 'Ù…Ø®ØµØµ' : 'ØºÙŠØ± Ù…Ø®ØµØµ',
                purchaseStatus: newPurchaseStatus,
                items: itemsWithAllocated
            }, { merge: true });
        }

        // Update product purchase history when a purchase is saved
        async function updateProductPurchaseHistory(purchaseId, supplierName, internalNumber, supplierInvoiceNumber, date, items) {
            if (!db || !items || items.length === 0) return;
            
            try {
                // Process each item in the purchase
                for (const item of items) {
                    const productId = item.productId;
                    if (!productId) continue;
                    
                    const productRef = doc(db, 'products', productId);
                    const productSnap = await getDoc(productRef);
                    
                    if (productSnap.exists()) {
                        const productData = productSnap.data();
                        const currentHistory = Array.isArray(productData.purchaseHistory) ? productData.purchaseHistory : [];
                        
                        // Create new purchase history entry
                        const newHistoryEntry = {
                            purchaseId: purchaseId,
                            supplierName: supplierName,
                            internalNumber: internalNumber,
                            supplierInvoiceNumber: supplierInvoiceNumber,
                            quantity: Number(item.quantity || 0),
                            unitPrice: Number(item.unitCost || 0),
                            totalAmount: Number(item.quantity || 0) * Number(item.unitCost || 0),
                            purchaseDate: new Date(date),
                            purchaseStatus: 'Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„',
                            addedAt: new Date()
                        };
                        
                        // Add to beginning of history (most recent first)
                        const updatedHistory = [newHistoryEntry, ...currentHistory];
                        
                        // Keep only last 50 entries to prevent document size issues
                        const trimmedHistory = updatedHistory.slice(0, 50);
                        
                        // Update the product document
                        await setDoc(productRef, { 
                            purchaseHistory: trimmedHistory 
                        }, { merge: true });
                    }
                }
            } catch (error) {
                console.error('Error updating product purchase history:', error);
                throw error; // Re-throw to be caught by calling function
            }
        }

        // Helper function to calculate location-based quantities from stock movements
        async function calculateLocationQuantities(productId) {
            if (!db || !productId) return { warehouse: 0, showroom: 0, total: 0 };
            
            try {
                const movementsQuery = query(
                    collection(db, 'stockMovements'), 
                    where('productId', '==', productId)
                );
                const movementsSnap = await getDocs(movementsQuery);
                
                let warehouse = 0;
                let showroom = 0;
                
                movementsSnap.forEach(doc => {
                    const movement = doc.data();
                    const qty = Number(movement.quantity || 0);
                    const location = movement.location || 'warehouse'; // default to warehouse
                    
                    if (movement.type === 'IN') {
                        if (location === 'warehouse') warehouse += qty;
                        else if (location === 'showroom') showroom += qty;
                    } else if (movement.type === 'OUT') {
                        // For OUT movements, we need to deduct from total, but we don't know the specific location
                        // For now, we'll assume OUT comes from showroom first, then warehouse
                        if (showroom >= qty) {
                            showroom -= qty;
                        } else {
                            const remaining = qty - showroom;
                            showroom = 0;
                            warehouse = Math.max(0, warehouse - remaining);
                        }
                    } else if (movement.type === 'Transfer') {
                        const fromLocation = movement.fromLocation || 'warehouse';
                        const toLocation = movement.toLocation || 'showroom';
                        
                        if (fromLocation === 'warehouse') warehouse -= qty;
                        else if (fromLocation === 'showroom') showroom -= qty;
                        
                        if (toLocation === 'warehouse') warehouse += qty;
                        else if (toLocation === 'showroom') showroom += qty;
                    }
                });
                
                return {
                    warehouse: Math.max(0, warehouse),
                    showroom: Math.max(0, showroom),
                    total: Math.max(0, warehouse + showroom)
                };
            } catch (error) {
                console.error('Error calculating location quantities:', error);
                return { warehouse: 0, showroom: 0, total: 0 };
            }
        }
        function calculatePurchaseTotal() {
            let subtotal = 0;
            const items = purchaseItemsContainer.querySelectorAll('.purchase-item');
            items.forEach(row => {
                const q = Number((row.querySelector('.pi-qty')||{}).value||0);
                const c = Number((row.querySelector('.pi-cost')||{}).value||0);
                if (!isNaN(q) && !isNaN(c)) subtotal += round2(q * c);
            });
            // VAT
            const vatEnabled = purchaseVatEnabledEl ? !!purchaseVatEnabledEl.checked : false;
            const vatRatePct = purchaseVatRateEl ? Number(purchaseVatRateEl.value || 0) : 0;
            const vatAmount = vatEnabled ? round2(subtotal * (vatRatePct/100)) : 0;
            const total = round2(subtotal + vatAmount);

            if (purchaseSubtotalEl) purchaseSubtotalEl.textContent = `${subtotal.toFixed(2)} Ø¬.Ù…`;
            if (purchaseVatAmountEl) purchaseVatAmountEl.textContent = `${vatAmount.toFixed(2)} Ø¬.Ù…`;
            if (purchaseTotalEl) purchaseTotalEl.textContent = `${total.toFixed(2)} Ø¬.Ù…`;
            
            // Update payment display
            updatePurchasePaymentDisplay(total);
            return total;
        }

        function updatePurchasePaymentDisplay(total) {
            const paymentStatus = purchasePaymentStatusInput ? purchasePaymentStatusInput.value : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
            let paidAmount = 0;
            
            if (paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„') {
                paidAmount = total;
            } else if (paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') {
                paidAmount = Number(purchaseInitialPaymentInput ? purchaseInitialPaymentInput.value : 0) || 0;
            }
            
            const remaining = Math.max(0, total - paidAmount);
            
            if (purchasePaymentDisplay) purchasePaymentDisplay.textContent = `${paidAmount.toFixed(2)} Ø¬.Ù…`;
            if (purchaseRemainingDisplay) purchaseRemainingDisplay.textContent = `${remaining.toFixed(2)} Ø¬.Ù…`;
        }
        if (addPurchaseLineBtn) addPurchaseLineBtn.addEventListener('click', addPurchaseLine);
        if (addPurchaseBtn) addPurchaseBtn.addEventListener('click', openPurchaseModal);
        if (cancelPurchaseBtn) cancelPurchaseBtn.addEventListener('click', closePurchaseModal);

        // Stock Out Event Listeners
        if (addStockOutBtn) addStockOutBtn.addEventListener('click', openStockOutModal);
        if (cancelStockOutBtn) cancelStockOutBtn.addEventListener('click', closeStockOutModal);
        if (addStockOutItemBtn) addStockOutItemBtn.addEventListener('click', addStockOutItem);
        if (addStockOutForm) addStockOutForm.addEventListener('submit', (e) => { e.preventDefault(); saveStockOut(); });
        // (Reverted) no extra click handler; submit handler below handles save
        
        // View Stock Out Event Listeners
        if (closeViewStockOutBtn) closeViewStockOutBtn.addEventListener('click', hideStockOutModal);
        if (printStockOutBtn) printStockOutBtn.addEventListener('click', () => { if (currentViewingStockOutId) showPrintableStockOutModal(currentViewingStockOutId); });
        const voidStockOutBtn = document.getElementById('void-stock-out-btn');
        if (voidStockOutBtn) voidStockOutBtn.addEventListener('click', () => { if (currentViewingStockOutId) voidStockOut(currentViewingStockOutId); });
        
        // Printable Stock Out Event Listeners (reverted to original behavior)
        if (executeStockOutPrintBtn) executeStockOutPrintBtn.addEventListener('click', () => {
            const oldTitle = document.title;
            document.title = `ØµØ±Ù Ù…Ø®Ø²ÙˆÙ† - ${stockOutsCache.find(s => s.id === currentViewingStockOutId)?.stockOutNumber || ''}`;
            window.print();
            document.title = oldTitle;
        });
        if (closeStockOutPrintModalBtn) closeStockOutPrintModalBtn.addEventListener('click', hidePrintableStockOutModal);


        // Allocation modal
        const allocateModal = document.getElementById('allocate-modal');
        const allocateItemsContainer = document.getElementById('allocate-items-container');
        const confirmAllocationBtn = document.getElementById('confirm-allocation-btn');
        const cancelAllocationBtn = document.getElementById('cancel-allocation-btn');
        let pendingAllocation = null; // { purchaseId, date, items[] }

        function openAllocationModal(purchaseId, date, items) {
            pendingAllocation = { purchaseId, date, items };
            allocateItemsContainer.innerHTML = '';
            items.forEach((it, idx) => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-12 gap-2 items-start';
                div.innerHTML = `
                    <div class="col-span-5 text-sm font-medium">${it.productName || it.productId}</div>
                    <div class="col-span-3">
                        <label class="block text-xs text-gray-500 mb-1">Ø§Ù„Ù…Ø®Ø²Ù†</label>
                        <input type="number" min="0" value="${it.quantity}" class="w-full px-2 py-1 border rounded-md al-warehouse" placeholder="0">
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs text-gray-500 mb-1">Ø§Ù„Ù…Ø¹Ø±Ø¶</label>
                        <input type="number" min="0" value="0" class="w-full px-2 py-1 border rounded-md al-showroom" placeholder="0">
                    </div>
                `;
                div.dataset.index = String(idx);
                allocateItemsContainer.appendChild(div);

                // Auto-balance allocations between warehouse and showroom
                const whInput = div.querySelector('.al-warehouse');
                const shInput = div.querySelector('.al-showroom');
                let syncing = false;
                const clamp = (v) => {
                    const n = Number(v);
                    if (isNaN(n)) return 0;
                    return Math.max(0, Math.min(it.quantity, n));
                };
                const syncFromWarehouse = () => {
                    if (syncing) return;
                    syncing = true;
                    const w = clamp(whInput.value);
                    const s = it.quantity - w;
                    whInput.value = String(w);
                    shInput.value = String(s);
                    syncing = false;
                };
                const syncFromShowroom = () => {
                    if (syncing) return;
                    syncing = true;
                    const s = clamp(shInput.value);
                    const w = it.quantity - s;
                    shInput.value = String(s);
                    whInput.value = String(w);
                    syncing = false;
                };
                if (whInput) whInput.addEventListener('input', syncFromWarehouse);
                if (shInput) shInput.addEventListener('input', syncFromShowroom);
            });
            allocateModal.classList.remove('hidden');
        }
        function closeAllocationModal() { allocateModal.classList.add('hidden'); pendingAllocation = null; }
        if (cancelAllocationBtn) cancelAllocationBtn.addEventListener('click', closeAllocationModal);

        if (savePurchaseBtn) {
            savePurchaseBtn.addEventListener('click', async () => {
                if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù† (Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©).'); return; }
                if (!auth || !auth.currentUser) { alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„ Ù„Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡.'); return; }
                const supplierName = purchaseSupplierInput.value.trim();
                const date = purchaseDateInput.value || new Date().toISOString().slice(0,10);
                const internalNumber = purchaseInternalNumberInput.value.trim();
                const supplierInvoiceNumber = purchaseSupplierInvoiceInput.value.trim();
                const paymentStatus = purchasePaymentStatusInput.value || 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                const initialPayment = Number(purchaseInitialPaymentInput.value || 0);
                const paymentMethod = purchasePaymentMethodInput.value.trim();
                const items = [];
                const rows = purchaseItemsContainer.querySelectorAll('.purchase-item');
                for (const row of rows) {
                    const productInput = row.querySelector('.pi-desc');
                    const qty = Number((row.querySelector('.pi-qty')||{}).value || 0);
                    const unitCost = Number((row.querySelector('.pi-cost')||{}).value || 0);
                    const productName = productInput ? productInput.value.trim() : '';
                    
                    if (!productName || qty <= 0 || unitCost < 0) continue;
                    
                    // Check if it's an existing product
                    const existingProduct = productsCache.find(p => `${p.name} (${p.sku})` === productName);
                    let productId;
                    
                    if (existingProduct) {
                        // Use existing product
                        productId = existingProduct.id;
                    } else {
                        // Create new product using the same logic as Sales section
                        productId = await createNewProductFromText(productName, unitCost);
                        if (!productId) {
                            alert(`ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬: ${productName}`);
                            continue;
                        }
                    }
                    
                    items.push({ productId, productName, quantity: qty, unitCost });
                }
                if (!supplierName || items.length === 0) { alert('Ø§ÙƒÙ…Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯ ØµØ­ÙŠØ­Ø©.'); return; }
                
                // Calculate total and validate payment (rounded)
                const lineSum = items.reduce((s, it) => s + Math.round(((Number(it.quantity)||0) * (Number(it.unitCost)||0)) * 100)/100, 0);
                const vatEnabled = (purchaseVatEnabledEl ? !!purchaseVatEnabledEl.checked : false);
                const vatRatePct = (purchaseVatRateEl ? Number(purchaseVatRateEl.value || 0) : 0);
                const vatAmount = vatEnabled ? Math.round(lineSum * (vatRatePct/100) * 100)/100 : 0;
                const total = Math.round((lineSum + vatAmount) * 100)/100;
                let finalPaymentStatus = paymentStatus;
                let finalPaidAmount = initialPayment;
                
                // Auto-calculate payment status and amount
                if (paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„') {
                    finalPaidAmount = total;
                    finalPaymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                } else if (paymentStatus === 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹') {
                    if (initialPayment >= total) {
                        finalPaidAmount = total;
                        finalPaymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„';
                    } else if (initialPayment > 0) {
                        finalPaymentStatus = 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹';
                    } else {
                        finalPaymentStatus = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                        finalPaidAmount = 0;
                    }
                } else {
                    finalPaidAmount = 0;
                    finalPaymentStatus = 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹';
                }
                
                // Validate payment amount
                if (finalPaidAmount > total) {
                    alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (${finalPaidAmount.toFixed(2)}) Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡ (${total.toFixed(2)}).`);
                    return;
                }

                // Check if payment is from petty cash and validate balance
                const isPettyCashPayment = paymentSourcePettyCash && paymentSourcePettyCash.checked;
                let selectedPettyCashBoxId = null;
                
                if (isPettyCashPayment) {
                    selectedPettyCashBoxId = purchasePettyCashBox.value;
                    if (!selectedPettyCashBoxId) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù„Ù„Ø¯ÙØ¹ Ù…Ù†Ù‡.');
                        return;
                    }
                    
                    // Validate petty cash balance
                    try {
                        const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', selectedPettyCashBoxId));
                        if (!boxDoc.exists()) {
                            alert('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
                            return;
                        }
                        
                        const boxData = boxDoc.data();
                        if (boxData.status !== 'active') {
                            alert('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù†Ø´Ø·.');
                            return;
                        }
                        
                        if (finalPaidAmount > boxData.currentBalance) {
                            alert(`Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${boxData.currentBalance.toFixed(2)} Ø¬.Ù…`);
                            return;
                        }
                    } catch (error) {
                        console.error('Error validating petty cash balance:', error);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù‡Ø¯Ø©.');
                        return;
                    }
                }
                const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                let purchaseRef = null;
                try {
                    purchaseRef = doc(collection(db, 'purchases'));
                    await setDoc(purchaseRef, { 
                        supplierName, 
                        date, 
                        internalNumber,
                        supplierInvoiceNumber,
                        items, 
                        createdAt: new Date(), 
                        createdBy, 
                        purchaseStatus: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 
                        allocationStatus: 'ØºÙŠØ± Ù…Ø®ØµØµ',
                        paidAmount: finalPaidAmount,
                        paymentStatus: finalPaymentStatus,
                        vatEnabled: vatEnabled,
                        vatRate: vatRatePct,
                        subtotal: lineSum,
                        vatAmount: vatAmount,
                        total: total
                    });
                } catch (e) {
                    console.error('Save purchase error (base doc)', e);
                    const msg = (e && (e.message || e.code)) ? (e.message + (e.code ? ` [${e.code}]` : '')) : '';
                    alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡: ' + msg);
                    return;
                }

                // Secondary step: create initial payment (non-blocking for purchase creation)
                if (finalPaidAmount > 0 && paymentMethod && purchaseRef) {
                    try {
                        const paymentRef = doc(collection(db, 'purchasePayments'));
                        await setDoc(paymentRef, {
                            purchaseId: purchaseRef.id,
                            amount: finalPaidAmount,
                            method: paymentMethod,
                            date: date,
                            notes: 'Ø¯ÙØ¹Ø© Ø£ÙˆÙ„ÙŠØ©',
                            createdAt: new Date(),
                            createdBy: auth.currentUser && auth.currentUser.uid ? auth.currentUser.uid : null
                        });
                    } catch (e) {
                        console.error('Initial purchase payment create failed', e);
                        const msg = (e && (e.message || e.code)) ? (e.message + (e.code ? ` [${e.code}]` : '')) : '';
                        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ù„ÙƒÙ† ÙØ´Ù„Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©: ' + msg);
                    }
                }

                // Handle petty cash deduction if payment is from petty cash
                if (isPettyCashPayment && finalPaidAmount > 0 && selectedPettyCashBoxId && purchaseRef) {
                    try {
                        await runTransaction(db, async (transaction) => {
                            // Get current box data
                            const boxRef = doc(db, 'pettyCashBoxes', selectedPettyCashBoxId);
                            const boxDoc = await transaction.get(boxRef);
                            
                            if (!boxDoc.exists()) {
                                throw new Error('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                            }
                            
                            const boxData = boxDoc.data();
                            const newBalance = boxData.currentBalance - finalPaidAmount;
                            
                            // Update box balance
                            transaction.update(boxRef, {
                                currentBalance: newBalance,
                                updatedAt: serverTimestamp()
                            });
                            
                            // Create balance change record
                            const balanceChangeRef = doc(collection(db, 'balanceChanges'));
                            transaction.set(balanceChangeRef, {
                                boxId: selectedPettyCashBoxId,
                                type: 'withdrawal',
                                amount: finalPaidAmount,
                                oldBalance: boxData.currentBalance,
                                newBalance: newBalance,
                                description: `Ø³Ø­Ø¨ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - ${supplierName} (ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: ${internalNumber})`,
                                date: serverTimestamp(),
                                purchaseId: purchaseRef.id,
                                createdAt: serverTimestamp(),
                                createdBy: createdBy
                            });
                        });
                        
                        console.log(`Successfully deducted ${finalPaidAmount} from petty cash box ${selectedPettyCashBoxId}`);
                    } catch (error) {
                        console.error('Error deducting from petty cash:', error);
                        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ù„ÙƒÙ† ÙØ´Ù„ Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©: ' + error.message);
                    }
                }

                // Auto-allocate all items to warehouse and update product purchase history
                try {
                    closePurchaseModal();
                    if (purchaseRef) {
                        await autoAllocateToWarehouse(purchaseRef.id, date, items);
                        
                        // Update product purchase history for each item
                        await updateProductPurchaseHistory(purchaseRef.id, supplierName, internalNumber, supplierInvoiceNumber, date, items);
                        
                        await fetchAndDisplayPurchases(); // Refresh the purchase list
                        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­!');
                    }
                } catch (e) {
                    console.error('Auto allocation or purchase history update failed', e);
                    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„ÙƒÙ† ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: ' + (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            });
        }

        if (confirmAllocationBtn) {
            confirmAllocationBtn.addEventListener('click', async () => {
                if (!db || !pendingAllocation) { closeAllocationModal(); return; }
                const { purchaseId, date, items } = pendingAllocation;
                const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                // Read entered allocations
                const rows = allocateItemsContainer.querySelectorAll('div[data-index]');
                for (const row of rows) {
                    const idx = Number(row.dataset.index);
                    const it = items[idx];
                    const wh = Number((row.querySelector('.al-warehouse')||{}).value || 0);
                    const sh = Number((row.querySelector('.al-showroom')||{}).value || 0);
                    if (isNaN(wh) || isNaN(sh) || wh < 0 || sh < 0 || (wh + sh) !== it.quantity) {
                        alert('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ®ØµÙŠØµ Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©.');
                        return;
                    }
                }
                try {
                    let anyAllocated = false;
                    // Track allocatedQty per item
                    const allocatedPerItem = new Array(items.length).fill(0);
                    const rows2 = allocateItemsContainer.querySelectorAll('div[data-index]');
                    for (const row of rows2) {
                        const idx = Number(row.dataset.index);
                        const it = items[idx];
                        const wh = Number((row.querySelector('.al-warehouse')||{}).value || 0);
                        const sh = Number((row.querySelector('.al-showroom')||{}).value || 0);
                        const allocations = [ { location: 'warehouse', qty: wh }, { location: 'showroom', qty: sh } ];
                        for (const a of allocations) {
                            if (a.qty > 0) {
                                anyAllocated = true;
                                await addDoc(collection(db, 'stockMovements'), {
                                    productId: it.productId,
                                    quantity: a.qty,
                                    type: 'IN',
                                    source: 'Purchase',
                                    refId: purchaseId,
                                    unitCost: it.unitCost,
                                    location: a.location,
                                    date,
                                    createdAt: new Date(),
                                    createdBy
                                });
                                allocatedPerItem[idx] += a.qty;
                                // DISABLED: Do NOT update product quantity automatically
                                // Inventory should only be updated manually from the inventory section
                                // const pRef = doc(db, 'products', it.productId);
                                // const pSnap = await getDoc(pRef);
                                // if (pSnap.exists()) {
                                //     const cur = Number(pSnap.data().quantity || 0);
                                //     await setDoc(pRef, { quantity: cur + a.qty }, { merge: true });
                                // }
                            }
                        }
                    }
                    // Update purchase status based on allocation
                    let newPurchaseStatus = 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
                    if (anyAllocated) {
                        const allFullyAllocated = items.every((item, i) => {
                            const allocatedQty = Number(allocatedPerItem[i] || 0);
                            const totalQty = Number(item.quantity || 0);
                            return allocatedQty >= totalQty;
                        });
                        newPurchaseStatus = allFullyAllocated ? 'Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 'Ù…Ø³ØªÙ„Ù… Ø¬Ø²Ø¦ÙŠØ§Ù‹';
                    }
                    // Persist allocatedQty per item back on the purchase for quick reads
                    const itemsWithAllocated = items.map((it, i) => ({ ...it, allocatedQty: Number(allocatedPerItem[i] || 0) }));
                    
                    await setDoc(doc(db, 'purchases', purchaseId), { 
                        allocationStatus: anyAllocated ? 'Ù…Ø®ØµØµ' : 'ØºÙŠØ± Ù…Ø®ØµØµ',
                        purchaseStatus: newPurchaseStatus,
                        items: itemsWithAllocated
                    }, { merge: true });
                    closeAllocationModal();
                    await fetchAndDisplayPurchases();
                } catch (e) {
                    console.error('Allocation error', e);
                    alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹: ' + (e && (e.message || e.code) ? (e.message || e.code) : ''));
                }
            });
        }

        // Quick add product modal logic
        const qpModal = document.getElementById('quick-product-modal');
        const qpForm = document.getElementById('quick-product-form');
        const qpName = document.getElementById('qp-name');
        const qpSku = document.getElementById('qp-sku');
        const qpDescription = document.getElementById('qp-description');
        const qpWebsitePrice = document.getElementById('qp-website-price');
        const qpAmazonPrice = document.getElementById('qp-amazon-price');
        const qpQuantity = document.getElementById('qp-quantity');
        const qpUnitCost = document.getElementById('qp-unit-cost');
        const qpLineTotal = document.getElementById('qp-line-total');
        const qpSaveBtn = document.getElementById('qp-save-btn');
        const qpCancelBtn = document.getElementById('qp-cancel-btn');
        let qpTargetSelect = null;

        // Function to calculate and update line total
        function updateQuickProductLineTotal() {
            const quantity = Number(qpQuantity.value || 0);
            const unitCost = Number(qpUnitCost.value || 0);
            const lineTotal = quantity * unitCost;
            qpLineTotal.textContent = `${lineTotal.toFixed(2)} Ø¬.Ù…`;
        }

        // Add event listeners for real-time calculation
        if (qpQuantity) qpQuantity.addEventListener('input', updateQuickProductLineTotal);
        if (qpUnitCost) qpUnitCost.addEventListener('input', updateQuickProductLineTotal);

        function openQuickProductModal(targetSelect) {
            qpTargetSelect = targetSelect || null;
            if (!qpModal) return;
            qpForm.reset();
            updateQuickProductLineTotal(); // Reset the line total display
            qpModal.classList.remove('hidden');
        }
        function closeQuickProductModal() { if (qpModal) qpModal.classList.add('hidden'); qpTargetSelect = null; }
        if (qpCancelBtn) qpCancelBtn.addEventListener('click', closeQuickProductModal);
        if (qpSaveBtn) {
            qpSaveBtn.addEventListener('click', async () => {
                if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù†.'); return; }
                
                // Get all form values
                const name = (qpName.value || '').trim();
                const sku = (qpSku.value || '').trim();
                const description = (qpDescription.value || '').trim();
                const websitePrice = Number(qpWebsitePrice.value || 0);
                const amazonPrice = Number(qpAmazonPrice.value || 0);
                const quantity = Number(qpQuantity.value || 0);
                const unitCost = Number(qpUnitCost.value || 0);
                
                // Validation
                if (!name || !sku) { 
                    alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ùˆ SKU Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.'); 
                    return; 
                }
                if (quantity <= 0) {
                    alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.');
                    return;
                }
                if (unitCost <= 0) {
                    alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ÙˆØ­Ø¯Ø© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.');
                    return;
                }

                qpSaveBtn.disabled = true;
                qpSaveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                
                try {
                    // Check SKU uniqueness
                    const skuQ = query(collection(db, 'products'), where('sku', '==', sku));
                    const skuSnap = await getDocs(skuQ);
                    if (!skuSnap.empty) { 
                        alert('SKU Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… SKU ÙØ±ÙŠØ¯.'); 
                        return; 
                    }
                    
                    // Create the product in the database
                    const docRef = await addDoc(collection(db, 'products'), { 
                        name, 
                        sku, 
                        description,
                        quantity: 0, // Will be updated through purchase allocation
                        websitePrice: websitePrice,
                        amazonPrice: amazonPrice, 
                        createdAt: new Date() 
                    });
                    
                    // Update products cache
                    const newProduct = { id: docRef.id, name, sku, description, quantity: 0, websitePrice: websitePrice, amazonPrice: amazonPrice };
                    productsCache.push(newProduct);
                    
                    // Update any existing product selects in the purchase form
                    if (qpTargetSelect) {
                        // Rebuild the target select options
                        qpTargetSelect.innerHTML = '';
                        const ph = document.createElement('option'); 
                        ph.textContent = 'Ø§Ø®ØªØ± Ù…Ù†ØªØ¬...'; 
                        ph.value = ''; 
                        qpTargetSelect.appendChild(ph);
                        
                        const newOpt = document.createElement('option'); 
                        newOpt.value = '__new__'; 
                        newOpt.textContent = '+ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯â€¦'; 
                        qpTargetSelect.appendChild(newOpt);
                        
                        productsCache.forEach(p => { 
                            const o = document.createElement('option'); 
                            o.value = p.id; 
                            o.textContent = `${p.name} (${p.sku})`; 
                            qpTargetSelect.appendChild(o); 
                        });
                        
                        // Select the newly created product
                        qpTargetSelect.value = newProduct.id;
                        
                        // Find the parent row and populate the quantity and unit cost
                        const parentRow = qpTargetSelect.closest('.purchase-item');
                        if (parentRow) {
                            const qtyInput = parentRow.querySelector('.pi-qty');
                            const costInput = parentRow.querySelector('.pi-cost');
                            
                            if (qtyInput) qtyInput.value = quantity;
                            if (costInput) costInput.value = unitCost.toFixed(2);
                            
                            // Trigger calculation update
                            if (typeof calculatePurchaseTotal === 'function') {
                                calculatePurchaseTotal();
                            }
                        }
                    }
                    
                    closeQuickProductModal();
                    alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                    
                } catch (e) {
                    console.error('Quick add product error', e);
                    alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬: ' + (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                } finally {
                    qpSaveBtn.disabled = false;
                    qpSaveBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØ§ØªÙˆØ±Ø©';
                }
            });
        }

        // Distribution modal logic
        const distributeModal = document.getElementById('distribute-modal');
        const distributeProductName = document.getElementById('distribute-product-name');
        const distributeProductSku = document.getElementById('distribute-product-sku');
        const distributeWarehouseAvailable = document.getElementById('distribute-warehouse-available');
        const distributeToShowroom = document.getElementById('distribute-to-showroom');
        const distributeMaxQty = document.getElementById('distribute-max-qty');
        const distributeRemainingWarehouse = document.getElementById('distribute-remaining-warehouse');
        const distributeMovingShowroom = document.getElementById('distribute-moving-showroom');
        const distributeSaveBtn = document.getElementById('distribute-save-btn');
        const distributeCancelBtn = document.getElementById('distribute-cancel-btn');
        let currentDistributeProductId = null;
        let currentWarehouseQty = 0;

        function openDistributeModal(productId, productName, productSku, warehouseQty) {
            currentDistributeProductId = productId;
            currentWarehouseQty = Number(warehouseQty || 0);
            
            if (!distributeModal) return;
            
            if (distributeProductName) distributeProductName.textContent = productName || 'Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            if (distributeProductSku) distributeProductSku.textContent = productSku || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            if (distributeWarehouseAvailable) distributeWarehouseAvailable.textContent = currentWarehouseQty;
            if (distributeMaxQty) distributeMaxQty.textContent = currentWarehouseQty;
            
            if (distributeToShowroom) {
                distributeToShowroom.max = currentWarehouseQty;
                distributeToShowroom.value = 0;
            }
            
            updateDistributePreview();
            distributeModal.classList.remove('hidden');
        }

        function closeDistributeModal() {
            if (distributeModal) distributeModal.classList.add('hidden');
            currentDistributeProductId = null;
            currentWarehouseQty = 0;
        }

        function updateDistributePreview() {
            const toShowroom = Number(distributeToShowroom.value || 0);
            const remaining = Math.max(0, currentWarehouseQty - toShowroom);
            
            distributeRemainingWarehouse.textContent = remaining;
            distributeMovingShowroom.textContent = toShowroom;
        }

        if (distributeCancelBtn) distributeCancelBtn.addEventListener('click', closeDistributeModal);
        
        if (distributeToShowroom) {
            distributeToShowroom.addEventListener('input', updateDistributePreview);
        }

        if (distributeSaveBtn) {
            distributeSaveBtn.addEventListener('click', async () => {
                if (!db || !currentDistributeProductId) {
                    closeDistributeModal();
                    return;
                }
                
                const transferQty = Number(distributeToShowroom.value || 0);
                if (transferQty <= 0) {
                    alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ± Ù„Ù„Ù†Ù‚Ù„.');
                    return;
                }
                
                if (transferQty > currentWarehouseQty) {
                    alert('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù†Ù‚Ù„Ù‡Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†.');
                    return;
                }
                
                distributeSaveBtn.disabled = true;
                distributeSaveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...';
                
                try {
                    const createdBy = (auth && auth.currentUser) ? auth.currentUser.uid : null;
                    
                    // Create transfer stock movement record
                    await addDoc(collection(db, 'stockMovements'), {
                        productId: currentDistributeProductId,
                        quantity: transferQty,
                        type: 'Transfer',
                        fromLocation: 'warehouse',
                        toLocation: 'showroom',
                        source: 'Manual Distribution',
                        date: new Date(),
                        createdAt: new Date(),
                        createdBy
                    });
                    
                    // Update product total quantity to stay in sync
                    const updatedLocations = await calculateLocationQuantities(currentDistributeProductId);
                    await setDoc(doc(db, 'products', currentDistributeProductId), {
                        quantity: updatedLocations.total
                    }, { merge: true });
                    
                    closeDistributeModal();
                    await fetchAndDisplayProducts(); // Refresh the display
                    alert('ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­!');
                    
                } catch (error) {
                    console.error('Distribution error:', error);
                    alert('ÙØ´Ù„ ÙÙŠ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ' + (error && error.message ? error.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                } finally {
                    distributeSaveBtn.disabled = false;
                    distributeSaveBtn.textContent = 'ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙˆØ²ÙŠØ¹';
                }
            });
        }

        async function voidPurchase(purchaseId) {
            if (!db) { alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†.'); return; }
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ø³ÙŠØªÙ… Ø¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.')) return;
            try {
                // Reverse all allocations
                await reversePurchaseAllocations(purchaseId);
                // Mark purchase as voided
                await setDoc(doc(db, 'purchases', purchaseId), { 
                    voided: true, 
                    voidedAt: new Date(), 
                    voidedBy: (auth && auth.currentUser) ? auth.currentUser.uid : null, 
                    allocationStatus: 'ØºÙŠØ± Ù…Ø®ØµØµ',
                    purchaseStatus: 'Ù…Ù„ØºØ§Ø©'
                }, { merge: true });
                await fetchAndDisplayPurchases();
                await fetchAndDisplayProducts();
                alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ¹ÙƒØ³ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.');
            } catch (e) {
                console.error('Void purchase failed', e);
                alert('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡.');
            }
        }

        // Deleted Items lists
        const deletedPurchasesContainer = null; // no deleted purchases list inside inventory anymore
        const deletedProductsContainer = document.getElementById('deleted-products-container');
        const deletedPurchasesList = document.getElementById('deleted-purchases-list');
        const refreshDeletedPurchasesBtn = document.getElementById('refresh-deleted-purchases-btn');
        const refreshDeletedBtn = document.getElementById('refresh-deleted-btn');
        // removed inventory recent purchases panel
        async function loadDeletedLists() {
            if (!db) return;
            // No deleted purchases list on inventory page
            // Deleted products (soft-deleted via deleted flag if used)
            if (deletedProductsContainer) {
                deletedProductsContainer.innerHTML = '<div class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
                try {
                    const qDelProd = query(collection(db, 'products')); // filter client-side
                    const snap2 = await getDocs(qDelProd);
                    if (snap2.empty) {
                        deletedProductsContainer.innerHTML = '<div class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø°ÙˆÙØ©.</div>';
                    } else {
                        const ul2 = document.createElement('ul');
                        const docs2 = snap2.docs
                            .map(d => ({ id: d.id, ...d.data() }))
                            .filter(p => p.deleted === true)
                            .sort((a,b) => {
                                const ad = a.deletedAt && a.deletedAt.toDate ? a.deletedAt.toDate().getTime() : (a.deletedAt && a.deletedAt.seconds ? a.deletedAt.seconds*1000 : 0);
                                const bd = b.deletedAt && b.deletedAt.toDate ? b.deletedAt.toDate().getTime() : (b.deletedAt && b.deletedAt.seconds ? b.deletedAt.seconds*1000 : 0);
                                return bd - ad;
                            });
                        if (docs2.length === 0) {
                            deletedProductsContainer.innerHTML = '<div class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø°ÙˆÙØ©.</div>';
                        } else {
                            docs2.forEach(p => {
                                const li = document.createElement('li');
                                li.className = 'py-1 border-b last:border-b-0';
                                li.textContent = `${p.name || p.id} â€” SKU: ${p.sku || ''}`;
                                ul2.appendChild(li);
                            });
                            deletedProductsContainer.innerHTML = '';
                            deletedProductsContainer.appendChild(ul2);
                        }
                    }
                } catch (e) {
                    console.error('Load deleted products failed', e);
                    deletedProductsContainer.innerHTML = '<div class="text-red-500">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©.</div>';
                }
            }
        }
        if (refreshDeletedBtn) refreshDeletedBtn.addEventListener('click', loadDeletedLists);

        async function loadDeletedPurchasesList() {
            if (!db || !deletedPurchasesList) return;
            deletedPurchasesList.innerHTML = '<div class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            try {
                const qDelPurch = query(collection(db, 'purchases'));
                const snap = await getDocs(qDelPurch);
                const docs = snap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(p => p.deleted === true)
                    .sort((a,b) => {
                        const ad = a.deletedAt && a.deletedAt.toDate ? a.deletedAt.toDate().getTime() : (a.deletedAt && a.deletedAt.seconds ? a.deletedAt.seconds*1000 : 0);
                        const bd = b.deletedAt && b.deletedAt.toDate ? b.deletedAt.toDate().getTime() : (b.deletedAt && b.deletedAt.seconds ? b.deletedAt.seconds*1000 : 0);
                        return bd - ad;
                    });
                if (docs.length === 0) {
                    deletedPurchasesList.innerHTML = '<div class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø­Ø°ÙˆÙØ©.</div>';
                } else {
                    const ul = document.createElement('ul');
                    docs.forEach(p => {
                        const li = document.createElement('li');
                        li.className = 'py-1 border-b last:border-b-0';
                        li.textContent = `${p.internalNumber || p.id} â€” ${p.supplierName || ''} â€” ${p.date || ''}`;
                        ul.appendChild(li);
                    });
                    deletedPurchasesList.innerHTML = '';
                    deletedPurchasesList.appendChild(ul);
                }
            } catch (e) {
                console.error('Load deleted purchases (purchases page) failed', e);
                deletedPurchasesList.innerHTML = '<div class="text-red-500">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±.</div>';
            }
        }

        // Add click-outside-to-close functionality for all modals
        // This is added at the end to ensure all other event listeners are set up first
        if(invoiceModal) {
            invoiceModal.addEventListener('click', e => { 
                if (e.target === invoiceModal) { 
                    hideAddModal(); 
                } 
            });
        }
        if(viewInvoiceModal) {
            viewInvoiceModal.addEventListener('click', e => { 
                if (e.target === viewInvoiceModal) { 
                    hideViewModal(); 
                } 
            });
        }
        if(printableInvoiceModal) {
            printableInvoiceModal.addEventListener('click', e => { 
                if (e.target === printableInvoiceModal) { 
                    hidePrintableModal(); 
                } 
            });
        }
        if(viewPurchaseModal) {
            viewPurchaseModal.addEventListener('click', e => { 
                if (e.target === viewPurchaseModal) { 
                    hidePurchaseModal(); 
                } 
            });
        }
        if(printablePurchaseModal) {
            printablePurchaseModal.addEventListener('click', e => { 
                if (e.target === printablePurchaseModal) { 
                    hidePrintablePurchaseModal(); 
                } 
            });
        }
        if(productViewModal) {
            productViewModal.addEventListener('click', e => { 
                if (e.target === productViewModal) { 
                    hideProductViewModal(); 
                } 
            });
        }
        if(purchaseModal) {
            purchaseModal.addEventListener('click', e => { 
                if (e.target === purchaseModal) { 
                    closePurchaseModal(); 
                } 
            });
        }
        if(allocateModal) {
            allocateModal.addEventListener('click', e => { 
                if (e.target === allocateModal) { 
                    closeAllocationModal(); 
                } 
            });
        }
        if(qpModal) {
            qpModal.addEventListener('click', e => { 
                if (e.target === qpModal) { 
                    closeQuickProductModal(); 
                } 
            });
        }
        if(distributeModal) {
            distributeModal.addEventListener('click', e => { 
                if (e.target === distributeModal) { 
                    closeDistributeModal(); 
                } 
            });
        }
        if(stockOutModal) {
            stockOutModal.addEventListener('click', e => { 
                if (e.target === stockOutModal) { 
                    closeStockOutModal(); 
                } 
            });
        }
        if(viewStockOutModal) {
            viewStockOutModal.addEventListener('click', e => { 
                if (e.target === viewStockOutModal) { 
                    hideStockOutModal(); 
                } 
            });
        }
        if(printableStockOutModal) {
            printableStockOutModal.addEventListener('click', e => { 
                if (e.target === printableStockOutModal) { 
                    hidePrintableStockOutModal(); 
                } 
            });
        }

        // ==================== EXPENSES & PETTY CASH MANAGEMENT ====================
        
        // Modal references
        const pettyCashBoxModal = document.getElementById('petty-cash-box-modal');
        const viewPettyCashBoxModal = document.getElementById('view-petty-cash-box-modal');
        const expenseModal = document.getElementById('expense-modal');
        const employeeModal = document.getElementById('employee-modal');
        
        // Button references
        const addPettyCashBoxBtn = document.getElementById('add-petty-cash-box-btn');
        const createMissingRecordsBtn = document.getElementById('create-missing-records-btn');
        const savePettyCashBoxBtn = document.getElementById('save-petty-cash-box-btn');
        const cancelPettyCashBoxBtn = document.getElementById('cancel-petty-cash-box-btn');
        const closeViewBoxModalBtn = document.getElementById('close-view-box-modal-btn');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const addExpenseToBoxBtn = document.getElementById('add-expense-to-box-btn');
        const saveExpenseBtn = document.getElementById('save-expense-btn');
        const cancelExpenseBtn = document.getElementById('cancel-expense-btn');
        const closeBoxBtn = document.getElementById('close-box-btn');
        const addEmployeeBtn = document.getElementById('add-employee-btn');
        const saveEmployeeBtn = document.getElementById('save-employee-btn');
        const cancelEmployeeBtn = document.getElementById('cancel-employee-btn');
        
        // Form inputs
        const boxNameInput = document.getElementById('box-name');
        const boxInitialAmountInput = document.getElementById('box-initial-amount');
        const boxAdditionalAmountInput = document.getElementById('box-additional-amount');
        const boxStartDateInput = document.getElementById('box-start-date');
        const expenseCategorySelect = document.getElementById('expense-category');
        const expenseSourceSelect = document.getElementById('expense-source');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const expenseDateInput = document.getElementById('expense-date');
        const expenseEmployeeSelect = document.getElementById('expense-employee');
        const expenseBoxSelect = document.getElementById('expense-box-select');
        const boxSelectionDiv = document.getElementById('box-selection-div');
        const employeeNameInput = document.getElementById('employee-name');
        const employeeWeeklyLimitInput = document.getElementById('employee-weekly-limit');
        const employeePositionInput = document.getElementById('employee-position');
        const employeePhoneInput = document.getElementById('employee-phone');
        const expenseBalanceWarning = document.getElementById('expense-balance-warning');
        const currentBalanceDisplay = document.getElementById('current-balance-display');
        const remainingBalanceDisplay = document.getElementById('remaining-balance-display');
        const remainingBalanceAmount = document.getElementById('remaining-balance-amount');
        const employeeSelectionDiv = document.getElementById('employee-selection-div');
        const employeeBalanceInfo = document.getElementById('employee-balance-info');
        const employeeWeeklyLimitDisplay = document.getElementById('employee-weekly-limit-display');
        const requestedAmountDisplay = document.getElementById('requested-amount-display');
        const employeeRemainingAfter = document.getElementById('employee-remaining-after');
        const employeeRemainingAmount = document.getElementById('employee-remaining-amount');
        
        // Table body references
        const pettyCashBoxesTableBody = document.getElementById('petty-cash-boxes-table-body');
        const expensesTableBody = document.getElementById('expenses-table-body');
        const viewBoxExpensesList = document.getElementById('view-box-expenses-list');
        const employeesTableBody = document.getElementById('employees-table-body');
        
        // Current box being viewed
        let currentViewingBox = null;
        
        // Category labels mapping
        const categoryLabels = {
            'advance': 'Ø³Ù„ÙØ©',
            'financial-aid': 'Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø§Ù„ÙŠØ©',
            'office-supplies': 'Ù„ÙˆØ§Ø²Ù… Ù…ÙƒØªØ¨ÙŠØ©',
            'transportation': 'Ù…ÙˆØ§ØµÙ„Ø§Øª',
            'meals': 'ÙˆØ¬Ø¨Ø§Øª',
            'maintenance': 'ØµÙŠØ§Ù†Ø©',
            'utilities': 'Ù…Ø±Ø§ÙÙ‚',
            'cleaning': 'Ù†Ø¸Ø§ÙØ©',
            'communication': 'Ø§ØªØµØ§Ù„Ø§Øª',
            'other': 'Ø£Ø®Ø±Ù‰'
        };

        // Load custom categories from database
        async function loadCustomCategories() {
            try {
                const customCategoriesQuery = query(collection(db, 'customExpenseCategories'), orderBy('createdAt', 'desc'));
                const customCategoriesSnapshot = await getDocs(customCategoriesQuery);
                
                const expenseCategorySelect = document.getElementById('expense-category');
                if (expenseCategorySelect) {
                    // Get existing custom category IDs to avoid duplicates
                    const existingCustomOptions = Array.from(expenseCategorySelect.querySelectorAll('option[value^="custom-"]'));
                    const existingCustomIds = existingCustomOptions.map(option => option.value);
                    
                    // Add new custom categories to dropdown and update categoryLabels
                    customCategoriesSnapshot.forEach(doc => {
                        const customId = `custom-${doc.id}`;
                        
                        // Only add if not already present
                        if (!existingCustomIds.includes(customId)) {
                            const categoryData = doc.data();
                            const option = document.createElement('option');
                            option.value = customId;
                            option.textContent = categoryData.name;
                            
                            // Insert before the "add new category" option
                            const addNewOption = expenseCategorySelect.querySelector('option[value="add-new-category"]');
                            if (addNewOption) {
                                expenseCategorySelect.insertBefore(option, addNewOption);
                            } else {
                                expenseCategorySelect.appendChild(option);
                            }
                        }
                        
                        // Always update categoryLabels for display purposes
                        const categoryData = doc.data();
                        categoryLabels[`custom-${doc.id}`] = categoryData.name;
                    });
                }
            } catch (error) {
                console.error('Error loading custom categories:', error);
            }
        }

        // Save custom category to database
        async function saveCustomCategory(categoryName) {
            try {
                const categoryData = {
                    name: categoryName,
                    createdAt: serverTimestamp(),
                    createdBy: 'system' // You can modify this to track who created it
                };
                
                const docRef = await addDoc(collection(db, 'customExpenseCategories'), categoryData);
                console.log('Custom category saved with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('Error saving custom category:', error);
                throw error;
            }
        }
        
        // Initialize date inputs to today
        function initializeDateInputs() {
            const today = new Date().toISOString().split('T')[0];
            if (boxStartDateInput) boxStartDateInput.value = today;
            if (expenseDateInput) expenseDateInput.value = today;
        }
        
        // Open petty cash box modal
        function openPettyCashBoxModal() {
            if (pettyCashBoxModal) {
                initializeDateInputs();
                boxNameInput.value = '';
                boxInitialAmountInput.value = '';
                
                // Hide additional amount field for new boxes
                const addMoneyDiv = document.getElementById('add-money-div');
                if (addMoneyDiv) {
                    addMoneyDiv.classList.add('hidden');
                }
                
                // Reset initial amount label
                const initialAmountLabel = document.querySelector('label[for="box-initial-amount"]');
                if (initialAmountLabel) {
                    initialAmountLabel.textContent = 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Ø¬.Ù…)';
                }
                
                // Reset editing state
                window.editingBoxId = null;
                
                // Reset modal title and button
                document.querySelector('#petty-cash-box-modal h3').textContent = 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯';
                document.getElementById('save-petty-cash-box-btn').textContent = 'ÙØªØ­ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚';
                
                pettyCashBoxModal.classList.remove('hidden');
            }
        }
        
        // Close petty cash box modal
        function closePettyCashBoxModal() {
            if (pettyCashBoxModal) {
                pettyCashBoxModal.classList.add('hidden');
            }
        }
        
        // Save new petty cash box or update existing one
        async function savePettyCashBox() {
            if (!firebaseInitialized || !db) return;
            
            const name = boxNameInput.value.trim();
            const initialAmount = parseFloat(boxInitialAmountInput.value);
            const additionalAmount = parseFloat(boxAdditionalAmountInput.value) || 0;
            const startDate = boxStartDateInput.value;
            const isEditing = window.editingBoxId;
            
            if (!name || !initialAmount || !startDate) {
                alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            if (initialAmount <= 0) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
                return;
            }
            
            if (isEditing && additionalAmount < 0) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ ØµÙØ±');
                return;
            }
            
            savePettyCashBoxBtn.disabled = true;
            savePettyCashBoxBtn.textContent = isEditing ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...' : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            
            try {
                if (isEditing) {
                    // Add money to existing box
                    const boxRef = doc(db, 'pettyCashBoxes', window.editingBoxId);
                    const boxDoc = await getDoc(boxRef);
                    
                    if (!boxDoc.exists()) {
                        throw new Error('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    }
                    
                    const currentBox = boxDoc.data();
                    const newCurrentBalance = currentBox.currentBalance + additionalAmount;
                    
                    const updateData = {
                        name,
                        initialAmount: currentBox.initialAmount + additionalAmount, // Update initial amount
                        currentBalance: newCurrentBalance,
                        updatedAt: serverTimestamp()
                    };
                    
                    await updateDoc(boxRef, updateData);
                    
                    // Create balance change record for deposits
                    if (additionalAmount > 0) {
                        try {
                            const balanceChangeData = {
                                boxId: window.editingBoxId,
                                type: 'deposit',
                                amount: additionalAmount,
                                oldBalance: currentBox.currentBalance,
                                newBalance: newCurrentBalance,
                                description: `Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©`,
                                date: serverTimestamp(),
                                createdBy: auth.currentUser ? auth.currentUser.uid : null,
                                createdAt: serverTimestamp()
                            };
                            
                            console.log('Creating balance change record for deposit:', balanceChangeData);
                            await addDoc(collection(db, 'balanceChanges'), balanceChangeData);
                            console.log('Balance change record created successfully');
                        } catch (error) {
                            console.error('Could not create balance change record:', error);
                            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ØŒ Ù„ÙƒÙ† ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„: ' + error.message);
                        }
                    }
                    
                    // Reset editing state
                    window.editingBoxId = null;
                    
                    // Reset modal
                    document.querySelector('#petty-cash-box-modal h3').textContent = 'Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù‡Ø¯Ø© Ø¬Ø¯ÙŠØ¯';
                    document.getElementById('save-petty-cash-box-btn').textContent = 'ÙØªØ­ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚';
                    
                    // Hide additional amount field
                    const addMoneyDiv = document.getElementById('add-money-div');
                    if (addMoneyDiv) {
                        addMoneyDiv.classList.add('hidden');
                    }
                    
                    // Reset initial amount label
                    const initialAmountLabel = document.querySelector('label[for="box-initial-amount"]');
                    if (initialAmountLabel) {
                        initialAmountLabel.textContent = 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Ø¬.Ù…)';
                    }
                    
                    closePettyCashBoxModal();
                    fetchAndDisplayPettyCashBoxes();
                    alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${additionalAmount.toFixed(2)} Ø¬.Ù… Ø¥Ù„Ù‰ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­`);
                    
                } else {
                    // Create new box
                    const boxData = {
                        name,
                        initialAmount,
                        currentBalance: initialAmount,
                        startDate: new Date(startDate),
                        endDate: null,
                        status: 'active',
                        createdBy: auth.currentUser.uid,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    await addDoc(collection(db, 'pettyCashBoxes'), boxData);
                    
                    closePettyCashBoxModal();
                    fetchAndDisplayPettyCashBoxes();
                    alert('ØªÙ… ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
                }
            } catch (error) {
                console.error('Error saving petty cash box:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©: ' + error.message);
            } finally {
                savePettyCashBoxBtn.disabled = false;
                savePettyCashBoxBtn.textContent = isEditing ? 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº' : 'ÙØªØ­ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚';
            }
        }
        
        // Fetch and display petty cash boxes
        async function fetchAndDisplayPettyCashBoxes() {
            if (!firebaseInitialized || !db) return;
            
            try {
                // First, check for missing deposit records
                await createMissingDepositRecords();
                
                // Use simple query without orderBy to avoid index requirements
                const boxesQuery = query(collection(db, 'pettyCashBoxes'));
                const boxesSnapshot = await getDocs(boxesQuery);
                
                if (boxesSnapshot.empty) {
                    pettyCashBoxesTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¹Ù‡Ø¯Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
                    return;
                }
                
                // Convert to array and sort by creation date (newest first)
                const boxesArray = [];
                boxesSnapshot.forEach(docSnap => {
                    const box = docSnap.data();
                    boxesArray.push({
                        id: docSnap.id,
                        ...box,
                        createdAt: box.createdAt?.toDate ? box.createdAt.toDate() : new Date(0)
                    });
                });
                
                // Sort by creation date (newest first)
                boxesArray.sort((a, b) => b.createdAt - a.createdAt);
                
                pettyCashBoxesTableBody.innerHTML = '';
                boxesArray.forEach(box => {
                    const boxId = box.id;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const startDate = box.startDate?.toDate ? box.startDate.toDate().toLocaleDateString('ar-EG') : 'N/A';
                    const endDate = box.endDate?.toDate ? box.endDate.toDate().toLocaleDateString('ar-EG') : '-';
                    const statusBadge = box.status === 'active' 
                        ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Ù†Ø´Ø·</span>'
                        : '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">Ù…ØºÙ„Ù‚</span>';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">${box.name || 'N/A'}</td>
                        <td class="px-4 py-3">${box.initialAmount.toFixed(2)} Ø¬.Ù…</td>
                        <td class="px-4 py-3 font-semibold ${box.currentBalance < 100 ? 'text-red-600' : 'text-green-600'}">${box.currentBalance.toFixed(2)} Ø¬.Ù…</td>
                        <td class="px-4 py-3">${startDate}</td>
                        <td class="px-4 py-3">${endDate}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-blue-600 hover:text-blue-800 view-box-btn" data-box-id="${boxId}">Ø¹Ø±Ø¶</button>
                                <button class="text-green-600 hover:text-green-800 edit-box-btn" data-box-id="${boxId}">ØªØ¹Ø¯ÙŠÙ„</button>
                                ${box.status === 'active' && box.currentBalance > 0 ? `<button class="text-purple-600 hover:text-purple-800 settle-box-btn" data-box-id="${boxId}" title="ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¹Ù‡Ø¯Ø©">ØªØ³ÙˆÙŠØ©</button>` : ''}
                                <button class="text-red-600 hover:text-red-800 delete-box-btn" data-box-id="${boxId}">Ø­Ø°Ù</button>
                            </div>
                        </td>
                    `;
                    
                    pettyCashBoxesTableBody.appendChild(row);
                });
                
                // Remove existing event listeners to prevent duplicates
                document.querySelectorAll('.view-box-btn').forEach(btn => {
                    btn.replaceWith(btn.cloneNode(true));
                });
                document.querySelectorAll('.settle-box-btn').forEach(btn => {
                    btn.replaceWith(btn.cloneNode(true));
                });
                document.querySelectorAll('.edit-box-btn').forEach(btn => {
                    btn.replaceWith(btn.cloneNode(true));
                });
                document.querySelectorAll('.delete-box-btn').forEach(btn => {
                    btn.replaceWith(btn.cloneNode(true));
                });
                
                // Attach event listeners to view buttons
                document.querySelectorAll('.view-box-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const boxId = btn.getAttribute('data-box-id');
                        viewPettyCashBox(boxId);
                    });
                });
                
                // Attach event listeners to settle buttons
                document.querySelectorAll('.settle-box-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const boxId = btn.getAttribute('data-box-id');
                        settlePettyCashBox(boxId);
                    });
                });
                
                // Attach event listeners to edit buttons
                document.querySelectorAll('.edit-box-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const boxId = btn.getAttribute('data-box-id');
                        editPettyCashBox(boxId);
                    });
                });
                
                // Attach event listeners to delete buttons
                document.querySelectorAll('.delete-box-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const boxId = btn.getAttribute('data-box-id');
                        deletePettyCashBox(boxId);
                    });
                });
            } catch (error) {
                console.error('Error fetching petty cash boxes:', error);
                pettyCashBoxesTableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            }
        }
        
        // View petty cash box details
        async function viewPettyCashBox(boxId) {
            if (!firebaseInitialized || !db) return;
            
            try {
                const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', boxId));
                if (!boxDoc.exists()) {
                    alert('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const box = boxDoc.data();
                currentViewingBox = { id: boxId, ...box };
                
                // Populate box information
                document.getElementById('view-box-name').textContent = box.name || 'N/A';
                document.getElementById('view-box-initial-amount').textContent = box.initialAmount.toFixed(2) + ' Ø¬.Ù…';
                document.getElementById('view-box-current-balance').textContent = box.currentBalance.toFixed(2) + ' Ø¬.Ù…';
                document.getElementById('view-box-start-date').textContent = box.startDate?.toDate ? box.startDate.toDate().toLocaleDateString('ar-EG') : 'N/A';
                
                const statusEl = document.getElementById('view-box-status');
                if (box.status === 'active') {
                    statusEl.textContent = 'Ù†Ø´Ø·';
                    statusEl.className = 'font-semibold text-green-600';
                    closeBoxBtn.classList.remove('hidden');
                    addExpenseToBoxBtn.classList.remove('hidden');
                } else {
                    statusEl.textContent = 'Ù…ØºÙ„Ù‚';
                    statusEl.className = 'font-semibold text-gray-600';
                    closeBoxBtn.classList.add('hidden');
                    addExpenseToBoxBtn.classList.add('hidden');
                }
                
                if (box.endDate) {
                    document.getElementById('view-box-end-date-container').classList.remove('hidden');
                    document.getElementById('view-box-end-date').textContent = box.endDate.toDate ? box.endDate.toDate().toLocaleDateString('ar-EG') : 'N/A';
                } else {
                    document.getElementById('view-box-end-date-container').classList.add('hidden');
                }
                
                // Fetch and display expenses for this box
                await loadBoxExpenses(boxId);
                
                viewPettyCashBoxModal.classList.remove('hidden');
            } catch (error) {
                console.error('Error viewing box:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©: ' + error.message);
            }
        }
        
        // Load expenses and balance changes for a specific box
        async function loadBoxExpenses(boxId) {
            if (!firebaseInitialized || !db) return;
            
            try {
                // Get expenses
                const expensesQuery = query(
                    collection(db, 'expenses'),
                    where('boxId', '==', boxId),
                    orderBy('date', 'desc')
                );
                const expensesSnapshot = await getDocs(expensesQuery);
                
                // Get balance changes (deposits and withdrawals) - use simple query without orderBy
                let balanceChangesSnapshot = { forEach: () => {} };
                try {
                    // Use simple query without orderBy to avoid index requirements
                    const balanceChangesQuery = query(
                        collection(db, 'balanceChanges'),
                        where('boxId', '==', boxId)
                    );
                    balanceChangesSnapshot = await getDocs(balanceChangesQuery);
                    console.log('Balance changes found:', balanceChangesSnapshot.size);
                    
                    balanceChangesSnapshot.forEach(docSnap => {
                        const change = docSnap.data();
                        console.log('Balance change:', change.type, change.description, change.amount);
                    });
                } catch (error) {
                    console.log('No balance changes found or collection not accessible:', error.message);
                    // Continue without balance changes
                }
                
                // Combine and sort all transactions
                const allTransactions = [];
                
                // Add expenses
                expensesSnapshot.forEach(docSnap => {
                    const expense = docSnap.data();
                    allTransactions.push({
                        id: docSnap.id,
                        type: 'expense',
                        date: expense.date,
                        category: expense.category,
                        description: expense.description,
                        amount: -expense.amount, // Negative for expenses
                        source: expense.source,
                        employeeId: expense.employeeId,
                        docRef: docSnap.ref
                    });
                });
                
                // Add balance changes (deposits and withdrawals)
                balanceChangesSnapshot.forEach(docSnap => {
                    const change = docSnap.data();
                    allTransactions.push({
                        id: docSnap.id,
                        type: change.type === 'deposit' ? 'deposit' : 'withdrawal',
                        date: change.date,
                        category: change.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨',
                        description: change.description,
                        amount: change.type === 'deposit' ? change.amount : -change.amount, // Positive for deposits, negative for withdrawals
                        oldBalance: change.oldBalance,
                        newBalance: change.newBalance,
                        purchaseId: change.purchaseId, // Include purchase ID if available
                        docRef: docSnap.ref
                    });
                });
                
                // Sort by date (newest first) - client-side sorting
                allTransactions.sort((a, b) => {
                    const dateA = a.date?.toDate ? a.date.toDate() : new Date(0);
                    const dateB = b.date?.toDate ? b.date.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                if (allTransactions.length === 0) {
                    viewBoxExpensesList.innerHTML = '';
                    document.getElementById('view-box-no-expenses').classList.remove('hidden');
                    return;
                }
                
                document.getElementById('view-box-no-expenses').classList.add('hidden');
                viewBoxExpensesList.innerHTML = '';
                
                allTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    const transactionDate = transaction.date?.toDate ? transaction.date.toDate().toLocaleDateString('ar-EG') : 'N/A';
                    
                    // Handle categories
                    let categoryLabel = transaction.category;
                    if (transaction.type === 'expense') {
                        categoryLabel = categoryLabels[transaction.category];
                        if (!categoryLabel) {
                            categoryLabel = transaction.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        }
                        if (!categoryLabel) {
                            categoryLabel = transaction.category || 'N/A';
                        }
                    }
                    
                    // Determine transaction type and styling
                    let typeLabel, typeIcon, rowClass, amountClass;
                    if (transaction.type === 'deposit') {
                        typeLabel = 'Ø¥ÙŠØ¯Ø§Ø¹';
                        typeIcon = 'â•';
                        rowClass = 'hover:bg-green-50 bg-green-25';
                        amountClass = 'text-green-600 font-semibold';
                    } else if (transaction.type === 'withdrawal') {
                        typeLabel = 'Ø³Ø­Ø¨ (Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)';
                        typeIcon = 'ğŸ›’';
                        rowClass = 'hover:bg-orange-50 bg-orange-25';
                        amountClass = 'text-orange-600 font-semibold';
                    } else {
                        typeLabel = 'Ù…ØµØ±ÙˆÙ';
                        typeIcon = 'â–';
                        rowClass = 'hover:bg-red-50 bg-red-25';
                        amountClass = 'text-red-600 font-semibold';
                    }
                    
                    row.className = rowClass;
                    
                    // Calculate balance after transaction
                    let balanceAfter = 'N/A';
                    if ((transaction.type === 'deposit' || transaction.type === 'withdrawal') && transaction.newBalance !== undefined) {
                        balanceAfter = transaction.newBalance.toFixed(2) + ' Ø¬.Ù…';
                    }
                    
                    // Format amount with sign
                    const amountText = transaction.amount > 0 
                        ? `+${Math.abs(transaction.amount).toFixed(2)} Ø¬.Ù…`
                        : `${transaction.amount.toFixed(2)} Ø¬.Ù…`;
                    
                    row.innerHTML = `
                        <td class="p-2">${transactionDate}</td>
                        <td class="p-2">
                            <span class="px-2 py-1 text-xs rounded-full ${transaction.type === 'deposit' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${typeIcon} ${typeLabel}
                            </span>
                        </td>
                        <td class="p-2">${categoryLabel}</td>
                        <td class="p-2">${transaction.description || 'N/A'}</td>
                        <td class="p-2 text-left ${amountClass}">${amountText}</td>
                        <td class="p-2 font-semibold">${balanceAfter}</td>
                        <td class="p-2">
                            ${transaction.type === 'expense' ? `
                                <div class="flex space-x-2 space-x-reverse">
                                    <button class="text-green-600 hover:text-green-800 print-expense-btn" data-expense-id="${transaction.id}">Ø·Ø¨Ø§Ø¹Ø©</button>
                                    <button class="text-blue-600 hover:text-blue-800 edit-expense-btn" data-expense-id="${transaction.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="text-red-600 hover:text-red-800 delete-expense-btn" data-expense-id="${transaction.id}">Ø­Ø°Ù</button>
                                </div>
                            ` : transaction.type === 'withdrawal' ? `
                                <span class="text-orange-600 text-sm">${transaction.purchaseId ? 'Ù…Ø±ØªØ¨Ø· Ø¨ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡' : 'Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø¹Ù‡Ø¯Ø©'}</span>
                            ` : '<span class="text-gray-500">-</span>'}
                        </td>
                    `;
                    
                    viewBoxExpensesList.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading box expenses:', error);
                viewBoxExpensesList.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</td></tr>';
            }
        }
        
        // Edit petty cash box
        async function editBox(boxId) {
            if (!firebaseInitialized || !db) return;
            
            try {
                const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', boxId));
                if (!boxDoc.exists()) {
                    alert('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const box = boxDoc.data();
                
                // Populate the form with existing data
                boxNameInput.value = box.name || '';
                boxInitialAmountInput.value = box.initialAmount || '';
                
                // Set the start date
                if (box.startDate && box.startDate.toDate) {
                    const date = box.startDate.toDate();
                    boxStartDateInput.value = date.toISOString().split('T')[0];
                }
                
                // Show current balance and additional amount field for editing
                const addMoneyDiv = document.getElementById('add-money-div');
                if (addMoneyDiv) {
                    addMoneyDiv.classList.remove('hidden');
                }
                
                // Update the initial amount label to show current balance
                const initialAmountLabel = document.querySelector('label[for="box-initial-amount"]');
                if (initialAmountLabel) {
                    initialAmountLabel.innerHTML = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ (Ø¬.Ù…) - Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${box.currentBalance.toFixed(2)} Ø¬.Ù…`;
                }
                
                // Clear the additional amount field
                if (boxAdditionalAmountInput) {
                    boxAdditionalAmountInput.value = '';
                }
                
                // Store the box ID for updating
                window.editingBoxId = boxId;
                
                // Update modal title and button
                document.querySelector('#petty-cash-box-modal h3').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©';
                document.getElementById('save-petty-cash-box-btn').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº';
                
                // Show the modal
                pettyCashBoxModal.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading box:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: ' + error.message);
            }
        }
        
        // Delete petty cash box
        async function deleteBox(boxId) {
            if (!firebaseInitialized || !db) return;
            
            try {
                // Get box data first
                const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', boxId));
                if (!boxDoc.exists()) {
                    alert('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const box = boxDoc.data();
                
                // Check if box has expenses
                const expensesQuery = query(
                    collection(db, 'expenses'),
                    where('boxId', '==', boxId)
                );
                const expensesSnapshot = await getDocs(expensesQuery);
                
                if (!expensesSnapshot.empty) {
                    const confirmDelete = window.confirm(
                        `ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${expensesSnapshot.size} Ù…ØµØ±ÙˆÙØ§Øª.\n` +
                        'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ¬Ù…ÙŠØ¹ Ù…ØµØ±ÙˆÙØ§ØªÙ‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.\n' +
                        'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
                    );
                    if (!confirmDelete) return;
                } else {
                    const confirmDelete = window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ØŸ');
                    if (!confirmDelete) return;
                }
                
                // Use transaction to delete box and all associated expenses
                await runTransaction(db, async (transaction) => {
                    // Delete all associated expenses
                    expensesSnapshot.forEach(expenseDoc => {
                        transaction.delete(expenseDoc.ref);
                    });
                    
                    // Delete the box
                    transaction.delete(doc(db, 'pettyCashBoxes', boxId));
                });
                
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ¬Ù…ÙŠØ¹ Ù…ØµØ±ÙˆÙØ§ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
                
                // Refresh displays
                fetchAndDisplayPettyCashBoxes();
                fetchAndDisplayAllExpenses();
                
                // Close view modal if it's open for this box
                if (currentViewingBox && currentViewingBox.id === boxId) {
                    viewPettyCashBoxModal.classList.add('hidden');
                    currentViewingBox = null;
                }
                
            } catch (error) {
                console.error('Error deleting box:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: ' + error.message);
            }
        }
        
        // Close petty cash box
        async function closePettyCashBox() {
            if (!currentViewingBox || !firebaseInitialized || !db) return;
            
            if (currentViewingBox.status === 'closed') {
                alert('Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù…ØºÙ„Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }
            
            const confirm = window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡.');
            if (!confirm) return;
            
            closeBoxBtn.disabled = true;
            closeBoxBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚...';
            
            try {
                await updateDoc(doc(db, 'pettyCashBoxes', currentViewingBox.id), {
                    status: 'closed',
                    endDate: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
                viewPettyCashBoxModal.classList.add('hidden');
                fetchAndDisplayPettyCashBoxes();
            } catch (error) {
                console.error('Error closing box:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: ' + error.message);
            } finally {
                closeBoxBtn.disabled = false;
                closeBoxBtn.textContent = 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚';
            }
        }
        
        // Settle petty cash box (clear remaining balance to zero)
        async function settlePettyCashBox(boxId) {
            if (!firebaseInitialized || !db) return;
            
            // Prevent multiple simultaneous settlements
            if (window.settlingBoxes && window.settlingBoxes.has(boxId)) {
                console.log('Settlement already in progress for box:', boxId);
                return;
            }
            
            if (!window.settlingBoxes) {
                window.settlingBoxes = new Set();
            }
            window.settlingBoxes.add(boxId);
            
            try {
                // Get the box data first
                const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', boxId));
                if (!boxDoc.exists()) {
                    alert('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const box = boxDoc.data();
                
                // Check if box is active
                if (box.status !== 'active') {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³ÙˆÙŠØ© ØµÙ†Ø¯ÙˆÙ‚ Ù…ØºÙ„Ù‚');
                    return;
                }
                
                // Check if there's a balance to settle
                if (box.currentBalance <= 0) {
                    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ Ù„Ù„ØªØ³ÙˆÙŠØ©');
                    return;
                }
                
                const confirm = window.confirm(
                    `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³ÙˆÙŠØ© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© "${box.name}"ØŸ\n` +
                    `Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${box.currentBalance.toFixed(2)} Ø¬.Ù…\n` +
                    `Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù…ØµØ±ÙˆÙ Ù„Ù„ØªÙˆØ«ÙŠÙ‚.`
                );
                if (!confirm) return;
                
                const remainingBalance = box.currentBalance;
                
                console.log(`=== SETTLEMENT START ===`);
                console.log(`Box ID: ${boxId}`);
                console.log(`Box Name: ${box.name}`);
                console.log(`Remaining Balance: ${remainingBalance}`);
                
                // Create an expense record for the settlement
                const settlementExpense = {
                    boxId: boxId,
                    boxName: box.name,
                    category: 'ØªØ³ÙˆÙŠØ© Ø¹Ù‡Ø¯Ø©',
                    source: 'petty_cash',
                    description: `ØªØ³ÙˆÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©: ${box.name}`,
                    amount: remainingBalance,
                    date: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    isSettlement: true
                };
                
                console.log(`Creating settlement expense:`, settlementExpense);
                
                // Add the settlement expense record
                const expenseDocRef = await addDoc(collection(db, 'expenses'), settlementExpense);
                console.log(`Settlement expense created with ID: ${expenseDocRef.id}`);
                
                // Update the box to set balance to zero, close it, and mark as settled
                await updateDoc(doc(db, 'pettyCashBoxes', boxId), {
                    currentBalance: 0,
                    status: 'closed',
                    settledAt: serverTimestamp(),
                    endDate: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                console.log(`=== SETTLEMENT COMPLETED ===`);
                console.log(`Box ${boxId} settled successfully with amount: ${remainingBalance}`);
                
                alert(`ØªÙ…Øª ØªØ³ÙˆÙŠØ© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯: ${remainingBalance.toFixed(2)} Ø¬.Ù…`);
                
                // Refresh the petty cash boxes table
                fetchAndDisplayPettyCashBoxes();
                
                // Update the dashboard petty cash balance to exclude the settled box
                if (typeof updateDashboardPettyCashBalance === 'function') {
                    updateDashboardPettyCashBalance();
                }
                
                // If viewing this box, refresh the view
                if (currentViewingBox && currentViewingBox.id === boxId) {
                    viewPettyCashBox(boxId);
                }
            } catch (error) {
                console.error('Error settling petty cash box:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¹Ù‡Ø¯Ø©: ' + error.message);
            } finally {
                // Remove from settling set
                if (window.settlingBoxes) {
                    window.settlingBoxes.delete(boxId);
                }
            }
        }
        
        // Open expense modal
        async function openExpenseModal(preselectedBoxId = null) {
            if (!firebaseInitialized || !db) return;
            
            initializeDateInputs();
            expenseDescriptionInput.value = '';
            expenseAmountInput.value = '';
            expenseCategorySelect.value = '';
            expenseSourceSelect.value = '';
            expenseEmployeeSelect.value = '';
            expenseBalanceWarning.classList.add('hidden');
            remainingBalanceDisplay.classList.add('hidden');
            
            // Reset custom category field
            const customCategoryDiv = document.getElementById('custom-category-div');
            const customCategoryName = document.getElementById('custom-category-name');
            if (customCategoryDiv) {
                customCategoryDiv.classList.add('hidden');
            }
            if (customCategoryName) {
                customCategoryName.value = '';
                customCategoryName.required = false;
            }
            
            // Store the preselected box ID for use in saveExpense
            window.currentExpenseBoxId = preselectedBoxId;
            
            // Load employees for selection
            await loadEmployeesForExpenseForm();
            
            // Load petty cash boxes for selection
            await loadPettyCashBoxesForExpenseForm();
            
            // Load custom categories
            await loadCustomCategories();
            
            // Hide box and employee selection initially
            if (boxSelectionDiv) {
                boxSelectionDiv.classList.add('hidden');
            }
            if (employeeSelectionDiv) {
                employeeSelectionDiv.classList.add('hidden');
            }
            if (employeeBalanceInfo) {
                employeeBalanceInfo.classList.add('hidden');
            }
            
            // Display current balance
            if (preselectedBoxId) {
                try {
                    // Fetch the box data to get current balance
                    const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', preselectedBoxId));
                    if (boxDoc.exists()) {
                        const boxData = boxDoc.data();
                        currentBalanceDisplay.textContent = boxData.currentBalance.toFixed(2) + ' Ø¬.Ù…';
                        // Update currentViewingBox with fresh data
                        currentViewingBox = { id: preselectedBoxId, ...boxData };
                    } else {
                        currentBalanceDisplay.textContent = '0.00 Ø¬.Ù…';
                    }
                } catch (error) {
                    console.error('Error fetching box balance:', error);
                    currentBalanceDisplay.textContent = '0.00 Ø¬.Ù…';
                }
            } else {
                currentBalanceDisplay.textContent = '0.00 Ø¬.Ù…';
            }
            
            expenseModal.classList.remove('hidden');
        }
        
        
        // Check expense balance warning
        function checkExpenseBalance() {
            const amount = parseFloat(expenseAmountInput.value);
            const source = expenseSourceSelect.value;
            const category = expenseCategorySelect.value;
            
            // Hide all balance displays initially
            expenseBalanceWarning.classList.add('hidden');
            remainingBalanceDisplay.classList.add('hidden');
            
            // Show/hide box and employee selection based on source
            if (source === 'petty-cash') {
                if (boxSelectionDiv) {
                    boxSelectionDiv.classList.remove('hidden');
                }
                if (employeeSelectionDiv) {
                    employeeSelectionDiv.classList.remove('hidden');
                }
                // Check employee weekly limit
                checkEmployeeWeeklyLimit();
            } else if (source === 'company-paid' && category === 'advance') {
                // For company-paid advance expenses, show employee selection but hide box selection
                if (boxSelectionDiv) {
                    boxSelectionDiv.classList.add('hidden');
                }
                if (employeeSelectionDiv) {
                    employeeSelectionDiv.classList.remove('hidden');
                }
                // Check employee weekly limit
                checkEmployeeWeeklyLimit();
            } else {
                if (boxSelectionDiv) {
                    boxSelectionDiv.classList.add('hidden');
                }
                if (employeeSelectionDiv) {
                    employeeSelectionDiv.classList.add('hidden');
                }
                if (employeeBalanceInfo) {
                    employeeBalanceInfo.classList.add('hidden');
                }
            }
            
            // Update employee field requirement based on category
            updateEmployeeFieldRequirement(category);
            
            if (currentViewingBox && amount && source === 'petty-cash') {
                const balance = currentViewingBox.currentBalance;
                const remainingBalance = balance - amount;
                
                if (amount > balance) {
                    // Show warning for over-spending
                    expenseBalanceWarning.classList.remove('hidden');
                    remainingBalanceDisplay.classList.add('hidden');
                } else {
                    // Show remaining balance
                    remainingBalanceAmount.textContent = remainingBalance.toFixed(2) + ' Ø¬.Ù…';
                    remainingBalanceDisplay.classList.remove('hidden');
                    expenseBalanceWarning.classList.add('hidden');
                }
            } else if (currentViewingBox && amount && source === 'company-paid') {
                // For company-paid expenses, show current balance (no change)
                remainingBalanceAmount.textContent = currentViewingBox.currentBalance.toFixed(2) + ' Ø¬.Ù…';
                remainingBalanceDisplay.classList.remove('hidden');
            }
        }
        
        // Update employee field requirement based on category
        function updateEmployeeFieldRequirement(category) {
            const employeeSelect = document.getElementById('expense-employee');
            const employeeLabel = document.querySelector('label[for="expense-employee"]');
            
            if (category === 'advance') {
                // Make employee field required for "Ø³Ù„ÙØ©" category
                if (employeeSelect) {
                    employeeSelect.required = true;
                }
                if (employeeLabel) {
                    employeeLabel.innerHTML = 'Ø§Ù„Ù…ÙˆØ¸Ù <span class="text-red-500">*</span>';
                }
            } else {
                // Make employee field optional for other categories
                if (employeeSelect) {
                    employeeSelect.required = false;
                }
                if (employeeLabel) {
                    employeeLabel.innerHTML = 'Ø§Ù„Ù…ÙˆØ¸Ù';
                }
            }
        }
        
        // Close expense modal
        function closeExpenseModal() {
            if (expenseModal) {
                expenseModal.classList.add('hidden');
            }
        }
        
        // Edit expense
        async function editExpense(expenseId) {
            if (!firebaseInitialized || !db) return;
            
            // Load custom categories first
            await loadCustomCategories();
            
            try {
                const expenseDoc = await getDoc(doc(db, 'expenses', expenseId));
                if (!expenseDoc.exists()) {
                    alert('Ø§Ù„Ù…ØµØ±ÙˆÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const expense = expenseDoc.data();
                
                // Populate the expense form with existing data
                // Handle custom categories - check if it's a custom category ID or predefined category
                if (categoryLabels[expense.category]) {
                    expenseCategorySelect.value = expense.category;
                } else if (expense.category.startsWith('custom-')) {
                    // It's a custom category ID - try to find it in the dropdown
                    const customCategoryId = expense.category.replace('custom-', '');
                    const customCategoryOption = expenseCategorySelect.querySelector(`option[value="custom-${customCategoryId}"]`);
                    if (customCategoryOption) {
                        expenseCategorySelect.value = `custom-${customCategoryId}`;
                    } else {
                        // Custom category not found in dropdown, show as "add new category"
                        expenseCategorySelect.value = 'add-new-category';
                        const customCategoryDiv = document.getElementById('custom-category-div');
                        const customCategoryName = document.getElementById('custom-category-name');
                        if (customCategoryDiv && customCategoryName) {
                            customCategoryDiv.classList.remove('hidden');
                            // Try to get the category name from the database
                            try {
                                const customCategoryDoc = await getDoc(doc(db, 'customExpenseCategories', customCategoryId));
                                if (customCategoryDoc.exists()) {
                                    customCategoryName.value = customCategoryDoc.data().name;
                                } else {
                                    customCategoryName.value = expense.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                }
                            } catch (error) {
                                customCategoryName.value = expense.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            }
                            customCategoryName.required = true;
                        }
                    }
                } else {
                    // It's an old-style custom category (not using the new system)
                    expenseCategorySelect.value = 'add-new-category';
                    const customCategoryDiv = document.getElementById('custom-category-div');
                    const customCategoryName = document.getElementById('custom-category-name');
                    if (customCategoryDiv && customCategoryName) {
                        customCategoryDiv.classList.remove('hidden');
                        customCategoryName.value = expense.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        customCategoryName.required = true;
                    }
                }
                expenseSourceSelect.value = expense.source || '';
                expenseDescriptionInput.value = expense.description || '';
                expenseAmountInput.value = expense.amount || '';
                
                // Set the date
                if (expense.date && expense.date.toDate) {
                    const date = expense.date.toDate();
                    expenseDateInput.value = date.toISOString().split('T')[0];
                }
                
                // Store the expense ID for updating
                window.editingExpenseId = expenseId;
                window.currentExpenseBoxId = expense.boxId;
                
                // Fetch and display current balance
                if (expense.boxId) {
                    try {
                        const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', expense.boxId));
                        if (boxDoc.exists()) {
                            const boxData = boxDoc.data();
                            currentBalanceDisplay.textContent = boxData.currentBalance.toFixed(2) + ' Ø¬.Ù…';
                            currentViewingBox = { id: expense.boxId, ...boxData };
                        }
                    } catch (error) {
                        console.error('Error fetching box balance:', error);
                    }
                }
                
                // Update modal title
                document.querySelector('#expense-modal h3').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ';
                document.getElementById('save-expense-btn').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
                
                expenseModal.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading expense:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
            }
        }
        
        // Delete expense
        async function deleteExpense(expenseId) {
            if (!firebaseInitialized || !db) return;
            
            const confirm = window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ');
            if (!confirm) return;
            
            try {
                // Get the expense data first to check if we need to update box balance
                const expenseDoc = await getDoc(doc(db, 'expenses', expenseId));
                if (!expenseDoc.exists()) {
                    alert('Ø§Ù„Ù…ØµØ±ÙˆÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const expense = expenseDoc.data();
                
                // Use transaction to handle balance updates
                await runTransaction(db, async (transaction) => {
                    // Delete the expense
                    transaction.delete(doc(db, 'expenses', expenseId));
                    
                    // If it was a petty cash expense, restore the balance
                    if (expense.source === 'petty-cash' && expense.boxId) {
                        const boxRef = doc(db, 'pettyCashBoxes', expense.boxId);
                        const boxDoc = await transaction.get(boxRef);
                        
                        if (boxDoc.exists()) {
                            const boxData = boxDoc.data();
                            const restoredBalance = boxData.currentBalance + expense.amount;
                            
                            // Update box balance
                            transaction.update(boxRef, {
                                currentBalance: restoredBalance,
                                updatedAt: serverTimestamp()
                            });
                        }
                    }
                });
                
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
                
                // Refresh displays
                fetchAndDisplayPettyCashBoxes();
                fetchAndDisplayAllExpenses();
                
                // If viewing a box, reload its expenses
                if (currentViewingBox && currentViewingBox.id === expense.boxId) {
                    await viewPettyCashBox(expense.boxId);
                }
                
            } catch (error) {
                console.error('Error deleting expense:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
            }
        }
        
        // Print expense details
        async function printExpense(expenseId) {
            if (!firebaseInitialized || !db) return;
            
            console.log('Printing expense', expenseId);
            
            try {
                let expense;
                let isPurchaseLinked = false;
                
                // First try to get from regular expenses collection
                const expenseDoc = await getDoc(doc(db, 'expenses', expenseId));
                if (expenseDoc.exists()) {
                    expense = expenseDoc.data();
                } else {
                    // If not found in expenses, try balanceChanges (purchase-linked expenses)
                    const balanceChangeDoc = await getDoc(doc(db, 'balanceChanges', expenseId));
                    if (balanceChangeDoc.exists()) {
                        const changeData = balanceChangeDoc.data();
                        expense = {
                            category: 'Ù…Ø´ØªØ±ÙŠØ§Øª',
                            description: changeData.description,
                            amount: changeData.amount,
                            source: 'petty-cash',
                            date: changeData.date,
                            boxId: changeData.boxId,
                            employeeId: null,
                            purchaseId: changeData.purchaseId,
                            createdAt: changeData.createdAt,
                            updatedAt: changeData.updatedAt
                        };
                        isPurchaseLinked = true;
                    } else {
                        alert('Ø§Ù„Ù…ØµØ±ÙˆÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        return;
                    }
                }
                
                // Get employee name
                let employeeName = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (expense.employeeId) {
                    try {
                        const employeeDoc = await getDoc(doc(db, 'employees', expense.employeeId));
                        if (employeeDoc.exists()) {
                            employeeName = employeeDoc.data().name;
                        }
                    } catch (error) {
                        console.error('Error fetching employee:', error);
                    }
                }
                
                // Get box name
                let boxName = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (expense.boxId) {
                    try {
                        const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', expense.boxId));
                        if (boxDoc.exists()) {
                            boxName = boxDoc.data().name;
                        }
                    } catch (error) {
                        console.error('Error fetching box:', error);
                    }
                }
                
                // Get category label
                const categoryLabels = {
                    'advance': 'Ø³Ù„ÙØ©',
                    'financial-aid': 'Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø§Ù„ÙŠØ©',
                    'office-supplies': 'Ù„ÙˆØ§Ø²Ù… Ù…ÙƒØªØ¨ÙŠØ©',
                    'transportation': 'Ù…ÙˆØ§ØµÙ„Ø§Øª',
                    'meals': 'ÙˆØ¬Ø¨Ø§Øª',
                    'maintenance': 'ØµÙŠØ§Ù†Ø©',
                    'utilities': 'Ù…Ø±Ø§ÙÙ‚',
                    'cleaning': 'Ù†Ø¸Ø§ÙØ©',
                    'communication': 'Ø§ØªØµØ§Ù„Ø§Øª',
                    'other': 'Ø£Ø®Ø±Ù‰'
                };
                
                let categoryLabel = expense.category;
                if (isPurchaseLinked) {
                    categoryLabel = 'Ù…Ø´ØªØ±ÙŠØ§Øª';
                } else if (categoryLabels[expense.category]) {
                    categoryLabel = categoryLabels[expense.category];
                } else if (expense.category.startsWith('custom-')) {
                    // Try to get custom category name
                    try {
                        const customCategoryDoc = await getDoc(doc(db, 'customCategories', expense.category));
                        if (customCategoryDoc.exists()) {
                            categoryLabel = customCategoryDoc.data().name;
                        }
                    } catch (error) {
                        console.error('Error fetching custom category:', error);
                    }
                }
                
                // Get source label
                const sourceLabel = expense.source === 'petty-cash' ? 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©' : 'Ø¯ÙØ¹ Ø§Ù„Ø´Ø±ÙƒØ©';
                
                // Format dates
                const formatDate = (date) => {
                    if (!date) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const d = date.toDate ? date.toDate() : new Date(date);
                    return d.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };
                
                // Populate the expense details modal
                document.getElementById('print-expense-category').textContent = categoryLabel;
                document.getElementById('print-expense-amount').textContent = `${expense.amount.toFixed(2)} Ø¬.Ù…`;
                document.getElementById('print-expense-date').textContent = formatDate(expense.date);
                document.getElementById('print-expense-source').textContent = sourceLabel;
                document.getElementById('print-expense-description').textContent = expense.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ';
                document.getElementById('print-expense-employee').textContent = employeeName;
                document.getElementById('print-expense-box').textContent = boxName;
                document.getElementById('print-expense-created').textContent = formatDate(expense.createdAt);
                document.getElementById('print-expense-updated').textContent = formatDate(expense.updatedAt);
                
                // Show the expense details modal
                document.getElementById('expense-details-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading expense for printing:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
            }
        }
        
        // Print purchase details
        async function printPurchase(purchaseId) {
            if (!firebaseInitialized || !db) return;
            
            console.log('Printing purchase', purchaseId);
            
            try {
                // Get purchase data from cache first
                let purchase = purchasesCache.find(p => p.id === purchaseId);
                
                if (!purchase) {
                    // If not in cache, fetch from database
                    const purchaseDoc = await getDoc(doc(db, 'purchases', purchaseId));
                    if (!purchaseDoc.exists()) {
                        alert('ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                        return;
                    }
                    purchase = { id: purchaseDoc.id, ...purchaseDoc.data() };
                }
                
                // Calculate totals exactly like the existing view
                const items = Array.isArray(purchase.items) ? purchase.items : [];
                const subtotal = items.reduce((sum, item) => sum + (Number(item.quantity) || 0) * (Number(item.unitCost) || 0), 0);
                const vatEnabled = !!purchase.vatEnabled;
                const vatRate = Number(purchase.vatRate) || 0;
                const vatAmount = vatEnabled ? (subtotal * (vatRate / 100)) : 0;
                const total = subtotal + vatAmount;
                const paidAmount = Number(purchase.paidAmount) || 0;
                const remaining = total - paidAmount;
                
                // Store purchase data globally for printing
                currentPrintingPurchase = purchase;
                
                // Populate the purchase details modal with exact same structure as showPurchaseModal
                document.getElementById('print-purchase-internal-number').textContent = purchase.internalNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-invoice-number').textContent = purchase.supplierInvoiceNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-details-date').textContent = purchase.date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-supplier').textContent = purchase.supplierName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-payment-method').textContent = purchase.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-payment-status').textContent = purchase.paymentStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-receive-status').textContent = purchase.purchaseStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                document.getElementById('print-purchase-status').textContent = 'Ù†Ø´Ø·'; // Default status
                
                document.getElementById('print-purchase-total').textContent = `${total.toFixed(2)} Ø¬.Ù…`;
                document.getElementById('print-purchase-paid').textContent = `${paidAmount.toFixed(2)} Ø¬.Ù…`;
                document.getElementById('print-purchase-remaining').textContent = `${remaining.toFixed(2)} Ø¬.Ù…`;
                document.getElementById('print-purchase-tax').textContent = `${vatAmount.toFixed(2)} Ø¬.Ù…`;
                
                // Populate items with exact same structure as showPurchaseModal
                const itemsContainer = document.getElementById('print-purchase-items');
                if (items.length > 0) {
                    itemsContainer.innerHTML = `
                        <table class="w-full text-right border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="border border-gray-300 p-2">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td class="border border-gray-300 p-2">${item.productName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td class="border border-gray-300 p-2 text-center">${Number(item.quantity) || 0}</td>
                                        <td class="border border-gray-300 p-2 text-center">${Number(item.unitCost || 0).toFixed(2)} Ø¬.Ù…</td>
                                        <td class="border border-gray-300 p-2 text-center">${((Number(item.quantity) || 0) * (Number(item.unitCost) || 0)).toFixed(2)} Ø¬.Ù…</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    itemsContainer.innerHTML = '<p class="text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>';
                }
                
                document.getElementById('print-purchase-notes').textContent = purchase.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
                
                // Show the purchase details modal
                document.getElementById('purchase-details-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading purchase for printing:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡: ' + error.message);
            }
        }
        
        // Populate printable expense content
        function populatePrintableExpense() {
            const expenseToPrint = document.getElementById('expense-to-print');
            
            // Get the data from the details modal
            const category = document.getElementById('print-expense-category').textContent;
            const amount = document.getElementById('print-expense-amount').textContent;
            const date = document.getElementById('print-expense-date').textContent;
            const source = document.getElementById('print-expense-source').textContent;
            const description = document.getElementById('print-expense-description').textContent;
            const employee = document.getElementById('print-expense-employee').textContent;
            const box = document.getElementById('print-expense-box').textContent;
            const created = document.getElementById('print-expense-created').textContent;
            const updated = document.getElementById('print-expense-updated').textContent;
            
            // Check if this is a purchase-linked expense by looking at the category
            const isPurchaseLinked = category === 'Ù…Ø´ØªØ±ÙŠØ§Øª';
            
            expenseToPrint.innerHTML = `
                <div style="font-family: 'Cairo', sans-serif; direction: rtl; text-align: right; padding: 30px; background: white; max-width: 600px; margin: 0 auto;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1f2937; padding-bottom: 15px;">
                        <h1 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">ÙØ§ØªÙˆØ±Ø© Ù…ØµØ±ÙˆÙ</h1>
                        <div style="font-size: 14px; color: #6b7280;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</div>
                    </div>
                    
                    <!-- Fields in exact order as specified -->
                    <div style="line-height: 2.5;">
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„ÙØ¦Ø© (Category):</div>
                            <div style="color: #374151; font-size: 16px;">${category}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„ÙˆØµÙ (Description):</div>
                            <div style="color: #374151; font-size: 16px;">${description}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„Ù…Ø¨Ù„Øº (Amount) (Ø¬.Ù…):</div>
                            <div style="color: #374151; font-size: 18px; font-weight: bold;">${amount}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„Ø­Ø§Ù„Ø© (Status):</div>
                            <div style="color: #374151; font-size: 16px;">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙØ¹ (Payment Source):</div>
                            <div style="color: #374151; font-size: 16px;">${source}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© (Petty Cash Box):</div>
                            <div style="color: #374151; font-size: 16px;">${box || 'â€”'}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„Ù…ÙˆØ¸Ù (Employee):</div>
                            <div style="color: #374151; font-size: 16px;">${employee || 'â€”'}</div>
                        </div>
                        
                        <!-- Visual separator line -->
                        <div style="border-top: 2px solid #e5e7eb; margin: 30px 0; padding-top: 20px;">
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„ØªØ§Ø±ÙŠØ® (Date):</div>
                            <div style="color: #374151; font-size: 16px;">${date}</div>
                        </div>
                        
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Populate printable purchase content
        function populatePrintablePurchase(purchase = null) {
            const purchaseToPrint = document.getElementById('purchase-details-to-print');
            
            // Get the data from the details modal or use provided purchase data
            let internalNumber, invoiceNumber, date, supplier, paymentMethod, paymentStatus, receiveStatus, status, total, paid, remaining, tax, items, notes;
            
            if (purchase) {
                // Use provided purchase data
                internalNumber = purchase.internalNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                invoiceNumber = purchase.supplierInvoiceNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                date = purchase.date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                supplier = purchase.supplierName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                paymentMethod = purchase.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                paymentStatus = purchase.paymentStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                receiveStatus = purchase.purchaseStatus || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                status = 'Ù†Ø´Ø·';
                
                // Calculate totals
                const itemsArray = Array.isArray(purchase.items) ? purchase.items : [];
                const subtotal = itemsArray.reduce((sum, item) => sum + (Number(item.quantity) || 0) * (Number(item.unitCost) || 0), 0);
                const vatEnabled = !!purchase.vatEnabled;
                const vatRate = Number(purchase.vatRate) || 0;
                const vatAmount = vatEnabled ? (subtotal * (vatRate / 100)) : 0;
                const totalAmount = subtotal + vatAmount;
                const paidAmount = Number(purchase.paidAmount) || 0;
                const remainingAmount = totalAmount - paidAmount;
                
                total = `${totalAmount.toFixed(2)} Ø¬.Ù…`;
                paid = `${paidAmount.toFixed(2)} Ø¬.Ù…`;
                remaining = `${remainingAmount.toFixed(2)} Ø¬.Ù…`;
                tax = `${vatAmount.toFixed(2)} Ø¬.Ù…`;
                notes = purchase.notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
                
                // Generate items HTML
                if (itemsArray.length > 0) {
                    items = `
                        <table class="w-full text-right border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="border border-gray-300 p-2">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                    <th class="border border-gray-300 p-2">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsArray.map(item => `
                                    <tr>
                                        <td class="border border-gray-300 p-2">${item.productName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td class="border border-gray-300 p-2">${item.quantity || 0}</td>
                                        <td class="border border-gray-300 p-2">${Number(item.unitCost || 0).toFixed(2)} Ø¬.Ù…</td>
                                        <td class="border border-gray-300 p-2">${((Number(item.quantity) || 0) * (Number(item.unitCost) || 0)).toFixed(2)} Ø¬.Ù…</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    items = '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±</p>';
                }
            } else {
                // Fallback to DOM elements
                internalNumber = document.getElementById('print-purchase-internal-number').textContent;
                invoiceNumber = document.getElementById('print-purchase-invoice-number').textContent;
                date = document.getElementById('print-purchase-details-date').textContent;
                supplier = document.getElementById('print-purchase-supplier').textContent;
                paymentMethod = document.getElementById('print-purchase-payment-method').textContent;
                paymentStatus = document.getElementById('print-purchase-payment-status').textContent;
                receiveStatus = document.getElementById('print-purchase-receive-status').textContent;
                status = document.getElementById('print-purchase-status').textContent;
                total = document.getElementById('print-purchase-total').textContent;
                paid = document.getElementById('print-purchase-paid').textContent;
                remaining = document.getElementById('print-purchase-remaining').textContent;
                tax = document.getElementById('print-purchase-tax').textContent;
                items = document.getElementById('print-purchase-items').innerHTML;
                notes = document.getElementById('print-purchase-notes').textContent;
            }
            
            // Extract numeric values for calculations
            const totalValue = parseFloat(total.replace(/[^\d.-]/g, '')) || 0;
            const paidValue = parseFloat(paid.replace(/[^\d.-]/g, '')) || 0;
            const remainingValue = parseFloat(remaining.replace(/[^\d.-]/g, '')) || 0;
            const taxValue = parseFloat(tax.replace(/[^\d.-]/g, '')) || 0;
            const subtotalValue = totalValue - taxValue;
            
            purchaseToPrint.innerHTML = `
                <div style="font-family: 'Cairo', sans-serif; direction: rtl; text-align: right; padding: 30px; background: white; max-width: 600px; margin: 0 auto;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1f2937; padding-bottom: 15px;">
                        <h1 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</h1>
                        <div style="font-size: 14px; color: #6b7280;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</div>
                    </div>
                    
                    <!-- Fields in exact order as specified -->
                    <div style="line-height: 2.5;">
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„Ù…ÙˆØ±Ø¯ (Supplier):</div>
                            <div style="color: #374151; font-size: 16px;">${supplier}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Invoice Number):</div>
                            <div style="color: #374151; font-size: 16px;">${invoiceNumber}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (Payment Method):</div>
                            <div style="color: #374151; font-size: 16px;">${paymentMethod}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„ÙˆØµÙ (Description):</div>
                            <div style="color: #374151; font-size: 16px;">${notes || 'â€”'}</div>
                        </div>
                        
                        <!-- Visual separator line -->
                        <div style="border-top: 2px solid #e5e7eb; margin: 30px 0; padding-top: 20px;">
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Total Amount) (Ø¬.Ù…):</div>
                            <div style="color: #374151; font-size: 18px; font-weight: bold;">${totalValue.toFixed(2)}</div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #1f2937; margin-bottom: 5px;">Ø§Ù„ØªØ§Ø±ÙŠØ® (Date):</div>
                            <div style="color: #374151; font-size: 16px;">${date}</div>
                        </div>
                        
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Permanent delete expense (for purchase-linked expenses)
        async function permanentDeleteExpense(expenseId, purchaseId) {
            if (!firebaseInitialized || !db) return;
            
            const confirm = window.confirm(
                'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….\n' +
                'Ø³ÙŠØªÙ… Ø£ÙŠØ¶Ø§Ù‹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.\n' +
                'Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.\n\n' +
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
            );
            if (!confirm) return;
            
            try {
                // Get the expense data first
                const expenseDoc = await getDoc(doc(db, 'expenses', expenseId));
                if (!expenseDoc.exists()) {
                    alert('Ø§Ù„Ù…ØµØ±ÙˆÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const expense = expenseDoc.data();
                
                // Use transaction to handle all updates atomically
                await runTransaction(db, async (transaction) => {
                    // 1. Delete the expense document
                    transaction.delete(doc(db, 'expenses', expenseId));
                    
                    // 2. If it was a petty cash expense, restore the box balance
                    if (expense.source === 'petty-cash' && expense.boxId) {
                        const boxRef = doc(db, 'pettyCashBoxes', expense.boxId);
                        const boxDoc = await transaction.get(boxRef);
                        
                        if (boxDoc.exists()) {
                            const boxData = boxDoc.data();
                            const restoredBalance = boxData.currentBalance + expense.amount;
                            
                            // Update box balance
                            transaction.update(boxRef, {
                                currentBalance: restoredBalance,
                                updatedAt: serverTimestamp()
                            });
                        }
                    }
                    
                    // 3. Delete the balance change record if it exists
                    if (purchaseId) {
                        const balanceChangesQuery = query(
                            collection(db, 'balanceChanges'),
                            where('purchaseId', '==', purchaseId),
                            where('type', '==', 'withdrawal')
                        );
                        const balanceChangesSnapshot = await getDocs(balanceChangesQuery);
                        
                        balanceChangesSnapshot.forEach(docSnap => {
                            transaction.delete(docSnap.ref);
                        });
                    }
                    
                    // 4. Update accounting records - reverse the expense impact
                    // This ensures the accounting system reflects the deletion
                    const accountingEntry = {
                        type: 'expense_reversal',
                        description: `Ø¥Ù„ØºØ§Ø¡ Ù…ØµØ±ÙˆÙ: ${expense.description}`,
                        amount: expense.amount, // Positive amount to reverse the expense
                        date: serverTimestamp(),
                        expenseId: expenseId,
                        purchaseId: purchaseId,
                        source: expense.source,
                        category: expense.category,
                        employeeId: expense.employeeId,
                        boxId: expense.boxId,
                        createdAt: serverTimestamp(),
                        createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null
                    };
                    
                    // Add the reversal entry to accounting records
                    const accountingRef = doc(collection(db, 'accountingRecords'));
                    transaction.set(accountingRef, accountingEntry);
                });
                
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                
                // Refresh displays
                fetchAndDisplayPettyCashBoxes();
                fetchAndDisplayAllExpenses();
                
                // If viewing a box, reload its expenses
                if (currentViewingBox && currentViewingBox.id === expense.boxId) {
                    await viewPettyCashBox(expense.boxId);
                }
                
            } catch (error) {
                console.error('Error permanently deleting expense:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
            }
        }
        
        // Permanent delete purchase withdrawal (balanceChanges entry), restore petty cash
        async function permanentDeletePurchaseWithdrawal(balanceChangeId) {
            if (!firebaseInitialized || !db) return;
            const confirmed = window.confirm(
                'ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©.\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ'
            );
            if (!confirmed) return;
            try {
                const bcRef = doc(db, 'balanceChanges', balanceChangeId);
                const bcSnap = await getDoc(bcRef);
                if (!bcSnap.exists()) {
                    alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                const bc = bcSnap.data();
                if (bc.type !== 'withdrawal') {
                    alert('Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù„ÙŠØ³ Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨.');
                    return;
                }
                const boxId = bc.boxId;
                const amount = Number(bc.amount) || 0;
                if (!boxId || amount <= 0) {
                    alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©.');
                    return;
                }
                await runTransaction(db, async (transaction) => {
                    const boxRef = doc(db, 'pettyCashBoxes', boxId);
                    const boxSnap = await transaction.get(boxRef);
                    if (!boxSnap.exists()) throw new Error('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    const boxData = boxSnap.data();
                    const restored = (Number(boxData.currentBalance) || 0) + amount;
                    transaction.update(boxRef, { currentBalance: restored, updatedAt: serverTimestamp() });
                    transaction.delete(bcRef);
                    // Add accounting reversal
                    const accountingRef = doc(collection(db, 'accountingRecords'));
                    transaction.set(accountingRef, {
                        type: 'purchase_withdrawal_reversal',
                        description: bc.description ? `Ø¥Ù„ØºØ§Ø¡: ${bc.description}` : 'Ø¥Ù„ØºØ§Ø¡ Ø³Ø­Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡',
                        amount: amount,
                        date: serverTimestamp(),
                        purchaseId: bc.purchaseId || null,
                        boxId: boxId,
                        createdAt: serverTimestamp(),
                        createdBy: (auth && auth.currentUser) ? auth.currentUser.uid : null
                    });
                });
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø­Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø±ØµÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª.');
                fetchAndDisplayPettyCashBoxes();
                fetchAndDisplayAllExpenses();
                if (currentViewingBox && currentViewingBox.id) {
                    await viewPettyCashBox(currentViewingBox.id);
                }
            } catch (e) {
                console.error('Permanent delete purchase withdrawal failed', e);
                alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ' + (e && e.message ? e.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            }
        }
        
        // Save expense
        async function saveExpense() {
            if (!firebaseInitialized || !db) return;
            
            // Get boxId from selection or preselected
            let boxId = window.currentExpenseBoxId;
            if (!boxId && expenseBoxSelect) {
                boxId = expenseBoxSelect.value;
            }
            let category = expenseCategorySelect.value;
            const source = expenseSourceSelect.value;
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);
            const date = expenseDateInput.value;
            const isEditing = window.editingExpenseId;
            
            // Handle custom category
            if (category === 'add-new-category') {
                const customCategoryName = document.getElementById('custom-category-name').value.trim();
                if (!customCategoryName) {
                    alert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
                    return;
                }
                // Save the custom category to database and get its ID
                try {
                    const customCategoryId = await saveCustomCategory(customCategoryName);
                    category = `custom-${customCategoryId}`;
                    // Add the new category to the dropdown immediately
                    const expenseCategorySelect = document.getElementById('expense-category');
                    if (expenseCategorySelect) {
                        const option = document.createElement('option');
                        option.value = `custom-${customCategoryId}`;
                        option.textContent = customCategoryName;
                        option.selected = true; // Select the newly created category
                        
                        // Insert before the "add new category" option
                        const addNewOption = expenseCategorySelect.querySelector('option[value="add-new-category"]');
                        if (addNewOption) {
                            expenseCategorySelect.insertBefore(option, addNewOption);
                        } else {
                            expenseCategorySelect.appendChild(option);
                        }
                        
                        // Add to categoryLabels for display purposes
                        categoryLabels[`custom-${customCategoryId}`] = customCategoryName;
                    }
                } catch (error) {
                    alert('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: ' + error.message);
                    return;
                }
            } else if (category.startsWith('custom-')) {
                // Handle existing custom category - extract the actual category name
                const customCategoryId = category.replace('custom-', '');
                try {
                    const customCategoryDoc = await getDoc(doc(db, 'customExpenseCategories', customCategoryId));
                    if (customCategoryDoc.exists()) {
                        const customCategoryData = customCategoryDoc.data();
                        category = customCategoryData.name.toLowerCase().replace(/\s+/g, '-');
                    } else {
                        alert('Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØµØµØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                        return;
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØµØµØ©: ' + error.message);
                    return;
                }
            }
            
            // Only require petty cash box if the expense source is petty-cash
            if (source === 'petty-cash' && !boxId) {
                alert('ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©');
                return;
            }
            
            if (!category || !source || !description || !amount || !date) {
                alert('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            // Validate category is not the "add new category" option
            if (category === 'add-new-category') {
                alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©');
                return;
            }
            
            if (amount <= 0) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
                return;
            }
            
            // Check if amount exceeds balance for petty cash expenses
            if (source === 'petty-cash' && currentViewingBox && amount > currentViewingBox.currentBalance) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚. Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ' + currentViewingBox.currentBalance.toFixed(2) + ' Ø¬.Ù…');
                return;
            }
            
            // Validate employee selection based on category
            let employeeId = null;
            
            // Employee is mandatory only for "Ø³Ù„ÙØ©" (Advance) category
            if (category === 'advance') {
                employeeId = expenseEmployeeSelect.value;
                if (!employeeId) {
                    alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ø³Ù„ÙØ©.');
                    return;
                }
            } else if (source === 'petty-cash') {
                // For other petty cash expenses, employee is optional but recommended
                employeeId = expenseEmployeeSelect.value;
            }
            
            // Check employee weekly limit only if employee is selected
            if (employeeId) {
                const weeklyUsage = await calculateEmployeeWeeklyUsage(employeeId);
                const employeeDoc = await getDoc(doc(db, 'employees', employeeId));
                if (employeeDoc.exists()) {
                    const employee = employeeDoc.data();
                    const remaining = employee.weeklyLimit - weeklyUsage;
                    if (amount > remaining) {
                        alert(`Ø§Ù„Ù…Ø¨Ù„Øº (${amount.toFixed(2)} Ø¬.Ù…) ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ù…ÙˆØ¸Ù (${remaining.toFixed(2)} Ø¬.Ù…)`);
                        return;
                    }
                }
            }
            
            saveExpenseBtn.disabled = true;
            saveExpenseBtn.textContent = isEditing ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...' : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            
            try {
                // Use transaction to handle expense and balance updates
                await runTransaction(db, async (transaction) => {
                    let boxRef = null;
                    let boxDoc = null;
                    let boxData = null;
                    
                    // Only get box data if the expense source is petty-cash
                    if (source === 'petty-cash' && boxId) {
                        boxRef = doc(db, 'pettyCashBoxes', boxId);
                        boxDoc = await transaction.get(boxRef);
                        
                        if (!boxDoc.exists()) {
                            throw new Error('ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                        }
                        
                        boxData = boxDoc.data();
                        
                        // For new expenses, check if box is active
                        if (!isEditing && boxData.status !== 'active') {
                            throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙØ§Øª Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù…ØºÙ„Ù‚');
                        }
                    }
                    
                    let oldExpenseData = null;
                    if (isEditing) {
                        // Get the old expense data for balance calculations
                        const oldExpenseDoc = await transaction.get(doc(db, 'expenses', window.editingExpenseId));
                        if (oldExpenseDoc.exists()) {
                            oldExpenseData = oldExpenseDoc.data();
                        }
                    }
                    
                    // Calculate balance changes
                    let balanceChange = 0;
                    if (source === 'petty-cash') {
                        balanceChange = -amount; // Subtract for new/updated petty cash expense
                    }
                    
                    if (isEditing && oldExpenseData) {
                        // Restore old amount if it was petty cash
                        if (oldExpenseData.source === 'petty-cash') {
                            balanceChange += oldExpenseData.amount; // Add back the old amount
                        }
                    }
                    
                    // Check if new balance would be sufficient (only for petty-cash expenses)
                    if (source === 'petty-cash' && boxData && (boxData.currentBalance + balanceChange) < 0) {
                        throw new Error('Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­ ØºÙŠØ± ÙƒØ§ÙÙ');
                    }
                    
                    // Create or update expense document
                    const expenseData = {
                        category,
                        source,
                        description,
                        amount,
                        date: new Date(date),
                        updatedAt: serverTimestamp()
                    };
                    
                    // Only include boxId if the expense source is petty-cash
                    if (source === 'petty-cash' && boxId) {
                        expenseData.boxId = boxId;
                    }
                    
                    // Add employeeId if it's a petty cash expense
                    if (employeeId) {
                        expenseData.employeeId = employeeId;
                    }
                    
                    if (isEditing) {
                        // Update existing expense
                        transaction.update(doc(db, 'expenses', window.editingExpenseId), expenseData);
                    } else {
                        // Create new expense
                        expenseData.createdBy = auth.currentUser.uid;
                        expenseData.createdAt = serverTimestamp();
                        const expenseRef = doc(collection(db, 'expenses'));
                        transaction.set(expenseRef, expenseData);
                    }
                    
                    // Update box balance if there's a change and we have a box
                    if (balanceChange !== 0 && boxRef && boxData) {
                        const newBalance = boxData.currentBalance + balanceChange;
                        
                        const updateData = {
                            currentBalance: newBalance,
                            updatedAt: serverTimestamp()
                        };
                        
                        // Auto-close box if balance reaches zero (only for new expenses)
                        if (!isEditing && newBalance <= 0) {
                            updateData.status = 'closed';
                            updateData.endDate = serverTimestamp();
                        }
                        
                        transaction.update(boxRef, updateData);
                    }
                });
                
                // Reset editing state
                window.editingExpenseId = null;
                
                // Reset modal
                document.querySelector('#expense-modal h3').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯';
                document.getElementById('save-expense-btn').textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ';
                
                closeExpenseModal();
                fetchAndDisplayPettyCashBoxes();
                fetchAndDisplayAllExpenses();
                
                // If viewing a box, reload its expenses
                if (currentViewingBox && currentViewingBox.id === boxId) {
                    await viewPettyCashBox(boxId);
                }
                
                alert(isEditing ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error saving expense:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
            } finally {
                saveExpenseBtn.disabled = false;
                saveExpenseBtn.textContent = isEditing ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ';
            }
        }
        
        // Fetch and display all expenses
        async function fetchAndDisplayAllExpenses() {
            if (!firebaseInitialized || !db) return;
            
            try {
                // Get regular expenses
                const expensesQuery = query(collection(db, 'expenses'));
                const expensesSnapshot = await getDocs(expensesQuery);
                
                // Get purchase transactions from balance changes
                let purchaseTransactionsSnapshot = { forEach: () => {} };
                try {
                    const balanceChangesQuery = query(
                        collection(db, 'balanceChanges'),
                        where('type', '==', 'withdrawal')
                    );
                    purchaseTransactionsSnapshot = await getDocs(balanceChangesQuery);
                    console.log('Purchase transactions found:', purchaseTransactionsSnapshot.size);
                } catch (error) {
                    console.log('No purchase transactions found:', error.message);
                }
                
                // Combine all transactions
                const allTransactions = [];
                
                // Add regular expenses
                expensesSnapshot.forEach(docSnap => {
                    const expense = docSnap.data();
                    allTransactions.push({
                        id: docSnap.id,
                        type: 'expense',
                        date: expense.date,
                        category: expense.category,
                        description: expense.description,
                        amount: expense.amount,
                        source: expense.source,
                        employeeId: expense.employeeId,
                        boxId: expense.boxId,
                        purchaseId: null,
                        docRef: docSnap.ref
                    });
                });
                
                // Add purchase transactions
                purchaseTransactionsSnapshot.forEach(docSnap => {
                    const change = docSnap.data();
                    allTransactions.push({
                        id: docSnap.id,
                        type: 'purchase',
                        date: change.date,
                        category: 'Ù…Ø´ØªØ±ÙŠØ§Øª',
                        description: change.description,
                        amount: change.amount,
                        source: 'petty-cash',
                        employeeId: null,
                        boxId: change.boxId,
                        purchaseId: change.purchaseId,
                        docRef: docSnap.ref
                    });
                });
                
                // Sort by date (newest first)
                allTransactions.sort((a, b) => {
                    const dateA = a.date?.toDate ? a.date.toDate() : new Date(0);
                    const dateB = b.date?.toDate ? b.date.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                if (allTransactions.length === 0) {
                    expensesTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>';
                    return;
                }
                
                // Load boxes to get box names
                const boxesQuery = query(collection(db, 'pettyCashBoxes'));
                const boxesSnapshot = await getDocs(boxesQuery);
                const boxesMap = {};
                boxesSnapshot.forEach(docSnap => {
                    boxesMap[docSnap.id] = docSnap.data().name;
                });
                
                // Load employees to get employee names
                const employeesQuery = query(collection(db, 'employees'));
                const employeesSnapshot = await getDocs(employeesQuery);
                const employeesMap = {};
                employeesSnapshot.forEach(docSnap => {
                    employeesMap[docSnap.id] = docSnap.data().name;
                });
                
                expensesTableBody.innerHTML = '';
                let totalAmount = 0;
                let serialNumber = 1;
                
                allTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    const transactionDate = transaction.date?.toDate ? transaction.date.toDate().toLocaleDateString('ar-EG') : 'N/A';
                    
                    // Handle categories
                    let categoryLabel = transaction.category;
                    if (transaction.type === 'expense') {
                        categoryLabel = categoryLabels[transaction.category];
                        if (!categoryLabel) {
                            categoryLabel = transaction.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        }
                        if (!categoryLabel) {
                            categoryLabel = transaction.category || 'N/A';
                        }
                    }
                    
                    const boxName = boxesMap[transaction.boxId] || 'N/A';
                    const employeeName = transaction.employeeId ? (employeesMap[transaction.employeeId] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const sourceLabel = transaction.source === 'petty-cash' ? 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©' : 'Ø¯ÙØ¹ Ø§Ù„Ø´Ø±ÙƒØ©';
                    
                    // Color coding based on transaction type
                    let rowClass;
                    if (transaction.type === 'purchase') {
                        rowClass = 'hover:bg-orange-50 bg-orange-25'; // Orange for purchase transactions
                    } else if (transaction.source === 'petty-cash') {
                        rowClass = 'hover:bg-blue-50 bg-blue-25'; // Blue for petty cash expenses
                    } else {
                        rowClass = 'hover:bg-green-50 bg-green-25'; // Green for company expenses
                    }
                    
                    row.className = rowClass;
                    
                    // Determine action buttons based on transaction type
                    let actionButtons = '';
                    if (transaction.type === 'expense') {
                        actionButtons = `
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-green-600 hover:text-green-800 print-expense-btn" data-expense-id="${transaction.id}">Ø·Ø¨Ø§Ø¹Ø©</button>
                                <button class="text-blue-600 hover:text-blue-800 edit-expense-btn" data-expense-id="${transaction.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="text-red-600 hover:text-red-800 delete-expense-btn" data-expense-id="${transaction.id}">Ø­Ø°Ù</button>
                            </div>
                        `;
                    } else if (transaction.type === 'purchase') {
                        if (transaction.purchaseId) {
                            actionButtons = `
                                <div class="flex space-x-2 space-x-reverse">
                                    <button class="text-red-600 hover:text-red-800 permanent-delete-purchase-withdrawal-btn" data-balance-change-id="${transaction.id}">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                                </div>
                            `;
                        } else {
                            actionButtons = `
                                <span class="text-orange-600 text-sm">Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø¹Ù‡Ø¯Ø©</span>
                            `;
                        }
                    } else {
                        actionButtons = '<span class="text-gray-500">-</span>';
                    }
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center font-semibold text-gray-600">${serialNumber}</td>
                        <td class="px-4 py-3">${transactionDate}</td>
                        <td class="px-4 py-3">${categoryLabel}</td>
                        <td class="px-4 py-3">${transaction.description || 'N/A'}</td>
                        <td class="px-4 py-3 font-semibold">${transaction.amount.toFixed(2)} Ø¬.Ù…</td>
                        <td class="px-4 py-3">${employeeName}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 text-xs rounded-full ${transaction.source === 'petty-cash' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                ${sourceLabel}
                            </span>
                        </td>
                        <td class="px-4 py-3">${boxName}</td>
                        <td class="px-4 py-3">
                            ${actionButtons}
                        </td>
                    `;
                    
                    expensesTableBody.appendChild(row);
                    totalAmount += transaction.amount;
                    serialNumber++;
                });
                
                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.className = 'bg-gray-100 font-bold';
                totalRow.innerHTML = `
                    <td colspan="8" class="px-4 py-3 text-right">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</td>
                    <td class="px-4 py-3 font-bold text-lg">${totalAmount.toFixed(2)} Ø¬.Ù…</td>
                `;
                expensesTableBody.appendChild(totalRow);
            } catch (error) {
                console.error('Error fetching expenses:', error);
                expensesTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            }
        }
        
        // Update dashboard petty cash balance widget
        async function updateDashboardPettyCashBalance() {
            if (!firebaseInitialized || !db) return;
            
            const balanceElement = document.getElementById('active-petty-cash-balance');
            if (!balanceElement) return;
            
            try {
                const activeBoxesQuery = query(
                    collection(db, 'pettyCashBoxes'),
                    where('status', '==', 'active')
                );
                const activeBoxesSnapshot = await getDocs(activeBoxesQuery);
                
                if (activeBoxesSnapshot.empty) {
                    balanceElement.textContent = '0.00 Ø¬.Ù…';
                    balanceElement.classList.remove('text-green-600', 'text-orange-600');
                    balanceElement.classList.add('text-gray-400');
                    return;
                }
                
                let totalBalance = 0;
                activeBoxesSnapshot.forEach(docSnap => {
                    const box = docSnap.data();
                    totalBalance += box.currentBalance || 0;
                });
                
                balanceElement.textContent = totalBalance.toFixed(2) + ' Ø¬.Ù…';
                
                // Color coding based on balance
                balanceElement.classList.remove('text-gray-400', 'text-orange-600', 'text-green-600');
                if (totalBalance < 500) {
                    balanceElement.classList.add('text-orange-600');
                } else {
                    balanceElement.classList.add('text-green-600');
                }
            } catch (error) {
                console.error('Error updating dashboard petty cash balance:', error);
                balanceElement.textContent = 'Ø®Ø·Ø£';
            }
        }
        
        // ==================== EMPLOYEE MANAGEMENT ====================
        
        // Fetch and display employees
        async function fetchAndDisplayEmployees() {
            if (!firebaseInitialized || !db) {
                console.error('Firebase not initialized or database not available');
                return;
            }
            
            try {
                console.log('Fetching employees...');
                const employeesQuery = query(collection(db, 'employees'), orderBy('name'));
                const employeesSnapshot = await getDocs(employeesQuery);
                
                console.log('Employees snapshot:', employeesSnapshot);
                
                if (employeesTableBody) {
                    employeesTableBody.innerHTML = '';
                    
                    if (employeesSnapshot.empty) {
                        console.log('No employees found');
                        employeesTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</td></tr>';
                        return;
                    }
                    
                    console.log(`Found ${employeesSnapshot.docs.length} employees`);
                    for (const employeeDoc of employeesSnapshot.docs) {
                        const employee = { id: employeeDoc.id, ...employeeDoc.data() };
                        console.log('Processing employee:', employee);
                        await displayEmployeeRow(employee);
                    }
                }
            } catch (error) {
                console.error('Error fetching employees:', error);
                console.error('Error details:', error.message, error.code);
                if (employeesTableBody) {
                    employeesTableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${error.message}</td></tr>`;
                }
            }
        }
        
        // Display employee row
        async function displayEmployeeRow(employee) {
            if (!employeesTableBody) return;
            
            // Calculate weekly usage and get week info
            const weeklyUsage = await calculateEmployeeWeeklyUsage(employee.id);
            const weekInfo = await getEmployeeWeekInfo(employee.id);
            const remaining = employee.weeklyLimit - weeklyUsage;
            const status = remaining > 0 ? 'Ù…ØªØ§Ø­' : 'Ù…Ø³ØªÙ†ÙØ°';
            const statusClass = remaining > 0 ? 'text-green-600' : 'text-red-600';
            
            // Format week info for display
            let weekDisplay = '';
            if (weekInfo && weekInfo.hasExpenses) {
                const weekStart = weekInfo.currentWeekStart.toLocaleDateString('ar-EG');
                const weekEnd = weekInfo.currentWeekEnd.toLocaleDateString('ar-EG');
                weekDisplay = `${weekStart} - ${weekEnd} (${weekInfo.daysRemaining} Ø£ÙŠØ§Ù… Ù…ØªØ¨Ù‚ÙŠØ©)`;
            } else {
                weekDisplay = 'Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯';
            }
            
            // Add debugging info
            console.log(`Employee ${employee.name} (${employee.id}):`, {
                weeklyUsage: weeklyUsage,
                weekInfo: weekInfo,
                hasExpenses: weekInfo ? weekInfo.hasExpenses : false,
                firstExpenseDate: weekInfo ? weekInfo.firstExpenseDate : null
            });
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-3 text-sm text-gray-900">${employee.name}</td>
                <td class="px-4 py-3 text-sm text-gray-900">${employee.weeklyLimit.toFixed(2)} Ø¬.Ù…</td>
                <td class="px-4 py-3 text-sm text-gray-900">${weeklyUsage.toFixed(2)} Ø¬.Ù…</td>
                <td class="px-4 py-3 text-sm text-gray-900">${remaining.toFixed(2)} Ø¬.Ù…</td>
                <td class="px-4 py-3 text-sm ${statusClass}">${status}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                    <div class="text-xs text-gray-500 mb-1">${weekDisplay}</div>
                    <button class="text-blue-600 hover:text-blue-800 mr-2 edit-employee-btn" data-employee-id="${employee.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="text-red-600 hover:text-red-800 delete-employee-btn" data-employee-id="${employee.id}">Ø­Ø°Ù</button>
                </td>
            `;
            employeesTableBody.appendChild(row);
        }
        
        // Calculate employee weekly usage (Employee-specific week cycle)
        async function calculateEmployeeWeeklyUsage(employeeId) {
            if (!firebaseInitialized || !db) return 0;
            
            try {
                // Get all expenses for this employee (petty cash only)
                const expensesQuery = query(
                    collection(db, 'expenses'),
                    where('employeeId', '==', employeeId),
                    where('source', '==', 'petty-cash')
                );
                
                const expensesSnapshot = await getDocs(expensesQuery);
                
                if (expensesSnapshot.empty) {
                    console.log(`No expenses found for employee ${employeeId}`);
                    return 0;
                }
                
                // Convert to array and sort by date
                const allExpenses = [];
                expensesSnapshot.forEach(docSnap => {
                    const expense = docSnap.data();
                    allExpenses.push({
                        id: docSnap.id,
                        ...expense,
                        date: expense.date?.toDate ? expense.date.toDate() : null
                    });
                });
                
                // Sort by date (newest first)
                allExpenses.sort((a, b) => b.date - a.date);
                
                if (allExpenses.length === 0) {
                    console.log(`No expenses found for employee ${employeeId}`);
                    return 0;
                }
                
                // Get the most recent expense date
                const mostRecentDate = allExpenses[0].date;
                console.log(`Most recent expense for employee ${employeeId}:`, mostRecentDate);
                
                // Calculate the start of the current employee week
                // Employee week starts from their first expense date
                const firstExpense = allExpenses[allExpenses.length - 1];
                const firstExpenseDate = firstExpense.date;
                
                // Calculate how many weeks have passed since first expense
                const daysSinceFirst = Math.floor((new Date() - firstExpenseDate) / (1000 * 60 * 60 * 24));
                const weeksSinceFirst = Math.floor(daysSinceFirst / 7);
                
                // Current employee week starts from: firstExpenseDate + (weeksSinceFirst * 7 days)
                const currentWeekStart = new Date(firstExpenseDate);
                currentWeekStart.setDate(firstExpenseDate.getDate() + (weeksSinceFirst * 7));
                currentWeekStart.setHours(0, 0, 0, 0);
                
                // Current employee week ends 6 days later
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
                currentWeekEnd.setHours(23, 59, 59, 999);
                
                console.log(`Employee ${employeeId} week:`, {
                    firstExpense: firstExpenseDate,
                    currentWeekStart: currentWeekStart,
                    currentWeekEnd: currentWeekEnd,
                    daysSinceFirst: daysSinceFirst,
                    weeksSinceFirst: weeksSinceFirst
                });
                
                // Calculate usage for current employee week
                let totalUsage = 0;
                allExpenses.forEach(expense => {
                    const expenseDate = expense.date;
                    
                    if (expenseDate >= currentWeekStart && expenseDate <= currentWeekEnd) {
                        totalUsage += expense.amount;
                        console.log(`Included expense: ${expense.amount} on ${expenseDate}`);
                    }
                });
                
                console.log(`Total usage for employee ${employeeId} in current week: ${totalUsage}`);
                return totalUsage;
                
            } catch (error) {
                console.error('Error calculating weekly usage:', error);
                return 0;
            }
        }
        
        // Get employee week information (for display)
        async function getEmployeeWeekInfo(employeeId) {
            if (!firebaseInitialized || !db) return null;
            
            try {
                const expensesQuery = query(
                    collection(db, 'expenses'),
                    where('employeeId', '==', employeeId),
                    where('source', '==', 'petty-cash')
                );
                
                const expensesSnapshot = await getDocs(expensesQuery);
                
                if (expensesSnapshot.empty) {
                    return {
                        hasExpenses: false,
                        currentWeekStart: null,
                        currentWeekEnd: null,
                        daysRemaining: 7
                    };
                }
                
                // Convert to array and sort by date
                const allExpenses = [];
                expensesSnapshot.forEach(docSnap => {
                    const expense = docSnap.data();
                    allExpenses.push({
                        id: docSnap.id,
                        ...expense,
                        date: expense.date?.toDate ? expense.date.toDate() : null
                    });
                });
                
                // Sort by date (oldest first)
                allExpenses.sort((a, b) => a.date - b.date);
                
                const firstExpense = allExpenses[0];
                const firstExpenseDate = firstExpense.date;
                
                // Calculate current week
                const daysSinceFirst = Math.floor((new Date() - firstExpenseDate) / (1000 * 60 * 60 * 24));
                const weeksSinceFirst = Math.floor(daysSinceFirst / 7);
                
                const currentWeekStart = new Date(firstExpenseDate);
                currentWeekStart.setDate(firstExpenseDate.getDate() + (weeksSinceFirst * 7));
                currentWeekStart.setHours(0, 0, 0, 0);
                
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
                currentWeekEnd.setHours(23, 59, 59, 999);
                
                const now = new Date();
                const daysRemaining = Math.ceil((currentWeekEnd - now) / (1000 * 60 * 60 * 24));
                
                return {
                    hasExpenses: true,
                    firstExpenseDate: firstExpenseDate,
                    currentWeekStart: currentWeekStart,
                    currentWeekEnd: currentWeekEnd,
                    daysRemaining: Math.max(0, daysRemaining),
                    weeksSinceFirst: weeksSinceFirst
                };
                
            } catch (error) {
                console.error('Error getting employee week info:', error);
                return null;
            }
        }
        
        // Open employee modal
        function openEmployeeModal(employeeId = null) {
            if (employeeId) {
                // Edit mode
                loadEmployeeForEdit(employeeId);
            } else {
                // Add mode
                employeeNameInput.value = '';
                employeeWeeklyLimitInput.value = '500';
                employeePositionInput.value = '';
                employeePhoneInput.value = '';
                document.querySelector('#employee-modal h3').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯';
                document.getElementById('save-employee-btn').textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù';
            }
            
            if (employeeModal) {
                employeeModal.classList.remove('hidden');
            }
        }
        
        // Load employee for editing
        async function loadEmployeeForEdit(employeeId) {
            if (!firebaseInitialized || !db) return;
            
            try {
                const employeeDoc = await getDoc(doc(db, 'employees', employeeId));
                if (!employeeDoc.exists()) {
                    alert('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }
                
                const employee = employeeDoc.data();
                employeeNameInput.value = employee.name;
                employeeWeeklyLimitInput.value = employee.weeklyLimit;
                employeePositionInput.value = employee.position || '';
                employeePhoneInput.value = employee.phone || '';
                
                document.querySelector('#employee-modal h3').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù';
                document.getElementById('save-employee-btn').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
                
                window.editingEmployeeId = employeeId;
                
            } catch (error) {
                console.error('Error loading employee:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù: ' + error.message);
            }
        }
        
        // Save employee
        async function saveEmployee() {
            if (!firebaseInitialized || !db) return;
            
            const name = employeeNameInput.value.trim();
            const weeklyLimit = parseFloat(employeeWeeklyLimitInput.value);
            const position = employeePositionInput.value.trim();
            const phone = employeePhoneInput.value.trim();
            const isEditing = window.editingEmployeeId;
            
            if (!name || !weeklyLimit) {
                alert('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†');
                return;
            }
            
            if (weeklyLimit <= 0) {
                alert('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
                return;
            }
            
            try {
                const employeeData = {
                    name,
                    weeklyLimit,
                    position,
                    phone,
                    updatedAt: serverTimestamp()
                };
                
                if (isEditing) {
                    // Update existing employee
                    await updateDoc(doc(db, 'employees', window.editingEmployeeId), employeeData);
                } else {
                    // Create new employee
                    employeeData.createdBy = auth.currentUser.uid;
                    employeeData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'employees'), employeeData);
                }
                
                // Reset editing state
                window.editingEmployeeId = null;
                
                // Close modal
                closeEmployeeModal();
                
                // Refresh employees list
                await fetchAndDisplayEmployees();
                
                // Refresh employee dropdown in expense form
                await loadEmployeesForExpenseForm();
                
                alert(isEditing ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Error saving employee:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù: ' + error.message);
            }
        }
        
        // Delete employee
        async function deleteEmployee(employeeId) {
            if (!firebaseInitialized || !db) return;
            
            const confirm = window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ');
            if (!confirm) return;
            
            try {
                await deleteDoc(doc(db, 'employees', employeeId));
                await fetchAndDisplayEmployees();
                await loadEmployeesForExpenseForm();
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù: ' + error.message);
            }
        }
        
        // Close employee modal
        function closeEmployeeModal() {
            if (employeeModal) {
                employeeModal.classList.add('hidden');
            }
            window.editingEmployeeId = null;
        }
        
        // Load employees for expense form dropdown
        async function loadEmployeesForExpenseForm() {
            if (!firebaseInitialized || !db || !expenseEmployeeSelect) return;
            
            try {
                const employeesQuery = query(collection(db, 'employees'), orderBy('name'));
                const employeesSnapshot = await getDocs(employeesQuery);
                
                // Clear existing options except the first one
                expenseEmployeeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù...</option>';
                
                employeesSnapshot.forEach(doc => {
                    const employee = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = employee.name;
                    expenseEmployeeSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading employees for expense form:', error);
            }
        }
        
        // Load petty cash boxes for expense form dropdown
        async function loadPettyCashBoxesForExpenseForm() {
            if (!firebaseInitialized || !db) {
                console.error('Firebase not initialized or database not available');
                return;
            }
            
            try {
                console.log('Loading petty cash boxes for expense form...');
                
                // First, let's try without the where clause to see all boxes
                const allBoxesQuery = query(collection(db, 'pettyCashBoxes'), orderBy('createdAt', 'desc'));
                const allBoxesSnapshot = await getDocs(allBoxesQuery);
                
                console.log('All boxes snapshot:', allBoxesSnapshot);
                console.log(`Found ${allBoxesSnapshot.docs.length} total boxes`);
                
                // Filter active boxes manually
                const activeBoxes = allBoxesSnapshot.docs.filter(doc => {
                    const data = doc.data();
                    console.log('Box data:', doc.id, data);
                    return data.status === 'active';
                });
                
                console.log(`Found ${activeBoxes.length} active boxes after filtering`);
                
                // Find the box selection dropdown in the expense form
                const boxSelect = document.getElementById('expense-box-select');
                console.log('Box select element:', boxSelect);
                
                if (boxSelect) {
                    // Clear existing options
                    boxSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©...</option>';
                    
                    if (activeBoxes.length === 0) {
                        console.log('No active petty cash boxes found');
                        const noBoxOption = document.createElement('option');
                        noBoxOption.value = '';
                        noBoxOption.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¹Ù‡Ø¯Ø© Ù†Ø´Ø·Ø©';
                        noBoxOption.disabled = true;
                        boxSelect.appendChild(noBoxOption);
                        return;
                    }
                    
                    activeBoxes.forEach(doc => {
                        const box = doc.data();
                        console.log('Processing active box:', doc.id, box);
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = `${box.name} (${box.currentBalance.toFixed(2)} Ø¬.Ù…)`;
                        boxSelect.appendChild(option);
                    });
                    
                    console.log('Box select options after loading:', boxSelect.innerHTML);
                } else {
                    console.error('Box select element not found');
                }
                
            } catch (error) {
                console.error('Error loading petty cash boxes for expense form:', error);
                console.error('Error details:', error.message, error.code);
                
                // Fallback: try to load without orderBy
                try {
                    console.log('Trying fallback query without orderBy...');
                    const fallbackQuery = query(collection(db, 'pettyCashBoxes'), where('status', '==', 'active'));
                    const fallbackSnapshot = await getDocs(fallbackQuery);
                    
                    console.log('Fallback query result:', fallbackSnapshot);
                    console.log(`Found ${fallbackSnapshot.docs.length} boxes in fallback`);
                    
                    const boxSelect = document.getElementById('expense-box-select');
                    if (boxSelect) {
                        boxSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©...</option>';
                        
                        fallbackSnapshot.forEach(doc => {
                            const box = doc.data();
                            console.log('Fallback processing box:', doc.id, box);
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = `${box.name} (${box.currentBalance.toFixed(2)} Ø¬.Ù…)`;
                            boxSelect.appendChild(option);
                        });
                    }
                } catch (fallbackError) {
                    console.error('Fallback query also failed:', fallbackError);
                }
            }
        }
        
        // Manual function to test box loading (for debugging)
        async function testBoxLoading() {
            console.log('=== TESTING BOX LOADING ===');
            await loadPettyCashBoxesForExpenseForm();
            console.log('=== END TEST ===');
        }
        
        // Make it available globally for debugging
        window.testBoxLoading = testBoxLoading;
        
        // Function to show employee week details (for debugging/admin use)
        async function showEmployeeWeekDetails(employeeId) {
            const weekInfo = await getEmployeeWeekInfo(employeeId);
            const weeklyUsage = await calculateEmployeeWeeklyUsage(employeeId);
            
            console.log('=== EMPLOYEE WEEK DETAILS ===');
            console.log('Employee ID:', employeeId);
            console.log('Week Info:', weekInfo);
            console.log('Weekly Usage:', weeklyUsage);
            
            if (weekInfo && weekInfo.hasExpenses) {
                console.log('First Expense Date:', weekInfo.firstExpenseDate);
                console.log('Current Week Start:', weekInfo.currentWeekStart);
                console.log('Current Week End:', weekInfo.currentWeekEnd);
                console.log('Days Remaining:', weekInfo.daysRemaining);
                console.log('Weeks Since First:', weekInfo.weeksSinceFirst);
            }
            console.log('=== END DETAILS ===');
            
            return { weekInfo, weeklyUsage };
        }
        
        // Make it available globally
        window.showEmployeeWeekDetails = showEmployeeWeekDetails;
        
        // Function to check if employee has any expenses (for debugging)
        async function checkEmployeeExpenses(employeeId) {
            if (!firebaseInitialized || !db) return null;
            
            try {
                console.log(`=== CHECKING EXPENSES FOR EMPLOYEE ${employeeId} ===`);
                
                // Get all expenses for this employee
                const allExpensesQuery = query(
                    collection(db, 'expenses'),
                    where('employeeId', '==', employeeId),
                    orderBy('date', 'desc')
                );
                const allExpensesSnapshot = await getDocs(allExpensesQuery);
                
                console.log(`Total expenses found: ${allExpensesSnapshot.docs.length}`);
                
                allExpensesSnapshot.forEach((doc, index) => {
                    const expense = doc.data();
                    console.log(`Expense ${index + 1}:`, {
                        id: doc.id,
                        amount: expense.amount,
                        date: expense.date.toDate(),
                        source: expense.source,
                        category: expense.category,
                        description: expense.description
                    });
                });
                
                // Get petty cash expenses only
                const pettyCashExpensesQuery = query(
                    collection(db, 'expenses'),
                    where('employeeId', '==', employeeId),
                    where('source', '==', 'petty-cash'),
                    orderBy('date', 'desc')
                );
                const pettyCashExpensesSnapshot = await getDocs(pettyCashExpensesQuery);
                
                console.log(`Petty cash expenses found: ${pettyCashExpensesSnapshot.docs.length}`);
                
                return {
                    totalExpenses: allExpensesSnapshot.docs.length,
                    pettyCashExpenses: pettyCashExpensesSnapshot.docs.length,
                    allExpenses: allExpensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    pettyCashExpenses: pettyCashExpensesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                };
                
            } catch (error) {
                console.error('Error checking employee expenses:', error);
                return null;
            }
        }
        
        // Make it available globally
        window.checkEmployeeExpenses = checkEmployeeExpenses;
        
        // Check employee weekly limit
        async function checkEmployeeWeeklyLimit() {
            if (!expenseEmployeeSelect || !expenseAmountInput || !employeeBalanceInfo) return;
            
            const employeeId = expenseEmployeeSelect.value;
            const amount = parseFloat(expenseAmountInput.value) || 0;
            
            if (!employeeId || amount <= 0) {
                employeeBalanceInfo.classList.add('hidden');
                return;
            }
            
            try {
                const weeklyUsage = await calculateEmployeeWeeklyUsage(employeeId);
                const employeeDoc = await getDoc(doc(db, 'employees', employeeId));
                
                if (!employeeDoc.exists()) {
                    employeeBalanceInfo.classList.add('hidden');
                    return;
                }
                
                const employee = employeeDoc.data();
                const remaining = employee.weeklyLimit - weeklyUsage;
                const newRemaining = remaining - amount;
                
                // Update display
                employeeWeeklyLimitDisplay.textContent = `${remaining.toFixed(2)} Ø¬.Ù…`;
                requestedAmountDisplay.textContent = `${amount.toFixed(2)} Ø¬.Ù…`;
                
                if (newRemaining >= 0) {
                    employeeRemainingAmount.textContent = `${newRemaining.toFixed(2)} Ø¬.Ù…`;
                    employeeRemainingAfter.classList.remove('hidden');
                    employeeBalanceInfo.classList.remove('hidden');
                } else {
                    employeeRemainingAfter.classList.add('hidden');
                    employeeBalanceInfo.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error checking employee weekly limit:', error);
                employeeBalanceInfo.classList.add('hidden');
            }
        }
        
        // Event listeners for petty cash management
        if (createMissingRecordsBtn) {
            createMissingRecordsBtn.addEventListener('click', async () => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù„Ø¬Ù…ÙŠØ¹ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©ØŸ')) {
                    createMissingRecordsBtn.disabled = true;
                    createMissingRecordsBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
                    
                    try {
                        await createMissingDepositRecords();
                        alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                        fetchAndDisplayPettyCashBoxes(); // Refresh the list
                    } catch (error) {
                        console.error('Error creating missing records:', error);
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ' + error.message);
                    } finally {
                        createMissingRecordsBtn.disabled = false;
                        createMissingRecordsBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©';
                    }
                }
            });
        }

        if (addPettyCashBoxBtn) {
            addPettyCashBoxBtn.addEventListener('click', openPettyCashBoxModal);
        }
        
        if (savePettyCashBoxBtn) {
            savePettyCashBoxBtn.addEventListener('click', savePettyCashBox);
        }
        
        if (cancelPettyCashBoxBtn) {
            cancelPettyCashBoxBtn.addEventListener('click', closePettyCashBoxModal);
        }
        
        if (closeViewBoxModalBtn) {
            closeViewBoxModalBtn.addEventListener('click', () => {
                viewPettyCashBoxModal.classList.add('hidden');
            });
        }
        
        if (addExpenseBtn) {
            addExpenseBtn.addEventListener('click', () => openExpenseModal());
        }
        
        if (addExpenseToBoxBtn) {
            addExpenseToBoxBtn.addEventListener('click', () => {
                if (currentViewingBox) {
                    openExpenseModal(currentViewingBox.id);
                }
            });
        }
        
        if (saveExpenseBtn) {
            saveExpenseBtn.addEventListener('click', saveExpense);
        }
        
        if (cancelExpenseBtn) {
            cancelExpenseBtn.addEventListener('click', closeExpenseModal);
        }
        
        // Expense details modal event listeners
        const closeExpenseDetailsBtn = document.getElementById('close-expense-details-btn');
        const printExpenseBtn = document.getElementById('print-expense-btn');
        const executeExpensePrintBtn = document.getElementById('execute-expense-print-btn');
        const closeExpensePrintModalBtn = document.getElementById('close-expense-print-modal-btn');
        
        if (closeExpenseDetailsBtn) {
            closeExpenseDetailsBtn.addEventListener('click', () => {
                document.getElementById('expense-details-modal').classList.add('hidden');
            });
        }
        
        if (printExpenseBtn) {
            printExpenseBtn.addEventListener('click', () => {
                // Hide the details modal and show the printable modal
                document.getElementById('expense-details-modal').classList.add('hidden');
                document.getElementById('printable-expense-modal').classList.remove('hidden');
                
                // Populate the printable content
                populatePrintableExpense();
            });
        }
        
        if (executeExpensePrintBtn) {
            executeExpensePrintBtn.addEventListener('click', async () => {
                try {
                    // Get the expense description for filename
                    const expenseDescription = document.getElementById('print-expense-description').textContent || 'Expense';
                    const serialNumber = getNextPdfSerial();
                    
                    // Clean the description for filename (remove special characters)
                    const cleanDescription = expenseDescription.replace(/[<>:"/\\|?*]/g, '').trim();
                    const filename = `${serialNumber} - ${cleanDescription}.pdf`;
                    
                    console.log('Generating PDF with filename:', filename);
                    
                    // Generate and save PDF
                    await generatePDF('expense-to-print', filename);
                    
                    // Also trigger browser print dialog
                    window.print();
                } catch (error) {
                    console.error('Error in expense print:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
                }
            });
        }
        
        if (closeExpensePrintModalBtn) {
            closeExpensePrintModalBtn.addEventListener('click', () => {
                document.getElementById('printable-expense-modal').classList.add('hidden');
            });
        }
        
        // Purchase details modal event listeners
        const closePurchaseDetailsBtn = document.getElementById('close-purchase-details-btn');
        const printPurchaseDetailsBtn = document.getElementById('print-purchase-details-btn');
        const executePurchaseDetailsPrintBtn = document.getElementById('execute-purchase-details-print-btn');
        const closePurchaseDetailsPrintModalBtn = document.getElementById('close-purchase-details-print-modal-btn');
        
        if (closePurchaseDetailsBtn) {
            closePurchaseDetailsBtn.addEventListener('click', () => {
                document.getElementById('purchase-details-modal').classList.add('hidden');
            });
        }
        
        if (printPurchaseDetailsBtn) {
            printPurchaseDetailsBtn.addEventListener('click', () => {
                // Hide the details modal and show the printable modal
                document.getElementById('purchase-details-modal').classList.add('hidden');
                document.getElementById('printable-purchase-details-modal').classList.remove('hidden');
                
                // Populate the printable content
                populatePrintablePurchase(currentPrintingPurchase);
            });
        }
        
        if (executePurchaseDetailsPrintBtn) {
            executePurchaseDetailsPrintBtn.addEventListener('click', async () => {
                try {
                    // Get the purchase description for filename
                    const purchaseDescription = document.getElementById('print-purchase-supplier').textContent || 'Purchase';
                    const serialNumber = getNextPdfSerial();
                    
                    // Clean the description for filename (remove special characters)
                    const cleanDescription = purchaseDescription.replace(/[<>:"/\\|?*]/g, '').trim();
                    const filename = `${serialNumber} - ${cleanDescription}.pdf`;
                    
                    console.log('Generating PDF with filename:', filename);
                    
                    // Generate and save PDF
                    await generatePDF('purchase-details-to-print', filename);
                    
                    // Also trigger browser print dialog
                    window.print();
                } catch (error) {
                    console.error('Error in purchase print:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø´Ø±Ø§Ø¡: ' + error.message);
                }
            });
        }
        
        if (closePurchaseDetailsPrintModalBtn) {
            closePurchaseDetailsPrintModalBtn.addEventListener('click', () => {
                document.getElementById('printable-purchase-details-modal').classList.add('hidden');
            });
        }
        
        if (closeBoxBtn) {
            closeBoxBtn.addEventListener('click', closePettyCashBox);
        }
        
        
        if (expenseAmountInput) {
            expenseAmountInput.addEventListener('input', checkExpenseBalance);
        }
        
        if (expenseSourceSelect) {
            expenseSourceSelect.addEventListener('change', checkExpenseBalance);
        }
        
        // Handle category selection change
        const customCategoryDiv = document.getElementById('custom-category-div');
        const customCategoryName = document.getElementById('custom-category-name');
        
        if (expenseCategorySelect) {
            expenseCategorySelect.addEventListener('change', async function() {
                if (this.value === 'add-new-category') {
                    customCategoryDiv.classList.remove('hidden');
                    customCategoryName.required = true;
                    customCategoryName.focus();
                } else {
                    customCategoryDiv.classList.add('hidden');
                    customCategoryName.required = false;
                    customCategoryName.value = '';
                }
                
                // Update employee field requirement based on category
                updateEmployeeFieldRequirement(this.value);
                
                // Check expense balance to update employee selection visibility
                checkExpenseBalance();
                
                // No need to reload categories on every change - they're already loaded when modal opens
            });
        }
        
        if (expenseBoxSelect) {
            expenseBoxSelect.addEventListener('change', async function() {
                const boxId = this.value;
                if (boxId) {
                    try {
                        const boxDoc = await getDoc(doc(db, 'pettyCashBoxes', boxId));
                        if (boxDoc.exists()) {
                            const boxData = boxDoc.data();
                            currentBalanceDisplay.textContent = boxData.currentBalance.toFixed(2) + ' Ø¬.Ù…';
                            currentViewingBox = { id: boxId, ...boxData };
                        }
                    } catch (error) {
                        console.error('Error fetching box balance:', error);
                        currentBalanceDisplay.textContent = '0.00 Ø¬.Ù…';
                    }
                }
            });
        }
        
        if (expenseEmployeeSelect) {
            expenseEmployeeSelect.addEventListener('change', checkEmployeeWeeklyLimit);
        }
        
        if (expenseAmountInput) {
            expenseAmountInput.addEventListener('input', checkEmployeeWeeklyLimit);
        }
        
        // Employee event listeners
        if (addEmployeeBtn) {
            addEmployeeBtn.addEventListener('click', () => openEmployeeModal());
        }
        
        if (saveEmployeeBtn) {
            saveEmployeeBtn.addEventListener('click', saveEmployee);
        }
        
        if (cancelEmployeeBtn) {
            cancelEmployeeBtn.addEventListener('click', closeEmployeeModal);
        }
        
        // Add event listeners for edit and delete buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-expense-btn')) {
                const expenseId = e.target.getAttribute('data-expense-id');
                editExpense(expenseId);
            }
            
            if (e.target.classList.contains('delete-expense-btn')) {
                const expenseId = e.target.getAttribute('data-expense-id');
                deleteExpense(expenseId);
            }
            
            if (e.target.classList.contains('print-expense-btn')) {
                const expenseId = e.target.getAttribute('data-expense-id');
                printExpense(expenseId);
            }
            
            if (e.target.classList.contains('permanent-delete-expense-btn')) {
                const expenseId = e.target.getAttribute('data-expense-id');
                const purchaseId = e.target.getAttribute('data-purchase-id');
                permanentDeleteExpense(expenseId, purchaseId);
            }
            
            if (e.target.classList.contains('permanent-delete-purchase-withdrawal-btn')) {
                const balanceChangeId = e.target.getAttribute('data-balance-change-id');
                permanentDeletePurchaseWithdrawal(balanceChangeId);
            }
            
            if (e.target.classList.contains('edit-employee-btn')) {
                const employeeId = e.target.getAttribute('data-employee-id');
                openEmployeeModal(employeeId);
            }
            
            if (e.target.classList.contains('delete-employee-btn')) {
                const employeeId = e.target.getAttribute('data-employee-id');
                deleteEmployee(employeeId);
            }
            
            if (e.target.classList.contains('edit-box-btn')) {
                const boxId = e.target.getAttribute('data-box-id');
                editBox(boxId);
            }
            
            if (e.target.classList.contains('delete-box-btn')) {
                const boxId = e.target.getAttribute('data-box-id');
                deleteBox(boxId);
            }
        });
        
        // Click outside to close modals
        if (pettyCashBoxModal) {
            pettyCashBoxModal.addEventListener('click', e => {
                if (e.target === pettyCashBoxModal) {
                    closePettyCashBoxModal();
                }
            });
        }
        
        if (viewPettyCashBoxModal) {
            viewPettyCashBoxModal.addEventListener('click', e => {
                if (e.target === viewPettyCashBoxModal) {
                    viewPettyCashBoxModal.classList.add('hidden');
                }
            });
        }
        
        if (expenseModal) {
            expenseModal.addEventListener('click', e => {
                if (e.target === expenseModal) {
                    closeExpenseModal();
                }
            });
        }
        
        // ==================== END EXPENSES & PETTY CASH MANAGEMENT ====================

        // ==================== REPORTS MANAGEMENT ====================
        
        // Reports page elements
        const reportTypeSelect = document.getElementById('report-type');
        const reportStartDate = document.getElementById('report-start-date');
        const reportEndDate = document.getElementById('report-end-date');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportContent = document.getElementById('report-content');
        
        // Initialize date inputs
        function initializeReportDates() {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            reportStartDate.value = firstDayOfMonth.toISOString().split('T')[0];
            reportEndDate.value = today.toISOString().split('T')[0];
        }
        
        // Generate report based on selected type and date range
        async function generateReport() {
            if (!firebaseInitialized || !db) return;
            
            const reportType = reportTypeSelect.value;
            const startDate = new Date(reportStartDate.value);
            const endDate = new Date(reportEndDate.value);
            
            if (!reportType || !startDate || !endDate) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }
            
            if (startDate > endDate) {
                alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
                return;
            }
            
            generateReportBtn.disabled = true;
            generateReportBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            
            try {
                switch (reportType) {
                    case 'sales':
                        await generateSalesReport(startDate, endDate);
                        break;
                    case 'inventory':
                        await generateInventoryReport();
                        break;
                    case 'financial':
                        await generateFinancialReport(startDate, endDate);
                        break;
                    case 'expenses':
                        await generateExpensesReport(startDate, endDate);
                        break;
                    case 'customers':
                        await generateCustomerReport(startDate, endDate);
                        break;
                    case 'products':
                        await generateProductReport(startDate, endDate);
                        break;
                }
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
            } finally {
                generateReportBtn.disabled = false;
                generateReportBtn.textContent = 'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
            }
        }
        
        // Sales Report
        async function generateSalesReport(startDate, endDate) {
            const invoicesQuery = query(
                collection(db, 'invoices'),
                where('createdAt', '>=', startDate),
                where('createdAt', '<=', endDate),
                orderBy('createdAt', 'desc')
            );
            
            const invoicesSnapshot = await getDocs(invoicesQuery);
            const invoices = [];
            let totalRevenue = 0;
            let totalPaid = 0;
            let totalDue = 0;
            const salesByChannel = {};
            const salesByPaymentMethod = {};
            
            invoicesSnapshot.forEach(doc => {
                const invoice = { id: doc.id, ...doc.data() };
                
                // Skip voided invoices in sales reports
                if (invoice.voided) {
                    return; // Skip voided invoices completely
                }
                
                invoices.push(invoice);
                
                totalRevenue += invoice.total || 0;
                totalPaid += invoice.paidAmount || 0;
                totalDue += invoice.amountDue || 0;
                
                // Sales by channel
                const channel = invoice.channel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                salesByChannel[channel] = (salesByChannel[channel] || 0) + (invoice.total || 0);
                
                // Sales by payment method
                const paymentMethod = invoice.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                salesByPaymentMethod[paymentMethod] = (salesByPaymentMethod[paymentMethod] || 0) + (invoice.total || 0);
            });
            
            const reportHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="exportReport('sales')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                ØªØµØ¯ÙŠØ± PDF
                            </button>
                            <button onclick="exportReport('sales', 'excel')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                ØªØµØ¯ÙŠØ± Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-green-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4>
                            <p class="text-2xl font-bold text-green-600">${totalRevenue.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-blue-800">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h4>
                            <p class="text-2xl font-bold text-blue-600">${totalPaid.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-orange-800">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</h4>
                            <p class="text-2xl font-bold text-orange-600">${totalDue.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-purple-800">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h4>
                            <p class="text-2xl font-bold text-purple-600">${invoices.length}</p>
                        </div>
                    </div>
                    
                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="text-lg font-semibold mb-4">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‚Ù†Ø§Ø©</h4>
                            <canvas id="salesByChannelChart" width="400" height="200"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="text-lg font-semibold mb-4">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</h4>
                            <canvas id="salesByPaymentChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Detailed Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù‚Ù†Ø§Ø©</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoices.map(invoice => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 border">${invoice.id}</td>
                                        <td class="px-4 py-3 border">${invoice.customer || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td class="px-4 py-3 border">${invoice.date ? new Date(invoice.date.seconds * 1000).toLocaleDateString('ar-EG') : 'N/A'}</td>
                                        <td class="px-4 py-3 border">${invoice.channel || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td class="px-4 py-3 border">${invoice.paymentMethod || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td class="px-4 py-3 border font-semibold">${(invoice.total || 0).toFixed(2)} Ø¬.Ù…</td>
                                        <td class="px-4 py-3 border text-green-600">${(invoice.paidAmount || 0).toFixed(2)} Ø¬.Ù…</td>
                                        <td class="px-4 py-3 border text-red-600">${(invoice.amountDue || 0).toFixed(2)} Ø¬.Ù…</td>
                                        <td class="px-4 py-3 border">
                                            <span class="px-2 py-1 text-xs rounded-full ${invoice.paymentStatus === 'Paid in full' ? 'bg-green-100 text-green-800' : invoice.paymentStatus === 'Partially paid' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                                ${invoice.paymentStatus === 'Paid in full' ? 'Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : invoice.paymentStatus === 'Partially paid' ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
            
            // Create charts
            createSalesByChannelChart(salesByChannel);
            createSalesByPaymentChart(salesByPaymentMethod);
        }
        
        // Inventory Report
        async function generateInventoryReport() {
            const productsSnapshot = await getDocs(collection(db, 'products'));
            const products = [];
            let totalProducts = 0;
            let lowStockProducts = 0;
            let outOfStockProducts = 0;
            
            productsSnapshot.forEach(doc => {
                const product = { id: doc.id, ...doc.data() };
                products.push(product);
                totalProducts++;
                
                if (product.quantity === 0) {
                    outOfStockProducts++;
                } else if (product.quantity < 10) { // Assuming 10 is low stock threshold
                    lowStockProducts++;
                }
            });
            
            const reportHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="exportReport('inventory')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                ØªØµØ¯ÙŠØ± PDF
                            </button>
                            <button onclick="exportReport('inventory', 'excel')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                ØªØµØ¯ÙŠØ± Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
                            <p class="text-2xl font-bold text-blue-600">${totalProducts}</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-red-800">Ù…Ù†ØªØ¬Ø§Øª Ù†Ø§ÙØ¯Ø©</h4>
                            <p class="text-2xl font-bold text-red-600">${outOfStockProducts}</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-yellow-800">Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶</h4>
                            <p class="text-2xl font-bold text-yellow-600">${lowStockProducts}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-green-800">Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ</h4>
                            <p class="text-2xl font-bold text-green-600">${totalProducts - outOfStockProducts - lowStockProducts}</p>
                        </div>
                    </div>
                    
                    <!-- Products Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">SKU</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => {
                                    let status = 'Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ';
                                    let statusClass = 'bg-green-100 text-green-800';
                                    
                                    if (product.quantity === 0) {
                                        status = 'Ù†Ø§ÙØ¯';
                                        statusClass = 'bg-red-100 text-red-800';
                                    } else if (product.quantity < 10) {
                                        status = 'Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶';
                                        statusClass = 'bg-yellow-100 text-yellow-800';
                                    }
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 border">${product.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                            <td class="px-4 py-3 border">${product.sku || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                            <td class="px-4 py-3 border font-semibold">${product.quantity || 0}</td>
                                            <td class="px-4 py-3 border">
                                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                                    ${status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 border">${product.createdAt ? new Date(product.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : 'N/A'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
        }
        
        // Financial Report
        async function generateFinancialReport(startDate, endDate) {
            // Get invoices for the period
            const invoicesQuery = query(
                collection(db, 'invoices'),
                where('createdAt', '>=', startDate),
                where('createdAt', '<=', endDate)
            );
            
            const invoicesSnapshot = await getDocs(invoicesQuery);
            let totalRevenue = 0;
            let totalPaid = 0;
            let totalDue = 0;
            
            invoicesSnapshot.forEach(doc => {
                const invoice = doc.data();
                
                // Skip voided invoices in sales reports
                if (invoice.voided) {
                    return; // Skip voided invoices completely
                }
                
                totalRevenue += invoice.total || 0;
                totalPaid += invoice.paidAmount || 0;
                totalDue += invoice.amountDue || 0;
            });
            
            // Get petty cash boxes
            const pettyCashSnapshot = await getDocs(collection(db, 'pettyCashBoxes'));
            let totalPettyCash = 0;
            let activeBoxes = 0;
            
            pettyCashSnapshot.forEach(doc => {
                const box = doc.data();
                if (box.status === 'active') {
                    totalPettyCash += box.currentBalance || 0;
                    activeBoxes++;
                }
            });
            
            const reportHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="exportReport('financial')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                ØªØµØ¯ÙŠØ± PDF
                            </button>
                            <button onclick="exportReport('financial', 'excel')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                ØªØµØ¯ÙŠØ± Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-green-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h4>
                            <p class="text-2xl font-bold text-green-600">${totalRevenue.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-blue-800">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</h4>
                            <p class="text-2xl font-bold text-blue-600">${totalPaid.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-orange-800">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚</h4>
                            <p class="text-2xl font-bold text-orange-600">${totalDue.toFixed(2)} Ø¬.Ù…</p>
                        </div>
                    </div>
                    
                    <!-- Cash Management -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-purple-800">Ø±ØµÙŠØ¯ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</h4>
                            <p class="text-2xl font-bold text-purple-600">${totalPettyCash.toFixed(2)} Ø¬.Ù…</p>
                            <p class="text-sm text-purple-600">${activeBoxes} ØµÙ†Ø¯ÙˆÙ‚ Ù†Ø´Ø·</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-indigo-800">ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ</h4>
                            <p class="text-2xl font-bold text-indigo-600">${(totalPaid + totalPettyCash).toFixed(2)} Ø¬.Ù…</p>
                            <p class="text-sm text-indigo-600">Ø§Ù„Ù…Ø¯ÙÙˆØ¹ + Ø±ØµÙŠØ¯ Ø§Ù„Ø¹Ù‡Ø¯Ø©</p>
                        </div>
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
        }
        
        // Expenses Report (Comprehensive)
        async function generateExpensesReport(startDate, endDate) {
            // Adjust end date to include the entire day
            const adjustedEndDate = new Date(endDate);
            adjustedEndDate.setHours(23, 59, 59, 999);
            
            // Get regular expenses from expenses collection
            const expensesQuery = query(
                collection(db, 'expenses'),
                where('date', '>=', startDate),
                where('date', '<=', adjustedEndDate),
                orderBy('date', 'desc')
            );
            
            const expensesSnapshot = await getDocs(expensesQuery);
            
            // Get purchase transactions from balance changes
            const balanceChangesQuery = query(
                collection(db, 'balanceChanges'),
                where('type', '==', 'withdrawal'),
                where('date', '>=', startDate),
                where('date', '<=', adjustedEndDate),
                orderBy('date', 'desc')
            );
            
            const balanceChangesSnapshot = await getDocs(balanceChangesQuery);
            
            // Load boxes to get box names
            const boxesQuery = query(collection(db, 'pettyCashBoxes'));
            const boxesSnapshot = await getDocs(boxesQuery);
            const boxesMap = {};
            boxesSnapshot.forEach(docSnap => {
                boxesMap[docSnap.id] = docSnap.data().name;
            });
            
            // Load employees to get employee names
            const employeesQuery = query(collection(db, 'employees'));
            const employeesSnapshot = await getDocs(employeesQuery);
            const employeesMap = {};
            employeesSnapshot.forEach(docSnap => {
                employeesMap[docSnap.id] = docSnap.data().name;
            });
            
            // Category labels mapping
            const categoryLabels = {
                'rent': 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',
                'utilities': 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚',
                'salaries': 'Ø§Ù„Ø±ÙˆØ§ØªØ¨',
                'supplies': 'Ø§Ù„Ù„ÙˆØ§Ø²Ù…',
                'marketing': 'Ø§Ù„ØªØ³ÙˆÙŠÙ‚',
                'maintenance': 'Ø§Ù„ØµÙŠØ§Ù†Ø©',
                'transport': 'Ø§Ù„Ù†Ù‚Ù„',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            
            // Combine all transactions
            const allTransactions = [];
            
            // Add regular expenses
            expensesSnapshot.forEach(docSnap => {
                const expense = docSnap.data();
                allTransactions.push({
                    id: docSnap.id,
                    type: 'expense',
                    date: expense.date,
                    category: expense.category,
                    description: expense.description,
                    amount: expense.amount,
                    source: expense.source,
                    employeeId: expense.employeeId,
                    boxId: expense.boxId,
                    purchaseId: null
                });
            });
            
            // Add purchase transactions
            balanceChangesSnapshot.forEach(docSnap => {
                const change = docSnap.data();
                allTransactions.push({
                    id: docSnap.id,
                    type: 'purchase',
                    date: change.date,
                    category: 'Ù…Ø´ØªØ±ÙŠØ§Øª',
                    description: change.description,
                    amount: change.amount,
                    source: 'petty-cash',
                    employeeId: null,
                    boxId: change.boxId,
                    purchaseId: change.purchaseId
                });
            });
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => {
                const dateA = a.date?.toDate ? a.date.toDate() : new Date(0);
                const dateB = b.date?.toDate ? b.date.toDate() : new Date(0);
                return dateB - dateA;
            });
            
            // Calculate totals and statistics
            let totalAmount = 0;
            let expensesTotal = 0;
            let purchasesTotal = 0;
            let pettyCashTotal = 0;
            let companyPaymentTotal = 0;
            const categoryBreakdown = {};
            const sourceBreakdown = { 'petty-cash': 0, 'company-payment': 0 };
            
            allTransactions.forEach(transaction => {
                totalAmount += transaction.amount;
                
                if (transaction.type === 'expense') {
                    expensesTotal += transaction.amount;
                } else if (transaction.type === 'purchase') {
                    purchasesTotal += transaction.amount;
                }
                
                if (transaction.source === 'petty-cash') {
                    pettyCashTotal += transaction.amount;
                    sourceBreakdown['petty-cash'] += transaction.amount;
                } else if (transaction.source === 'company-payment') {
                    companyPaymentTotal += transaction.amount;
                    sourceBreakdown['company-payment'] += transaction.amount;
                }
                
                // Category breakdown
                const category = transaction.type === 'purchase' ? 'Ù…Ø´ØªØ±ÙŠØ§Øª' : (categoryLabels[transaction.category] || transaction.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                categoryBreakdown[category] = (categoryBreakdown[category] || 0) + transaction.amount;
            });
            
            const reportHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="exportReport('expenses')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                ØªØµØ¯ÙŠØ± PDF
                            </button>
                            <button onclick="exportReport('expenses', 'excel')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                ØªØµØ¯ÙŠØ± Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 mb-4">
                        Ø§Ù„ÙØªØ±Ø©: Ù…Ù† ${startDate.toLocaleDateString('ar-EG')} Ø¥Ù„Ù‰ ${endDate.toLocaleDateString('ar-EG')}
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-red-50 p-4 rounded-lg border-r-4 border-red-500">
                            <h4 class="text-sm font-medium text-red-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
                            <p class="text-2xl font-bold text-red-600">${totalAmount.toFixed(2)} Ø¬.Ù…</p>
                            <p class="text-xs text-red-600 mt-1">${allTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø©</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border-r-4 border-blue-500">
                            <h4 class="text-sm font-medium text-blue-800">Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ø§Ù…Ø©</h4>
                            <p class="text-2xl font-bold text-blue-600">${expensesTotal.toFixed(2)} Ø¬.Ù…</p>
                            <p class="text-xs text-blue-600 mt-1">${expensesSnapshot.size} Ù…ØµØ±ÙˆÙ</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border-r-4 border-orange-500">
                            <h4 class="text-sm font-medium text-orange-800">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h4>
                            <p class="text-2xl font-bold text-orange-600">${purchasesTotal.toFixed(2)} Ø¬.Ù…</p>
                            <p class="text-xs text-orange-600 mt-1">${balanceChangesSnapshot.size} Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg border-r-4 border-purple-500">
                            <h4 class="text-sm font-medium text-purple-800">Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</h4>
                            <p class="text-2xl font-bold text-purple-600">${pettyCashTotal.toFixed(2)} Ø¬.Ù…</p>
                            <p class="text-xs text-purple-600 mt-1">${((pettyCashTotal / totalAmount) * 100).toFixed(1)}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
                        </div>
                    </div>
                    
                    <!-- Category Breakdown -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="text-sm font-semibold text-gray-800 mb-3">Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${Object.entries(categoryBreakdown).sort((a, b) => b[1] - a[1]).map(([category, amount]) => `
                                <div class="bg-white p-3 rounded border">
                                    <div class="text-xs text-gray-600">${category}</div>
                                    <div class="text-lg font-semibold text-gray-800">${amount.toFixed(2)} Ø¬.Ù…</div>
                                    <div class="text-xs text-gray-500">${((amount / totalAmount) * 100).toFixed(1)}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Source Breakdown -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-blue-800 mb-2">ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©</h4>
                            <div class="flex items-end justify-between">
                                <div>
                                    <p class="text-2xl font-bold text-blue-600">${sourceBreakdown['petty-cash'].toFixed(2)} Ø¬.Ù…</p>
                                    <p class="text-xs text-blue-600">${((sourceBreakdown['petty-cash'] / totalAmount) * 100).toFixed(1)}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
                                </div>
                                <svg class="w-12 h-12 text-blue-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                                    <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-green-800 mb-2">Ø¯ÙØ¹ Ø§Ù„Ø´Ø±ÙƒØ©</h4>
                            <div class="flex items-end justify-between">
                                <div>
                                    <p class="text-2xl font-bold text-green-600">${sourceBreakdown['company-payment'].toFixed(2)} Ø¬.Ù…</p>
                                    <p class="text-xs text-green-600">${((sourceBreakdown['company-payment'] / totalAmount) * 100).toFixed(1)}% Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</p>
                                </div>
                                <svg class="w-12 h-12 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Expenses Table -->
                    <div class="bg-white rounded-lg border">
                        <div class="px-4 py-3 bg-gray-50 border-b">
                            <h4 class="font-semibold text-gray-800">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„ÙØ¦Ø©</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„ÙˆØµÙ</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„Ù…ØµØ¯Ø±</th>
                                        <th class="px-4 py-3 text-xs font-medium text-gray-600 uppercase">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${allTransactions.length === 0 ? `
                                        <tr>
                                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                                <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                </svg>
                                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                                            </td>
                                        </tr>
                                    ` : allTransactions.map(transaction => {
                                        const transactionDate = transaction.date?.toDate ? transaction.date.toDate().toLocaleDateString('ar-EG') : 'N/A';
                                        
                                        // Handle categories
                                        let categoryLabel = transaction.category;
                                        if (transaction.type === 'expense') {
                                            categoryLabel = categoryLabels[transaction.category] || transaction.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                                        }
                                        
                                        const boxName = boxesMap[transaction.boxId] || 'N/A';
                                        const employeeName = transaction.employeeId ? (employeesMap[transaction.employeeId] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                                        const sourceLabel = transaction.source === 'petty-cash' ? 'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù‡Ø¯Ø©' : 'Ø¯ÙØ¹ Ø§Ù„Ø´Ø±ÙƒØ©';
                                        
                                        // Color coding based on transaction type
                                        let rowClass = '';
                                        let typeLabel = '';
                                        let typeBadge = '';
                                        
                                        if (transaction.type === 'purchase') {
                                            rowClass = 'bg-orange-25 hover:bg-orange-50';
                                            typeLabel = 'Ù…Ø´ØªØ±ÙŠØ§Øª';
                                            typeBadge = 'bg-orange-100 text-orange-800';
                                        } else if (transaction.source === 'petty-cash') {
                                            rowClass = 'bg-blue-25 hover:bg-blue-50';
                                            typeLabel = 'Ù…ØµØ±ÙˆÙ';
                                            typeBadge = 'bg-blue-100 text-blue-800';
                                        } else {
                                            rowClass = 'bg-green-25 hover:bg-green-50';
                                            typeLabel = 'Ù…ØµØ±ÙˆÙ';
                                            typeBadge = 'bg-green-100 text-green-800';
                                        }
                                        
                                        return `
                                            <tr class="${rowClass}">
                                                <td class="px-4 py-3 text-sm">${transactionDate}</td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 text-xs rounded-full ${typeBadge}">
                                                        ${typeLabel}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm">${categoryLabel}</td>
                                                <td class="px-4 py-3 text-sm">${transaction.description || 'N/A'}</td>
                                                <td class="px-4 py-3 font-semibold text-red-600">${transaction.amount.toFixed(2)} Ø¬.Ù…</td>
                                                <td class="px-4 py-3 text-sm">${employeeName}</td>
                                                <td class="px-4 py-3">
                                                    <span class="px-2 py-1 text-xs rounded-full ${transaction.source === 'petty-cash' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                                        ${sourceLabel}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm">${boxName}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                                ${allTransactions.length > 0 ? `
                                    <tfoot class="bg-gray-50 border-t-2 border-gray-300">
                                        <tr>
                                            <td colspan="4" class="px-4 py-3 text-right font-bold text-gray-800">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ:</td>
                                            <td class="px-4 py-3 font-bold text-red-600 text-lg">${totalAmount.toFixed(2)} Ø¬.Ù…</td>
                                            <td colspan="3"></td>
                                        </tr>
                                    </tfoot>
                                ` : ''}
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
        }
        
        // Customer Report
        async function generateCustomerReport(startDate, endDate) {
            const invoicesQuery = query(
                collection(db, 'invoices'),
                where('createdAt', '>=', startDate),
                where('createdAt', '<=', endDate)
            );
            
            const invoicesSnapshot = await getDocs(invoicesQuery);
            const customers = {};
            let totalCustomers = 0;
            
            invoicesSnapshot.forEach(doc => {
                const invoice = doc.data();
                
                // Skip voided invoices in customer reports
                if (invoice.voided) {
                    return; // Skip voided invoices completely
                }
                
                const customer = invoice.customer || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                if (!customers[customer]) {
                    customers[customer] = {
                        name: customer,
                        totalInvoices: 0,
                        totalAmount: 0,
                        lastPurchase: invoice.date
                    };
                    totalCustomers++;
                }
                
                customers[customer].totalInvoices++;
                customers[customer].totalAmount += invoice.total || 0;
                
                if (invoice.date && (!customers[customer].lastPurchase || invoice.date > customers[customer].lastPurchase)) {
                    customers[customer].lastPurchase = invoice.date;
                }
            });
            
            const customerList = Object.values(customers).sort((a, b) => b.totalAmount - a.totalAmount);
            
            const reportHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="exportReport('customers')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                ØªØµØ¯ÙŠØ± PDF
                            </button>
                            <button onclick="exportReport('customers', 'excel')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                ØªØµØ¯ÙŠØ± Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Customer Summary -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="text-sm font-medium text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
                        <p class="text-2xl font-bold text-blue-600">${totalCustomers}</p>
                    </div>
                    
                    <!-- Top Customers Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customerList.map(customer => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 border font-semibold">${customer.name}</td>
                                        <td class="px-4 py-3 border">${customer.totalInvoices}</td>
                                        <td class="px-4 py-3 border font-semibold text-green-600">${customer.totalAmount.toFixed(2)} Ø¬.Ù…</td>
                                        <td class="px-4 py-3 border">${customer.lastPurchase ? new Date(customer.lastPurchase.seconds * 1000).toLocaleDateString('ar-EG') : 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
        }
        
        // Product Report
        async function generateProductReport(startDate, endDate) {
            // Get all products
            const productsSnapshot = await getDocs(collection(db, 'products'));
            const products = [];
            
            productsSnapshot.forEach(doc => {
                products.push({ id: doc.id, ...doc.data() });
            });
            
            // Get sales data for the period
            const invoicesQuery = query(
                collection(db, 'invoices'),
                where('createdAt', '>=', startDate),
                where('createdAt', '<=', endDate)
            );
            
            const invoicesSnapshot = await getDocs(invoicesQuery);
            const productSales = {};
            
            invoicesSnapshot.forEach(doc => {
                const invoice = doc.data();
                
                // Skip voided invoices in product reports
                if (invoice.voided) {
                    return; // Skip voided invoices completely
                }
                
                if (invoice.items) {
                    invoice.items.forEach(item => {
                        if (!productSales[item.productId]) {
                            productSales[item.productId] = {
                                productName: item.productName,
                                totalQuantity: 0,
                                totalRevenue: 0
                            };
                        }
                        productSales[item.productId].totalQuantity += item.quantity || 0;
                        productSales[item.productId].totalRevenue += (item.price || 0) * (item.quantity || 0);
                    });
                }
            });
            
            const reportHTML = `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="exportReport('products')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                ØªØµØ¯ÙŠØ± PDF
                            </button>
                            <button onclick="exportReport('products', 'excel')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                ØªØµØ¯ÙŠØ± Excel
                            </button>
                        </div>
                    </div>
                    
                    <!-- Product Performance Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-right border-collapse">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                    <th class="px-4 py-3 border text-xs font-medium text-gray-500 uppercase">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(productSales).sort((a, b) => b.totalRevenue - a.totalRevenue).map(sale => {
                                    const product = products.find(p => p.name === sale.productName);
                                    let status = 'Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ';
                                    let statusClass = 'bg-green-100 text-green-800';
                                    
                                    if (!product || product.quantity === 0) {
                                        status = 'Ù†Ø§ÙØ¯';
                                        statusClass = 'bg-red-100 text-red-800';
                                    } else if (product.quantity < 10) {
                                        status = 'Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶';
                                        statusClass = 'bg-yellow-100 text-yellow-800';
                                    }
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 border font-semibold">${sale.productName}</td>
                                            <td class="px-4 py-3 border">${sale.totalQuantity}</td>
                                            <td class="px-4 py-3 border font-semibold text-green-600">${sale.totalRevenue.toFixed(2)} Ø¬.Ù…</td>
                                            <td class="px-4 py-3 border">${product ? product.quantity : 'N/A'}</td>
                                            <td class="px-4 py-3 border">
                                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                                    ${status}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = reportHTML;
        }
        
        // Chart creation functions
        function createSalesByChannelChart(data) {
            const ctx = document.getElementById('salesByChannelChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createSalesByPaymentChart(data) {
            const ctx = document.getElementById('salesByPaymentChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬.Ù…)',
                        data: Object.values(data),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Export functionality
        function exportReport(type, format = 'pdf') {
            // This would implement actual export functionality
            alert(`ØªØµØ¯ÙŠØ± ${type} ÙƒÙ€ ${format} - Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹`);
        }
        
        // Event listeners
        generateReportBtn.addEventListener('click', generateReport);
        
        // Initialize reports when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeReportDates();
        });
        
        // Debug function to check all expenses and their employee IDs
        async function debugAllExpenses() {
            if (!firebaseInitialized || !db) return;
            
            try {
                const expensesQuery = query(collection(db, 'expenses'), orderBy('date', 'desc'));
                const expensesSnapshot = await getDocs(expensesQuery);
                
                console.log('=== ALL EXPENSES DEBUG ===');
                console.log(`Total expenses: ${expensesSnapshot.size}`);
                
                expensesSnapshot.forEach(docSnap => {
                    const expense = docSnap.data();
                    console.log(`Expense ID: ${docSnap.id}`, {
                        description: expense.description,
                        amount: expense.amount,
                        employeeId: expense.employeeId,
                        source: expense.source,
                        date: expense.date?.toDate ? expense.date.toDate().toLocaleDateString() : 'Invalid date'
                    });
                });
            } catch (error) {
                console.error('Error debugging expenses:', error);
            }
        }
        
        // Make debug function globally available
        window.debugAllExpenses = debugAllExpenses;
        
        // ==================== END REPORTS MANAGEMENT ====================
    });
</script>
</body>
</html>

